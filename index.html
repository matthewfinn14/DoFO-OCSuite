<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Head Coach Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .wristband-print-container {
            display: none;
        }

        @media print {
            @page {
                size: auto;
                /* Let prompt/printer decide, or portrait */
                /* 11" width - 10" content = 1" margin. 0.5" left/right */
                /* 8.5" height - 6" content = 2.5" margin. 1.25" top/bottom */
                margin: 0.5in;
            }

            body {
                background: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                margin: 0;
                padding: 0;
            }

            /* Hide everything by default, specifically buttons and inputs */
            /* Show root */
            #root>* {
                display: flex !important;
                /* was display: none */
            }

            .app-container,
            .sidebar {
                display: none !important;
            }

            .print-only-scripts {
                display: block !important;
            }

            .script-view-panel {
                display: none !important;
            }

            /* Print Utilities */
            .print-only-text {
                display: block !important;
            }

            .no-print {
                display: none !important;
            }

            /* Screen Utilities */
            .screen-hidden {
                display: none;
            }

            .main-content {
                display: block !important;
                padding: 0 !important;
                margin: 0 !important;
                height: auto !important;
                overflow: visible !important;
            }

            /* Break Flex Layout for Print */
            .practice-flex-container {
                display: block !important;
                overflow: visible !important;
            }

            .wristband-print-container {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: white;
                color: black;
            }

            .travel-print-container {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                background: white;
                color: black;
                padding: 2rem;
            }

            button,
            .btn,
            input,
            select {
                display: none !important;
            }

            .wristband-print-container {
                display: grid !important;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                /* 2 cards wide (10" total), 2 cards high (6" total) fits on 11x8.5 */
                grid-template-columns: 5in 5in;
                grid-template-rows: 3in 3in;
                justify-content: center;
                align-content: center;
                gap: 0.25in;
                padding: 0;
                background: white;
                box-sizing: border-box;
                z-index: 9999;
            }

            .wristband-print-container>* {
                display: flex !important;
            }

            .wristband-card {
                width: 5in;
                height: 3in;
                border: 2px solid black !important;
                display: flex;
                flex-direction: column;
                background: white;
                overflow: hidden;
                /* Ensure content stays within 5x3 */
            }

            .wristband-card-header {
                font-size: 10pt;
                font-weight: bold;
                background: black !important;
                color: white !important;
                text-align: center;
                padding: 2px 0;
                border-bottom: 2px solid black;
                text-transform: uppercase;
            }

            .wristband-content {
                flex: 1;
                display: flex;
                border-top: 1px solid black;
            }

            .wristband-col {
                flex: 1;
                display: flex;
                flex-direction: column;
            }

            .wristband-col:first-child {
                border-right: 2px solid black;
                /* Split columns clearly */
            }

            .wristband-row {
                flex: 1;
                /* Distribute height evenly */
                display: flex;
                border-bottom: 1px solid black;
                align-items: center;
                overflow: hidden;
            }

            .wristband-row:last-child {
                border-bottom: none;
            }

            .wristband-num {
                width: 28px;
                /* Fixed width */
                font-size: 8pt;
                font-weight: bold;
                background: #f0f0f0 !important;
                /* Light grey for numbers */
                display: flex;
                align-items: center;
                justify-content: center;
                border-right: 1px solid black;
                height: 100%;
                color: black;
            }

            .wristband-play {
                flex: 1;
                font-size: 8pt;
                /* Smaller font to fit */
                font-weight: bold;
                padding: 0 4px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                display: flex;
                align-items: center;
                height: 100%;
            }

            /* Alternating row colors for readability if desired, but user image showed white/tan strips */
            /* Let's try to match user sample roughly or keep clean white */
            .wristband-row:nth-child(odd) .wristband-play {
                background: white;
            }

            .wristband-row:nth-child(even) .wristband-play {
                background: #ffedd5 !important;
                /* Orange-ish tint like screenshot */
            }

            /* Specific overrides for color classes if we pass them */
            .wristband-card.green .wristband-row:nth-child(even) .wristband-play {
                background: #dcfce7 !important;
            }
        }
    </style>
</head>

<body>
    <!-- Error Handler (Standard JS) -->
    <script>
        window.onerror = function (message, source, lineno, colno, error) {
            document.body.innerHTML = '<div style="color:red; padding:20px; font-family: sans-serif;"><h1>Application Error</h1><p><strong>Message:</strong> ' + message + '</p><p><strong>Source:</strong> ' + source + '</p><p><strong>Line:</strong> ' + lineno + '</p></div>';
            return false;
        };
    </script>

    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Data & Constants ---
        // ... (rest of the file)


        // --- Data & Constants ---

        const TAG_CATEGORIES = {
            "Field Position": ["Backed Up", "Coming Out", "Open Field", "Fringe", "Red Zone", "Gold Zone", "Goal Line", "2-PT"],
            "Down & Distance": [
                "1st & 10", "Normal Down",
                "2nd & XL", "2nd & Long", "2nd & Med", "2nd & Short",
                "3rd & XL", "3rd & Long", "3rd & Med", "3rd & Short",
                "4th & XL", "4th & Long", "4th & Med", "4th & Short"
            ],
            "Situation": ["2 Min", "4 Min", "End of Game", "Possession", "Opening Script", "Tank Play", "Test Play", "Setup Play"],
            "Coverage Beaters": ["MOFO (Middle Open)", "MOFC (Middle Closed)", "Man Beater", "Zone Beater"],
            "Front Beaters": ["Odd Beater", "Even Beater", "Pressure Beater"],
            "Motion": [
                "Down motion",
                "THRU MO from 1x3 to 2x2",
                "THRU mo from 2x2 to 3x1",
                "Orbit MO from 1x3 to 2x2",
                "Orbit MO from 2x2 to 3x1",
                "RB push motion",
                "Zipper",
                "YAC",
                "YO-YO"
            ],
            "Primary Target": ["X", "A", "Z", "Y", "B", "Q", "F"],

            // Merged Call Sheet Tags
            "Play Type": [
                "Tank Runs",
                "Perimeter Runs",
                "FLOW RPOS",
                "FIT RPOS",
                "Quick",
                "Intermediate",
                "PAP",
                "MOVEMENT",
                "Deep",
                "GADGET"
            ],

            "Action Types": ["Strong Run", "Weak Run", "Quick Game", "Drop Back", "Screen", "Gadget"],
            "Base Type": ["Run", "Pass", "RPO", "Gadget"]
        };

        const HASH_PREFERENCES = ["Left", "Right", "Middle", "Any"];

        const INITIAL_PLAYS = [
            // 100s - WB1 Left Column
            { id: '101', wristbandSlot: '101', name: 'DIAMOND RT GRN 3 GAMBLE', formation: 'Diamond Rt', tags: ['Gamble'] },
            { id: '103', wristbandSlot: '103', name: 'BUNCH RT 2 GAMBLE', formation: 'Bunch Rt', tags: ['Gamble'] },
            { id: '105', wristbandSlot: '105', name: 'BUNCH LT 3 RED 6 + GAMBLE*', formation: 'Bunch Lt', tags: ['Gamble', 'Red 6'] },
            { id: '107', wristbandSlot: '107', name: 'GRN BOOMER 1', formation: 'Green', tags: ['Boomer'] },
            { id: '109', wristbandSlot: '109', name: 'RED 39 MUSTANG', formation: 'Red', tags: ['Mustang'] },
            { id: '111', wristbandSlot: '111', name: 'BRT 56D + KNIFE', formation: 'Bright', tags: ['Knife'] },
            { id: '113', wristbandSlot: '113', name: 'GRN Fist Smoke', formation: 'Green', tags: ['Smoke'] },
            { id: '115', wristbandSlot: '115', name: '983 BLUE 1', formation: 'Blue', tags: ['983'] },
            { id: '117', wristbandSlot: '117', name: 'BRT RED "A THRU" + SALT', formation: 'Bright Red', tags: ['Salt'] },
            { id: '119', wristbandSlot: '119', name: '941 BLUE 4+ Y Willy', formation: 'Blue', tags: ['Willy'] },
            { id: '121', wristbandSlot: '121', name: '983 BLUE 2+ CAPONE', formation: 'Blue', tags: ['Capone'] },
            { id: '123', wristbandSlot: '123', name: '934 BLUE 2 SUPER', formation: 'Blue', tags: ['Super'] },
            { id: '125', wristbandSlot: '125', name: '980 BLUE 6+ Y RPO', formation: 'Blue', tags: ['RPO'] },
            { id: '127', wristbandSlot: '127', name: '984 RED 2+ Y Willy', formation: 'Red', tags: ['Willy'] },
            { id: '129', wristbandSlot: '129', name: '36A RED 4+Y Willy', formation: 'Red', tags: ['Willy'] },
            { id: '131', wristbandSlot: '131', name: 'GRN RED "B THRU" + 3T', formation: 'Green Red', tags: [] },
            { id: '133', wristbandSlot: '133', name: '463 BLUE 4A', formation: 'Blue', tags: [] },
            { id: '135', wristbandSlot: '135', name: '488 LIZ GREEN STICK + TAG', formation: 'Green', tags: ['Stick'] },
            { id: '137', wristbandSlot: '137', name: '468 RN "A JET"', formation: 'Rn', tags: ['Jet'] },
            { id: '139', wristbandSlot: '139', name: '468 LIZ GRN RICE*', formation: 'Green', tags: ['Rice'] },
            { id: '141', wristbandSlot: '141', name: '430 GRN RICE*', formation: 'Green', tags: ['Rice'] },
            { id: '143', wristbandSlot: '143', name: '488 RED "A ACROSS" 3A+ KNIFE', formation: 'Red', tags: ['Knife'] },
            { id: '145', wristbandSlot: '145', name: '987 BLUE 6G+ WILLY', formation: 'Blue', tags: ['Willy'] },
            { id: '147', wristbandSlot: '147', name: '466 ORNG BOOMER 1 + A SHALLOW', formation: 'Orange', tags: ['Boomer', 'Shallow'] },

            // 100s - WB1 Right Column
            { id: '102', wristbandSlot: '102', name: 'DIAMOND LT GRN GAMBLE', formation: 'Diamond Lt', tags: ['Gamble'] },
            { id: '104', wristbandSlot: '104', name: 'BUNCH LT 3 GAMBLE (BULLS)*', formation: 'Bunch Lt', tags: ['Gamble', 'Bulls'] },
            { id: '106', wristbandSlot: '106', name: 'BUNCH RT RT RED 6 + GAMBLE*', formation: 'Bunch Rt', tags: ['Gamble', 'Red 6'] },
            { id: '108', wristbandSlot: '108', name: 'GRN BOOMER 1 SPECIAL', formation: 'Green', tags: ['Boomer'] },
            { id: '110', wristbandSlot: '110', name: 'RED 39 MUSTANG', formation: 'Red', tags: ['Mustang'] },
            { id: '112', wristbandSlot: '112', name: '987 GRN 5G + KNIFE', formation: 'Green', tags: ['Knife'] },
            { id: '114', wristbandSlot: '114', name: '988 GRN FIST LEAK', formation: 'Green', tags: ['Leak'] },
            { id: '116', wristbandSlot: '116', name: '983 GRN 1 SMOKE*', formation: 'Green', tags: ['Smoke'] },
            { id: '118', wristbandSlot: '118', name: '974 RED 5Y + GOT7!', formation: 'Red', tags: ['Got7'] },
            { id: '120', wristbandSlot: '120', name: '974 RED 5Y+ GOT7!', formation: 'Red', tags: ['Got7'] },
            { id: '122', wristbandSlot: '122', name: '974 RED 5Y + CAPONE', formation: 'Red', tags: ['Capone'] },
            { id: '124', wristbandSlot: '124', name: '934 RED 1 (A ARC)', formation: 'Red', tags: ['Arc'] },
            { id: '126', wristbandSlot: '126', name: '970 RED 6+ Y RPO', formation: 'Red', tags: ['RPO'] },
            { id: '128', wristbandSlot: '128', name: '973 BLUE 4Y + WILLY', formation: 'Blue', tags: ['Willy'] },
            { id: '130', wristbandSlot: '130', name: '473 BLUE 4A + WILLY', formation: 'Blue', tags: ['Willy'] },
            { id: '132', wristbandSlot: '132', name: '974 RED "B THRU" + 4T', formation: 'Red', tags: [] },
            { id: '134', wristbandSlot: '134', name: '374 RED 3A', formation: 'Red', tags: [] },
            { id: '136', wristbandSlot: '136', name: '877 RIP GOLD STICK + TAG', formation: 'Gold', tags: ['Stick'] },
            { id: '138', wristbandSlot: '138', name: '866 RIP "A JET"', formation: 'Rip', tags: ['Jet'] },
            { id: '140', wristbandSlot: '140', name: '888 LIZ GRN BOOMER 1 + B SHAL*', formation: 'Green', tags: ['Boomer'] },
            { id: '142', wristbandSlot: '142', name: '830 RIP Inverted Veer', formation: 'Rip', tags: ['Veer'] },
            { id: '144', wristbandSlot: '144', name: '470 Rip Red "A ACROSS" 4A + Knife', formation: 'Red', tags: ['Knife'] },
            { id: '146', wristbandSlot: '146', name: '987 RED 5G+ WILLY', formation: 'Red', tags: ['Willy'] },
            { id: '148', wristbandSlot: '148', name: '466 ORNG STASH (X ST)', formation: 'Orange', tags: ['Stash'] },

            // 200s - WB2 Left Column
            { id: '201', wristbandSlot: '201', name: '987 BLUE 3', formation: 'Blue', tags: [] },
            { id: '203', wristbandSlot: '203', name: '473 GRN B THRU + MICKEY (SIG)', formation: 'Green', tags: ['Mickey'] },
            { id: '205', wristbandSlot: '205', name: '987 BRN CROSS*', formation: 'Brown', tags: ['Cross'] },
            { id: '207', wristbandSlot: '207', name: '288 BRN SHARK (SIG)', formation: 'Brown', tags: ['Shark'] },
            { id: '209', wristbandSlot: '209', name: '469 RED 2', formation: 'Red', tags: [] },
            { id: '211', wristbandSlot: '211', name: '877 RED 3T', formation: 'Red', tags: [] },
            { id: '213', wristbandSlot: '213', name: '479 OVER U RED 2*', formation: 'Red', tags: [] },
            { id: '215', wristbandSlot: '215', name: '430 OVER O DITCH', formation: 'Over', tags: ['Ditch'] },
            { id: '217', wristbandSlot: '217', name: '888 GRN BOOMER 1', formation: 'Green', tags: ['Boomer'] },
            { id: '219', wristbandSlot: '219', name: 'TANK 48 OVER RED 2*', formation: 'Red', tags: [] },
            { id: '221', wristbandSlot: '221', name: '830 METAL RED Z JUKE', formation: 'Red', tags: ['Juke'] },
            { id: '223', wristbandSlot: '223', name: '677 RED 1 OPTION', formation: 'Red', tags: ['Option'] },
            { id: '225', wristbandSlot: '225', name: '878 GRN WHEEL BUMP*', formation: 'Green', tags: ['Wheel'] },
            { id: '227', wristbandSlot: '227', name: '889 BRN TAG+ WHEEL*', formation: 'Brown', tags: ['Wheel'] },
            { id: '229', wristbandSlot: '229', name: '469 RED 2', formation: 'Red', tags: [] },
            { id: '231', wristbandSlot: '231', name: '876 J RED 1', formation: 'Red', tags: [] },
            { id: '233', wristbandSlot: '233', name: '984 RED 1 + SMOKE (SIG)', formation: 'Red', tags: ['Smoke'] },
            { id: '235', wristbandSlot: '235', name: '697 BROWN SMASH + DEPOT', formation: 'Brown', tags: ['Smash'] },
            { id: '237', wristbandSlot: '237', name: '369 RED WHEEL BUMP + Q SPK', formation: 'Red', tags: ['Wheel'] },
            { id: '239', wristbandSlot: '239', name: '983 RED SWING NOLES', formation: 'Red', tags: ['Swing'] },
            { id: '241', wristbandSlot: '241', name: '489 RED 2 (J ROG)', formation: 'Red', tags: [] },
            { id: '243', wristbandSlot: '243', name: '676 BLUE 3Y*', formation: 'Blue', tags: [] },
            { id: '245', wristbandSlot: '245', name: '888 RED BRN', formation: 'Red', tags: [] },
            { id: '247', wristbandSlot: '247', name: '934 MAROON MOSS', formation: 'Maroon', tags: ['Moss'] },

            // 200s - WB2 Right Column
            { id: '202', wristbandSlot: '202', name: '987 BLUE 2', formation: 'Blue', tags: [] },
            { id: '204', wristbandSlot: '204', name: '473 GRN B THRU + MICKEY (SIG)', formation: 'Green', tags: ['Mickey'] },
            { id: '206', wristbandSlot: '206', name: '987 GRN CROSS*', formation: 'Green', tags: ['Cross'] },
            { id: '208', wristbandSlot: '208', name: '288 GRN SHARK (SIG)', formation: 'Green', tags: ['Shark'] },
            { id: '210', wristbandSlot: '210', name: '469 RED 1', formation: 'Red', tags: [] },
            { id: '212', wristbandSlot: '212', name: '877 RED 3T', formation: 'Red', tags: [] },
            { id: '214', wristbandSlot: '214', name: '479 OVER U RED 2*', formation: 'Red', tags: [] },
            { id: '216', wristbandSlot: '216', name: '430 OVER O DITCH', formation: 'Over', tags: ['Ditch'] },
            { id: '218', wristbandSlot: '218', name: '877 GOLD BOOMER 1', formation: 'Gold', tags: ['Boomer'] },
            { id: '220', wristbandSlot: '220', name: 'TANK 471 OVER BLUE 2', formation: 'Blue', tags: [] },
            { id: '222', wristbandSlot: '222', name: '830 METAL RED Z JUKE', formation: 'Red', tags: ['Juke'] },
            { id: '224', wristbandSlot: '224', name: '688 BLUE 1 OPTION', formation: 'Blue', tags: ['Option'] },
            { id: '226', wristbandSlot: '226', name: '878 GRN WHEEL BUMP*', formation: 'Green', tags: ['Wheel'] },
            { id: '228', wristbandSlot: '228', name: '889 BRN SMASH + BLADE', formation: 'Brown', tags: ['Smash'] },
            { id: '230', wristbandSlot: '230', name: '370 BLUE 1', formation: 'Blue', tags: [] },
            { id: '232', wristbandSlot: '232', name: '876 BLUE 1', formation: 'Blue', tags: [] },
            { id: '234', wristbandSlot: '234', name: '984 RED 1 + SMOKE (SIG)', formation: 'Red', tags: ['Smoke'] },
            { id: '236', wristbandSlot: '236', name: 'NUB RT + TUB LEFT BLUE Z THRU 4A', formation: 'Nub Rt', tags: [] },
            { id: '238', wristbandSlot: '238', name: '480 BLACK WHEEL SHARK', formation: 'Black', tags: ['Wheel', 'Shark'] },
            { id: '240', wristbandSlot: '240', name: 'SCRAMBLE 984 RED SHOW 3Y MLB*', formation: 'Red', tags: ['Scramble'] },
            { id: '242', wristbandSlot: '242', name: '370 RED 1 (J ROG)', formation: 'Red', tags: [] },
            { id: '244', wristbandSlot: '244', name: '983 RED 1*', formation: 'Red', tags: [] },
            { id: '246', wristbandSlot: '246', name: 'TANK 32A U OVER BLUE QB WEDGE RT', formation: 'Blue', tags: ['Wedge'] },
            { id: '248', wristbandSlot: '248', name: '934 MAROON (SIG)', formation: 'Maroon', tags: [] },
        ];

        // --- Director of Ops Data ---
        const WEEKLY_OPS_TASKS = [
            // Saturday
            { id: 'sat_1', day: 'Saturday', task: 'Break down our game film', roles: ['HC', 'OC', 'DC'], completed: false },
            { id: 'sat_2', day: 'Saturday', task: 'Send opponent film to Hudl Assist', roles: ['HC', 'OC', 'DC'], completed: false },

            // Sunday
            { id: 'sun_1', day: 'Sunday', task: 'Break down opponent scheme, tendencies, and personnel', roles: ['OC', 'DC', 'Position Coach'], completed: false },
            { id: 'sun_2', day: 'Sunday', task: 'Formulate game plan and prepare scheme tweaks', roles: ['HC', 'OC', 'DC'], completed: false },
            { id: 'sun_3', day: 'Sunday', task: 'Staff Meeting: Preview opponent & discuss improvements', roles: ['ALL'], completed: false },
            { id: 'sun_4', day: 'Sunday', task: 'Finalize practice plans and segment allotments', roles: ['HC', 'OC', 'DC'], completed: false },

            // Monday
            { id: 'mon_1', day: 'Monday', task: 'Check JV Game schedule (adjust practice load)', roles: ['HC', 'OC', 'DC'], completed: false },
            { id: 'mon_2', day: 'Monday', task: 'Film segment prior to walkthrough', roles: ['HC', 'OC', 'DC', 'Position Coach'], completed: false },
            { id: 'mon_3', day: 'Monday', task: 'Walkthrough', roles: ['ALL'], completed: false },
            { id: 'mon_4', day: 'Monday', task: 'Upload previous game film to Hudl (if not done)', roles: ['HC', 'Ops'], completed: false },

            // Tuesday
            { id: 'tue_1', day: 'Tuesday', task: 'Complete opponent scouting report', roles: ['OC', 'DC'], completed: false },
            { id: 'tue_2', day: 'Tuesday', task: 'Finalize practice scripts for Wed/Thu', roles: ['OC', 'DC'], completed: false },

            // Wednesday
            { id: 'wed_1', day: 'Wednesday', task: 'Confirm travel arrangements', roles: ['Ops', 'HC'], completed: false },
            { id: 'wed_2', day: 'Wednesday', task: 'Check medical/injury reports', roles: ['HC', 'Ops'], completed: false },

            // Thursday
            { id: 'thu_1', day: 'Thursday', task: 'Review game day roster', roles: ['HC', 'OC', 'DC'], completed: false },
            { id: 'thu_2', day: 'Thursday', task: 'Print wristbands and call sheets', roles: ['OC', 'DC', 'Ops'], completed: false },

            // Friday
            { id: 'fri_1', day: 'Friday', task: 'Pre-game meal check', roles: ['Ops'], completed: false },
            { id: 'fri_2', day: 'Friday', task: 'Equipment check', roles: ['Ops'], completed: false }
        ];

        // --- Components ---

        const Icon = ({ name, size = 20, color, style = {} }) => {
            const icons = {
                LayoutDashboard: 'üìä',
                PlusCircle: '‚ûï',
                List: 'üìã',
                Grid: 'üî¢',
                Clock: '‚è∞',
                Users: 'üë•',
                User: 'üë§',
                Monitor: 'üíª',
                Settings: '‚öôÔ∏è',
                Home: 'üè†',
                ChevronDown: '‚ñº',
                ChevronRight: '‚ñ∂',
                Calendar: 'üìÖ',
                Book: 'üìñ',
                Clipboard: '‚úçÔ∏è',
                Activity: '‚ö°',
                Trophy: 'üèÜ',
                Swords: '‚öîÔ∏è',
                Dumbbell: 'üí™', // Mapping Dumbbell to Arm Flexing as requested
                Gamepad2: 'üèà', // User asked for FOOTBALL icon for Madden, so mapping Gamepad2 to Football. Wait, fallback is Football. Explicit matches request.
                Printer: 'üñ®Ô∏è',
                Check: '‚úÖ',
                Bus: 'üöå',
                Checkbox: '‚òëÔ∏è',
                Minus: '‚õî', // Using 'No Entry' for delete/remove to be distinct
                Lock: 'üîí'
            };
            // Default to üèà if not found, which conveniently handles the "Football" request if I used a random name, 
            // but for Madden I used Gamepad2. 
            // User request: "Put a football icon next to Madden Ratings".
            // So Gamepad2 should map to üèà.

            const iconChar = icons[name];

            // If the icon name is specifically "Gamepad2", return specific Football emoji if mapped, else üèà fallback works too.
            // But let's be explicit in the map.

            return <span style={{ fontSize: '1.2rem', marginRight: '0.5rem', display: 'inline-block', width: '1.2em', textAlign: 'center', ...style, color: color }}>{iconChar || 'üèà'}</span>;
        };

        const OPS_CALENDAR = [
            "November", "December", "January", "February", "March", "April", "May",
            "Week 1 of Summer", "Week 2 of Summer", "Week 3 of Summer", "Week 4 of Summer",
            "Week 5 of Summer", "Week 6 of Summer", "Week 7 of Summer", "Week 8 of Summer",
            "Family Week", "Camp Week", "First Week of Practice",
            "Week 0", "Week 1", "Week 2", "Week 3", "Week 4", "Week 5",
            "Week 6", "Week 7", "Week 8", "Week 9", "Week 10", "Week 11",
            "Week 12", "Week 13", "First Week with No Game"
        ];

        const DirectorOpsView = ({ dutyAssignments, staff, currentWeek, currentUser }) => {
            // State for the selected period
            const [selectedPeriod, setSelectedPeriod] = useState(() => {
                // Initialize with active week if available, otherwise default
                return currentWeek?.name || "Week 1";
            });

            // Sync with global Active Week changes
            useEffect(() => {
                if (currentWeek?.name) {
                    setSelectedPeriod(currentWeek.name);
                }
            }, [currentWeek?.name]);

            // Is this period a "Standard Game Week" that should arguably have the template?
            // "Week 0" through "Week 13", "First Week of Practice" likely benefit from the standard template.
            const isStandardWeek = (period) => {
                return period.startsWith("Week") && !period.includes("Summer") || period === "First Week of Practice" || period === "Camp Week";
            };

            // Is this a Monthly period? (Nov-May)
            const isMonthly = (period) => {
                return ["November", "December", "January", "February", "March", "April", "May"].includes(period);
            };

            // Local state for tasks tailored for this session. 
            // We now load tasks *dependent* on the selectedPeriod.
            // We need a mechanism to switch tasks when period changes, without losing state.
            // Best way: Load ALL director ops data as a big object { "Week 1": [...], "November": [...] }
            // Or just load/save the specific key on change. Loading specific key is safer for memory if data grows.

            const [tasks, setTasks] = useState([]);

            // Load tasks when selectedPeriod changes
            useEffect(() => {
                const storageKey = `director_ops_tasks_${selectedPeriod}`;
                const saved = localStorage.getItem(storageKey);

                if (saved) {
                    setTasks(JSON.parse(saved));
                } else {
                    // Initialize New Period
                    if (isStandardWeek(selectedPeriod)) {
                        setTasks(WEEKLY_OPS_TASKS); // Preload Standard Template
                    } else {
                        setTasks([]); // Start Empty for custom periods (Monthly, Summer)
                    }
                }
            }, [selectedPeriod]);

            // Filter by Staff ID / Current User Roles
            // In Person-Centric view, we show tasks assigned to ANY of the user's roles.

            const [isAddingTask, setIsAddingTask] = useState(false);
            // Default day depends on view type. Monthly? No day usually, or just "General".
            const [newTask, setNewTask] = useState({ task: '', day: 'Monday', roles: [] });

            // Persist to localStorage whenever tasks change
            // We use a ref to track if the *initial load* has happened, to avoid overwriting with empty array on first render mount cycle if useEffects race.
            // Actually, useEffect dependency on [tasks] usually fires after hydration. 
            // We need to be careful not to save '[]' over existing data if the `setTasks` from the read-effect hasn't fired.
            // A safer pattern is: read in one effect, save in another, but ensure we don't save *until* we've read.
            // Simplified: The read effect is above.
            // The write effect:
            const isFirstRun = useRef(true);
            const loadedPeriod = useRef(null);

            useEffect(() => {
                if (loadedPeriod.current === selectedPeriod) {
                    const storageKey = `director_ops_tasks_${selectedPeriod}`;
                    localStorage.setItem(storageKey, JSON.stringify(tasks));
                }
            }, [tasks, selectedPeriod]);

            // Sync ref when period changes to indicate we are loading
            useEffect(() => {
                loadedPeriod.current = null; // Reset
                const storageKey = `director_ops_tasks_${selectedPeriod}`;
                const saved = localStorage.getItem(storageKey);
                if (saved) {
                    setTasks(JSON.parse(saved));
                } else {
                    if (isStandardWeek(selectedPeriod)) {
                        setTasks(WEEKLY_OPS_TASKS);
                    } else {
                        setTasks([]);
                    }
                }
                loadedPeriod.current = selectedPeriod; // Mark as loaded
            }, [selectedPeriod]);


            const toggleTask = (id) => {
                setTasks(prev => prev.map(t => t.id === id ? { ...t, completed: !t.completed } : t));
            };

            const resetTasks = () => {
                if (confirm(`Reset all tasks for ${selectedPeriod}?`)) {
                    if (isStandardWeek(selectedPeriod)) {
                        setTasks(WEEKLY_OPS_TASKS);
                    } else {
                        setTasks([]);
                    }
                }
            };

            // Sync function to merge recurring role tasks into current week
            const syncRoleTasks = () => {
                const savedRoleTasks = localStorage.getItem('staff_role_tasks');
                if (!savedRoleTasks) return;

                const roleTasksMap = JSON.parse(savedRoleTasks);
                if (!roleTasksMap) return;

                // Flatten all tasks from roles map
                const newRoleTasks = [];
                Object.values(roleTasksMap).forEach(roleList => {
                    if (Array.isArray(roleList)) {
                        newRoleTasks.push(...roleList);
                    }
                });

                if (newRoleTasks.length === 0) {
                    alert('No recurring role tasks found to sync.');
                    return;
                }

                // Merge logic: Check if task string already exists for that day?
                // Or just append. Appending with unique ID is safest but could double up.
                // Let's filter duplicates by task name + day
                const currentTaskSignatures = new Set(tasks.map(t => `${t.day}|${t.task}`));

                const tasksToAdd = newRoleTasks.filter(rt => !currentTaskSignatures.has(`${rt.day}|${rt.task}`)).map(rt => ({
                    ...rt,
                    id: `synced_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                    completed: false
                }));

                if (tasksToAdd.length > 0) {
                    setTasks(prev => [...prev, ...tasksToAdd]);
                    alert(`Synced ${tasksToAdd.length} tasks from Role descriptions.`);
                } else {
                    alert('All role tasks are already present.');
                }
            };

            const handleAddTask = () => {
                if (!newTask.task.trim()) return;
                const taskToAdd = {
                    id: `custom_${Date.now()}`,
                    ...newTask,
                    completed: false,
                    roles: newTask.roles.length > 0 ? newTask.roles : ['ALL']
                };
                setTasks(prev => [...prev, taskToAdd]);
                setIsAddingTask(false);
                setNewTask({ task: '', day: isMonthly(selectedPeriod) ? 'General' : 'Monday', roles: [] });
            };

            const handleDeleteTask = (id) => {
                if (confirm('Delete this task?')) {
                    setTasks(tasks.filter(t => t.id !== id));
                }
            };

            const toggleNewTaskRole = (role) => {
                setNewTask(prev => {
                    const currentRoles = prev.roles;
                    if (currentRoles.includes(role)) {
                        return { ...prev, roles: currentRoles.filter(r => r !== role) };
                    } else {
                        return { ...prev, roles: [...currentRoles, role] };
                    }
                });
            };

            const handleImportDuties = () => {
                if (!dutyAssignments || Object.keys(dutyAssignments).length === 0) {
                    alert('No duty assignments found to import.');
                    return;
                }

                if (!confirm('Import assigned duties from Task Assigner? This will add them to your checklist.')) return;

                const newTasks = [];
                Object.entries(dutyAssignments).forEach(([key, coachIds]) => {
                    if (!coachIds || coachIds.length === 0) return;

                    const parts = key.split(' > ');
                    const dutyName = parts[parts.length - 1];
                    const category = parts[0];

                    let day = 'Monday';
                    if (isMonthly(selectedPeriod)) day = 'General';
                    else {
                        if (category === 'Practice') day = 'Monday';
                        if (category === 'Games') day = 'Friday';
                        if (category === 'Scouting') day = 'Sunday';
                        if (category === 'Medical') day = 'Wednesday';
                        if (category === 'Special Teams') day = 'Thursday';
                    }

                    const assignedRoles = [];
                    coachIds.forEach(id => {
                        const coach = staff.find(s => s.id === id);
                        if (coach) assignedRoles.push(coach.name);
                    });

                    // Avoid simple duplicates
                    const isDuplicate = tasks.some(t => t.task === `Duty: ${dutyName}` && t.day === day);
                    if (!isDuplicate) {
                        newTasks.push({
                            id: `duty_${Date.now()}_${Math.floor(Math.random() * 1000)}`,
                            day: day,
                            task: `Duty: ${dutyName}`,
                            roles: assignedRoles.length > 0 ? assignedRoles : ['Unassigned'],
                            completed: false
                        });
                    }
                });

                if (newTasks.length > 0) {
                    setTasks(prev => [...prev, ...newTasks]);
                    alert(`Imported ${newTasks.length} duties as tasks.`);
                } else {
                    alert('No new duties to import.');
                }
            };

            // Filter tasks based on Current User's Roles
            // Show task if 'ALL' is in task.roles OR any of currentUser.roles is in task.roles
            const displayTasks = tasks.filter(t => {
                if (!t.roles || t.roles.length === 0) return true; // Show unassigned
                if (t.roles.includes('ALL')) return true;

                // Check intersection
                const userRoles = currentUser?.roles || [];
                return t.roles.some(r => userRoles.includes(r));
            });



            // Grouping Logic
            let groupedTasks = {};

            if (isMonthly(selectedPeriod)) {
                // Monthly View: Just one list, or maybe grouped by "Week" if we added that field? 
                // For now, user asked for "Monthly Checklists", implying a simple list is fine.
                // We'll treat "General" as the main bucket, but handle if any stray days exist.
                groupedTasks["Monthly Tasks"] = displayTasks;
            } else {
                // Weekly View
                const orderedDays = ['Saturday', 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                // We also need to catch tasks that might have been assigned to other days (or "General") if manual entry allowed it
                // But for now, let's just use the ordered days + an "Other" catch-all if needed
                groupedTasks = orderedDays.reduce((acc, day) => {
                    const dayTasks = displayTasks.filter(t => t.day === day);
                    if (dayTasks.length > 0) acc[day] = dayTasks;
                    return acc;
                }, {});

                // Catch-all for "General" or mis-assigned days in weekly view
                const otherTasks = displayTasks.filter(t => !orderedDays.includes(t.day));
                if (otherTasks.length > 0) groupedTasks["General"] = otherTasks;
            }


            const progress = tasks.length > 0 ? Math.round((tasks.filter(t => t.completed).length / tasks.length) * 100) : 0;

            return (
                <div className="animate-fade-in" style={{ padding: '1rem', maxWidth: '800px', margin: '0 auto' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                        <div>
                            <h1>Director of Football Operations</h1>
                            <div style={{ color: 'var(--text-secondary)' }}>Weekly Task Checklist</div>
                        </div>

                        <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                            <select
                                className="form-select"
                                value={selectedPeriod}
                                onChange={e => setSelectedPeriod(e.target.value)}
                                style={{ width: 'auto', minWidth: '200px', fontWeight: 'bold' }}
                            >
                                {OPS_CALENDAR.map(p => <option key={p} value={p}>{p}</option>)}
                            </select>
                        </div>
                    </div>

                    <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '0.5rem', marginBottom: '2rem', alignItems: 'center' }}>
                        <span style={{ fontSize: '0.9rem', color: 'var(--text-secondary)', marginRight: '0.5rem' }}>View:</span>
                        <select
                            className="form-select"
                            value={selectedRole}
                            onChange={e => setSelectedRole(e.target.value)}
                            style={{ width: 'auto', minWidth: '120px', fontSize: '0.85rem' }}
                        >
                            {ROLES.map(r => <option key={r} value={r}>{r === 'ALL' ? 'All Roles' : r}</option>)}
                        </select>
                        <button className="btn btn-primary" onClick={() => setIsAddingTask(true)} title="Add Custom Task">
                            <Icon name="PlusCircle" />
                        </button>
                        <button className="btn btn-secondary" onClick={syncRoleTasks} title="Sync Recurring Role Tasks">
                            <Icon name="Activity" /> Sync
                        </button>
                        <button className="btn btn-secondary" onClick={handleImportDuties} title="Import from Task Assigner">
                            <Icon name="List" /> Import
                        </button>
                        <button className="btn btn-secondary" onClick={resetTasks} title="Reset Tasks">
                            üîÑ
                        </button>
                    </div>

                    {/* Add Task Modal */}
                    {isAddingTask && (
                        <div style={{
                            position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',
                            backgroundColor: 'rgba(0,0,0,0.5)', zIndex: 1000,
                            display: 'flex', alignItems: 'center', justifyContent: 'center'
                        }}>
                            <div style={{
                                backgroundColor: 'var(--bg-panel)', padding: '2rem', borderRadius: '12px',
                                border: '1px solid var(--border)', width: '90%', maxWidth: '500px'
                            }}>
                                <h3 style={{ marginBottom: '1.5rem' }}>Add New Task ({selectedPeriod})</h3>

                                <div style={{ marginBottom: '1rem' }}>
                                    <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.9rem' }}>Task Description</label>
                                    <input
                                        className="form-input"
                                        value={newTask.task}
                                        onChange={e => setNewTask({ ...newTask, task: e.target.value })}
                                        placeholder="Enter task details..."
                                    />
                                </div>

                                {/* Only show Day selector if not in Monthly mode (or stick to generic 'General') */}
                                {!isMonthly(selectedPeriod) && (
                                    <div style={{ marginBottom: '1rem' }}>
                                        <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.9rem' }}>Day</label>
                                        <select
                                            className="form-select"
                                            value={newTask.day}
                                            onChange={e => setNewTask({ ...newTask, day: e.target.value })}
                                        >
                                            {orderedDays.map(d => <option key={d} value={d}>{d}</option>)}
                                            <option value="General">General</option>
                                        </select>
                                    </div>
                                )}

                                <div style={{ marginBottom: '1.5rem' }}>
                                    <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.9rem' }}>Assign Roles (Optional)</label>
                                    <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                                        {ROLES.filter(r => r !== 'ALL').map(role => (
                                            <div
                                                key={role}
                                                onClick={() => toggleNewTaskRole(role)}
                                                style={{
                                                    padding: '0.25rem 0.5rem',
                                                    borderRadius: '4px',
                                                    border: `1px solid ${newTask.roles.includes(role) ? 'var(--accent)' : 'var(--border)'}`,
                                                    backgroundColor: newTask.roles.includes(role) ? 'rgba(56, 189, 248, 0.1)' : 'transparent',
                                                    cursor: 'pointer',
                                                    fontSize: '0.8rem',
                                                    color: newTask.roles.includes(role) ? 'var(--accent)' : 'var(--text-secondary)'
                                                }}
                                            >
                                                {role}
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '1rem' }}>
                                    <button className="btn btn-secondary" onClick={() => setIsAddingTask(false)}>Cancel</button>
                                    <button className="btn btn-primary" onClick={handleAddTask}>Save Task</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Progress Bar */}
                    <div style={{ marginBottom: '2rem', backgroundColor: 'var(--bg-input)', borderRadius: '999px', height: '10px', overflow: 'hidden' }}>
                        <div style={{ width: `${progress}%`, backgroundColor: 'var(--accent)', height: '100%', transition: 'width 0.5s ease' }} />
                    </div>
                    <div style={{ textAlign: 'right', marginBottom: '2rem', fontSize: '0.9rem', color: 'var(--accent)' }}>
                        {progress}% Completed
                    </div>

                    {Object.entries(groupedTasks).map(([groupName, groupTasks]) => (
                        <div key={groupName} style={{ marginBottom: '2rem', backgroundColor: 'var(--bg-panel)', borderRadius: '12px', padding: '1.5rem', border: '1px solid var(--border)' }}>
                            <h3 style={{ marginBottom: '1rem', borderBottom: '1px solid var(--border)', paddingBottom: '0.5rem', color: 'var(--text-primary)' }}>{groupName}</h3>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                {groupTasks.map(task => (
                                    <div
                                        key={task.id}
                                        onClick={() => toggleTask(task.id)}
                                        style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '1rem',
                                            padding: '0.75rem',
                                            backgroundColor: 'var(--bg-app)',
                                            borderRadius: '8px',
                                            cursor: 'pointer',
                                            border: '1px solid transparent',
                                            transition: 'all 0.2s',
                                            opacity: task.completed ? 0.6 : 1
                                        }}
                                        onMouseEnter={e => e.currentTarget.style.borderColor = 'var(--accent)'}
                                        onMouseLeave={e => e.currentTarget.style.borderColor = 'transparent'}
                                    >
                                        <div style={{
                                            width: '24px',
                                            height: '24px',
                                            borderRadius: '6px',
                                            border: `2px solid ${task.completed ? 'var(--accent)' : 'var(--text-secondary)'}`,
                                            backgroundColor: task.completed ? 'var(--accent)' : 'transparent',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            color: '#0f172a'
                                        }}>
                                            {task.completed && <Icon name="Check" size={16} />}
                                        </div>
                                        <div style={{ flex: 1 }}>
                                            <div style={{
                                                textDecoration: task.completed ? 'line-through' : 'none',
                                                color: task.completed ? 'var(--text-secondary)' : 'var(--text-primary)',
                                                fontWeight: task.completed ? 'normal' : '500'
                                            }}>
                                                {task.task}
                                            </div>
                                            {/* Role Tags */}
                                            {selectedRole === 'ALL' && task.roles && (
                                                <div style={{ display: 'flex', gap: '0.25rem', flexWrap: 'wrap', marginTop: '0.25rem' }}>
                                                    {task.roles.map(role => (
                                                        <span key={role} style={{
                                                            fontSize: '0.7rem',
                                                            padding: '0.1rem 0.4rem',
                                                            borderRadius: '4px',
                                                            backgroundColor: 'rgba(255,255,255,0.1)',
                                                            color: 'var(--text-secondary)'
                                                        }}>
                                                            {role}
                                                        </span>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const TagSelector = ({ selectedTags, onToggle }) => {
            return (
                <div className="space-y-4">
                    {Object.entries(TAG_CATEGORIES).map(([category, tags]) => (
                        <div key={category} className="tags-section">
                            <div className="tags-category-title">{category}</div>
                            <div className="tags-grid">
                                {tags.map(tag => (
                                    <div
                                        key={tag}
                                        className={`tag-chip ${selectedTags.includes(tag) ? 'selected' : ''}`}
                                        onClick={() => onToggle(tag)}
                                    >
                                        {tag}
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        // Helper to generate Zigzag Path
        const getZigZagPath = (points) => {
            if (points.length < 2) return '';
            let d = `M ${points[0].x},${points[0].y}`;
            for (let i = 0; i < points.length - 1; i++) {
                const A = points[i];
                const B = points[i + 1];
                const isLastSegment = i === points.length - 2;

                let targetB = B;
                let finalSegment = '';

                // If it's the last segment, leave a straight tail for the arrowhead
                if (isLastSegment) {
                    const totalDist = Math.hypot(B.x - A.x, B.y - A.y);
                    const arrowSpace = 5; // Reduced from 20 to 5 to hide transition inside arrow
                    if (totalDist > arrowSpace) {
                        const ratio = (totalDist - arrowSpace) / totalDist;
                        targetB = {
                            x: A.x + (B.x - A.x) * ratio,
                            y: A.y + (B.y - A.y) * ratio
                        };
                        finalSegment = ` L ${B.x},${B.y}`;
                    }
                }

                const dist = Math.hypot(targetB.x - A.x, targetB.y - A.y);
                const steps = Math.floor(dist / 10); // 10px zigzags

                if (steps <= 0) {
                    d += ` L ${targetB.x},${targetB.y}`;
                } else {
                    const dx = (targetB.x - A.x) / steps;
                    const dy = (targetB.y - A.y) / steps;
                    const nx = -dy * 0.5; // Width of zig
                    const ny = dx * 0.5;
                    for (let j = 1; j <= steps; j++) {
                        const mx = A.x + dx * j;
                        const my = A.y + dy * j;
                        if (j === steps) {
                            d += ` L ${mx},${my}`;
                        } else {
                            const side = j % 2 === 0 ? 1 : -1;
                            d += ` L ${mx + nx * side},${my + ny * side}`;
                        }
                    }
                }

                if (finalSegment) {
                    d += finalSegment;
                }
            }
            return d;
        };

        // --- PLAY DIAGRAM EDITOR ---
        const PlayDiagramEditor = ({ initialData, onSave, onCancel, mode = 'standard' }) => {

            // Helper for default formation (Red QB, Blue Skill, Black OL)
            const getDefaultFormation = () => {
                const center = 400;
                const los = 340; // Shifted UP (was 400) to give ~8 yards depth (160px space below)

                const cOL = '#000000';
                const cQB = '#ef4444';
                const cSkill = '#3b82f6';

                // Y-Offsets: 100px = 5 yards.
                // OL radius=15. Place at +18 to clear line.
                // QB Shotgun at 5 yds = +100px.

                if (mode === 'rooski-oline') {
                    // O-Line Rooski Default (T-G-C-G-T)
                    // Spacing: 60px between linemen
                    return [
                        { id: Date.now() + 1, type: 'player', points: [{ x: center, y: los + 18 }], color: cOL, label: 'C', shape: 'square', variant: 'filled' },
                        { id: Date.now() + 2, type: 'player', points: [{ x: center - 60, y: los + 18 }], color: cOL, label: 'G', shape: 'square', variant: 'filled' },
                        { id: Date.now() + 3, type: 'player', points: [{ x: center + 60, y: los + 18 }], color: cOL, label: 'G', shape: 'square', variant: 'filled' },
                        { id: Date.now() + 4, type: 'player', points: [{ x: center - 120, y: los + 18 }], color: cOL, label: 'T', shape: 'square', variant: 'filled' },
                        { id: Date.now() + 5, type: 'player', points: [{ x: center + 120, y: los + 18 }], color: cOL, label: 'T', shape: 'square', variant: 'filled' },
                    ];
                }

                if (mode === 'rooski-skill') {
                    // Skill Rooski Default (Just QB, maybe empty?)
                    // Let's start with just QB to give reference
                    return [
                        { id: Date.now() + 6, type: 'player', points: [{ x: center, y: los + 120 }], color: cQB, label: 'Q', shape: 'circle' },
                    ];
                }

                return [
                    // OL - Now Circles, Filled, Shifted back (+18)
                    { id: Date.now() + 1, type: 'player', points: [{ x: center, y: los + 18 }], color: cOL, label: 'C', shape: 'circle', variant: 'filled' },
                    { id: Date.now() + 2, type: 'player', points: [{ x: center - 40, y: los + 18 }], color: cOL, label: 'G', shape: 'circle', variant: 'filled' },
                    { id: Date.now() + 3, type: 'player', points: [{ x: center + 40, y: los + 18 }], color: cOL, label: 'G', shape: 'circle', variant: 'filled' },
                    { id: Date.now() + 4, type: 'player', points: [{ x: center - 80, y: los + 18 }], color: cOL, label: 'T', shape: 'circle', variant: 'filled' },
                    { id: Date.now() + 5, type: 'player', points: [{ x: center + 80, y: los + 18 }], color: cOL, label: 'T', shape: 'circle', variant: 'filled' },
                    // QB
                    { id: Date.now() + 6, type: 'player', points: [{ x: center, y: los + 120 }], color: cQB, label: 'Q', shape: 'circle' },
                    // RB
                    { id: Date.now() + 7, type: 'player', points: [{ x: center, y: los + 220 }], color: cSkill, label: 'R', shape: 'circle' },
                    // WR Left
                    { id: Date.now() + 8, type: 'player', points: [{ x: 100, y: los + 15 }], color: cSkill, label: 'X', shape: 'circle' },
                    // WR Right
                    { id: Date.now() + 9, type: 'player', points: [{ x: 700, y: los + 15 }], color: cSkill, label: 'Z', shape: 'circle' },
                    // Slot Left
                    { id: Date.now() + 10, type: 'player', points: [{ x: 200, y: los + 35 }], color: cSkill, label: 'H', shape: 'circle' },
                    // TE Right
                    { id: Date.now() + 11, type: 'player', points: [{ x: center + 120, y: los + 15 }], color: cSkill, label: 'Y', shape: 'circle' },
                ];
            };

            // Initialize with data OR default formation
            const [elements, setElements] = useState(() => {
                if (initialData && initialData.elements && initialData.elements.length > 0) {
                    return initialData.elements;
                }
                return getDefaultFormation();
            });

            const [selectedTool, setSelectedTool] = useState('line'); // free, line, player, delete
            const [color, setColor] = useState('#000000');
            const [lineStyle, setLineStyle] = useState('solid'); // solid, dashed, zigzag
            const [endType, setEndType] = useState('arrow'); // arrow, t, none
            const [selectedPlayerIcon, setSelectedPlayerIcon] = useState({ label: 'Q', shape: 'circle' });

            const [isDrawing, setIsDrawing] = useState(false);
            const [currentPath, setCurrentPath] = useState(null);

            // Drag State
            const [draggedId, setDraggedId] = useState(null);

            // Ref for SVG container to get coordinates
            const svgRef = useRef(null);

            // Tools configuration
            const TOOLS = [
                { id: 'free', icon: 'Edit3', label: 'Freehand' },
                { id: 'line', icon: 'Minus', label: 'Polyline / Straight' },
                // Arrow tool removed, now an option on line
                { id: 'player', icon: 'User', label: 'Player Icon' },
                { id: 'delete', icon: 'Trash', label: 'Delete Mode' }
            ];

            const COLORS = ['#000000', '#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'];

            const PLAYER_ICONS = [
                { label: 'Q', shape: 'circle' },
                { label: 'R', shape: 'circle' },
                { label: 'X', shape: 'circle' },
                { label: 'Y', shape: 'circle' },
                { label: 'Z', shape: 'circle' },
                { label: 'H', shape: 'circle' },
                { label: 'F', shape: 'circle' },
                { label: 'C', shape: 'square' },
                { label: 'G', shape: 'square' },
                { label: 'T', shape: 'square' }
            ];

            // Coordinate calibration: Map mouse event to SVG coordinates
            const getPoint = (e) => {
                if (!svgRef.current) return { x: 0, y: 0 };
                const CTM = svgRef.current.getScreenCTM();
                if (!CTM) return { x: 0, y: 0 };
                return {
                    x: (e.clientX - CTM.e) / CTM.a,
                    y: (e.clientY - CTM.f) / CTM.d
                };
            };

            const handleMouseDown = (e) => {
                if (draggedId) return; // Already dragging?
                if (selectedTool === 'delete') return;

                const point = getPoint(e);

                // If clicking empty space...
                if (selectedTool === 'player') {
                    const newElement = {
                        id: Date.now(),
                        type: 'player',
                        points: [point],
                        color,
                        label: selectedPlayerIcon.label,
                        shape: selectedPlayerIcon.shape
                    };
                    setElements(prev => [...prev, newElement]);
                    return;
                }

                // Polyline Interaction
                if (selectedTool === 'line') {
                    if (!isDrawing) {
                        setIsDrawing(true);
                        setCurrentPath({
                            id: Date.now(),
                            type: 'poly', // Generic polyline
                            points: [point, point], // Start with 2 points (second is mouse follower)
                            color,
                            style: lineStyle,
                            endType
                        });
                    } else {
                        // Add segment anchor
                        setCurrentPath(prev => ({
                            ...prev,
                            points: [...prev.points.slice(0, -1), point, point] // Replace follower with actual point, then add new follower
                        }));
                    }
                } else if (selectedTool === 'free') {
                    setIsDrawing(true);
                    setCurrentPath({
                        id: Date.now(),
                        type: 'free',
                        points: [point],
                        color,
                        style: lineStyle,
                        endType: 'none' // Freehand usually lines
                    });
                }
            };

            const handleElementMouseDown = (e, elId) => {
                e.stopPropagation();
                if (selectedTool === 'delete') return; // Let click handle delete

                // Start Drag
                setDraggedId(elId);
            };

            const handleMouseMove = (e) => {
                const point = getPoint(e);

                // Dragging Logic
                if (draggedId) {
                    setElements(prev => prev.map(el => {
                        if (el.id === draggedId) {
                            return { ...el, points: [point] };
                        }
                        return el;
                    }));
                    return;
                }

                // Drawing Logic
                if (!isDrawing || !currentPath) return;

                if (selectedTool === 'free') {
                    setCurrentPath(prev => ({
                        ...prev,
                        points: [...prev.points, point]
                    }));
                } else if (selectedTool === 'line') {
                    // Update the generic "follower" point (last point in array)
                    setCurrentPath(prev => {
                        const newPoints = [...prev.points];
                        newPoints[newPoints.length - 1] = point;
                        return { ...prev, points: newPoints };
                    });
                }
            };

            const handleDoubleClick = (e) => {
                if (!isDrawing || !currentPath) return;
                if (selectedTool === 'line') {
                    const finalPath = { ...currentPath };
                    // Remove the last point if it's just the cursor follower (already done in logic, but let's be safe)
                    // The 'follower' is usually the last point. 

                    // Filter out duplicate/too-close points
                    const uniquePoints = [];
                    if (finalPath.points.length > 0) {
                        uniquePoints.push(finalPath.points[0]);
                        for (let i = 1; i < finalPath.points.length; i++) {
                            const prev = uniquePoints[uniquePoints.length - 1];
                            const curr = finalPath.points[i];
                            const dist = Math.hypot(curr.x - prev.x, curr.y - prev.y);
                            if (dist > 2) { // Minimum 2px distance
                                uniquePoints.push(curr);
                            }
                        }
                    }

                    finalPath.points = uniquePoints;

                    setIsDrawing(false);
                    // Must have at least 2 points to be a line
                    if (finalPath.points.length > 1) {
                        setElements(prev => [...prev, finalPath]);
                    }
                    setCurrentPath(null);
                }
            };

            const handleMouseUp = () => {
                // Stop Dragging
                if (draggedId) {
                    setDraggedId(null);
                    return;
                }

                // Stop Freehand Drawing
                if (selectedTool === 'free') {
                    setIsDrawing(false);
                    if (currentPath && currentPath.points.length > 1) {
                        setElements(prev => [...prev, currentPath]);
                    }
                    setCurrentPath(null);
                }
                // Line tool does NOT finish on mouse up, waits for double click
            };

            // Rooski Skill Formation (Custom Colors/Labels)
            const getRooskiFormation = () => {
                const center = 400;
                const los = 340; // Same geometry as default

                const cOL = '#000000';
                const cQB = '#ef4444'; // Red

                // Custom Skill Colors
                const cX = '#a855f7'; // Purple
                const cZ = '#22c55e'; // Green
                const cY = '#eab308'; // Yellow
                const cA = '#ef4444'; // Red (Slot)
                const cB = '#3b82f6'; // Blue (RB)

                return [
                    // OL - Black Filled Circles
                    { id: Date.now() + 1, type: 'player', points: [{ x: center, y: los + 18 }], color: cOL, label: 'C', shape: 'circle', variant: 'filled' },
                    { id: Date.now() + 2, type: 'player', points: [{ x: center - 40, y: los + 18 }], color: cOL, label: 'G', shape: 'circle', variant: 'filled' },
                    { id: Date.now() + 3, type: 'player', points: [{ x: center + 40, y: los + 18 }], color: cOL, label: 'G', shape: 'circle', variant: 'filled' },
                    { id: Date.now() + 4, type: 'player', points: [{ x: center - 80, y: los + 18 }], color: cOL, label: 'T', shape: 'circle', variant: 'filled' },
                    { id: Date.now() + 5, type: 'player', points: [{ x: center + 80, y: los + 18 }], color: cOL, label: 'T', shape: 'circle', variant: 'filled' },
                    // QB - Red
                    { id: Date.now() + 6, type: 'player', points: [{ x: center, y: los + 100 }], color: cQB, label: 'Q', shape: 'circle' },
                    // B (was RB) - Blue
                    { id: Date.now() + 7, type: 'player', points: [{ x: center, y: los + 140 }], color: cB, label: 'B', shape: 'circle' },
                    // X - Purple
                    { id: Date.now() + 8, type: 'player', points: [{ x: 100, y: los + 15 }], color: cX, label: 'X', shape: 'circle' },
                    // Z - Green
                    { id: Date.now() + 9, type: 'player', points: [{ x: 700, y: los + 15 }], color: cZ, label: 'Z', shape: 'circle' },
                    // A (was H) - Red
                    { id: Date.now() + 10, type: 'player', points: [{ x: 200, y: los + 35 }], color: cA, label: 'A', shape: 'circle' },
                    // Y - Yellow
                    { id: Date.now() + 11, type: 'player', points: [{ x: center + 120, y: los + 15 }], color: cY, label: 'Y', shape: 'circle' },
                ];
            };

            const handleQuickOffense = () => {
                if (elements.length > 0 && !window.confirm('Clear current diagram?')) return;
                setElements(getDefaultFormation());
            };

            const handleRooskiOffense = () => {
                if (elements.length > 0 && !window.confirm('Clear current diagram?')) return;
                setElements(getRooskiFormation());
            };

            const handleClickElement = (elId) => {
                if (selectedTool === 'delete') {
                    setElements(prev => prev.filter(el => el.id !== elId));
                }
            };

            // Render SVG contents
            const renderElement = (el, isPreview = false) => {
                if (el.type === 'player') {
                    const { x, y } = el.points[0];
                    const size = 30; // Icon size
                    const isRect = el.shape === 'square';
                    const isFilled = el.variant === 'filled';
                    const fillColor = isFilled ? el.color : 'white';
                    const strokeColor = el.color; // Stroke matches color
                    const textColor = isFilled ? 'white' : el.color;

                    return (
                        <g
                            key={el.id}
                            onMouseDown={(e) => !isPreview && handleElementMouseDown(e, el.id)}
                            onClick={(e) => { e.stopPropagation(); !isPreview && handleClickElement(el.id); }}
                            style={{
                                cursor: selectedTool === 'delete' ? 'pointer' : (isPreview ? 'default' : 'move'),
                                opacity: isPreview ? 0.8 : 1
                            }}
                        >
                            {isRect ? (
                                <rect x={x - size / 2} y={y - size / 2} width={size} height={size} fill={fillColor} stroke={strokeColor} strokeWidth="2" />
                            ) : el.shape === 'star' ? (
                                <polygon
                                    points={`${x},${y - size / 1.5} ${x + size / 3},${y - size / 4} ${x + size / 1.2},${y - size / 4} ${x + size / 2},${y + size / 4} ${x + size / 1.5},${y + size / 1.2} ${x},${y + size / 2} ${x - size / 1.5},${y + size / 1.2} ${x - size / 2},${y + size / 4} ${x - size / 1.2},${y - size / 4} ${x - size / 3},${y - size / 4}`}
                                    fill={fillColor} stroke={strokeColor} strokeWidth="2"
                                />
                            ) : (
                                <circle cx={x} cy={y} r={size / 2} fill={fillColor} stroke={strokeColor} strokeWidth="2" />
                            )}
                            <text x={x} y={y} dy="0.35em" textAnchor="middle" fontSize="16" fontWeight="bold" fill={textColor} style={{ pointerEvents: 'none', userSelect: 'none' }}>{el.label}</text>
                        </g>
                    );
                }

                if (el.points.length < 2) return null;

                // Path Data Generation
                let d = '';
                if (el.style === 'zigzag') {
                    d = getZigZagPath(el.points);
                } else if (el.type === 'free' || el.type === 'poly') {
                    d = `M ${el.points.map(p => `${p.x},${p.y}`).join(' L ')}`;
                }

                // T-Block Marker (Custom logic since SVG markers are limited)
                let markerEnd = undefined;
                let tBlock = null;

                if (el.endType === 'arrow') {
                    markerEnd = `url(#arrowhead-${el.color})`;
                } else if (el.endType === 't') {
                    // Calculate perpendicular line at end
                    const end = el.points[el.points.length - 1];
                    const prev = el.points[el.points.length - 2] || el.points[0]; // Need vector
                    const dx = end.x - prev.x;
                    const dy = end.y - prev.y;
                    const len = Math.hypot(dx, dy) || 1;
                    const perpX = (-dy / len) * 15; // 15px width T
                    const perpY = (dx / len) * 15;

                    tBlock = (
                        <line
                            x1={end.x - perpX} y1={end.y - perpY}
                            x2={end.x + perpX} y2={end.y + perpY}
                            stroke={el.color}
                            strokeWidth="4"
                        />
                    );
                } else if (el.endType === 'dot') {
                    const end = el.points[el.points.length - 1];
                    tBlock = (
                        <circle cx={end.x} cy={end.y} r="6" fill={el.color} />
                    );
                }

                return (
                    <g key={el.id || 'current'} onClick={() => !isPreview && handleClickElement(el.id)} style={{ cursor: selectedTool === 'delete' ? 'pointer' : 'default', opacity: isPreview ? 0.6 : 1 }}>
                        <path
                            d={d}
                            stroke={el.color}
                            strokeWidth="4"
                            fill="none"
                            strokeDasharray={el.style === 'dashed' ? "10,5" : "none"}
                            markerEnd={markerEnd}
                        />
                        {tBlock}
                    </g>
                );
            };

            // Toggle Rooski Node (Y or F)
            const toggleRooskiNode = (label) => {
                setElements(prev => {
                    const exists = prev.find(e => e.label === label && e.type === 'player');
                    if (exists) {
                        return prev.filter(e => e.id !== exists.id);
                    } else {
                        // Add it
                        const center = 400;
                        const los = 340 + 18; // Match OL depth
                        let newPoint = { x: center, y: los };

                        if (label === 'Y') {
                            // Place Y near RT usually (right side)
                            newPoint = { x: center + 180, y: los };
                        } else if (label === 'F') {
                            // Place F in backfield
                            newPoint = { x: center + 60, y: los + 60 }; // Offset back and right
                        }

                        return [...prev, {
                            id: Date.now(),
                            type: 'player',
                            points: [newPoint],
                            color: '#3b82f6', // Skill color
                            label: label,
                            shape: 'square', // Match Rooski style
                            variant: 'filled'
                        }];
                    }
                });
            };

            return (
                <div style={{ position: 'fixed', top: 0, left: 0, width: '100%', height: '100%', background: 'rgba(0,0,0,0.8)', zIndex: 11000, display: 'flex', justifyContent: 'center', alignItems: 'center' }}>
                    <div className="animate-fade-in" style={{ width: '95%', height: '90%', background: 'white', borderRadius: '12px', display: 'flex', flexDirection: 'column', overflow: 'hidden', boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)' }}>
                        {/* Header / Toolbar */}
                        <div style={{ padding: '0.75rem 1rem', borderBottom: '1px solid #e5e7eb', display: 'flex', alignItems: 'center', background: '#f8fafc', gap: '0.5rem', flexWrap: 'wrap' }}>
                            <h3 style={{ margin: 0, marginRight: '0.5rem', fontSize: '1rem' }}>Diagrammer</h3>

                            {/* Tools */}
                            <div className="btn-group" style={{ display: 'flex', gap: '0.25rem' }}>
                                {TOOLS.map(tool => (
                                    <button
                                        key={tool.id}
                                        className={`btn ${selectedTool === tool.id ? 'btn-primary' : 'btn-secondary'}`}
                                        onClick={() => setSelectedTool(tool.id)}
                                        title={tool.label}
                                        style={{ padding: '0.4rem' }}
                                    >
                                        <Icon name={tool.icon} size={18} />
                                    </button>
                                ))}
                            </div>

                            <div style={{ width: '1px', height: '20px', background: '#cbd5e1', margin: '0 0.25rem' }}></div>

                            {/* Line Options (If Line Tool selected) */}
                            {selectedTool === 'line' && (
                                <div style={{ display: 'flex', gap: '0.25rem', alignItems: 'center', background: '#e2e8f0', padding: '0.25rem', borderRadius: '4px' }}>
                                    {/* Style */}
                                    <select value={lineStyle} onChange={(e) => setLineStyle(e.target.value)} className="form-input" style={{ padding: '2px', fontSize: '0.8rem', width: 'auto' }}>
                                        <option value="solid">Solid</option>
                                        <option value="dashed">-- Dashed</option>
                                        <option value="zigzag">Zigzag</option>
                                    </select>

                                    {/* End Type */}
                                    <div style={{ display: 'flex', gap: '2px' }}>
                                        <button className={`btn ${endType === 'arrow' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setEndType('arrow')} title="Arrow End" style={{ padding: '0.25rem 0.5rem' }}>Start ‚Üí End</button>
                                        <button className={`btn ${endType === 't' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setEndType('t')} title="Block T" style={{ padding: '0.25rem 0.5rem' }}>‚Äî| Block</button>
                                        <button className={`btn ${endType === 'dot' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setEndType('dot')} title="Dot End" style={{ padding: '0.25rem 0.5rem' }}>‚Ä¢ Dot</button>
                                        <button className={`btn ${endType === 'none' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setEndType('none')} title="No End" style={{ padding: '0.25rem 0.5rem' }}>Line</button>
                                    </div>
                                </div>
                            )}

                            {/* ROOSKI MODE TOGGLES */}
                            {(mode === 'rooski-oline' || mode === 'rooski-skill') && (
                                <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center', marginLeft: '0.5rem', background: '#e0f2fe', padding: '0.25rem 0.5rem', borderRadius: '4px', border: '1px solid #7dd3fc' }}>
                                    <span style={{ fontSize: '0.85rem', fontWeight: 'bold', color: '#0369a1' }}>Personnel:</span>
                                    <button
                                        className={`btn ${elements.some(e => e.label === 'Y') ? 'btn-primary' : 'btn-secondary'}`}
                                        onClick={() => toggleRooskiNode('Y')}
                                        style={{ padding: '0.2rem 0.6rem', fontSize: '0.85rem' }}
                                    >
                                        + Y (TE)
                                    </button>
                                    <button
                                        className={`btn ${elements.some(e => e.label === 'F') ? 'btn-primary' : 'btn-secondary'}`}
                                        onClick={() => toggleRooskiNode('F')}
                                        style={{ padding: '0.2rem 0.6rem', fontSize: '0.85rem' }}
                                    >
                                        + F (Back)
                                    </button>
                                </div>
                            )}

                            {/* Player Icons Palette */}
                            {selectedTool === 'player' && (
                                <div style={{ display: 'flex', gap: '0.25rem', alignItems: 'center', background: '#e2e8f0', padding: '0.25rem', borderRadius: '4px' }}>
                                    {PLAYER_ICONS.map(p => (
                                        <button
                                            key={p.label} onClick={() => setSelectedPlayerIcon(p)}
                                            style={{ width: '24px', height: '24px', borderRadius: '4px', border: selectedPlayerIcon.label === p.label ? '2px solid var(--accent)' : '1px solid #ccc', background: 'white', fontWeight: 'bold', fontSize: '0.7rem', color: 'black', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}
                                        >
                                            {p.label}
                                        </button>
                                    ))}
                                    <button className="btn btn-secondary" onClick={handleQuickOffense} title="11-Man Formation" style={{ fontSize: '0.7rem', padding: '0.25rem 0.4rem' }}>‚ö° Quick 11</button>
                                    <button className="btn btn-secondary" onClick={handleRooskiOffense} title="Rooski Skill Colors" style={{ fontSize: '0.7rem', padding: '0.25rem 0.4rem', background: '#e0f2fe', color: '#0369a1', borderColor: '#bae6fd' }}>üé® Rooski</button>
                                </div>
                            )}

                            <div style={{ flex: 1 }}></div>

                            {/* Color Picker */}
                            <div style={{ display: 'flex', gap: '0.25rem', alignItems: 'center' }}>
                                {COLORS.map(c => (
                                    <button key={c} onClick={() => setColor(c)} style={{ width: '20px', height: '20px', borderRadius: '50%', background: c, border: color === c ? '2px solid white' : '1px solid rgba(0,0,0,0.1)', boxShadow: color === c ? '0 0 0 2px var(--accent)' : 'none', transform: color === c ? 'scale(1.1)' : 'scale(1)' }} />
                                ))}
                            </div>

                            <div style={{ width: '1px', height: '20px', background: '#cbd5e1', margin: '0 0.5rem' }}></div>

                            {/* Actions */}
                            <button className="btn btn-secondary" onClick={onCancel} style={{ fontSize: '0.8rem', padding: '0.4rem 0.8rem' }}>Cancel</button>
                            <button className="btn btn-primary" onClick={() => onSave({ elements })} style={{ fontSize: '0.8rem', padding: '0.4rem 0.8rem' }}>
                                <Icon name="Save" size={14} style={{ marginRight: '4px' }} /> Save
                            </button>
                        </div>

                        {/* Help Text */}
                        <div style={{ background: '#fff', borderBottom: '1px solid #eee', padding: '0.25rem 1rem', fontSize: '0.75rem', color: '#666', display: 'flex', justifyContent: 'center' }}>
                            {selectedTool === 'line' ? 'Tip: Click to start ‚Ä¢ Click to turn corner ‚Ä¢ Double-Click to finish' :
                                selectedTool === 'player' ? 'Tip: Drag icons to move ‚Ä¢ Click on field to add new' : 'Drag to draw'}
                        </div>

                        {/* Canvas */}
                        <div style={{ flex: 1, position: 'relative', background: '#ffffff', cursor: selectedTool === 'delete' ? 'no-drop' : (selectedTool === 'player' ? 'default' : 'crosshair'), overflow: 'hidden' }}>
                            <svg
                                ref={svgRef}
                                width="100%"
                                height="100%"
                                viewBox="0 0 800 500"
                                preserveAspectRatio="none"
                                onMouseDown={handleMouseDown}
                                onMouseMove={handleMouseMove}
                                onMouseUp={handleMouseUp}
                                onDoubleClick={handleDoubleClick} // New
                                onMouseLeave={handleMouseUp}
                            >
                                <defs>
                                    {COLORS.map(c => (
                                        <marker key={c} id={`arrowhead-${c}`} markerWidth="6" markerHeight="4" refX="5" refY="2" orient="auto">
                                            <polygon points="0 0, 6 2, 0 4" fill={c} />
                                        </marker>
                                    ))}
                                    {/* Grid Pattern */}
                                    <pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse">
                                        <path d="M 100 0 L 0 0 0 100" fill="none" stroke="#f0f0f0" strokeWidth="1" />
                                    </pattern>
                                </defs>

                                {/* Field Background Logic */}
                                {mode === 'detailed' ? (
                                    <>
                                        <rect width="100%" height="100%" fill="white" />
                                        {/* Detailed grid/field lines (High School Specs) */}
                                        {/* Field Width 53.33 yards = 800px => 15px/yard */}
                                        {/* Hashes: Equal Thirds => 17.78 yds from sideline => 266.6px */}
                                        {/* Numbers: Top of numbers 9 yards from sideline => 135px */}

                                        {[0, 1, 2, 3, 4, 5, 6, 7].map(i => {
                                            // Lines every 5 yards (75px)
                                            // LOS at 350
                                            const y = 50 + (i * 75); // 50, 125, 200, 275, 350, 425, 500

                                            return (
                                                <g key={i}>
                                                    {/* Yard Line */}
                                                    <line x1="0" y1={y} x2="800" y2={y} stroke={y === 350 ? "#000" : "#e2e8f0"} strokeWidth={y === 350 ? 3 : 2} />

                                                    {/* High School Hashes (Thirds) */}
                                                    <line x1="266" y1={y - 8} x2="266" y2={y + 8} stroke="#000" strokeWidth="2" />
                                                    <line x1="534" y1={y - 8} x2="534" y2={y + 8} stroke="#000" strokeWidth="2" />

                                                    {/* Yard Numbers (Contrast Fixed) */}
                                                    {Math.abs(350 - y) % 150 === 0 && y !== 350 && (
                                                        <>
                                                            <text x="135" y={y + 8} fill="#64748b" fontSize="24" fontWeight="bold" textAnchor="middle" style={{ opacity: 0.6 }}>{(350 - y) / 15}</text>
                                                            <text x="665" y={y + 8} fill="#64748b" fontSize="24" fontWeight="bold" textAnchor="middle" style={{ opacity: 0.6 }}>{(350 - y) / 15}</text>
                                                        </>
                                                    )}
                                                </g>
                                            );
                                        })}
                                        {/* LOS Marker */}
                                        <text x="20" y="345" fontSize="12" fontWeight="bold" fill="#000">LOS</text>
                                        <text x="780" y="345" fontSize="12" fontWeight="bold" fill="#000" textAnchor="end">LOS</text>
                                    </>
                                ) : (
                                    <>
                                        {/* Simple/Rooski Field */}
                                        <rect width="100%" height="100%" fill="white" />
                                        <rect width="100%" height="100%" fill="url(#grid)" />

                                        {/* Yard Lines - Adjusted for 340 LOS (~8 yards back) */}
                                        <line x1="0" y1="340" x2="100%" y2="340" stroke="#000" strokeWidth="3" />
                                        <text x="20" y="335" fontSize="12" fill="#666">LOS</text>
                                        <text x="780" y="335" fontSize="12" fill="#666" textAnchor="end">LOS</text>

                                        {/* -5 Yards (340 + 100 = 440) */}
                                        <line x1="0" y1="440" x2="100%" y2="440" stroke="#ccc" strokeWidth="1" strokeDasharray="5,5" />
                                        <text x="20" y="435" fontSize="12" fill="#999">-5</text>
                                        <text x="780" y="435" fontSize="12" fill="#999" textAnchor="end">-5</text>

                                        {/* +5 Yards (340 - 100 = 240) */}
                                        <line x1="0" y1="240" x2="100%" y2="240" stroke="#ccc" strokeWidth="1" strokeDasharray="5,5" />
                                        <text x="20" y="235" fontSize="12" fill="#999">+5</text>
                                        <text x="780" y="235" fontSize="12" fill="#999" textAnchor="end">+5</text>

                                        {/* +10 Yards (240 - 100 = 140) */}
                                        <line x1="0" y1="140" x2="100%" y2="140" stroke="#000" strokeWidth="1" />
                                        <text x="20" y="135" fontSize="12" fill="#666">+10</text>
                                        <text x="780" y="135" fontSize="12" fill="#666" textAnchor="end">+10</text>

                                        {/* +15 Yards (140 - 100 = 40) */}
                                        <line x1="0" y1="40" x2="100%" y2="40" stroke="#ccc" strokeWidth="1" strokeDasharray="5,5" />
                                        <text x="20" y="35" fontSize="12" fill="#999">+15</text>
                                        <text x="780" y="35" fontSize="12" fill="#999" textAnchor="end">+15</text>

                                        {/* Hash Marks Concept (just small ticks) */}
                                        {[140, 240, 340, 440].map(y => (
                                            <g key={y}>
                                                <line x1="360" y1={y - 5} x2="360" y2={y + 5} stroke="#ccc" strokeWidth="1" />
                                                <line x1="440" y1={y - 5} x2="440" y2={y + 5} stroke="#ccc" strokeWidth="1" />
                                            </g>
                                        ))}
                                    </>
                                )}

                                {elements.map(el => renderElement(el))} // Render saved elements
                                {currentPath && renderElement(currentPath, true)} // Render active drawing (preview)
                            </svg>
                        </div>
                    </div>
                </div>
            );
        };

        const PlayInput = ({ onSave, onCancel, onDelete, initialData }) => {
            const [isDiagramming, setIsDiagramming] = useState(false);
            const [activeScenarioId, setActiveScenarioId] = useState(null); // ID of scenario being edited
            const [activeDiagramMode, setActiveDiagramMode] = useState(null); // null, 'rooski-oline', 'rooski-skill', 'detailed'
            const [formData, setFormData] = useState({
                playCategory: '', // Existing field
                formation: '',
                formationTag: '',
                name: '',
                color: '',
                motion: '',
                playAction: false,
                tag1: '',
                tag2: '',
                tags: [],
                image: null,
                diagramData: null, // New: Diagram elements
                rooskiOlineData: null, // O-Line Rooski
                rooskiSkillData: null, // Skill Rooski
                scenarios: [], // Array of Detailed Scenarios
                activeScenarioId: null, // ID of scenario being edited
                wristbandSlot: '',
                // New call sheet fields
                playType: '', // Fastball, Curveball, Change Up, Strikeout
                actionTypes: [], // Array: Strong Run, Weak Run, Quick Game, etc.
                hashPreference: 'Any', // Left, Right, Middle, Any
                baseType: '', // Run, Pass, RPO, Gadget
                fieldZones: [], // Array: Fringe, Red Zone, Gold Zone, Goal Line
                downDistance: [], // Array: from existing tags
                sequenceName: '', // New Field: Look-alike sequence
                sequenceOrder: '', // New Field: Order in sequence
                ...initialData // Merge existing data ON TOP of defaults
            });

            // If initialData has diagramData but no image, we can render it? 
            // Currently the system uses 'image' for display. We might need to generate an SVG string as image or support rendering diagramData.
            // For now, let's allow saving and editing.

            const handleSaveDiagram = (data) => {
                setFormData(prev => ({ ...prev, diagramData: data }));
                setIsDiagramming(false);

                // Optional: Generate a thumbnail image from the diagram? 
                // Simple SVG data URI approach
                // Note: Converting elements to SVG string
                const svgContent = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="800" height="500" viewBox="0 0 800 500" style="background: white">
                        <g opacity="0.1">
                                    <line x1="0" y1="10%" x2="100%" y2="10%" stroke="#000" stroke-width="2" />
                                    <line x1="0" y1="30%" x2="100%" y2="30%" stroke="#000" stroke-width="2" />
                                    <line x1="0" y1="50%" x2="100%" y2="50%" stroke="#000" stroke-width="4" />
                                    <line x1="0" y1="70%" x2="100%" y2="70%" stroke="#000" stroke-width="2" />
                                    <line x1="0" y1="90%" x2="100%" y2="90%" stroke="#000" stroke-width="2" />
                        </g>
                        ${data.elements.map(el => {
                    let d = '';
                    if (el.type === 'free') {
                        d = `M ${el.points.map(p => `${p.x},${p.y}`).join(' L ')}`;
                    } else {
                        const start = el.points[0];
                        const end = el.points[el.points.length - 1];
                        d = `M ${start.x},${start.y} L ${end.x},${end.y}`;
                    }
                    // Markers are tricky in data URI without definitions.
                    // Simply defining markers in the SVG string
                    return `<path d="${d}" stroke="${el.color}" stroke-width="4" fill="none" stroke-dasharray="${el.style === 'dashed' ? '10,5' : 'none'}" />`;
                }).join('')}
                    </svg>
                `;
                const encoded = 'data:image/svg+xml;base64,' + btoa(svgContent);
                // setFormData(prev => ({ ...prev, diagramData: data, image: encoded })); // Use this if we want to preview it as image
                // Actually, let's keep diagramData separate and prefer it for rendering if available, falling back to image.
            };

            const toggleTag = (tag) => {
                setFormData(prev => ({
                    ...prev,
                    tags: prev.tags.includes(tag)
                        ? prev.tags.filter(t => t !== tag)
                        : [...prev.tags, tag]
                }));
            };

            const toggleActionType = (type) => {
                setFormData(prev => ({
                    ...prev,
                    actionTypes: prev.actionTypes.includes(type)
                        ? prev.actionTypes.filter(t => t !== type)
                        : [...prev.actionTypes, type]
                }));
            };

            const toggleFieldZone = (zone) => {
                setFormData(prev => ({
                    ...prev,
                    fieldZones: prev.fieldZones.includes(zone)
                        ? prev.fieldZones.filter(z => z !== zone)
                        : [...prev.fieldZones, zone]
                }));
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setFormData(prev => ({ ...prev, image: reader.result, diagramData: null })); // Clear diagramData if image is uploaded
                    };
                    reader.readAsDataURL(file);
                }
            };

            // SCENARIO HELPERS
            const handleAddScenario = () => {
                const newScenario = {
                    id: Date.now(),
                    front: 'Over',
                    coverage: 'Cover 3',
                    diagramData: null,
                    notes: { 'QB': '', 'RB': '', 'X': '', 'Z': '', 'Y': '', 'F': '', 'OL': '' }
                };
                setFormData(prev => ({
                    ...prev,
                    scenarios: [...(prev.scenarios || []), newScenario]
                }));
                setActiveScenarioId(newScenario.id); // Auto-select
            };

            const handleUpdateScenario = (id, field, value) => {
                setFormData(prev => ({
                    ...prev,
                    scenarios: prev.scenarios.map(s => s.id === id ? { ...s, [field]: value } : s)
                }));
            };

            const handleUpdateScenarioNote = (id, player, note) => {
                setFormData(prev => ({
                    ...prev,
                    scenarios: prev.scenarios.map(s => s.id === id ? {
                        ...s,
                        notes: { ...s.notes, [player]: note }
                    } : s)
                }));
            };

            const handleDeleteScenario = (id) => {
                if (window.confirm('Delete this scenario?')) {
                    setFormData(prev => ({
                        ...prev,
                        scenarios: prev.scenarios.filter(s => s.id !== id)
                    }));
                    if (activeScenarioId === id) setActiveScenarioId(null);
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({ ...formData, id: formData.id || Date.now().toString() });
            };

            const handleDelete = () => {
                if (window.confirm('Are you sure you want to delete this play? This cannot be undone.')) {
                    onDelete(formData.id);
                }
            };

            return (
                <div className="animate-fade-in">
                    {/* Diagram Editor Modal */}
                    {isDiagramming && (
                        <PlayDiagramEditor
                            initialData={formData.diagramData}
                            onSave={handleSaveDiagram}
                            onCancel={() => setIsDiagramming(false)}
                        />
                    )}

                    {/* Rooski O-Line Editor Modal */}
                    {activeDiagramMode === 'rooski-oline' && (
                        <PlayDiagramEditor
                            initialData={formData.rooskiOlineData ? { elements: formData.rooskiOlineData } : null}
                            mode="rooski-oline"
                            onSave={(data) => {
                                setFormData({ ...formData, rooskiOlineData: data.elements });
                                setActiveDiagramMode(null);
                            }}
                            onCancel={() => setActiveDiagramMode(null)}
                        />
                    )}

                    {/* Rooski Skill Editor Modal */}
                    {activeDiagramMode === 'rooski-skill' && (
                        <PlayDiagramEditor
                            initialData={formData.rooskiSkillData ? { elements: formData.rooskiSkillData } : null}
                            mode="rooski-skill"
                            onSave={(data) => {
                                setFormData({ ...formData, rooskiSkillData: data.elements });
                                setActiveDiagramMode(null);
                            }}
                            onCancel={() => setActiveDiagramMode(null)}
                        />
                    )}

                    {/* Detailed Scenario Editor Modal */}
                    {activeDiagramMode === 'detailed' && activeScenarioId && (
                        <PlayDiagramEditor
                            initialData={formData.scenarios.find(s => s.id === activeScenarioId)?.diagramData ? { elements: formData.scenarios.find(s => s.id === activeScenarioId).diagramData } : null}
                            mode="detailed"
                            onSave={(data) => {
                                handleUpdateScenario(activeScenarioId, 'diagramData', data.elements);
                                setActiveDiagramMode(null);
                            }}
                            onCancel={() => setActiveDiagramMode(null)}
                        />
                    )}

                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                        <h2>{initialData ? 'Edit Play' : 'New Play Design'}</h2>
                        {initialData && (
                            <button
                                type="button"
                                onClick={handleDelete}
                                className="btn"
                                style={{ backgroundColor: 'rgba(239, 68, 68, 0.1)', color: '#ef4444', border: '1px solid #ef4444' }}
                            >
                                üóëÔ∏è Delete Play
                            </button>
                        )}
                    </div>
                    <form onSubmit={handleSubmit}>


                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem' }}>
                            <div>
                                {/* REQUESTED ORDER: Formation, Formation Tag, Color, Action, Play Name, Tag 1, Tag 2 */}
                                <div className="form-group">
                                    <label className="form-label">Formation</label>
                                    <input
                                        className="form-input"
                                        value={formData.formation}
                                        onChange={e => setFormData({ ...formData, formation: e.target.value })}
                                        placeholder="e.g. Gun Trips Right"
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Formation Tag</label>
                                    <input
                                        className="form-input"
                                        value={formData.formationTag}
                                        onChange={e => setFormData({ ...formData, formationTag: e.target.value })}
                                        placeholder="e.g. Bunch, Stack"
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Color (RB/Protection)</label>
                                    <input
                                        className="form-input"
                                        value={formData.color}
                                        onChange={e => setFormData({ ...formData, color: e.target.value })}
                                        placeholder="e.g. Slide Right / Blue"
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Action (Shift/Motion/PA)</label>
                                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                                        <input
                                            className="form-input"
                                            value={formData.motion}
                                            onChange={e => setFormData({ ...formData, motion: e.target.value })}
                                            placeholder="e.g. Jet Motion"
                                        />
                                        <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer', whiteSpace: 'nowrap', padding: '0 1rem', background: 'var(--bg-input)', border: '1px solid var(--border)', borderRadius: 'var(--radius)' }}>
                                            <input
                                                type="checkbox"
                                                checked={formData.playAction}
                                                onChange={e => setFormData({ ...formData, playAction: e.target.checked })}
                                            />
                                            <span style={{ fontSize: '0.9rem' }}>Play Action</span>
                                        </label>
                                    </div>
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Play Name</label>
                                    <input
                                        className="form-input"
                                        value={formData.name}
                                        onChange={e => setFormData({ ...formData, name: e.target.value })}
                                        placeholder="e.g. TRIBE / Spider 2 Y Banana"
                                        required
                                    />
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                    <div className="form-group">
                                        <label className="form-label">Tag 1</label>
                                        <input
                                            className="form-input"
                                            value={formData.tag1}
                                            onChange={e => setFormData({ ...formData, tag1: e.target.value })}
                                            placeholder="e.g. Alert"
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Tag 2</label>
                                        <input
                                            className="form-input"
                                            value={formData.tag2}
                                            onChange={e => setFormData({ ...formData, tag2: e.target.value })}
                                            placeholder="e.g. Check"
                                        />
                                    </div>
                                </div>

                                {/* Hash Preference */}
                                <div className="form-group">
                                    <label className="form-label">Hash Preference</label>
                                    <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                                        {HASH_PREFERENCES.map(pref => (
                                            <button
                                                key={pref}
                                                type="button"
                                                className={`btn ${formData.hashPreference === pref ? 'btn-primary' : 'btn-secondary'}`}
                                                onClick={() => setFormData({ ...formData, hashPreference: pref })}
                                                style={{ flex: '1 1 auto', minWidth: '80px' }}
                                            >
                                                {pref}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Mirror Play */}
                                <div className="form-group">
                                    <label className="form-label">Mirror Play</label>
                                    <input
                                        className="form-input"
                                        value={formData.mirrorPlay || ''}
                                        onChange={e => setFormData({ ...formData, mirrorPlay: e.target.value })}
                                        placeholder="e.g. 877 BLUE 4T TRIBE"
                                    />
                                    <small style={{ color: 'var(--text-secondary)', fontSize: '0.75rem', marginTop: '0.25rem', display: 'block' }}>Enter the opposite/mirror version of this play</small>
                                </div>

                                {/* Look-Alike Sequence */}
                                <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '1rem' }}>
                                    <div className="form-group">
                                        <label className="form-label">Sequence / Look-Alike Group</label>
                                        <input
                                            className="form-input"
                                            value={formData.sequenceName || ''}
                                            onChange={e => setFormData({ ...formData, sequenceName: e.target.value })}
                                            placeholder="e.g. Power Series"
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Order</label>
                                        <input
                                            type="number"
                                            className="form-input"
                                            value={formData.sequenceOrder || ''}
                                            onChange={e => setFormData({ ...formData, sequenceOrder: e.target.value })}
                                            placeholder="#"
                                        />
                                    </div>
                                </div>



                                {/* Call Sheet Fields */}
                                {/* Call Sheet Tags Merged into Situational Tags */}

                            </div>
                            {/* Close Left Column, Open Right Column */}
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>

                                {/* Play Category (Moved Here) */}


                                <div className="form-group">
                                    <label className="form-label" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                        <span>Rooski O-Line Diagram</span>
                                        {formData.rooskiOlineData && (
                                            <span style={{ fontSize: '0.75rem', color: '#10b981', fontWeight: 'bold' }}>‚úì Active</span>
                                        )}
                                    </label>
                                    <div style={{
                                        border: formData.rooskiOlineData ? '2px solid #10b981' : '2px dashed var(--border)',
                                        borderRadius: 'var(--radius)',
                                        padding: '1rem',
                                        textAlign: 'center',
                                        minHeight: '200px',
                                        display: 'flex',
                                        flexDirection: 'column',
                                        justifyContent: 'center',
                                        alignItems: 'center',
                                        background: 'var(--bg-input)',
                                        position: 'relative',
                                        overflow: 'hidden',
                                        transition: 'all 0.2s'
                                    }}>
                                        {formData.rooskiOlineData ? (
                                            <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
                                                {/* Mini Preview */}
                                                <div style={{ width: '100%', height: '180px', marginBottom: '1rem', border: '1px solid #ddd', background: 'white', position: 'relative' }}>
                                                    <svg viewBox="0 0 800 500" width="100%" height="100%" style={{ display: 'block' }} preserveAspectRatio="xMidYMid meet">
                                                        <g opacity="0.1">
                                                            <line x1="0" y1="10%" x2="100%" y2="10%" stroke="#000" strokeWidth="2" />
                                                            <line x1="0" y1="90%" x2="100%" y2="90%" stroke="#000" strokeWidth="2" />
                                                        </g>
                                                        {formData.rooskiOlineData.map(el => (
                                                            // Simplified rendering
                                                            <circle key={el.id} cx={el.points[0].x} cy={el.points[0].y} r="5" fill={el.color} />
                                                        ))}
                                                    </svg>
                                                </div>
                                                <button type="button" className="btn btn-secondary" onClick={() => setActiveDiagramMode('rooski-oline')} style={{ fontSize: '0.8rem' }}>
                                                    <Icon name="Edit3" size={14} style={{ marginRight: '4px' }} /> Edit
                                                </button>
                                            </div>
                                        ) : (
                                            <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center' }}>
                                                <button type="button" className="btn btn-secondary" onClick={() => setActiveDiagramMode('rooski-oline')}>
                                                    <Icon name="PlusCircle" size={16} style={{ marginRight: '6px' }} /> Create O-Line
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                    {formData.rooskiOlineData && (
                                        <div style={{ marginTop: '0.5rem', display: 'flex', justifyContent: 'flex-end' }}>
                                            <button
                                                type="button"
                                                onClick={() => setFormData({ ...formData, rooskiOlineData: null })}
                                                style={{ background: 'none', border: 'none', color: '#ef4444', fontSize: '0.8rem', cursor: 'pointer', display: 'flex', alignItems: 'center' }}
                                            >
                                                <Icon name="Trash" size={12} style={{ marginRight: '4px' }} /> Remove
                                            </button>
                                        </div>
                                    )}
                                </div>

                                {/* Rooski Skill Diagram */}
                                <div className="form-group">
                                    <label className="form-label" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                        <span>Rooski Skill Diagram</span>
                                        {formData.rooskiSkillData && (
                                            <span style={{ fontSize: '0.75rem', color: '#3b82f6', fontWeight: 'bold' }}>‚úì Active</span>
                                        )}
                                    </label>
                                    <div style={{
                                        border: formData.rooskiSkillData ? '2px solid #3b82f6' : '2px dashed var(--border)',
                                        borderRadius: 'var(--radius)',
                                        padding: '1rem',
                                        textAlign: 'center',
                                        minHeight: '200px',
                                        display: 'flex',
                                        flexDirection: 'column',
                                        justifyContent: 'center',
                                        alignItems: 'center',
                                        background: 'var(--bg-input)',
                                        position: 'relative',
                                        overflow: 'hidden',
                                        transition: 'all 0.2s'
                                    }}>
                                        {formData.rooskiSkillData ? (
                                            <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
                                                {/* Mini Preview */}
                                                <div style={{ width: '100%', height: '180px', marginBottom: '1rem', border: '1px solid #ddd', background: 'white', position: 'relative' }}>
                                                    <svg viewBox="0 0 800 500" width="100%" height="100%" style={{ display: 'block' }} preserveAspectRatio="xMidYMid meet">
                                                        {formData.rooskiSkillData.map(el => (
                                                            <circle key={el.id} cx={el.points[0].x} cy={el.points[0].y} r="5" fill={el.color} />
                                                        ))}
                                                    </svg>
                                                </div>
                                                <button type="button" className="btn btn-secondary" onClick={() => setActiveDiagramMode('rooski-skill')} style={{ fontSize: '0.8rem' }}>
                                                    <Icon name="Edit3" size={14} style={{ marginRight: '4px' }} /> Edit
                                                </button>
                                            </div>
                                        ) : (
                                            <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center' }}>
                                                <button type="button" className="btn btn-secondary" onClick={() => setActiveDiagramMode('rooski-skill')}>
                                                    <Icon name="PlusCircle" size={16} style={{ marginRight: '6px' }} /> Create Skill
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                    {formData.rooskiSkillData && (
                                        <div style={{ marginTop: '0.5rem', display: 'flex', justifyContent: 'flex-end' }}>
                                            <button
                                                type="button"
                                                onClick={() => setFormData({ ...formData, rooskiSkillData: null })}
                                                style={{ background: 'none', border: 'none', color: '#ef4444', fontSize: '0.8rem', cursor: 'pointer', display: 'flex', alignItems: 'center' }}
                                            >
                                                <Icon name="Trash" size={12} style={{ marginRight: '4px' }} /> Remove
                                            </button>
                                        </div>
                                    )}
                                </div>

                                {/* Main Diagram Section */}
                                <div className="form-group">
                                    <label className="form-label">Play Diagram (Full Field)</label>
                                    <div style={{
                                        border: formData.diagramData ? '2px solid var(--accent)' : '2px dashed var(--border)',
                                        borderRadius: 'var(--radius)',
                                        padding: '1rem',
                                        textAlign: 'center',
                                        minHeight: '200px',
                                        background: 'var(--bg-input)',
                                        position: 'relative'
                                    }}>
                                        {formData.diagramData ? (
                                            <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
                                                <div style={{ width: '100%', height: '180px', marginBottom: '1rem', border: '1px solid #ddd', background: 'white', position: 'relative' }}>
                                                    {/* Simplistic preview - omitting complex SVG for brevity in restoration, user can edit to see full */}
                                                    <div style={{ width: '100%', height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#999' }}>
                                                        <span>Diagram Active ({formData.diagramData.elements.length} items)</span>
                                                    </div>
                                                </div>
                                                <div style={{ display: 'flex', gap: '0.5rem' }}>
                                                    <button type="button" className="btn btn-primary" onClick={() => setIsDiagramming(true)}>Edit Diagram</button>
                                                    <button type="button" className="btn btn-secondary" onClick={() => setFormData(prev => ({ ...prev, diagramData: null }))}>Clear</button>
                                                </div>
                                            </div>
                                        ) : formData.image ? (
                                            <>
                                                <img src={formData.image} alt="Play structure" style={{ maxWidth: '100%', maxHeight: '400px', objectFit: 'contain', marginBottom: '1rem' }} />
                                                <div style={{ display: 'flex', gap: '0.5rem' }}>
                                                    <button
                                                        type="button"
                                                        className="btn btn-secondary"
                                                        onClick={() => setFormData({ ...formData, image: null })}
                                                    >
                                                        Remove Image
                                                    </button>
                                                </div>
                                            </>
                                        ) : (
                                            <>
                                                <div style={{ marginBottom: '1rem', color: 'var(--text-secondary)' }}>
                                                    <Icon name="Image" size={48} style={{ opacity: 0.5, marginBottom: '0.5rem' }} />
                                                    <div>Drag & Drop or Click to Upload</div>
                                                </div>
                                                <div style={{ marginBottom: '1rem', textTransform: 'uppercase', fontSize: '0.8rem', opacity: 0.7 }}>‚Äî OR ‚Äî</div>
                                                <button
                                                    type="button"
                                                    className="btn btn-primary"
                                                    onClick={() => setIsDiagramming(true)}
                                                    style={{ position: 'relative', zIndex: 10 }}
                                                >
                                                    <Icon name="Edit3" size={16} style={{ marginRight: '6px' }} />
                                                    Create Diagram
                                                </button>
                                                <input
                                                    type="file"
                                                    onChange={handleImageUpload}
                                                    accept="image/*"
                                                    style={{ position: 'absolute', top: 0, left: 0, width: '100%', height: '100%', opacity: 0, cursor: 'pointer' }}
                                                    title=""
                                                />
                                            </>
                                        )}
                                    </div>
                                </div>
                            </div>


                        </div>

                        {/* Detailed Install & Variations Section (Full Width) */}
                        <div style={{ marginTop: '2rem', padding: '1.5rem', background: '#f8fafc', borderRadius: '12px', border: '1px solid #e2e8f0' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                                <h3 style={{ margin: 0, fontSize: '1.1rem', color: '#1e293b' }}>Detailed Install & Variations</h3>
                                <button type="button" className="btn btn-secondary" onClick={handleAddScenario} style={{ fontSize: '0.8rem' }}>
                                    <Icon name="PlusCircle" size={14} style={{ marginRight: '4px' }} /> Add Look
                                </button>
                            </div>

                            {/* Scenarios Tabs */}
                            {formData.scenarios && formData.scenarios.length > 0 ? (
                                <div style={{ display: 'flex', gap: '0.5rem', overflowX: 'auto', paddingBottom: '0.5rem', marginBottom: '1rem', borderBottom: '1px solid #e2e8f0' }}>
                                    {formData.scenarios.map(s => (
                                        <button
                                            key={s.id}
                                            type="button"
                                            onClick={() => setActiveScenarioId(s.id)}
                                            style={{
                                                padding: '0.5rem 1rem',
                                                borderRadius: '6px 6px 0 0',
                                                background: activeScenarioId === s.id ? 'white' : 'transparent',
                                                border: activeScenarioId === s.id ? '1px solid #e2e8f0' : 'none',
                                                borderBottom: activeScenarioId === s.id ? '2px solid var(--accent)' : 'none',
                                                fontWeight: activeScenarioId === s.id ? 'bold' : 'normal',
                                                color: activeScenarioId === s.id ? 'var(--accent)' : '#64748b',
                                                cursor: 'pointer',
                                                whiteSpace: 'nowrap'
                                            }}
                                        >
                                            {s.front} / {s.coverage}
                                        </button>
                                    ))}
                                </div>
                            ) : (
                                <div style={{ textAlign: 'center', padding: '1rem', color: '#94a3b8', fontStyle: 'italic', fontSize: '0.9rem' }}>
                                    No detailed variations added yet. Click "Add Look" to start.
                                </div>
                            )}

                            {/* Active Scenario Editor */}
                            {activeScenarioId && formData.scenarios.find(s => s.id === activeScenarioId) && (() => {
                                const scenario = formData.scenarios.find(s => s.id === activeScenarioId);
                                return (
                                    <div className="animate-fade-in">
                                        {/* Meta Data */}
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr auto', gap: '1rem', marginBottom: '1rem' }}>
                                            <div className="form-group">
                                                <label className="form-label">Defensive Front</label>
                                                <select
                                                    className="form-input"
                                                    value={scenario.front}
                                                    onChange={(e) => handleUpdateScenario(scenario.id, 'front', e.target.value)}
                                                >
                                                    <option value="Over">Over</option>
                                                    <option value="Under">Under</option>
                                                    <option value="Tite">Tite</option>
                                                    <option value="Bear">Bear</option>
                                                    <option value="Mint">Mint</option>
                                                    <option value="Odd">Odd</option>
                                                </select>
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Coverage</label>
                                                <select
                                                    className="form-input"
                                                    value={scenario.coverage}
                                                    onChange={(e) => handleUpdateScenario(scenario.id, 'coverage', e.target.value)}
                                                >
                                                    <option value="Cover 3">Cover 3</option>
                                                    <option value="Cover 1">Cover 1</option>
                                                    <option value="Cover 2">Cover 2</option>
                                                    <option value="Cover 4">Cover 4</option>
                                                    <option value="Cover 0">Cover 0</option>
                                                    <option value="Tampa 2">Tampa 2</option>
                                                </select>
                                            </div>
                                            <div style={{ display: 'flex', alignItems: 'flex-end' }}>
                                                <button type="button" className="btn btn-secondary" onClick={() => handleDeleteScenario(scenario.id)} title="Delete Scenario" style={{ color: '#ef4444' }}>
                                                    <Icon name="Trash" size={16} />
                                                </button>
                                            </div>
                                        </div>

                                        {/* Diagram and Notes Split */}
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem' }}>
                                            {/* Diagram Preview */}
                                            <div>
                                                <div style={{ width: '100%', height: '220px', border: '1px solid #cbd5e1', borderRadius: '8px', background: 'white', position: 'relative', overflow: 'hidden', marginBottom: '0.5rem' }}>
                                                    {scenario.diagramData ? (
                                                        <svg viewBox="0 0 800 500" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
                                                            {/* Mini Detailed Field Background (HS Specs) */}
                                                            <rect width="100%" height="100%" fill="white" />
                                                            {[0, 1, 2, 3].map(i => {
                                                                const y = 50 + i * 100;
                                                                return (
                                                                    <g key={i}>
                                                                        <line x1="0" y1={y} x2="800" y2={y} stroke="#e5e7eb" strokeWidth="2" />
                                                                        {/* Hashes 266/533 */}
                                                                        <line x1="266" y1={y - 5} x2="266" y2={y + 5} stroke="#cbd5e1" strokeWidth="2" />
                                                                        <line x1="534" y1={y - 5} x2="534" y2={y + 5} stroke="#cbd5e1" strokeWidth="2" />
                                                                    </g>
                                                                );
                                                            })}
                                                            {scenario.diagramData.map(el => (
                                                                <circle key={el.id} cx={el.points[0].x} cy={el.points[0].y} r="5" fill={el.color} />
                                                            ))}
                                                        </svg>
                                                    ) : (
                                                        <div style={{ width: '100%', height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#94a3b8', fontSize: '0.9rem' }}>
                                                            No diagram yet
                                                        </div>
                                                    )}
                                                </div>
                                                <button type="button" className="btn btn-secondary" style={{ width: '100%' }} onClick={() => setActiveDiagramMode('detailed')}>
                                                    <Icon name="Edit3" size={14} style={{ marginRight: '6px' }} /> Edit Field Diagram
                                                </button>
                                            </div>

                                            {/* Player Notes */}
                                            <div style={{ maxHeight: '300px', overflowY: 'auto' }}>
                                                <h4 style={{ margin: '0 0 0.5rem 0', fontSize: '0.9rem' }}>Player Assignment Notes</h4>
                                                {['QB', 'RB', 'X', 'Z', 'Y', 'F', 'OL'].map(pos => (
                                                    <div key={pos} style={{ marginBottom: '0.5rem', display: 'flex', alignItems: 'center' }}>
                                                        <span style={{ width: '30px', fontWeight: 'bold', fontSize: '0.8rem' }}>{pos}</span>
                                                        <input
                                                            className="form-input"
                                                            style={{ padding: '0.25rem 0.5rem', fontSize: '0.85rem', color: '#1e293b', background: '#ffffff', border: '1px solid #cbd5e1' }}
                                                            placeholder={`Notes for ${pos}...`}
                                                            value={scenario.notes?.[pos] || ''}
                                                            onChange={(e) => handleUpdateScenarioNote(scenario.id, pos, e.target.value)}
                                                        />
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })()}
                        </div>

                        <div className="form-group">
                            <label className="form-label" style={{ marginBottom: '1rem' }}>Situational Tags</label>
                            <TagSelector selectedTags={formData.tags} onToggle={toggleTag} />
                        </div>


                        <div style={{ display: 'flex', gap: '1rem', marginTop: '2rem', paddingBottom: '2rem' }}>
                            <button type="submit" className="btn btn-primary">Save Play</button>
                            <button type="button" onClick={onCancel} className="btn btn-secondary">Cancel</button>
                        </div>
                    </form >
                </div >
            );
        };

        const PlayCard = ({ play, onEdit, isSelected, onToggleSelection }) => {
            return (
                <div className={`play-card ${isSelected ? 'selected' : ''}`} onClick={() => onEdit(play)} style={{ cursor: 'pointer', position: 'relative', border: isSelected ? '2px solid #ef4444' : '' }}>
                    <div
                        onClick={(e) => {
                            e.stopPropagation();
                            onToggleSelection(play.id);
                        }}
                        style={{
                            position: 'absolute',
                            top: '5px',
                            right: '5px',
                            zIndex: 10,
                            background: 'rgba(0,0,0,0.5)',
                            borderRadius: '4px',
                            padding: '4px'
                        }}
                    >
                        <input
                            type="checkbox"
                            checked={isSelected || false}
                            onChange={() => { }} // Handled by div click
                            style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                        />
                    </div>

                    {play.diagramData ? (
                        <div className="play-image" style={{ background: 'white' }}>
                            <svg
                                viewBox="0 0 800 500"
                                width="100%"
                                height="100%"
                                style={{ display: 'block' }}
                                preserveAspectRatio="xMidYMid meet"
                            >
                                <g opacity="0.1">
                                    <line x1="0" y1="10%" x2="100%" y2="10%" stroke="#000" strokeWidth="2" />
                                    <line x1="0" y1="30%" x2="100%" y2="30%" stroke="#000" strokeWidth="2" />
                                    <line x1="0" y1="50%" x2="100%" y2="50%" stroke="#000" strokeWidth="4" />
                                    <line x1="0" y1="70%" x2="100%" y2="70%" stroke="#000" strokeWidth="2" />
                                    <line x1="0" y1="90%" x2="100%" y2="90%" stroke="#000" strokeWidth="2" />
                                </g>
                                {play.diagramData.elements && play.diagramData.elements.map(el => {
                                    if (el.type === 'player') {
                                        const { x, y } = el.points[0];
                                        const size = 30;
                                        const isRect = el.shape === 'square';
                                        return (
                                            <g key={el.id}>
                                                {isRect ? (
                                                    <rect x={x - size / 2} y={y - size / 2} width={size} height={size} fill="white" stroke={el.color} strokeWidth="2" />
                                                ) : (
                                                    <circle cx={x} cy={y} r={size / 2} fill="white" stroke={el.color} strokeWidth="2" />
                                                )}
                                                <text x={x} y={y} dy="0.35em" textAnchor="middle" fontSize="16" fontWeight="bold" fill={el.color}>{el.label}</text>
                                            </g>
                                        );
                                    }

                                    let d = '';
                                    if (el.style === 'zigzag') {
                                        d = getZigZagPath(el.points);
                                    } else if (el.type === 'free' || el.points.length > 1) {
                                        d = `M ${el.points.map(p => `${p.x},${p.y}`).join(' L ')}`;
                                    }

                                    let markerEnd = undefined;
                                    let tBlock = null;

                                    if (el.endType === 'arrow' || (!el.endType && el.type !== 'free')) {
                                        markerEnd = `url(#arrowhead-${el.color})`;
                                    } else if (el.endType === 't') {
                                        const end = el.points[el.points.length - 1];
                                        const prev = el.points[el.points.length - 2] || el.points[0];
                                        const dx = end.x - prev.x;
                                        const dy = end.y - prev.y;
                                        const len = Math.hypot(dx, dy) || 1;
                                        const perpX = (-dy / len) * 15;
                                        const perpY = (dx / len) * 15;
                                        tBlock = (
                                            <line
                                                x1={end.x - perpX} y1={end.y - perpY}
                                                x2={end.x + perpX} y2={end.y + perpY}
                                                stroke={el.color}
                                                strokeWidth="4"
                                            />
                                        );
                                    } else if (el.endType === 'dot') {
                                        const end = el.points[el.points.length - 1];
                                        tBlock = (
                                            <circle cx={end.x} cy={end.y} r="6" fill={el.color} />
                                        );
                                    } else if (el.endType === 'none') {
                                        markerEnd = undefined;
                                    } else if (el.type === 'arrow') {
                                        markerEnd = `url(#arrowhead-${el.color})`;
                                    }

                                    return (
                                        <g key={el.id}>
                                            <path
                                                d={d}
                                                stroke={el.color}
                                                strokeWidth="4"
                                                fill="none"
                                                strokeDasharray={el.style === 'dashed' ? "10,5" : "none"}
                                                markerEnd={markerEnd}
                                            />
                                            {tBlock}
                                        </g>
                                    );
                                })}
                            </svg>
                        </div>
                    ) : play.image ? (
                        <img src={play.image} className="play-image" alt={play.name} />
                    ) : (
                        <div className="play-image" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#334155' }}>
                            <span>No Diagram</span>
                        </div>
                    )}
                    <div className="play-content">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', flex: 1 }}>
                                <h3 className="play-title">{play.name}</h3>
                                {play.incomplete && (
                                    <span style={{
                                        background: '#eab308',
                                        color: 'white',
                                        padding: '0.25rem 0.5rem',
                                        borderRadius: '4px',
                                        fontSize: '0.7rem',
                                        fontWeight: 'bold',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '0.25rem'
                                    }}>
                                        ‚ö†Ô∏è INCOMPLETE
                                    </span>
                                )}
                            </div>
                            {play.wristbandSlot && <span className="mini-tag" style={{ background: 'var(--accent)', color: '#000' }}>#{play.wristbandSlot}</span>}
                        </div>
                        <div className="play-meta">
                            {play.formation} {play.formationTag && `(${play.formationTag})`} ‚Ä¢ {play.color}
                        </div>
                        <div className="play-tags">
                            {/* Tag 1 */}
                            {play.tag1 && (
                                <span className="mini-tag">
                                    {(TAG_CATEGORIES["Motion"] || []).includes(play.tag1) ? `"${play.tag1}"` : play.tag1}
                                </span>
                            )}

                            {/* Tag 2 */}
                            {play.tag2 && (
                                <span className="mini-tag">
                                    ({play.tag2})
                                </span>
                            )}

                            {/* Other Tags array (deduplicated) */}
                            {play.tags && play.tags.map(tag => {
                                // Deduplicate if tag matches fields
                                if (tag === play.tag1 || tag === play.tag2) return null;

                                const isMotion = (TAG_CATEGORIES["Motion"] || []).includes(tag);
                                return <span key={tag} className="mini-tag">{isMotion ? `"${tag}"` : tag}</span>
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const WristbandPrintCard = ({ title, start, end, slotMap, colorClass }) => {
            // Split range into two columns
            const totalSlots = end - start + 1;
            const mid = Math.ceil(totalSlots / 2);

            // Column 1: start to start + mid - 1
            // Column 2: start + mid to end
            // Wait, standard wristbands often interleave or go down?
            // User image: 101, 103... vs 102, 104... (Odds/Evens)?
            // Or 1-24, 25-48?
            // Let's do straight vertical split for readability: 1-24 on left, 25-48 on right.

            const col1Slots = [];
            const col2Slots = [];

            // Assuming 24 rows per column for 48 slots
            const rowsPerCol = 24;

            for (let i = 0; i < rowsPerCol; i++) {
                col1Slots.push(start + i);
                col2Slots.push(start + rowsPerCol + i);
            }

            return (
                <div className={`wristband-card ${colorClass}`}>
                    <div className="wristband-card-header">{title}</div>
                    <div className="wristband-content">
                        <div className="wristband-col">
                            {col1Slots.map(slot => (
                                <div key={slot} className="wristband-row">
                                    <div className="wristband-num">{slot}</div>
                                    <div className="wristband-play">{slotMap[slot]?.name || ''}</div>
                                </div>
                            ))}
                        </div>
                        <div className="wristband-col">
                            {col2Slots.map(slot => (
                                <div key={slot} className="wristband-row">
                                    <div className="wristband-num">{slot}</div>
                                    <div className="wristband-play">{slotMap[slot]?.name || ''}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const WristbandDiagramCard = ({ slot, play }) => {
            return (
                <div className="wristband-card" style={{ display: 'flex', flexDirection: 'column' }}>
                    <div className="wristband-card-header">#{slot} - {play?.name || 'Empty'}</div>
                    <div style={{ flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '0.25rem', overflow: 'hidden', background: '#fff' }}>
                        {play?.diagramData ? (
                            <svg
                                viewBox="0 0 800 500"
                                width="100%"
                                height="100%"
                                style={{ display: 'block' }}
                                preserveAspectRatio="xMidYMid meet"
                            >
                                <g opacity="0.1">
                                    <line x1="0" y1="10%" x2="100%" y2="10%" stroke="#000" strokeWidth="2" />
                                    <line x1="0" y1="30%" x2="100%" y2="30%" stroke="#000" strokeWidth="2" />
                                    <line x1="0" y1="50%" x2="100%" y2="50%" stroke="#000" strokeWidth="4" />
                                    <line x1="0" y1="70%" x2="100%" y2="70%" stroke="#000" strokeWidth="2" />
                                    <line x1="0" y1="90%" x2="100%" y2="90%" stroke="#000" strokeWidth="2" />
                                </g>
                                {play.diagramData.elements && play.diagramData.elements.map(el => {
                                    if (el.type === 'player') {
                                        const { x, y } = el.points[0];
                                        const size = 30;
                                        const isRect = el.shape === 'square';
                                        return (
                                            <g key={el.id}>
                                                {isRect ? (
                                                    <rect x={x - size / 2} y={y - size / 2} width={size} height={size} fill="white" stroke={el.color} strokeWidth="2" />
                                                ) : (
                                                    <circle cx={x} cy={y} r={size / 2} fill="white" stroke={el.color} strokeWidth="2" />
                                                )}
                                                <text x={x} y={y} dy="0.35em" textAnchor="middle" fontSize="16" fontWeight="bold" fill={el.color}>{el.label}</text>
                                            </g>
                                        );
                                    }

                                    let d = '';
                                    if (el.style === 'zigzag') {
                                        d = getZigZagPath(el.points);
                                    } else if (el.type === 'free' || el.points.length > 1) {
                                        d = `M ${el.points.map(p => `${p.x},${p.y}`).join(' L ')}`;
                                    }

                                    let markerEnd = undefined;
                                    let tBlock = null;

                                    if (el.endType === 'arrow' || (!el.endType && el.type !== 'free')) {
                                        markerEnd = `url(#arrowhead-${el.color})`;
                                    } else if (el.endType === 't') {
                                        const end = el.points[el.points.length - 1];
                                        const prev = el.points[el.points.length - 2] || el.points[0];
                                        const dx = end.x - prev.x;
                                        const dy = end.y - prev.y;
                                        const len = Math.hypot(dx, dy) || 1;
                                        // Thicker/Bigger T for wristband
                                        const perpX = (-dy / len) * 20;
                                        const perpY = (dx / len) * 20;
                                        tBlock = (
                                            <line
                                                x1={end.x - perpX} y1={end.y - perpY}
                                                x2={end.x + perpX} y2={end.y + perpY}
                                                stroke={el.color}
                                                strokeWidth="8"
                                            />
                                        );
                                    } else if (el.endType === 'dot') {
                                        const end = el.points[el.points.length - 1];
                                        tBlock = (
                                            <circle cx={end.x} cy={end.y} r="10" fill={el.color} />
                                        );
                                    } else if (el.endType === 'none') {
                                        markerEnd = undefined;
                                    } else if (el.type === 'arrow') {
                                        markerEnd = `url(#arrowhead-${el.color})`;
                                    }

                                    return (
                                        <g key={el.id}>
                                            <path
                                                d={d}
                                                stroke={el.color}
                                                strokeWidth="8"
                                                fill="none"
                                                strokeDasharray={el.style === 'dashed' ? "10,5" : "none"}
                                                markerEnd={markerEnd}
                                            />
                                            {tBlock}
                                        </g>
                                    );
                                })}
                            </svg>
                        ) : play?.image ? (
                            <img src={play.image} style={{ maxWidth: '100%', maxHeight: '100%', objectFit: 'contain' }} />
                        ) : (
                            <div style={{ color: '#ccc', fontSize: '0.8rem' }}>No Diagram</div>
                        )}
                    </div>
                    {play && (
                        <div style={{ padding: '0.25rem', fontSize: '0.7rem', textAlign: 'center', borderTop: '1px solid #eee' }}>
                            {play.formation} ‚Ä¢ {play.tags.join(', ')}
                        </div>
                    )}
                </div>
            );
        };

        const WristbandBuilder = ({ plays, onUpdatePlay }) => {
            const [mode, setMode] = useState('text'); // 'text' (100-299) or 'rooski' (300+)
            const [selectedPlayId, setSelectedPlayId] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');

            // Filter plays for the sidebar list
            const filteredPlays = useMemo(() => {
                return plays.filter(p =>
                    p.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    p.formation.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [plays, searchTerm]);

            // Group plays by slot for easy lookup
            const slotMap = useMemo(() => {
                const map = {};
                plays.forEach(p => {
                    if (p.wristbandSlot) map[p.wristbandSlot] = p;
                });
                return map;
            }, [plays]);

            const handleAssignSlot = (slot) => {
                if (!selectedPlayId) return;
                const play = plays.find(p => p.id === selectedPlayId);
                if (play) {
                    // Update play with new slot
                    onUpdatePlay({ ...play, wristbandSlot: slot.toString() });
                    setSelectedPlayId(null); // Deselect after assignment
                }
            };

            const handleClearSlot = (play) => {
                onUpdatePlay({ ...play, wristbandSlot: '' });
            };

            // Generate grid slots based on mode
            const slots = [];
            if (mode === 'text') {
                // 100s and 200s
                for (let i = 101; i <= 148; i++) slots.push(i);
                for (let i = 201; i <= 248; i++) slots.push(i);
            } else {
                // 300s and 400s (Rooski)
                for (let i = 301; i <= 312; i++) slots.push(i); // Example range
                for (let i = 401; i <= 412; i++) slots.push(i);
            }

            const diagramSlots = Object.keys(slotMap)
                .map(Number)
                .filter(n => n >= 300)
                .sort((a, b) => a - b);

            const handleExportToClipboard = () => {
                const lines = ['Slot\tPlay Name\tFormation\tConcept\tPrimary Tag'];
                const sortedSlots = Object.keys(slotMap).sort((a, b) => Number(a) - Number(b));

                sortedSlots.forEach(slot => {
                    const play = slotMap[slot];
                    // Format tags - get just the first one or primary
                    let tagStr = '';
                    if (play.tags && play.tags.length > 0) {
                        tagStr = play.tags[0].name || play.tags[0];
                    }

                    lines.push(`${slot}\t${play.name}\t${play.formation}\t${play.concept || ''}\t${tagStr}`);
                });

                const text = lines.join('\n');
                navigator.clipboard.writeText(text).then(() => {
                    alert('Wristband data copied to clipboard! You can now paste it directly into Google Sheets or Excel.');
                });
            };

            return (
                <div style={{ display: 'flex', height: 'calc(100vh - 100px)', gap: '2rem' }}>
                    {/* Left: Play Picker */}
                    <div style={{ width: '300px', display: 'flex', flexDirection: 'column', borderRight: '1px solid var(--border)', paddingRight: '1rem' }}>
                        <h3 style={{ marginBottom: '1rem' }}>Available Plays</h3>
                        <input
                            className="form-input"
                            placeholder="Search plays..."
                            value={searchTerm}
                            onChange={e => setSearchTerm(e.target.value)}
                            style={{ marginBottom: '1rem' }}
                        />
                        <div style={{ flex: 1, overflowY: 'auto', display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                            {filteredPlays.map(play => (
                                <div
                                    key={play.id}
                                    onClick={() => setSelectedPlayId(play.id)}
                                    style={{
                                        padding: '0.75rem',
                                        borderRadius: 'var(--radius)',
                                        border: '1px solid',
                                        borderColor: selectedPlayId === play.id ? 'var(--accent)' : 'var(--border)',
                                        backgroundColor: selectedPlayId === play.id ? 'rgba(56, 189, 248, 0.1)' : 'var(--bg-panel)',
                                        cursor: 'pointer',
                                        opacity: play.wristbandSlot ? 0.5 : 1
                                    }}
                                >
                                    <div style={{ fontWeight: 'bold', fontSize: '0.9rem' }}>{play.name}</div>
                                    <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>
                                        {play.formation}
                                        {play.wristbandSlot && <span style={{ marginLeft: '0.5rem', color: 'var(--accent)' }}>#{play.wristbandSlot}</span>}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Right: Wristband Grid */}
                    <div style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                            <div style={{ display: 'flex', gap: '1rem' }}>
                                <button
                                    className={`btn ${mode === 'text' ? 'btn-primary' : 'btn-secondary'}`}
                                    onClick={() => setMode('text')}
                                >
                                    Text Wristband (100-200)
                                </button>
                                <button
                                    className={`btn ${mode === 'rooski' ? 'btn-primary' : 'btn-secondary'}`}
                                    onClick={() => setMode('rooski')}
                                >
                                    Rooski / Diagrams (300+)
                                </button>
                            </div>
                            <div style={{ display: 'flex', gap: '0.5rem' }}>
                                <button className="btn btn-secondary" onClick={handleExportToClipboard}>
                                    <Icon name="Clipboard" size={16} style={{ marginRight: '6px' }} />
                                    Copy for Sheets
                                </button>
                                <button className="btn btn-secondary" onClick={() => window.print()}>üñ®Ô∏è Print</button>
                            </div>
                        </div>

                        <div style={{ flex: 1, overflowY: 'auto', display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(140px, 1fr))', gap: '0.5rem', alignContent: 'start' }}>
                            {slots.map(slot => {
                                const play = slotMap[slot];
                                return (
                                    <div
                                        key={slot}
                                        onClick={() => play ? handleClearSlot(play) : handleAssignSlot(slot)}
                                        style={{
                                            border: '1px solid var(--border)',
                                            borderRadius: 'var(--radius)',
                                            padding: '0.5rem',
                                            backgroundColor: play ? 'rgba(56, 189, 248, 0.1)' : 'var(--bg-panel)',
                                            cursor: 'pointer',
                                            minHeight: '80px',
                                            display: 'flex',
                                            flexDirection: 'column',
                                            justifyContent: 'space-between',
                                            borderColor: (selectedPlayId && !play) ? 'var(--accent)' : 'var(--border)',
                                            borderStyle: (selectedPlayId && !play) ? 'dashed' : 'solid'
                                        }}
                                    >
                                        <div style={{ fontWeight: 'bold', color: 'var(--text-secondary)', fontSize: '0.8rem' }}>#{slot}</div>
                                        {play ? (
                                            <>
                                                <div style={{ fontSize: '0.9rem', color: 'var(--text-secondary)', marginBottom: '0.25rem' }}>
                                                    {play.formation} {play.formationTag ? `(${play.formationTag})` : ''}
                                                </div>
                                                <div style={{ fontSize: '1.1rem', fontWeight: 'bold', marginBottom: '0.25rem' }}>
                                                    {play.name}
                                                </div>
                                                {play.concept && (
                                                    <div style={{ fontSize: '0.85rem', color: 'var(--accent)', marginBottom: '0.5rem' }}>
                                                        Concept: {play.concept}
                                                    </div>
                                                )}
                                                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.25rem', marginBottom: '0.5rem' }}>
                                                    {play.tags.map(tag => (
                                                        <span key={tag} style={{ fontSize: '0.7rem', backgroundColor: 'var(--bg-alt)', padding: '0.1rem 0.4rem', borderRadius: 'var(--radius-sm)' }}>
                                                            {tag}
                                                        </span>
                                                    ))}
                                                </div>
                                            </>
                                        ) : (
                                            <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', textAlign: 'center' }}>
                                                {selectedPlayId ? 'Click to Assign' : 'Empty'}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Hidden Print Container */}
                    <div className="wristband-print-container">
                        {/* Card 1: 100s (Green) */}
                        <WristbandPrintCard
                            title="WB 1 (100-148)"
                            start={101}
                            end={148}
                            slotMap={slotMap}
                            colorClass="green"
                        />
                        {/* Card 2: 100s (Green) - Duplicate */}
                        <WristbandPrintCard
                            title="WB 1 (100-148)"
                            start={101}
                            end={148}
                            slotMap={slotMap}
                            colorClass="green"
                        />
                        {/* Card 3: 200s (Orange) */}
                        <WristbandPrintCard
                            title="WB 2 (201-248)"
                            start={201}
                            end={248}
                            slotMap={slotMap}
                            colorClass="orange"
                        />
                        {/* Card 4: 200s (Orange) - Duplicate */}
                        <WristbandPrintCard
                            title="WB 2 (201-248)"
                            start={201}
                            end={248}
                            slotMap={slotMap}
                            colorClass="orange"
                        />

                        {/* Diagram Cards (300s/400s) */}
                        {diagramSlots.map(slot => (
                            <WristbandDiagramCard key={slot} slot={slot} play={slotMap[slot]} />
                        ))}
                    </div>
                </div>
            );
        };

        const PracticeScriptBuilder = ({ mode = 'plan', plays, plans, onUpdatePlans, staff, customFocusItems, addCustomFocusItem }) => {
            const [selectedDay, setSelectedDay] = useState('Monday');
            const [selectedSegmentId, setSelectedSegmentId] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedCoachFilter, setSelectedCoachFilter] = useState('ALL');
            const [selectedNotesCoach, setSelectedNotesCoach] = useState('ALL_COACHES');
            const [showScriptView, setShowScriptView] = useState(false);
            const [isFullScreen, setIsFullScreen] = useState(false);
            const [scoutCardUrls, setScoutCardUrls] = useState({}); // Session-only storage for blob URLs { [segmentId]: string }
            const [includePlayCards, setIncludePlayCards] = useState(false);

            const focusItems = ['Base Downs', 'Convert Downs', 'Red Zone', 'Gold Zone', 'Fringe', 'Goalline/Short YDG', 'Play Action', 'Motion', ...(customFocusItems || [])];

            // Helper function to migrate old notes format to new format
            const isOffenseSegment = (type) => {
                const offenseTypes = ['Team O', '7-on-7', 'Inside Run', 'Competition', 'O FUNDI', 'Take-Off', 'Goal Line', 'Short Yardage'];
                return offenseTypes.includes(type);
            };
            const migrateSegmentNotes = (segment) => {
                if (typeof segment.notes === 'string') {
                    return {
                        ...segment,
                        notes: segment.notes ? { 'ALL_COACHES': segment.notes } : {}
                    };
                }
                return segment;
            };

            const defaultPlan = {
                id: Date.now().toString(),
                date: new Date().toISOString().split('T')[0],
                startTime: '15:40',
                warmupDuration: 5,
                warmupNotes: {},
                warmupScript: [],
                warmupStaffId: '',
                prePracticeNotes: '',
                postPracticeNotes: '',
                segments: []
            };

            const plan = plans[selectedDay] ? { ...defaultPlan, ...plans[selectedDay] } : defaultPlan;

            // Helper to update the specific day's plan
            const updateCurrentPlan = (newPlan) => {
                onUpdatePlans({
                    ...plans,
                    [selectedDay]: newPlan
                });
            };

            // Ensure script slots consistency and calculate times
            // Moved here to be accessible by useEffect
            const ensureScriptSlots = (currentScript, duration, segmentType = '') => {
                const targetCount = Math.round((parseInt(duration) || 0) * 1.6) || 0; // Handle NaN/undefined safely

                const PATTERN_A = ['L', 'LM', 'RM', 'R', 'R', 'RM', 'LM', 'L'];
                const PATTERN_B = ['R', 'RM', 'LM', 'L', 'L', 'LM', 'RM', 'R'];

                // Determine pattern based on existing slots or random choice
                let pattern = Math.random() > 0.5 ? PATTERN_A : PATTERN_B;
                if (currentScript && currentScript.length > 0 && currentScript[0].hash) {
                    if (currentScript[0].hash === 'L') pattern = PATTERN_A;
                    else if (currentScript[0].hash === 'R') pattern = PATTERN_B;
                }

                const GHOST_SEQUENCE = [
                    'COIN TOSS', 'KICKOFF', 'TEAM D', 'PUNT RETURN', 'TEAM O', 'PAT',
                    'BACKED-UP PUNT', 'TEAM D', 'PAT BLOCK', 'KICKOFF RET', 'TEAM O',
                    'PUNT', 'HALFTIME', 'HANDS TEAM', 'HAIL MARY', '2-PT PLAY',
                    'ONSIDE KICK', 'PREVENT DEFENSE', 'VICTORY'
                ];

                // BACKFILL/FIX LOGIC: Ensure segments have yardlines (Take-Off) and hashes (All)
                let processedScript = [...(currentScript || [])];
                const yardlines = ['-30', '-40', '50', '40', '30', '20', '10', '5'];

                processedScript = processedScript.map((slot, i) => {
                    let newSlot = { ...slot };
                    let changed = false;

                    // Fix missing hashes
                    if (!newSlot.hash) {
                        newSlot.hash = pattern[i % 8];
                        changed = true;
                    }

                    // Fix Take-Off yardlines
                    if (segmentType === 'Take-Off') {
                        if (newSlot.yardLine === undefined || newSlot.situation !== undefined) {
                            delete newSlot.situation;
                            newSlot.yardLine = yardlines[i % yardlines.length] || '';
                            newSlot.downDistance = newSlot.downDistance || '';
                            changed = true;
                        }
                    }

                    // Fix Ghost Script situations (if empty and within sequence range)
                    if (segmentType === 'Ghost Script') {
                        if (!newSlot.situation && i < GHOST_SEQUENCE.length) {
                            newSlot.situation = GHOST_SEQUENCE[i];
                            changed = true;
                        }
                    }

                    return changed ? newSlot : slot;
                });

                // For Ghost Script, ensure we at least cover the sequence
                let needed = targetCount - processedScript.length;
                if (segmentType === 'Ghost Script' && processedScript.length < GHOST_SEQUENCE.length) {
                    needed = GHOST_SEQUENCE.length - processedScript.length;
                }

                if (needed <= 0) return processedScript;

                const newSlots = Array(needed).fill(0).map((_, i) => {
                    const slot = {
                        id: Date.now().toString() + Math.random(),
                        playId: '',
                        playName: '',
                        hash: pattern[(processedScript.length + i) % 8]
                    };

                    // For Take-Off segments, use yardLine and downDistance
                    if (segmentType === 'Take-Off') {
                        slot.yardLine = yardlines[(processedScript.length + i) % yardlines.length] || '';
                        slot.downDistance = '';
                    }
                    // For Ghost Script, use sequence
                    else if (segmentType === 'Ghost Script') {
                        const seqIndex = processedScript.length + i;
                        slot.situation = seqIndex < GHOST_SEQUENCE.length ? GHOST_SEQUENCE[seqIndex] : '';
                    }
                    else {
                        slot.situation = '';
                    }

                    return slot;
                });

                return [...processedScript, ...newSlots];
            };

            // Calculate segment times and ensure script consistency automatically
            useEffect(() => {
                if (!plan) return;

                let currentTime = new Date(`2000-01-01T${plan.startTime}`);

                // Add warmup offset
                if (plan.warmupDuration) {
                    currentTime.setMinutes(currentTime.getMinutes() + parseInt(plan.warmupDuration));
                }

                const updatedSegments = plan.segments.map((seg, index) => {
                    // Format as 12-hour time (e.g. 3:40 PM)
                    const segStartTime = currentTime.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });

                    // Add duration for next segment
                    currentTime.setMinutes(currentTime.getMinutes() + parseInt(seg.duration || 0));

                    // Ensure script slots are correct (including Take-Off yardlines)
                    const updatedScript = ensureScriptSlots(seg.script || [], parseInt(seg.duration || 0), seg.type);

                    // Force clear situation/focus for Ghost Script to resolve rendering issues
                    if (seg.type === 'Ghost Script' && seg.situation) {
                        return { ...seg, startTime: segStartTime, script: updatedScript, situation: '' };
                    }

                    return { ...seg, startTime: segStartTime, script: updatedScript };
                });

                // Only update if times actually changed to avoid infinite loop
                if (JSON.stringify(updatedSegments) !== JSON.stringify(plan.segments)) {
                    updateCurrentPlan({ ...plan, segments: updatedSegments });
                }
            }, [plan?.startTime, plan?.warmupDuration, plan?.segments.map(s => s.duration).join(',')]);



            const addSegment = () => {
                const duration = 5;
                const script = ensureScriptSlots([], duration);

                updateCurrentPlan({
                    ...plan,
                    segments: [
                        ...plan.segments,
                        {
                            id: Date.now().toString(),
                            duration,
                            type: 'NEW SEGMENT',
                            situation: '',
                            notes: {},
                            script,
                            staffId: '',
                            hasScript: false,
                            hasScoutCards: false
                        }
                    ]
                });
            };

            const updateSegment = (id, field, value) => {
                if (id === 'WARMUP') {
                    if (field === 'script') updateCurrentPlan({ ...plan, warmupScript: value });
                    if (field === 'staffId') updateCurrentPlan({ ...plan, warmupStaffId: value });
                    return;
                }

                if (field === 'duration') {
                    const segment = plan.segments.find(s => s.id === id);
                    const newScript = ensureScriptSlots(segment.script, value, segment.type);
                    updateCurrentPlan({
                        ...plan,
                        segments: plan.segments.map(s => s.id === id ? { ...s, duration: value, script: newScript } : s)
                    });
                    return;
                }

                // Handle type changes - migrate script when changing to/from Take-Off
                if (field === 'type') {
                    const segment = plan.segments.find(s => s.id === id);
                    const yardlines = ['-30', '-40', '50', '40', '30', '20', '10', '5'];

                    // If changing TO Take-Off, migrate existing script slots
                    if (value === 'Take-Off' && segment.script && segment.script.length > 0) {
                        const migratedScript = segment.script.map((slot, index) => {
                            const newSlot = { ...slot };
                            // Move situation to yardLine if it exists, otherwise use sequence
                            newSlot.yardLine = yardlines[index % yardlines.length] || '';
                            newSlot.downDistance = '';
                            delete newSlot.situation;
                            return newSlot;
                        });

                        updateCurrentPlan({
                            ...plan,
                            segments: plan.segments.map(s => s.id === id ? { ...s, type: value, script: migratedScript } : s)
                        });
                        return;
                    }

                    // If changing FROM Take-Off, migrate back to situation
                    if (segment.type === 'Take-Off' && value !== 'Take-Off' && segment.script && segment.script.length > 0) {
                        const migratedScript = segment.script.map(slot => {
                            const newSlot = { ...slot };
                            newSlot.situation = '';
                            delete newSlot.yardLine;
                            delete newSlot.downDistance;
                            return newSlot;
                        });

                        updateCurrentPlan({
                            ...plan,
                            segments: plan.segments.map(s => s.id === id ? { ...s, type: value, script: migratedScript } : s)
                        });
                        return;
                    }
                }

                updateCurrentPlan({
                    ...plan,
                    segments: plan.segments.map(s => s.id === id ? { ...s, [field]: value } : s)
                });
            };

            // Special handler for notes to support coach-specific notes
            const updateSegmentNotes = (segmentId, coachId, noteText) => {
                if (segmentId === 'WARMUP') {
                    const currentNotes = plan.warmupNotes || {};
                    const updated = { ...currentNotes, [coachId]: noteText };
                    if (!noteText || noteText.trim() === '') {
                        delete updated[coachId];
                    }
                    updateCurrentPlan({ ...plan, warmupNotes: updated });
                    return;
                }

                const segment = plan.segments.find(s => s.id === segmentId);
                const migratedSegment = migrateSegmentNotes(segment);
                const updatedNotes = {
                    ...migratedSegment.notes,
                    [coachId]: noteText
                };
                // If note is empty, remove the key
                if (!noteText || noteText.trim() === '') {
                    delete updatedNotes[coachId];
                }
                updateSegment(segmentId, 'notes', updatedNotes);
            };

            const removeSegment = (id) => {
                updateCurrentPlan({
                    ...plan,
                    segments: plan.segments.filter(s => s.id !== id)
                });
            };

            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];

            if (mode === 'script') {
                const scriptedSegments = plan.segments.filter(s => s.hasScript && s.script && s.script.length > 0);
                // Also check warmup
                if (plan.warmupHasScript && plan.warmupScript && plan.warmupScript.length > 0) {
                    scriptedSegments.unshift({
                        id: 'WARMUP',
                        type: 'Warmup',
                        duration: plan.warmupDuration,
                        hasScript: true,
                        script: plan.warmupScript,
                        startTime: plan.startTime // Approximate, start of practice
                    });
                }

                return (
                    <div style={{ display: 'flex', flexDirection: 'column', height: 'calc(100vh - 100px)' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem', borderBottom: '1px solid var(--border)', paddingBottom: '0.5rem' }}>
                            <div style={{ display: 'flex', gap: '0.5rem' }}>
                                {days.map(day => (
                                    <button
                                        key={day}
                                        className={`btn ${selectedDay === day ? 'btn-primary' : 'btn-secondary'}`}
                                        onClick={() => setSelectedDay(day)}
                                    >
                                        {day}
                                    </button>
                                ))}
                            </div>
                            <button className="btn btn-secondary" onClick={() => window.print()}>üñ®Ô∏è Print Scripts</button>
                        </div>

                        <div className="script-grid-container" style={{ flex: 1, overflowY: 'auto', padding: '1rem', display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(450px, 1fr))', gap: '2rem', alignContent: 'start' }}>
                            {scriptedSegments.length === 0 && (
                                <div style={{ gridColumn: '1 / -1', textAlign: 'center', padding: '3rem', color: 'var(--text-secondary)' }}>
                                    No scripted segments for this day. Go to the "Plans" tab to enable scripting for segments.
                                </div>
                            )}
                            {scriptedSegments.map(seg => (
                                <div key={seg.id} style={{ border: '2px solid black', breakInside: 'avoid', pageBreakInside: 'avoid', backgroundColor: 'white' }}>
                                    <div style={{
                                        backgroundColor: '#e2e8f0',
                                        padding: '0.5rem',
                                        borderBottom: '2px solid black',
                                        fontWeight: 'bold',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center'
                                    }}>
                                        <div>
                                            <span style={{ marginRight: '1rem' }}>{seg.startTime || ''}</span>
                                            <span style={{ textTransform: 'uppercase' }}>{seg.type}</span>
                                        </div>
                                        <div>
                                            {/* Display "SIT." based on focus item if present, else just duration */}
                                            {seg.situation && <span style={{ marginRight: '1rem', fontStyle: 'italic', fontSize: '0.9em' }}>{seg.situation}</span>}
                                            <span style={{ fontSize: '0.9em' }}>{seg.duration} MIN</span>
                                        </div>
                                    </div>
                                    <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '0.85rem' }}>
                                        <thead>
                                            <tr style={{ borderBottom: '1px solid black', backgroundColor: '#f8fafc' }}>
                                                <th style={{ textAlign: 'center', padding: '4px', borderRight: '1px solid #ccc', width: '30px' }}>#</th>
                                                <th style={{ textAlign: 'center', padding: '4px', borderRight: '1px solid #ccc', width: '30px' }}>H</th>
                                                {seg.type === 'Take-Off' && <th style={{ textAlign: 'left', padding: '4px', borderRight: '1px solid #ccc' }}>YARD</th>}
                                                {seg.type !== 'Take-Off' && seg.type !== 'Ghost Script' && <th style={{ textAlign: 'left', padding: '4px', borderRight: '1px solid #ccc' }}>SIT.</th>}
                                                <th style={{ textAlign: 'left', padding: '4px', borderRight: '1px solid #ccc' }}>PLAY / CALL</th>
                                                {isOffenseSegment(seg.type) && <th style={{ textAlign: 'left', padding: '4px', borderRight: '1px solid #ccc' }}>DEFENSE</th>}
                                                <th style={{ textAlign: 'left', padding: '4px' }}>NOTES</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {/* Ensure slots are populated even if just enabled but not opened in modal yet */}
                                            {ensureScriptSlots(seg.script, parseInt(seg.duration || 0), seg.type).map((slot, idx) => (
                                                <tr key={idx} style={{ borderBottom: '1px solid #ddd' }}>
                                                    <td style={{ textAlign: 'center', padding: '4px', borderRight: '1px solid #ccc', fontWeight: 'bold' }}>{idx + 1}</td>
                                                    <td style={{ textAlign: 'center', padding: '4px', borderRight: '1px solid #ccc' }}>{slot.hash}</td>
                                                    {seg.type === 'Take-Off' && <td style={{ textAlign: 'center', padding: '4px', borderRight: '1px solid #ccc' }}>{slot.yardLine}</td>}
                                                    {seg.type !== 'Take-Off' && seg.type !== 'Ghost Script' && <td style={{ textAlign: 'left', padding: '4px', borderRight: '1px solid #ccc', whiteSpace: 'nowrap' }}>{slot.situation}</td>}
                                                    <td style={{ textAlign: 'left', padding: '4px', borderRight: '1px solid #ccc', fontWeight: 'bold' }}>{slot.playName}</td>
                                                    {isOffenseSegment(seg.type) && <td style={{ textAlign: 'left', padding: '4px', borderRight: '1px solid #ccc' }}>{slot.defense}</td>}
                                                    <td style={{ textAlign: 'left', padding: '4px' }}>{slot.notes}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }

            return (
                <div style={{ display: 'flex', flexDirection: 'column', height: 'calc(100vh - 100px)' }}>
                    {/* Day Tabs */}
                    <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem', borderBottom: '1px solid var(--border)', paddingBottom: '0.5rem' }}>
                        {days.map(day => (
                            <button
                                key={day}
                                className={`btn ${selectedDay === day ? 'btn-primary' : 'btn-secondary'}`}
                                onClick={() => { setSelectedDay(day); setSelectedSegmentId(null); }}
                            >
                                {day}
                            </button>
                        ))}
                    </div>

                    <div className="practice-flex-container" style={{ display: 'flex', flex: 1, overflow: 'hidden' }}>
                        {/* Left: Schedule View */}
                        <div style={{ flex: 1, display: 'flex', flexDirection: 'column', overflowY: 'auto' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                                <h2>{selectedDay} Schedule</h2>
                                <div style={{ display: 'flex', gap: '1rem', alignItems: 'center' }}>
                                    <label>Start Time:</label>
                                    <input
                                        type="time"
                                        className="form-input"
                                        style={{ width: 'auto' }}
                                        value={plan.startTime}
                                        onChange={e => updateCurrentPlan({ ...plan, startTime: e.target.value })}
                                    />
                                    <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                                        <select
                                            className="form-select"
                                            style={{ width: 'auto', padding: '0.25rem 0.5rem' }}
                                            value={selectedCoachFilter}
                                            onChange={e => setSelectedCoachFilter(e.target.value)}
                                        >
                                            <option value="ALL">All Staff</option>
                                            {staff && staff.map(s => (
                                                <option key={s.id} value={s.id}>{s.name}</option>
                                            ))}
                                        </select>

                                        {/* "Include Play Cards" Checkbox - Only for Scout Offense/Defense */}
                                        {(() => {
                                            const coach = staff?.find(s => s.id === selectedCoachFilter);
                                            // Show if coach has Scout Offense or Defense duties
                                            // Or if no specific coach selected (shows for everyone potentially, or hide it? Let's hide if ALL)
                                            if (selectedCoachFilter === 'ALL') return null;

                                            const isScoutOffense = coach?.duties?.some(d => d.includes('Scout Offense') || d.includes('Scout Offensive'));
                                            const isDefense = coach?.duties?.some(d => d.includes('Defensive') || d.includes('Defense'));

                                            // Also check position groups if duties aren't explicit
                                            const isDefensePos = coach?.positions?.defense;

                                            if (isScoutOffense || isDefense || isDefensePos) {
                                                return (
                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.25rem', backgroundColor: 'var(--bg-panel)', padding: '0.25rem 0.5rem', borderRadius: '4px', border: '1px solid var(--border)' }}>
                                                        <input
                                                            type="checkbox"
                                                            checked={includePlayCards}
                                                            onChange={e => setIncludePlayCards(e.target.checked)}
                                                            id="print-cards-check"
                                                            style={{ cursor: 'pointer' }}
                                                        />
                                                        <label htmlFor="print-cards-check" style={{ fontSize: '0.85rem', cursor: 'pointer', userSelect: 'none' }}>Include Play Cards</label>
                                                    </div>
                                                );
                                            }
                                            return null;
                                        })()}

                                        <button className="btn btn-secondary" onClick={() => {
                                            // Print Logic
                                            if (typeof includePlayCards !== 'undefined' && includePlayCards) {
                                                // Find all segments visible to this coach
                                                const visibleSegments = plan.segments.filter(seg => selectedCoachFilter === 'ALL' || seg.staffId === selectedCoachFilter);

                                                // Collect unique URLs
                                                const urlsToOpen = new Set();
                                                visibleSegments.forEach(seg => {
                                                    if (scoutCardUrls[seg.id]) {
                                                        urlsToOpen.add(scoutCardUrls[seg.id]);
                                                    }
                                                });

                                                if (plan.warmupScoutCard && scoutCardUrls['WARMUP'] && (selectedCoachFilter === 'ALL' || plan.warmupStaffId === selectedCoachFilter)) {
                                                    urlsToOpen.add(scoutCardUrls['WARMUP']);
                                                }

                                                // Open each in new tab
                                                urlsToOpen.forEach(url => window.open(url, '_blank'));
                                            }
                                            window.print();
                                        }}>üñ®Ô∏è Print</button>
                                    </div>
                                </div>
                            </div>

                            {/* Coach Notes Selector */}
                            <div style={{ marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                <label style={{ fontWeight: 'bold' }}>Notes for:</label>
                                <select
                                    className="form-select"
                                    style={{ width: 'auto' }}
                                    value={selectedNotesCoach}
                                    onChange={e => setSelectedNotesCoach(e.target.value)}
                                >
                                    <option value="ALL_COACHES">All Coaches</option>
                                    {staff && staff.map(s => (
                                        <option key={s.id} value={s.id}>{s.name}</option>
                                    ))}
                                </select>
                            </div>

                            {/* Pre-Practice Notes */}
                            <div style={{ marginBottom: '1rem' }}>
                                <label style={{ fontWeight: 'bold', display: 'block', marginBottom: '0.25rem' }}>Pre-Practice Notes:</label>
                                <textarea
                                    className="form-input"
                                    style={{ width: '100%', minHeight: '60px', fontFamily: 'inherit' }}
                                    value={plan.prePracticeNotes || ''}
                                    onChange={e => updateCurrentPlan({ ...plan, prePracticeNotes: e.target.value })}
                                    placeholder="Announcements, weather, focus points..."
                                />
                            </div>


                            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '0.9rem' }}>
                                <thead>
                                    <tr style={{ borderBottom: '2px solid var(--border)', textAlign: 'left' }}>
                                        <th style={{ padding: '0.5rem' }}>#</th>
                                        <th style={{ padding: '0.5rem' }}>Time</th>
                                        <th style={{ padding: '0.5rem' }}>Dur</th>
                                        <th style={{ padding: '0.5rem' }}>Type</th>
                                        <th style={{ padding: '0.5rem' }}>Focus</th>
                                        <th style={{ padding: '0.5rem' }}>Contact</th>
                                        <th style={{ padding: '0.5rem' }}>Notes</th>
                                        <th style={{ padding: '0.5rem' }}>Script</th>
                                        <th className="no-print" style={{ padding: '0.5rem' }}>Scout Cards</th>
                                        <th className="no-print" style={{ padding: '0.5rem' }}>Delete</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {/* Warmup Row */}
                                    <tr
                                        style={{
                                            borderBottom: '1px solid var(--border)',
                                            backgroundColor: selectedSegmentId === 'WARMUP' ? 'rgba(56, 189, 248, 0.1)' : 'rgba(255, 255, 255, 0.02)',
                                            cursor: 'pointer'
                                        }}
                                        onClick={() => setSelectedSegmentId('WARMUP')}
                                    >
                                        <td style={{ padding: '0.5rem', fontWeight: 'bold', color: 'var(--accent)' }}>0</td>
                                        <td style={{ padding: '0.5rem' }}>
                                            {plan.startTime ? new Date(`2000-01-01T${plan.startTime}`).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true }) : ''}
                                        </td>
                                        <td style={{ padding: '0.5rem' }}>
                                            <input
                                                type="number"
                                                className="form-input"
                                                style={{ width: '50px', padding: '0.25rem' }}
                                                value={plan.warmupDuration || 0}
                                                onChange={e => updateCurrentPlan({ ...plan, warmupDuration: parseInt(e.target.value) || 0 })}
                                                onClick={e => e.stopPropagation()}
                                            />
                                        </td>
                                        <td style={{ padding: '0.5rem', fontStyle: 'italic' }}>Warmup</td>
                                        <td style={{ padding: '0.5rem' }}>
                                            <select
                                                className="form-select"
                                                style={{ padding: '0.25rem' }}
                                                value={plan.warmupSituation || ''}
                                                onChange={e => {
                                                    if (e.target.value === '__ADD_CUSTOM__') {
                                                        const customItem = prompt('Enter custom focus item:');
                                                        if (customItem && customItem.trim()) {
                                                            addCustomFocusItem(customItem.trim());
                                                            updateCurrentPlan({ ...plan, warmupSituation: customItem.trim() });
                                                        }
                                                    } else {
                                                        updateCurrentPlan({ ...plan, warmupSituation: e.target.value });
                                                    }
                                                }}
                                                onClick={e => e.stopPropagation()}
                                            >
                                                <option value="">-- Select Focus --</option>
                                                {['Base Downs', 'Convert Downs', 'Red Zone', 'Gold Zone', 'Fringe', 'Goalline/Short YDG', 'Play Action', 'Motion', ...customFocusItems].map(f => (
                                                    <option key={f} value={f}>{f}</option>
                                                ))}
                                                <option value="__ADD_CUSTOM__" style={{ fontStyle: 'italic', color: 'var(--accent)' }}>+ Add Custom...</option>
                                            </select>
                                        </td>
                                        <td style={{ padding: '0.5rem' }}>
                                            <select
                                                className="form-select"
                                                style={{ padding: '0.25rem', width: '90px' }}
                                                value={plan.warmupContact || ''}
                                                onChange={e => updateCurrentPlan({ ...plan, warmupContact: e.target.value })}
                                                onClick={e => e.stopPropagation()}
                                            >
                                                <option value="">--</option>
                                                <option value="Touch">Touch</option>
                                                <option value="Thud">Thud</option>
                                                <option value="Bird-Dog">Bird-Dog</option>
                                                <option value="ON AIR">ON AIR</option>
                                                <option value="Slight Resist">Slight Resist</option>
                                                <option value="Live">Live</option>
                                            </select>
                                        </td>
                                        <td style={{ padding: '0.5rem' }}>
                                            <input
                                                key={`warmup-notes-${selectedNotesCoach}`}
                                                className="form-input"
                                                style={{ padding: '0.25rem' }}
                                                value={plan.warmupNotes?.[selectedNotesCoach] || ''}
                                                onChange={e => updateSegmentNotes('WARMUP', selectedNotesCoach, e.target.value)}
                                                onClick={e => e.stopPropagation()}
                                                placeholder={selectedNotesCoach === 'ALL_COACHES' ? 'Notes...' : `Notes...`}
                                            />
                                        </td>
                                        <td style={{ padding: '0.5rem', textAlign: 'center' }}>
                                            {plan.warmupHasScript ? (
                                                <div style={{ display: 'flex', gap: '0.25rem', justifyContent: 'center', alignItems: 'center' }}>
                                                    <button
                                                        className="btn btn-primary"
                                                        style={{ padding: '0.25rem 0.5rem', fontSize: '0.8rem' }}
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            setSelectedSegmentId('WARMUP');
                                                            setShowScriptView(true);
                                                        }}
                                                    >
                                                        See Script
                                                    </button>
                                                    <button
                                                        className="btn"
                                                        style={{ padding: '0.25rem 0.4rem', fontSize: '0.7rem', color: '#ef4444' }}
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            if (confirm('Disable scripting for warmup? This will clear the script.')) {
                                                                updateCurrentPlan({ ...plan, warmupHasScript: false, warmupScript: [] });
                                                                if (selectedSegmentId === 'WARMUP') {
                                                                    setSelectedSegmentId(null);
                                                                }
                                                            }
                                                        }}
                                                        title="Disable scripting"
                                                    >
                                                        √ó
                                                    </button>
                                                </div>
                                            ) : (
                                                <input
                                                    type="checkbox"
                                                    checked={false}
                                                    onChange={e => {
                                                        updateCurrentPlan({ ...plan, warmupHasScript: e.target.checked });
                                                        if (e.target.checked) {
                                                            setSelectedSegmentId('WARMUP');
                                                            setShowScriptView(true);
                                                        }
                                                    }}
                                                    onClick={e => e.stopPropagation()}
                                                    style={{ cursor: 'pointer' }}
                                                />
                                            )}
                                        </td>
                                        <td className="no-print" style={{ padding: '0.5rem', textAlign: 'center' }}>
                                            <input
                                                type="file"
                                                id="warmup-scout-card"
                                                style={{ display: 'none' }}
                                                accept="application/pdf"
                                                onChange={(e) => {
                                                    const file = e.target.files[0];
                                                    if (file) {
                                                        const url = URL.createObjectURL(file);
                                                        setScoutCardUrls(prev => ({ ...prev, WARMUP: url }));
                                                        updateCurrentPlan({
                                                            ...plan,
                                                            warmupScoutCard: { name: file.name }
                                                        });
                                                    }
                                                }}
                                            />
                                            <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '0.25rem' }}>
                                                <button
                                                    className="btn btn-secondary"
                                                    style={{ padding: '0.25rem 0.5rem', fontSize: '0.7rem' }}
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        document.getElementById('warmup-scout-card').click();
                                                    }}
                                                    title="Upload PDF Card"
                                                >
                                                    {plan.warmupScoutCard ? 'üìé Replace' : 'üìé Upload'}
                                                </button>
                                                {plan.warmupScoutCard && (
                                                    <div style={{ fontSize: '0.7rem', maxWidth: '100px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                                        {scoutCardUrls['WARMUP'] ? (
                                                            <a
                                                                href={scoutCardUrls['WARMUP']}
                                                                target="_blank"
                                                                rel="noopener noreferrer"
                                                                onClick={e => e.stopPropagation()}
                                                                style={{ color: 'var(--accent)', textDecoration: 'none' }}
                                                            >
                                                                {plan.warmupScoutCard.name}
                                                            </a>
                                                        ) : (
                                                            <span style={{ color: 'var(--text-secondary)', cursor: 'help' }} title="File lost on refresh. Re-upload to view.">
                                                                {plan.warmupScoutCard.name}
                                                            </span>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        </td>
                                        <td className="no-print" style={{ padding: '0.5rem' }}></td>
                                    </tr>

                                    {plan.segments
                                        .map((seg, index) => (
                                            <tr
                                                key={seg.id}
                                                style={{
                                                    borderBottom: '1px solid var(--border)',
                                                    backgroundColor: selectedSegmentId === seg.id ? 'rgba(56, 189, 248, 0.1)' : 'transparent',
                                                    cursor: 'pointer'
                                                }}
                                                onClick={() => setSelectedSegmentId(seg.id)}
                                            >
                                                <td style={{ padding: '0.5rem', fontWeight: 'bold', color: 'var(--accent)' }}>
                                                    {index + 1}
                                                </td>
                                                <td style={{ padding: '0.5rem' }}>{seg.startTime}</td>
                                                <td style={{ padding: '0.5rem' }}>
                                                    <span className="print-only-text screen-hidden">{seg.duration}</span>
                                                    <input
                                                        type="number"
                                                        className="form-input no-print"
                                                        style={{ width: '60px', padding: '0.25rem' }}
                                                        value={seg.duration}
                                                        onChange={e => updateSegment(seg.id, 'duration', parseInt(e.target.value))}
                                                        onClick={e => e.stopPropagation()}
                                                    />
                                                </td>
                                                <td style={{ padding: '0.5rem' }}>
                                                    <span className="print-only-text screen-hidden">{seg.type}</span>
                                                    <select
                                                        className="form-select no-print"
                                                        style={{ width: '130px', padding: '0.25rem' }}
                                                        value={seg.type}
                                                        onChange={e => {
                                                            const newType = e.target.value;
                                                            if (newType === 'Ghost Script') {
                                                                const ghostSequence = [
                                                                    'COIN TOSS', 'KICKOFF', 'TEAM D', 'PUNT RETURN', 'TEAM O', 'PAT',
                                                                    'BACKED-UP PUNT', 'TEAM D', 'PAT BLOCK', 'KICKOFF RET', 'TEAM O',
                                                                    'PUNT', 'HALFTIME', 'HANDS TEAM', 'HAIL MARY', '2-PT PLAY',
                                                                    'ONSIDE KICK', 'PREVENT DEFENSE', 'VICTORY'
                                                                ];

                                                                const PATTERN_A = ['L', 'LM', 'RM', 'R', 'R', 'RM', 'LM', 'L'];
                                                                const PATTERN_B = ['R', 'RM', 'LM', 'L', 'L', 'LM', 'RM', 'R'];
                                                                const pattern = Math.random() > 0.5 ? PATTERN_A : PATTERN_B;

                                                                const ghostScript = ghostSequence.map((situation, i) => ({
                                                                    id: Date.now().toString() + i,
                                                                    playId: '',
                                                                    playName: '',
                                                                    hash: pattern[i % 8],
                                                                    situation: situation
                                                                }));

                                                                updateCurrentPlan({
                                                                    ...plan,
                                                                    segments: plan.segments.map(s => s.id === seg.id ? {
                                                                        ...s,
                                                                        type: newType,
                                                                        hasScript: true,
                                                                        script: ghostScript,
                                                                        situation: '' // Clear focus to avoid 3rd down dropdown logic interactions
                                                                    } : s)
                                                                });
                                                            } else {
                                                                updateSegment(seg.id, 'type', newType);
                                                            }
                                                        }}
                                                        onClick={e => e.stopPropagation()}
                                                    >
                                                        <option value="">-- Select Type --</option>
                                                        {['Competition', 'O FUNDI', 'D FUNDI', '7-on-7', 'Def. 7-on-7', 'Team O', 'Team D', 'Kickoff', 'Kick Return', 'Punt', 'Punt Return', 'Inside Run', 'Field Goal', 'Conditioning', 'Take-Off', 'Ghost Script', 'One-on-Ones', 'Tackling', 'Turnover', 'Specials'].map(t => (
                                                            <option key={t} value={t}>{t}</option>
                                                        ))}
                                                    </select>
                                                </td>
                                                <td style={{ padding: '0.5rem' }}>
                                                    <span className="print-only-text screen-hidden">{seg.situation}</span>
                                                    <select
                                                        className="form-select no-print"
                                                        style={{ padding: '0.25rem' }}
                                                        value={seg.situation || ''}
                                                        onChange={e => {
                                                            if (e.target.value === '__ADD_CUSTOM__') {
                                                                const customItem = prompt('Enter custom focus item:');
                                                                if (customItem && customItem.trim()) {
                                                                    addCustomFocusItem(customItem.trim());
                                                                    updateSegment(seg.id, 'situation', customItem.trim());
                                                                }
                                                            } else {
                                                                updateSegment(seg.id, 'situation', e.target.value);
                                                            }
                                                        }}
                                                        onClick={e => e.stopPropagation()}
                                                    >
                                                        <option value="">-- Focus --</option>
                                                        {focusItems.map(item => (
                                                            <option key={item} value={item}>{item}</option>
                                                        ))}
                                                        <option value="__ADD_CUSTOM__" style={{ fontStyle: 'italic', color: 'var(--accent)' }}>+ Add Custom...</option>
                                                    </select>
                                                </td>
                                                <td style={{ padding: '0.5rem' }}>
                                                    <span className="print-only-text screen-hidden">{seg.contactLevel}</span>
                                                    <select
                                                        className="form-select no-print"
                                                        style={{ padding: '0.25rem', width: '90px' }}
                                                        value={seg.contactLevel || ''}
                                                        onChange={e => updateSegment(seg.id, 'contactLevel', e.target.value)}
                                                        onClick={e => e.stopPropagation()}
                                                    >
                                                        <option value="">--</option>
                                                        <option value="Touch">Touch</option>
                                                        <option value="Thud">Thud</option>
                                                        <option value="Bird-Dog">Bird-Dog</option>
                                                        <option value="ON AIR">ON AIR</option>
                                                        <option value="Slight Resist">Slight Resist</option>
                                                        <option value="Live">Live</option>
                                                    </select>
                                                </td>
                                                <td style={{ padding: '0.5rem', whiteSpace: 'pre-wrap' }}>
                                                    {(() => {
                                                        const migrated = migrateSegmentNotes(seg);
                                                        const allNotes = migrated.notes['ALL_COACHES'];
                                                        const coachNotes = selectedNotesCoach !== 'ALL_COACHES' ? migrated.notes[selectedNotesCoach] : null;

                                                        // Interactive Input for editing
                                                        return (
                                                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.25rem' }}>
                                                                {/* Display All Coaches Notes (ReadOnly in this context if we are specific coach? Or just displayed above) */}
                                                                {selectedNotesCoach !== 'ALL_COACHES' && allNotes && (
                                                                    <div style={{ fontSize: '0.85rem', paddingBottom: '0.25rem', borderBottom: '1px dashed var(--border)' }}>
                                                                        <span style={{ fontWeight: 'bold', fontSize: '0.7rem', color: 'var(--text-secondary)', display: 'block' }}>ALL:</span>
                                                                        {allNotes}
                                                                    </div>
                                                                )}

                                                                <input
                                                                    key={`seg-${seg.id}-notes-${selectedNotesCoach}`}
                                                                    className="form-input"
                                                                    style={{ padding: '0.25rem' }}
                                                                    value={migrated.notes[selectedNotesCoach] || ''}
                                                                    onChange={e => updateSegmentNotes(seg.id, selectedNotesCoach, e.target.value)}
                                                                    onClick={e => e.stopPropagation()}
                                                                    placeholder={selectedNotesCoach === 'ALL_COACHES' ? 'Notes for all coaches...' : `Notes for ${staff?.find(s => s.id === selectedNotesCoach)?.name || 'this coach'}...`}
                                                                />
                                                            </div>
                                                        );
                                                    })()}
                                                </td>
                                                <td style={{ padding: '0.5rem', textAlign: 'center' }}>
                                                    {seg.hasScript ? (
                                                        <div style={{ display: 'flex', gap: '0.25rem', justifyContent: 'center', alignItems: 'center' }}>
                                                            <button
                                                                className="btn btn-primary"
                                                                style={{ padding: '0.25rem 0.5rem', fontSize: '0.8rem' }}
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    setSelectedSegmentId(seg.id);
                                                                    setShowScriptView(true);
                                                                }}
                                                            >
                                                                See Script
                                                            </button>
                                                            <button
                                                                className="btn"
                                                                style={{ padding: '0.25rem 0.4rem', fontSize: '0.7rem', color: '#ef4444' }}
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    if (confirm('Disable scripting for this segment? This will clear the script.')) {
                                                                        // Perform single atomic update to avoid race condition
                                                                        updateCurrentPlan({
                                                                            ...plan,
                                                                            segments: plan.segments.map(s => s.id === seg.id ? { ...s, hasScript: false, script: [] } : s)
                                                                        });

                                                                        if (selectedSegmentId === seg.id) {
                                                                            setSelectedSegmentId(null);
                                                                        }
                                                                    }
                                                                }}
                                                                title="Disable scripting"
                                                            >
                                                                √ó
                                                            </button>
                                                        </div>
                                                    ) : (
                                                        <input
                                                            type="checkbox"
                                                            checked={false}
                                                            onChange={e => {
                                                                if (e.target.checked) {
                                                                    // Atomically enable script AND populate slots based on duration/type
                                                                    const initializedScript = ensureScriptSlots([], parseInt(seg.duration || 0), seg.type);

                                                                    updateCurrentPlan({
                                                                        ...plan,
                                                                        segments: plan.segments.map(s => s.id === seg.id ? {
                                                                            ...s,
                                                                            hasScript: true,
                                                                            script: initializedScript
                                                                        } : s)
                                                                    });

                                                                    setSelectedSegmentId(seg.id);
                                                                    setShowScriptView(true);
                                                                } else {
                                                                    // Should not happen as unchecked state renders button, but for safety:
                                                                    updateSegment(seg.id, 'hasScript', false);
                                                                }
                                                            }}
                                                            onClick={e => e.stopPropagation()}
                                                            style={{ cursor: 'pointer' }}
                                                        />
                                                    )}
                                                </td>
                                                <td className="no-print" style={{ padding: '0.5rem', textAlign: 'center' }}>
                                                    <input
                                                        type="file"
                                                        id={`scout-card-${seg.id}`}
                                                        style={{ display: 'none' }}
                                                        accept="application/pdf"
                                                        onChange={(e) => {
                                                            const file = e.target.files[0];
                                                            if (file) {
                                                                const url = URL.createObjectURL(file);
                                                                setScoutCardUrls(prev => ({ ...prev, [seg.id]: url }));
                                                                updateSegment(seg.id, 'scoutCard', { name: file.name });
                                                            }
                                                        }}
                                                    />
                                                    <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '0.25rem' }}>
                                                        <button
                                                            className="btn btn-secondary"
                                                            style={{ padding: '0.25rem 0.5rem', fontSize: '0.7rem' }}
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                document.getElementById(`scout-card-${seg.id}`).click();
                                                            }}
                                                            title="Upload PDF Card"
                                                        >
                                                            {seg.scoutCard ? 'üìé Replace' : 'üìé Upload'}
                                                        </button>
                                                        {seg.scoutCard && (
                                                            <div style={{ fontSize: '0.7rem', maxWidth: '100px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                                                {scoutCardUrls[seg.id] ? (
                                                                    <a
                                                                        href={scoutCardUrls[seg.id]}
                                                                        target="_blank"
                                                                        rel="noopener noreferrer"
                                                                        onClick={e => e.stopPropagation()}
                                                                        style={{ color: 'var(--accent)', textDecoration: 'none' }}
                                                                    >
                                                                        {seg.scoutCard.name}
                                                                    </a>
                                                                ) : (
                                                                    <span style={{ color: 'var(--text-secondary)', cursor: 'help' }} title="File lost on refresh. Re-upload to view.">
                                                                        {seg.scoutCard.name}
                                                                    </span>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                </td>
                                                <td className="no-print" style={{ padding: '0.5rem' }}>
                                                    <button
                                                        className="btn"
                                                        style={{ padding: '0.25rem 0.5rem', fontSize: '0.8rem', color: '#ef4444' }}
                                                        onClick={(e) => { e.stopPropagation(); removeSegment(seg.id); }}
                                                    >
                                                        √ó
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    {/* Shake it up Segment - Static unnumbered */}
                                    <tr>
                                        <td colSpan="9" style={{ padding: '0.5rem' }}>
                                            <div style={{
                                                border: '1px dashed var(--border)',
                                                borderRadius: 'var(--radius)',
                                                display: 'flex',
                                                alignItems: 'center',
                                                backgroundColor: 'rgba(255, 255, 255, 0.02)',
                                                padding: '0.5rem',
                                                color: 'inherit'
                                            }}>
                                                <div style={{ fontWeight: 'bold', marginRight: '1rem', color: 'var(--accent)' }}>-</div>
                                                <div style={{ flex: 1, fontStyle: 'italic' }}>Shake it up</div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <div style={{ marginTop: '1rem' }}>
                                <button className="btn btn-primary" onClick={addSegment}>+ Add Segment</button>
                            </div>

                            {/* Post Practice Notes Section */}
                            <div style={{ marginTop: '2rem', borderTop: '2px solid var(--border)', paddingTop: '1rem' }}>
                                <label style={{ fontWeight: 'bold', display: 'block', marginBottom: '0.5rem' }}>Post Practice Notes:</label>
                                <div className="print-only-text screen-hidden" style={{ minHeight: '100px', whiteSpace: 'pre-wrap', border: '1px solid #ddd', padding: '0.5rem', borderRadius: '4px' }}>
                                    {plan.postPracticeNotes}
                                </div>
                                <textarea
                                    className="form-input no-print"
                                    style={{ width: '100%', minHeight: '100px', fontFamily: 'inherit' }}
                                    value={plan.postPracticeNotes || ''}
                                    onChange={e => updateCurrentPlan({ ...plan, postPracticeNotes: e.target.value })}
                                    placeholder="Post-practice thoughts, injuries, adjustments for tomorrow..."
                                />
                            </div>
                        </div>

                        {/* Print Only: Scripts View (Page 2) */}
                        <div className="print-only-scripts" style={{ display: 'none' }}>
                            <div style={{ pageBreakBefore: 'always', breakBefore: 'page' }}>
                                <h2 style={{ textAlign: 'center', marginBottom: '1rem', borderBottom: '2px solid black', paddingBottom: '0.5rem' }}>PRACTICE SCRIPTS</h2>
                                {plan.segments.filter(s => s.hasScript && s.script && s.script.length > 0).map(seg => (
                                    <div key={seg.id} style={{ marginBottom: '2rem' }}>
                                        <div style={{
                                            backgroundColor: '#f1f5f9',
                                            padding: '0.5rem',
                                            borderTop: '2px solid black',
                                            borderBottom: '1px solid black',
                                            fontWeight: 'bold',
                                            display: 'flex',
                                            justifyContent: 'space-between'
                                        }}>
                                            <span>{seg.startTime} - {seg.type}</span>
                                            {/* Show Coach Notes for this segment in script view too? User didn't ask, but helpful. */}
                                            {/* Just showing duration for now */}
                                            <span>{seg.duration} min</span>
                                        </div>
                                        <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '0.8rem' }}>
                                            <thead>
                                                <tr style={{ borderBottom: '1px solid black' }}>
                                                    <th style={{ textAlign: 'left', padding: '2px' }}>#</th>
                                                    <th style={{ textAlign: 'left', padding: '2px' }}>Hash</th>
                                                    {seg.type === 'Ghost Script' || seg.type === 'Take-Off' ? null : <th style={{ textAlign: 'left', padding: '2px' }}>Sit</th>}
                                                    {seg.type === 'Take-Off' && <th style={{ textAlign: 'left', padding: '2px' }}>YL</th>}
                                                    <th style={{ textAlign: 'left', padding: '2px' }}>Play</th>
                                                    <th style={{ textAlign: 'left', padding: '2px' }}>Notes</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {ensureScriptSlots(seg.script, parseInt(seg.duration || 0), seg.type).map((slot, idx) => (
                                                    <tr key={idx} style={{ borderBottom: '1px solid #ddd' }}>
                                                        <td style={{ padding: '2px', width: '30px' }}>{idx + 1}</td>
                                                        <td style={{ padding: '2px', width: '40px' }}>{slot.hash}</td>
                                                        {seg.type === 'Ghost Script' || seg.type === 'Take-Off' ? null : <td style={{ padding: '2px', width: '80px' }}>{slot.situation}</td>}
                                                        {seg.type === 'Take-Off' && <td style={{ padding: '2px', width: '50px' }}>{slot.yardLine}</td>}
                                                        <td style={{ padding: '2px', fontWeight: 'bold' }}>{slot.playName}</td>
                                                        <td style={{ padding: '2px', fontStyle: 'italic', color: '#555' }}>
                                                            {/* Script item specific notes if we had them, but playName usually covers it. */}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                ))}
                            </div>
                        </div>


                    </div>

                    {/* Script View Modal - Moved outside flex container */}
                    {showScriptView && (
                        <div
                            style={{
                                position: 'fixed',
                                top: 0,
                                left: 0,
                                width: '100vw',
                                height: '100vh',
                                backgroundColor: 'rgba(0,0,0,0.5)',
                                zIndex: 999,
                                backdropFilter: 'blur(2px)'
                            }}
                            onClick={() => setShowScriptView(false)}
                        />
                    )}
                    <div className="script-view-panel" style={{
                        display: showScriptView ? 'flex' : 'none',
                        flexDirection: 'column',
                        position: 'fixed',
                        zIndex: 1000,
                        backgroundColor: 'var(--bg-panel)',
                        padding: '2rem',
                        overflow: 'hidden',
                        ...(isFullScreen ? {
                            top: 0,
                            left: 0,
                            width: '100vw',
                            height: '100vh',
                            borderRadius: 0,
                            border: 'none'
                        } : {
                            top: '50%',
                            left: '50%',
                            transform: 'translate(-50%, -50%)',
                            width: '90%',
                            height: '90%',
                            maxWidth: '1200px',
                            borderRadius: '12px',
                            border: '1px solid var(--border)',
                            boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)'
                        })
                    }}>
                        {(() => {
                            const activeSegment = selectedSegmentId === 'WARMUP'
                                ? { id: 'WARMUP', type: 'Warmup', notes: plan.warmupNotes, script: plan.warmupScript || [], staffId: plan.warmupStaffId, hasScript: plan.warmupHasScript }
                                : plan.segments.find(s => s.id === selectedSegmentId);

                            const showScript = selectedSegmentId && activeSegment && activeSegment.hasScript;

                            return showScript ? (
                                <>
                                    <div style={{ marginBottom: '1rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                        <h3>Scripting: {activeSegment.type}</h3>
                                        <div style={{ display: 'flex', gap: '0.5rem' }}>
                                            <button
                                                className="btn btn-secondary"
                                                onClick={() => setIsFullScreen(!isFullScreen)}
                                                title={isFullScreen ? "Exit Full Screen" : "Expand to Full Screen"}
                                            >
                                                {isFullScreen ? '‚Üô Collapse' : '‚Üó Expand'}
                                            </button>
                                            <button
                                                className="btn btn-secondary"
                                                style={{ color: '#ef4444' }}
                                                onClick={() => {
                                                    setShowScriptView(false);
                                                    setIsFullScreen(false);
                                                    setSelectedSegmentId(null);
                                                }}
                                                title="Close Script View"
                                            >
                                                ‚úñ Close
                                            </button>
                                        </div>
                                    </div>

                                    <div style={{ flex: 1, overflowY: 'auto' }}>
                                        <datalist id="play-options">
                                            {plays.map(p => (
                                                <option key={p.id} value={p.name}>{p.formation}</option>
                                            ))}
                                        </datalist>

                                        <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '0.9rem' }}>
                                            <thead>
                                                <tr style={{ borderBottom: '2px solid var(--border)', textAlign: 'left' }}>
                                                    <th style={{ padding: '0.5rem', width: '50px' }}>#</th>
                                                    <th style={{ padding: '0.5rem', width: '60px' }}>Hash</th>
                                                    {activeSegment.type === 'Take-Off' ? (
                                                        <>
                                                            <th style={{ padding: '0.5rem', width: '80px' }}>Yard Line</th>
                                                            <th style={{ padding: '0.5rem', width: '100px' }}>Down/Dist</th>
                                                        </>
                                                    ) : (
                                                        <th style={{ padding: '0.5rem', width: '150px' }}>Situation</th>
                                                    )}
                                                    <th style={{ padding: '0.5rem' }}>Play Call</th>
                                                    {isOffenseSegment(activeSegment.type) && <th style={{ padding: '0.5rem' }}>Defense</th>}
                                                    <th style={{ padding: '0.5rem', width: '60px' }}>Insert</th>
                                                    <th style={{ padding: '0.5rem', width: '40px' }}></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {activeSegment.script.map((item, index) => (
                                                    <tr key={item.id} style={{ borderBottom: '1px solid var(--border)' }}>
                                                        <td style={{ padding: '0.5rem' }}>{index + 1}</td>
                                                        <td style={{ padding: '0.5rem' }}>
                                                            <select
                                                                className="form-input"
                                                                style={{ padding: '0.25rem' }}
                                                                value={item.hash}
                                                                onChange={e => {
                                                                    const newScript = activeSegment.script.map(s => s.id === item.id ? { ...s, hash: e.target.value } : s);
                                                                    updateSegment(selectedSegmentId, 'script', newScript);
                                                                }}
                                                            >
                                                                <option value=""></option>
                                                                <option value="L">L</option>
                                                                <option value="M">M</option>
                                                                <option value="R">R</option>
                                                            </select>
                                                        </td>
                                                        {activeSegment.type === 'Take-Off' ? (
                                                            <>
                                                                {/* Yard Line - auto-populated and read-only */}
                                                                <td style={{ padding: '0.5rem' }}>
                                                                    <input
                                                                        className="form-input"
                                                                        style={{ padding: '0.25rem', backgroundColor: 'var(--bg-panel)', cursor: 'not-allowed' }}
                                                                        value={item.yardLine || item.situation || ''}
                                                                        readOnly
                                                                        title="Auto-populated yard line"
                                                                    />
                                                                </td>
                                                                {/* Down/Distance - editable */}
                                                                <td style={{ padding: '0.5rem' }}>
                                                                    <input
                                                                        className="form-input"
                                                                        style={{ padding: '0.25rem' }}
                                                                        value={item.downDistance || ''}
                                                                        onChange={e => {
                                                                            const newScript = activeSegment.script.map(s => s.id === item.id ? { ...s, downDistance: e.target.value } : s);
                                                                            updateSegment(selectedSegmentId, 'script', newScript);
                                                                        }}
                                                                        placeholder="e.g. 3 & 5"
                                                                    />
                                                                </td>
                                                            </>
                                                        ) : (
                                                            <td style={{ padding: '0.5rem' }}>
                                                                {(() => {
                                                                    // Determine the segment focus
                                                                    const segmentFocus = activeSegment.situation || '';

                                                                    // 3rd Down focus: use S/M/L/XL options
                                                                    if (segmentFocus.toLowerCase().includes('3rd')) {
                                                                        return (
                                                                            <select
                                                                                className="form-input"
                                                                                style={{ padding: '0.25rem' }}
                                                                                value={item.situation}
                                                                                onChange={e => {
                                                                                    const newScript = activeSegment.script.map(s => s.id === item.id ? { ...s, situation: e.target.value } : s);
                                                                                    updateSegment(selectedSegmentId, 'script', newScript);
                                                                                }}
                                                                            >
                                                                                <option value="">--</option>
                                                                                <option value="S">S (Short)</option>
                                                                                <option value="M">M (Medium)</option>
                                                                                <option value="L">L (Long)</option>
                                                                                <option value="XL">XL (Extra Long)</option>
                                                                            </select>
                                                                        );
                                                                    }

                                                                    // Red Zone or Gold Zone: full down and distance input
                                                                    if (segmentFocus.toLowerCase().includes('red zone') ||
                                                                        segmentFocus.toLowerCase().includes('gold zone')) {
                                                                        return (
                                                                            <input
                                                                                className="form-input"
                                                                                style={{ padding: '0.25rem' }}
                                                                                value={item.situation}
                                                                                onChange={e => {
                                                                                    const newScript = activeSegment.script.map(s => s.id === item.id ? { ...s, situation: e.target.value } : s);
                                                                                    updateSegment(selectedSegmentId, 'script', newScript);
                                                                                }}
                                                                                placeholder="e.g. 1st & 10"
                                                                            />
                                                                        );
                                                                    }

                                                                    // Default: regular text input
                                                                    return (
                                                                        <input
                                                                            className="form-input"
                                                                            style={{ padding: '0.25rem' }}
                                                                            value={item.situation}
                                                                            onChange={e => {
                                                                                const newScript = activeSegment.script.map(s => s.id === item.id ? { ...s, situation: e.target.value } : s);
                                                                                updateSegment(selectedSegmentId, 'script', newScript);
                                                                            }}
                                                                            placeholder="e.g. 3rd & 5"
                                                                        />
                                                                    );
                                                                })()}
                                                            </td>
                                                        )}
                                                        <td style={{ padding: '0.5rem' }}>
                                                            <input
                                                                className="form-input"
                                                                list="play-options"
                                                                style={{ padding: '0.25rem', width: '100%', fontWeight: 'bold' }}
                                                                value={item.playName || ''}
                                                                onChange={e => {
                                                                    const val = e.target.value;
                                                                    // Try to find play ID from name
                                                                    const foundPlay = plays.find(p => p.name === val);
                                                                    const newScript = activeSegment.script.map(s => s.id === item.id ? { ...s, playName: val, playId: foundPlay ? foundPlay.id : '' } : s);
                                                                    updateSegment(selectedSegmentId, 'script', newScript);
                                                                }}
                                                                placeholder="Search play..."
                                                            />
                                                        </td>
                                                        {isOffenseSegment(activeSegment.type) && (
                                                            <td style={{ padding: '0.5rem' }}>
                                                                <input
                                                                    className="form-input"
                                                                    style={{ padding: '0.25rem' }}
                                                                    value={item.defense || ''}
                                                                    onChange={e => {
                                                                        const newScript = activeSegment.script.map(s => s.id === item.id ? { ...s, defense: e.target.value } : s);
                                                                        updateSegment(selectedSegmentId, 'script', newScript);
                                                                    }}
                                                                    placeholder="Front / Coverage"
                                                                />
                                                            </td>
                                                        )}
                                                        <td style={{ padding: '0.5rem', textAlign: 'center' }}>
                                                            <button
                                                                className="btn"
                                                                style={{ padding: '0.25rem 0.5rem', fontSize: '0.8rem', color: 'var(--accent)' }}
                                                                onClick={() => {
                                                                    const PATTERN_A = ['L', 'LM', 'RM', 'R', 'R', 'RM', 'LM', 'L'];
                                                                    const PATTERN_B = ['R', 'RM', 'LM', 'L', 'L', 'LM', 'RM', 'R'];
                                                                    let pattern = PATTERN_A;
                                                                    if (activeSegment.script.length > 0 && activeSegment.script[0].hash === 'R') pattern = PATTERN_B;

                                                                    // Insert empty slot
                                                                    let scriptItem = {
                                                                        id: Date.now().toString(),
                                                                        playId: '',
                                                                        playName: '',
                                                                        hash: pattern[index % 8]
                                                                    };

                                                                    if (activeSegment.type === 'Take-Off') {
                                                                        const yardlines = ['-30', '-40', '50', '40', '30', '20', '10', '5'];
                                                                        scriptItem.yardLine = yardlines[index] || '';
                                                                        scriptItem.downDistance = '';
                                                                    } else {
                                                                        scriptItem.situation = '';
                                                                    }

                                                                    const newScript = [...activeSegment.script];
                                                                    newScript.splice(index, 0, scriptItem);
                                                                    updateSegment(selectedSegmentId, 'script', newScript);
                                                                }}
                                                            >
                                                                ‚Üë
                                                            </button>
                                                        </td>
                                                        <td style={{ padding: '0.5rem' }}>
                                                            <button
                                                                className="btn"
                                                                style={{ padding: '0.25rem', color: '#ef4444' }}
                                                                onClick={() => {
                                                                    const newScript = activeSegment.script.filter(s => s.id !== item.id);
                                                                    updateSegment(selectedSegmentId, 'script', newScript);
                                                                }}
                                                            >
                                                                √ó
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}

                                                {/* Insert at End Row */}
                                                {activeSegment.script.length > 0 && (
                                                    <tr style={{ borderTop: '2px solid var(--border)' }}>
                                                        <td style={{ padding: '0.5rem', fontWeight: 'bold', color: 'var(--accent)' }}>{activeSegment.script.length + 1}</td>
                                                        <td colSpan="3" style={{ padding: '0.5rem', fontStyle: 'italic', color: 'var(--text-secondary)' }}>
                                                            Insert play at end
                                                        </td>
                                                        <td style={{ padding: '0.5rem', textAlign: 'center' }}>
                                                            <button
                                                                className="btn btn-primary"
                                                                style={{ padding: '0.25rem 0.5rem', fontSize: '0.8rem' }}
                                                                onClick={() => {
                                                                    const PATTERN_A = ['L', 'LM', 'RM', 'R', 'R', 'RM', 'LM', 'L'];
                                                                    const PATTERN_B = ['R', 'RM', 'LM', 'L', 'L', 'LM', 'RM', 'R'];
                                                                    let pattern = PATTERN_A;
                                                                    if (activeSegment.script.length > 0 && activeSegment.script[0].hash === 'R') pattern = PATTERN_B;

                                                                    // Add empty slot at end
                                                                    let scriptItem = {
                                                                        id: Date.now().toString(),
                                                                        playId: '',
                                                                        playName: '',
                                                                        hash: pattern[activeSegment.script.length % 8]
                                                                    };

                                                                    if (activeSegment.type === 'Take-Off') {
                                                                        const yardlines = ['-30', '-40', '50', '40', '30', '20', '10', '5'];
                                                                        scriptItem.yardLine = yardlines[activeSegment.script.length % yardlines.length] || '';
                                                                        scriptItem.downDistance = '';
                                                                    } else {
                                                                        scriptItem.situation = '';
                                                                    }

                                                                    updateSegment(selectedSegmentId, 'script', [...activeSegment.script, scriptItem]);
                                                                }}
                                                            >
                                                                +
                                                            </button>
                                                        </td>
                                                        <td></td>
                                                    </tr>
                                                )}

                                                {activeSegment.script.length === 0 && (
                                                    <tr>
                                                        <td colSpan={activeSegment.type === 'Take-Off' ? "7" : "6"} style={{ padding: '2rem', textAlign: 'center', color: 'var(--text-secondary)' }}>
                                                            No plays scripted yet. Use + button to add or just wait for auto-fill.
                                                        </td>
                                                    </tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </>
                            ) : (
                                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100%', color: 'var(--text-secondary)', flexDirection: 'column', gap: '0.5rem' }}>
                                    {selectedSegmentId && !activeSegment?.hasScript ? (
                                        <>
                                            <div>Script editor disabled for this segment</div>
                                            <div style={{ fontSize: '0.9rem' }}>Check the "Script" box to enable scripting</div>
                                        </>
                                    ) : (
                                        <div>Select a segment to script plays</div>
                                    )}
                                </div>
                            );
                        })()}
                    </div>

                    {/* Hidden Print Container */}
                    <div className="practice-print-container" style={{ display: 'none' }}>
                        {/* Page 1: Schedule */}
                        <div className="practice-print-header">
                            <h1>{selectedDay} Practice Plan</h1>
                            <div className="practice-print-meta">
                                <span>Date: {plan.date}</span>
                                <span>Start: {plan.startTime}</span>
                            </div>
                        </div>

                        <table className="practice-schedule-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Dur</th>
                                    <th>Type</th>
                                    <th>Focus</th>
                                    <th>Notes</th>
                                    <th>Staff</th>
                                </tr>
                            </thead>
                            <tbody>
                                {plan.prePracticeNotes && (
                                    <tr>
                                        <td colSpan="5" style={{ padding: '1rem', fontStyle: 'italic', background: '#f8fafc' }}>
                                            <strong>Pre-Practice Notes:</strong><br />
                                            {plan.prePracticeNotes}
                                        </td>
                                    </tr>
                                )}
                                <tr>
                                    <td>{plan.startTime ? new Date(`2000-01-01T${plan.startTime}`).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true }) : ''}</td>
                                    <td>{plan.warmupDuration}</td>
                                    <td>Warmup</td>
                                    <td>{plan.warmupSituation || ''}</td>
                                    <td>{plan.warmupNotes ? (
                                        Object.entries(plan.warmupNotes)
                                            .filter(([coachId, note]) => selectedCoachFilter === 'ALL' || coachId === selectedCoachFilter)
                                            .map(([coachId, note]) => note)
                                            .join(' | ')
                                    ) : ''}</td>
                                    <td>{staff && staff.find(s => s.id === plan.warmupStaffId)?.name || ''}</td>
                                </tr>
                                {plan.segments
                                    .filter(seg => selectedCoachFilter === 'ALL' || seg.staffId === selectedCoachFilter)
                                    .map(seg => (
                                        <tr key={seg.id}>
                                            <td>{seg.startTime}</td>
                                            <td>{seg.duration}</td>
                                            <td>{seg.type}</td>
                                            <td>{seg.situation || ''}</td>
                                            <td>{(() => {
                                                const migrated = migrateSegmentNotes(seg);
                                                const notes = migrated.notes;
                                                const allCoachesNotes = notes['ALL_COACHES'] || '';
                                                const coachNotes = selectedCoachFilter !== 'ALL' ? (notes[selectedCoachFilter] || '') : '';

                                                // Combine notes: All Coaches first, then coach-specific
                                                const combined = [];
                                                if (allCoachesNotes) combined.push(`[All] ${allCoachesNotes}`);
                                                if (coachNotes) combined.push(coachNotes);
                                                return combined.join(' | ');
                                            })()}</td>
                                            <td>{staff && staff.find(s => s.id === seg.staffId)?.name || ''}</td>
                                        </tr>
                                    ))}
                            </tbody>
                        </table>

                        <div className="practice-page-break"></div>

                        {/* Page 2+: Scripts */}
                        <div className="practice-print-header">
                            <h1>Scripts</h1>
                        </div>

                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                            {plan.segments.filter(s => s.script && s.script.length > 0).map(seg => (
                                <div key={seg.id} className="script-segment-container">
                                    <div className="script-segment-header">
                                        <span>{seg.type}</span>
                                        <span>{seg.duration}m</span>
                                    </div>
                                    <table className="script-table">
                                        <thead>
                                            <tr>
                                                <th style={{ width: '10%' }}>#</th>
                                                <th style={{ width: '15%' }}>Hash</th>
                                                <th style={{ width: '25%' }}>Sit</th>
                                                <th style={{ width: '50%' }}>Play</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {seg.script.map((item, idx) => (
                                                <tr key={item.id}>
                                                    <td>{idx + 1}</td>
                                                    <td>{item.hash}</td>
                                                    <td>{item.situation}</td>
                                                    <td>{item.playName}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- VALHALLA SYSTEM CONSTANTS ---


        const GamedayDashboard = ({ plays }) => {
            const [filters, setFilters] = useState({
                down: 'Any',
                distance: 'Any',
                fieldPos: 'Any',
                hash: 'Any'
            });

            const matchingPlays = useMemo(() => {
                if (filters.down === 'Any' && filters.distance === 'Any' && filters.fieldPos === 'Any') return plays;

                return plays.filter(play => {
                    const targetTags = [];
                    if (filters.down !== 'Any' && filters.distance !== 'Any') {
                        targetTags.push(`${filters.down} & ${filters.distance}`);
                    }
                    if (filters.fieldPos !== 'Any') targetTags.push(filters.fieldPos);

                    if (targetTags.length === 0) return true;
                    return targetTags.some(t => play.tags.includes(t));
                });
            }, [plays, filters]);

            return (
                <div>
                    <h2 style={{ marginBottom: '1.5rem' }}>Gameday Dashboard</h2>

                    <div className="gameday-header">
                        <div>
                            <label className="form-label">Down</label>
                            <div className="situation-toggle">
                                {['Any', '1st', '2nd', '3rd', '4th'].map(opt => (
                                    <button
                                        key={opt}
                                        className={filters.down === opt ? 'active' : ''}
                                        onClick={() => setFilters({ ...filters, down: opt })}
                                    >
                                        {opt}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div>
                            <label className="form-label">Distance</label>
                            <div className="situation-toggle">
                                {['Any', 'Short', 'Med', 'Long', 'XL'].map(opt => (
                                    <button
                                        key={opt}
                                        className={filters.distance === opt ? 'active' : ''}
                                        onClick={() => setFilters({ ...filters, distance: opt })}
                                    >
                                        {opt}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div>
                            <label className="form-label">Field Position</label>
                            <select
                                className="form-select"
                                style={{ minWidth: '200px' }}
                                value={filters.fieldPos}
                                onChange={e => setFilters({ ...filters, fieldPos: e.target.value })}
                            >
                                <option value="Any">Any</option>
                                {TAG_CATEGORIES["Field Position"].map(pos => (
                                    <option key={pos} value={pos}>{pos}</option>
                                ))}
                            </select>
                        </div>
                    </div>

                    <div style={{ marginBottom: '1rem', color: 'var(--text-secondary)' }}>
                        Found {matchingPlays.length} plays matching situation...
                    </div>

                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))', gap: '1.5rem' }}>
                        {matchingPlays.map(play => (
                            <PlayCard key={play.id} play={play} onEdit={() => { }} />
                        ))}
                    </div>
                </div>
            );
        };


        const PregameTimeline = ({ plan = {}, onUpdatePlan, teamLogo, staff }) => {
            const [kickoffTime, setKickoffTime] = useState(plan?.kickoffTime || '19:00');
            const [selectedCoachFilter, setSelectedCoachFilter] = useState('ALL');
            const [selectedNotesCoach, setSelectedNotesCoach] = useState('ALL_COACHES');

            // Helper function to migrate old notes format to new format
            const migrateSegmentNotes = (segment) => {
                if (typeof segment.notes === 'string') {
                    return {
                        ...segment,
                        notes: segment.notes ? { 'ALL_COACHES': segment.notes } : {}
                    };
                }
                return segment;
            };

            const updateKickoff = (time) => {
                setKickoffTime(time);
                onUpdatePlan({ ...plan, kickoffTime: time });
            };

            const addSegment = () => {
                const newSegment = {
                    id: Date.now().toString(),
                    startTime: '17:00',
                    duration: 15,
                    activity: 'New Activity',
                    location: 'Field',
                    notes: {},
                    staffId: ''
                };
                onUpdatePlan({ ...plan, segments: [...(plan.segments || []), newSegment] });
            };

            const updateSegment = (id, field, value) => {
                onUpdatePlan({
                    ...plan,
                    segments: (plan.segments || []).map(s => s.id === id ? { ...s, [field]: value } : s)
                });
            };

            // Special handler for notes to support coach-specific notes
            const updateSegmentNotes = (segmentId, coachId, noteText) => {
                const segment = (plan.segments || []).find(s => s.id === segmentId);
                if (!segment) return;

                const migratedSegment = migrateSegmentNotes(segment);
                const updatedNotes = {
                    ...migratedSegment.notes,
                    [coachId]: noteText
                };
                // If note is empty, remove the key
                if (!noteText || noteText.trim() === '') {
                    delete updatedNotes[coachId];
                }
                updateSegment(segmentId, 'notes', updatedNotes);
            };

            const deleteSegment = (id) => {
                onUpdatePlan({ ...plan, segments: (plan.segments || []).filter(s => s.id !== id) });
            };

            // Auto-calculate segment times based on duration
            useEffect(() => {
                if (!plan || !plan.segments || plan.segments.length === 0) return;

                // Sort segments by their current start time to maintain order
                const sortedSegments = [...plan.segments].sort((a, b) =>
                    a.startTime.localeCompare(b.startTime)
                );

                // Calculate times starting from the first segment
                let hasChanges = false;
                const updatedSegments = plan.segments.map(seg => {
                    // Find this segment's position in the sorted array
                    const sortedIndex = sortedSegments.findIndex(s => s.id === seg.id);

                    if (sortedIndex === 0) {
                        // Keep the first segment's time as-is
                        return seg;
                    }

                    // Calculate this segment's start time based on previous segment in sorted order
                    const prevSeg = sortedSegments[sortedIndex - 1];
                    const prevStartTime = new Date(`2000-01-01T${prevSeg.startTime}`);
                    prevStartTime.setMinutes(prevStartTime.getMinutes() + parseInt(prevSeg.duration || 0));

                    const calculatedTime = prevStartTime.toTimeString().slice(0, 5); // HH:MM format

                    if (seg.startTime !== calculatedTime) {
                        hasChanges = true;
                        return { ...seg, startTime: calculatedTime };
                    }
                    return seg;
                });

                // Only update if there are actual changes to avoid infinite loop
                if (hasChanges) {
                    onUpdatePlan({ ...plan, segments: updatedSegments });
                }
            }, [JSON.stringify(plan?.segments?.map(s => ({ id: s.id, duration: s.duration, startTime: s.startTime })))]);

            const calculateTMinus = (startTime) => {
                const start = new Date(`2000-01-01T${startTime}`);
                const kick = new Date(`2000-01-01T${kickoffTime}`);
                const diff = (kick - start) / 60000; // minutes
                return diff > 0 ? `T-${diff}` : `T+${Math.abs(diff)}`;
            };

            return (
                <div style={{ display: 'flex', flexDirection: 'column', height: 'calc(100vh - 100px)' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
                        <h2>Pre-game Timeline</h2>
                        <div style={{ display: 'flex', gap: '1rem', alignItems: 'center' }}>
                            <div>
                                <label style={{ marginRight: '0.5rem', fontWeight: 'bold' }}>Kickoff:</label>
                                <input
                                    type="time"
                                    className="form-input"
                                    style={{ width: 'auto', display: 'inline-block' }}
                                    value={kickoffTime}
                                    onChange={e => updateKickoff(e.target.value)}
                                />
                            </div>
                            <button className="btn btn-secondary" onClick={() => window.print()}>üñ®Ô∏è Print</button>
                        </div>
                    </div>

                    {/* Coach Filter */}
                    <div style={{ display: 'flex', gap: '1rem', marginBottom: '1rem', alignItems: 'center' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                            <label style={{ fontWeight: 'bold' }}>Notes for:</label>
                            <select
                                className="form-select"
                                style={{ width: 'auto' }}
                                value={selectedNotesCoach}
                                onChange={e => setSelectedNotesCoach(e.target.value)}
                            >
                                <option value="ALL_COACHES">All Coaches</option>
                                {staff && staff.map(s => (
                                    <option key={s.id} value={s.id}>{s.name}</option>
                                ))}
                            </select>
                        </div>
                    </div>

                    <div style={{ flex: 1, overflowY: 'auto' }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead>
                                <tr style={{ borderBottom: '2px solid var(--border)', textAlign: 'left', color: 'var(--text-secondary)', fontSize: '0.9rem' }}>
                                    <th style={{ padding: '0.5rem' }}>Time</th>
                                    <th style={{ padding: '0.5rem' }}>Dur</th>
                                    <th style={{ padding: '0.5rem' }}>T-Minus</th>
                                    <th style={{ padding: '0.5rem' }}>Activity</th>
                                    <th style={{ padding: '0.5rem' }}>Location</th>
                                    <th style={{ padding: '0.5rem' }}>Notes</th>
                                    <th style={{ padding: '0.5rem', textAlign: 'right' }}>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {((plan.segments || [])).filter(segment => selectedCoachFilter === 'ALL' || segment.staffId === selectedCoachFilter)
                                    .sort((a, b) => a.startTime.localeCompare(b.startTime))
                                    .map(segment => (
                                        <tr key={segment.id} style={{ borderBottom: '1px solid var(--border)' }}>
                                            <td style={{ padding: '0.5rem' }}>
                                                <input
                                                    type="time"
                                                    className="form-input"
                                                    value={segment.startTime}
                                                    onChange={e => updateSegment(segment.id, 'startTime', e.target.value)}
                                                />
                                            </td>
                                            <td style={{ padding: '0.5rem' }}>
                                                <input
                                                    type="number"
                                                    className="form-input"
                                                    style={{ width: '60px', padding: '0.25rem' }}
                                                    value={segment.duration || 15}
                                                    onChange={e => updateSegment(segment.id, 'duration', parseInt(e.target.value))}
                                                />
                                            </td>
                                            <td style={{ padding: '0.5rem', fontWeight: 'bold', color: 'var(--accent)' }}>
                                                {calculateTMinus(segment.startTime)}
                                            </td>
                                            <td style={{ padding: '0.5rem' }}>
                                                <input
                                                    type="text"
                                                    className="form-input"
                                                    value={segment.activity}
                                                    onChange={e => updateSegment(segment.id, 'activity', e.target.value)}
                                                />
                                            </td>
                                            <td style={{ padding: '0.5rem' }}>
                                                <input
                                                    type="text"
                                                    className="form-input"
                                                    value={segment.location}
                                                    onChange={e => updateSegment(segment.id, 'location', e.target.value)}
                                                />
                                            </td>
                                            <td style={{ padding: '0.5rem' }}>
                                                <input
                                                    key={`pregame-${segment.id}-notes-${selectedNotesCoach}`}
                                                    type="text"
                                                    className="form-input"
                                                    value={(() => {
                                                        const migrated = migrateSegmentNotes(segment);
                                                        return migrated.notes[selectedNotesCoach] || '';
                                                    })()}
                                                    onChange={e => updateSegmentNotes(segment.id, selectedNotesCoach, e.target.value)}
                                                    placeholder={selectedNotesCoach === 'ALL_COACHES' ? 'Notes for all coaches...' : `Notes for ${staff?.find(s => s.id === selectedNotesCoach)?.name || 'this coach'}...`}
                                                />
                                            </td>
                                            <td style={{ padding: '0.5rem', textAlign: 'right' }}>
                                                <button className="btn" style={{ color: '#ef4444' }} onClick={() => deleteSegment(segment.id)}>
                                                    <Icon name="PlusCircle" style={{ transform: 'rotate(45deg)' }} />
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                            </tbody>
                        </table>

                        {/* Add Segment Button - placed below table for better UX */}
                        <div style={{ marginTop: '1rem' }}>
                            <button className="btn btn-primary" onClick={addSegment}>+ Add Segment</button>
                        </div>

                        {/* Hidden Print Container */}
                        <div className="pregame-print-container" style={{ display: 'none' }}>
                            <div className="practice-print-header">
                                <h1>Pre-game Timeline</h1>
                                <div className="practice-print-meta">
                                    <span>Kickoff: {kickoffTime}</span>
                                </div>
                            </div>

                            <table className="practice-schedule-table">
                                <thead>
                                    <tr>
                                        <th>Real Time</th>
                                        <th>Dur</th>
                                        <th>Clock</th>
                                        <th>Activity</th>
                                        <th>Location</th>
                                        <th>Staff</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {plan.segments
                                        .sort((a, b) => a.startTime.localeCompare(b.startTime))
                                        .map(seg => (
                                            <tr key={seg.id}>
                                                <td>{seg.startTime}</td>
                                                <td>{seg.duration || 15}</td>
                                                <td style={{ fontWeight: 'bold' }}>{calculateTMinus(seg.startTime)}</td>
                                                <td>{seg.activity}</td>
                                                <td>{seg.location}</td>
                                                <td>{staff && staff.find(s => s.id === seg.staffId)?.name || ''}</td>
                                                <td>{(() => {
                                                    const migrated = migrateSegmentNotes(seg);
                                                    const notes = migrated.notes;
                                                    const allCoachesNotes = notes['ALL_COACHES'] || '';
                                                    const coachNotes = selectedCoachFilter !== 'ALL' ? (notes[selectedCoachFilter] || '') : '';

                                                    // Combine notes: All Coaches first, then coach-specific
                                                    const combined = [];
                                                    if (allCoachesNotes) combined.push(`[All] ${allCoachesNotes}`);
                                                    if (coachNotes) combined.push(coachNotes);
                                                    return combined.join(' | ');
                                                })()}</td>
                                            </tr>
                                        ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const PlayerProfileView = ({ player, onClose, onUpdate }) => {
            const [activeTab, setActiveTab] = useState('profile');
            const [dialForm, setDialForm] = useState({
                soreness: 1, fatigue: 1, stress: 1, mood: 10,
                sleepQuality: 10, sleepDuration: '7-8',
                pain: false, painLocation: '', painSeverity: 1,
                rpe: 5, readiness: 10, notes: ''
            });

            const saveDialLog = () => {
                const entry = {
                    id: Date.now().toString(),
                    date: new Date().toISOString(),
                    timestamp: Date.now(),
                    ...dialForm
                };
                const currentLogs = metrics.warriorDialLogs || [];
                // Check if already logged today? For now allow multiple, but usually daily.
                updateProfile('metrics', 'warriorDialLogs', [entry, ...currentLogs]);
                alert('Warrior Dial Logged Successfully!');
            }; // profile, athletics, valhalla

            if (!player) return null;

            // Ensure nested objects exist
            const profile = player.profile || { favorites: {}, goals: {} };
            const metrics = player.metrics || { attendanceStreak: 0, longestStreak: 0, awards: [], warriorDialLogs: [], testHistory: [], weightLog: [] };
            if (!profile.sportsHistory) profile.sportsHistory = {}; // New: Sports History
            if (!metrics.warriorDialLogs) metrics.warriorDialLogs = [];
            if (!metrics.testHistory) metrics.testHistory = []; // New: Historic Testing
            if (!metrics.weightLog) metrics.weightLog = []; // New: Weight Log
            const favorites = profile.favorites || {};
            const goals = profile.goals || {};

            const updateProfile = (section, field, value) => {
                const newProfile = { ...profile };
                if (section === 'root') {
                    newProfile[field] = value;
                } else {
                    newProfile[section] = { ...newProfile[section], [field]: value };
                }
                onUpdate(player.id, 'profile', newProfile);
            };

            return (
                <div style={{
                    position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',
                    backgroundColor: 'rgba(0,0,0,0.8)', zIndex: 2000,
                    display: 'flex', justifyContent: 'center', alignItems: 'center'
                }} onClick={onClose}>
                    <div style={{
                        width: '90%', height: '90%', backgroundColor: '#f8fafc', borderRadius: '16px',
                        display: 'flex', flexDirection: 'column', overflow: 'hidden', boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1)'
                    }} onClick={e => e.stopPropagation()}>

                        {/* Header Banner */}
                        <div style={{ background: 'var(--primary)', color: 'white', padding: '2rem', display: 'flex', alignItems: 'center', gap: '2rem', position: 'relative' }}>
                            <div style={{
                                width: '100px', height: '100px', borderRadius: '50%', background: 'white', color: 'var(--primary)',
                                display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '3rem', fontWeight: 'bold',
                                border: '4px solid white'
                            }}>
                                {player.jersey}
                            </div>
                            <div>
                                <h1 style={{ margin: 0, fontSize: '2.5rem' }}>{player.firstName} {player.lastName}</h1>
                                <div style={{ fontSize: '1.2rem', opacity: 0.9 }}>
                                    {player.position} ‚Ä¢ {player.year} ‚Ä¢ {player.height}, {player.weight} lbs
                                </div>
                            </div>
                            <div style={{ marginLeft: 'auto', display: 'flex', gap: '2rem', textAlign: 'center' }}>
                                <div>
                                    <div style={{ fontSize: '2rem', fontWeight: 'bold' }}>{metrics.attendanceStreak || 0}</div>
                                    <div style={{ fontSize: '0.8rem', opacity: 0.8, textTransform: 'uppercase' }}>Current Streak</div>
                                </div>
                                <div style={{ opacity: 0.6 }}>
                                    <div style={{ fontSize: '2rem', fontWeight: 'bold' }}>{metrics.longestStreak || 0}</div>
                                    <div style={{ fontSize: '0.8rem', textTransform: 'uppercase' }}>Longest Streak</div>
                                </div>
                            </div>
                            <button onClick={onClose} style={{ position: 'absolute', top: '1rem', right: '1rem', background: 'none', border: 'none', color: 'white', cursor: 'pointer', fontSize: '1.5rem' }}>√ó</button>
                        </div>

                        {/* Navigation Tabs */}
                        <div style={{ display: 'flex', borderBottom: '1px solid #e2e8f0', background: 'white', padding: '0 2rem' }}>
                            {['profile', 'athletics', 'dial', 'valhalla'].map(tab => (
                                <button
                                    key={tab}
                                    onClick={() => setActiveTab(tab)}
                                    style={{
                                        padding: '1rem 2rem',
                                        background: 'none',
                                        border: 'none',
                                        borderBottom: activeTab === tab ? '4px solid var(--primary)' : '4px solid transparent',
                                        color: activeTab === tab ? 'var(--primary)' : '#64748b',
                                        fontWeight: activeTab === tab ? 'bold' : 'normal',
                                        cursor: 'pointer',
                                        fontSize: '1rem',
                                        textTransform: 'capitalize'
                                    }}
                                >
                                    {tab === 'valhalla' ? 'Quest for Valhalla' : tab === 'dial' ? 'Warrior Dial' : tab}
                                </button>
                            ))}
                        </div>

                        {/* Content Area */}
                        <div style={{ flex: 1, overflowY: 'auto', padding: '2rem' }}>

                            {/* PROFILE TAB */}
                            {activeTab === 'profile' && (
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(350px, 1fr))', gap: '2rem' }}>
                                    {/* Personal Favorites */}
                                    <div className="card" style={{ padding: '1.5rem' }}>
                                        <h3 style={{ borderBottom: '2px solid #e2e8f0', paddingBottom: '0.5rem', marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                            <Icon name="Star" size={20} /> Player Favorites
                                        </h3>
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                            {[
                                                { label: 'NFL Team', field: 'nflTeam', icon: 'Tv' },
                                                { label: 'NBA Team', field: 'nbaTeam', icon: 'Tv' },
                                                { label: 'MLB Team', field: 'mlbTeam', icon: 'Tv' },
                                                { label: 'Musicians', field: 'musicians', icon: 'Music' },
                                                { label: 'Favorite Food', field: 'food', icon: 'Pizza' },
                                                { label: 'Favorite Movie', field: 'movie', icon: 'Film' },
                                            ].map(item => (
                                                <div key={item.field} className="form-group">
                                                    <label className="form-label">{item.label}</label>
                                                    <input
                                                        className="form-input"
                                                        value={favorites[item.field] || ''}
                                                        onChange={e => updateProfile('favorites', item.field, e.target.value)}
                                                        placeholder={`Enter ${item.label}...`}
                                                    />
                                                </div>
                                            ))}
                                        </div>
                                        <div className="form-group" style={{ marginTop: '1rem' }}>
                                            <label className="form-label">Other Hobbies</label>
                                            <textarea
                                                className="form-input"
                                                rows="3"
                                                value={favorites.hobbies || ''}
                                                onChange={e => updateProfile('favorites', 'hobbies', e.target.value)}
                                            />
                                        </div>
                                    </div>

                                    {/* About & Family */}
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '2rem' }}>
                                        <div className="card" style={{ padding: '1.5rem' }}>
                                            <h3 style={{ borderBottom: '2px solid #e2e8f0', paddingBottom: '0.5rem', marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                <Icon name="Users" size={20} /> Family
                                            </h3>
                                            <div className="form-group">
                                                <label className="form-label" style={{ marginBottom: '0.5rem' }}>Tell us about your family</label>
                                                <textarea
                                                    className="form-input"
                                                    rows="4"
                                                    value={profile.family || ''}
                                                    onChange={e => updateProfile('root', 'family', e.target.value)}
                                                    placeholder="Parents, siblings, pets..."
                                                />
                                            </div>
                                        </div>

                                        <div className="card" style={{ padding: '1.5rem', flex: 1 }}>
                                            <h3 style={{ borderBottom: '2px solid #e2e8f0', paddingBottom: '0.5rem', marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                <Icon name="Compass" size={20} /> The Future
                                            </h3>
                                            <div className="form-group">
                                                <label className="form-label">Goals after High School</label>
                                                <textarea
                                                    className="form-input"
                                                    value={goals.postHS || ''}
                                                    onChange={e => updateProfile('goals', 'postHS', e.target.value)}
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Dream Job / Career</label>
                                                <input
                                                    className="form-input"
                                                    value={goals.job || ''}
                                                    onChange={e => updateProfile('goals', 'job', e.target.value)}
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Target Colleges</label>
                                                <input
                                                    className="form-input"
                                                    value={goals.colleges || ''}
                                                    onChange={e => updateProfile('goals', 'colleges', e.target.value)}
                                                    placeholder="University of Iowa, Iowa State..."
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* SPORTS HISTORY TAB (In Profile) */}
                            {activeTab === 'profile' && (
                                <div className="card" style={{ marginTop: '2rem', padding: '1.5rem', gridColumn: '1 / -1' }}>
                                    <h3 style={{ borderBottom: '2px solid #e2e8f0', paddingBottom: '0.5rem', marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                        <Icon name="Trophy" size={20} /> Sports Participation History
                                    </h3>
                                    <div style={{ overflowX: 'auto' }}>
                                        <table style={{ width: '100%', borderCollapse: 'collapse', textAlign: 'center' }}>
                                            <thead>
                                                <tr style={{ background: '#f1f5f9', color: '#475569' }}>
                                                    <th style={{ padding: '0.75rem', border: '1px solid #cbd5e1' }}>Season</th>
                                                    <th style={{ padding: '0.75rem', border: '1px solid #cbd5e1' }}>Freshman</th>
                                                    <th style={{ padding: '0.75rem', border: '1px solid #cbd5e1' }}>Sophomore</th>
                                                    <th style={{ padding: '0.75rem', border: '1px solid #cbd5e1' }}>Junior</th>
                                                    <th style={{ padding: '0.75rem', border: '1px solid #cbd5e1' }}>Senior</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {[
                                                    { season: 'Fall', options: ['Football', 'Cross Country'] },
                                                    { season: 'Winter', options: ['Basketball', 'Wrestling', 'Swimming'] },
                                                    { season: 'Spring', options: ['Track', 'Soccer', 'Golf', 'Tennis'] },
                                                    { season: 'Summer', options: ['Baseball', 'Softball'] }
                                                ].map(row => (
                                                    <tr key={row.season}>
                                                        <td style={{ fontWeight: 'bold', padding: '0.75rem', border: '1px solid #cbd5e1', textAlign: 'left' }}>{row.season}</td>
                                                        {['FR', 'SO', 'JR', 'SR'].map(year => (
                                                            <td key={year} style={{ padding: '0.5rem', border: '1px solid #cbd5e1' }}>
                                                                <input
                                                                    type="text"
                                                                    className="form-input"
                                                                    style={{ textAlign: 'center', fontSize: '0.9rem' }}
                                                                    placeholder="-"
                                                                    value={profile.sportsHistory?.[`${year}_${row.season}`] || ''}
                                                                    onChange={e => {
                                                                        const newVal = { ...(profile.sportsHistory || {}) };
                                                                        newVal[`${year}_${row.season}`] = e.target.value;
                                                                        updateProfile('profile', 'sportsHistory', newVal);
                                                                    }}
                                                                    list={`sports-${row.season}`}
                                                                />
                                                                <datalist id={`sports-${row.season}`}>
                                                                    {row.options.map(opt => <option key={opt} value={opt} />)}
                                                                </datalist>
                                                            </td>
                                                        ))}
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {/* ATHLETICS TAB */}
                            {activeTab === 'athletics' && (
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))', gap: '2rem' }}>

                                    {/* Attendance & Streaks */}
                                    <div className="card" style={{ padding: '1.5rem' }}>
                                        <h3 style={{ borderBottom: '2px solid #e2e8f0', paddingBottom: '0.5rem', marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                            <Icon name="Activity" size={20} /> Attendance & Streaks
                                        </h3>
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                            <div className="form-group">
                                                <label className="form-label">Current Attendance Streak</label>
                                                <input
                                                    type="number"
                                                    className="form-input"
                                                    value={metrics.attendanceStreak || 0}
                                                    onChange={e => updateProfile('metrics', 'attendanceStreak', parseInt(e.target.value) || 0)}
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Longest Streak (All Time)</label>
                                                <input
                                                    type="number"
                                                    className="form-input"
                                                    value={metrics.longestStreak || 0}
                                                    onChange={e => updateProfile('metrics', 'longestStreak', parseInt(e.target.value) || 0)}
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    {/* Testing Numbers (Manual Entry for now) */}
                                    <div className="card" style={{ padding: '1.5rem' }}>
                                        <h3 style={{ borderBottom: '2px solid #e2e8f0', paddingBottom: '0.5rem', marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                            <Icon name="Dumbbell" size={20} /> Maxes (Lbs / Sec)
                                        </h3>
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                            {['Bench', 'Squat', 'Clean', '40yd', 'Pro Agility', 'Vertical'].map(test => {
                                                const key = test.toLowerCase().replace(/ /g, '');
                                                return (
                                                    <div key={key} className="form-group">
                                                        <label className="form-label">{test}</label>
                                                        <input
                                                            className="form-input"
                                                            type="number"
                                                            step="0.01"
                                                            value={metrics[key] || ''}
                                                            onChange={e => updateProfile('metrics', key, e.target.value)}
                                                        />
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    {/* Historic Test Outs */}
                                    <div className="card" style={{ padding: '1.5rem', gridColumn: '1 / -1' }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem', borderBottom: '2px solid #e2e8f0', paddingBottom: '0.5rem' }}>
                                            <h3 style={{ margin: 0, display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                <Icon name="Dumbbell" size={20} /> Historic Test Outs
                                            </h3>
                                            <button className="btn-sm btn-primary" onClick={() => {
                                                const newEntry = {
                                                    id: Date.now(), date: new Date().toISOString().slice(0, 10),
                                                    squat: 0, bench: 0, powerClean: 0, vert: 0, broad: 0, forty: 0, tenFly: 0, ironMan: 0
                                                };
                                                updateProfile('metrics', 'testHistory', [...(metrics.testHistory || []), newEntry]);
                                            }}>+ Add Test</button>
                                        </div>
                                        <div style={{ overflowX: 'auto' }}>
                                            <table style={{ width: '100%', borderCollapse: 'collapse', textAlign: 'center', fontSize: '0.9rem' }}>
                                                <thead>
                                                    <tr style={{ background: '#f8fafc', color: '#64748b' }}>
                                                        <th style={{ padding: '0.5rem' }}>Date</th>
                                                        <th style={{ padding: '0.5rem' }}>Squat</th>
                                                        <th style={{ padding: '0.5rem' }}>Bench</th>
                                                        <th style={{ padding: '0.5rem' }}>Clean</th>
                                                        <th style={{ padding: '0.5rem' }}>Vert</th>
                                                        <th style={{ padding: '0.5rem' }}>Broad</th>
                                                        <th style={{ padding: '0.5rem' }}>40yd</th>
                                                        <th style={{ padding: '0.5rem' }}>10m Fly</th>
                                                        <th style={{ padding: '0.5rem' }}>Iron Man</th>
                                                        <th style={{ padding: '0.5rem' }}>Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {(metrics.testHistory || []).sort((a, b) => new Date(b.date) - new Date(a.date)).map(test => (
                                                        <tr key={test.id} style={{ borderBottom: '1px solid #e2e8f0' }}>
                                                            <td style={{ padding: '0.25rem' }}>
                                                                <input type="date" className="form-input" style={{ width: '130px', padding: '0.25rem' }} value={test.date} onChange={e => {
                                                                    const updated = metrics.testHistory.map(t => t.id === test.id ? { ...t, date: e.target.value } : t);
                                                                    updateProfile('metrics', 'testHistory', updated);
                                                                }} />
                                                            </td>
                                                            {['squat', 'bench', 'powerClean', 'vert', 'broad', 'forty', 'tenFly', 'ironMan'].map(field => (
                                                                <td key={field} style={{ padding: '0.25rem' }}>
                                                                    <input type="number" className="form-input" style={{ width: '60px', padding: '0.25rem', textAlign: 'center' }} value={test[field]} onChange={e => {
                                                                        const updated = metrics.testHistory.map(t => t.id === test.id ? { ...t, [field]: e.target.value } : t);
                                                                        updateProfile('metrics', 'testHistory', updated);
                                                                    }} />
                                                                </td>
                                                            ))}
                                                            <td>
                                                                <button onClick={() => {
                                                                    const updated = metrics.testHistory.filter(t => t.id !== test.id);
                                                                    updateProfile('metrics', 'testHistory', updated);
                                                                }} style={{ color: '#ef4444', background: 'none', border: 'none', cursor: 'pointer' }}>√ó</button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    {/* Body Weight Tracker */}
                                    <div className="card" style={{ padding: '1.5rem', gridColumn: 'span 2' }}> {/* Changed to span 2 to fit grid */}
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem', borderBottom: '2px solid #e2e8f0', paddingBottom: '0.5rem' }}>
                                            <h3 style={{ margin: 0, display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                <Icon name="Scale" size={20} /> Weight Tracker
                                            </h3>
                                            <button className="btn-sm btn-primary" onClick={() => {
                                                const newEntry = { id: Date.now(), date: new Date().toISOString().slice(0, 10), weight: player.weight || 150 };
                                                updateProfile('metrics', 'weightLog', [...(metrics.weightLog || []), newEntry]);
                                            }}>+ Log Weight</button>
                                        </div>
                                        <div style={{ display: 'flex', gap: '2rem' }}>
                                            <div style={{ flex: 1, maxHeight: '300px', overflowY: 'auto' }}>
                                                <table style={{ width: '100%', textAlign: 'left' }}>
                                                    <thead>
                                                        <tr><th style={{ padding: '0.5rem', color: '#64748b' }}>Date</th><th style={{ padding: '0.5rem', color: '#64748b' }}>Weight (lbs)</th><th></th></tr>
                                                    </thead>
                                                    <tbody>
                                                        {(metrics.weightLog || []).sort((a, b) => new Date(b.date) - new Date(a.date)).map(log => (
                                                            <tr key={log.id} style={{ borderBottom: '1px solid #f1f5f9' }}>
                                                                <td style={{ padding: '0.25rem' }}>
                                                                    <input type="date" className="form-input" style={{ width: '140px', padding: '0.25rem' }} value={log.date} onChange={e => {
                                                                        const updated = metrics.weightLog.map(l => l.id === log.id ? { ...l, date: e.target.value } : l);
                                                                        updateProfile('metrics', 'weightLog', updated);
                                                                    }} />
                                                                </td>
                                                                <td style={{ padding: '0.25rem' }}>
                                                                    <input type="number" className="form-input" style={{ width: '80px', padding: '0.25rem' }} value={log.weight} onChange={e => {
                                                                        const updated = metrics.weightLog.map(l => l.id === log.id ? { ...l, weight: e.target.value } : l);
                                                                        updateProfile('metrics', 'weightLog', updated);
                                                                    }} />
                                                                </td>
                                                                <td>
                                                                    <button onClick={() => {
                                                                        const updated = metrics.weightLog.filter(l => l.id !== log.id);
                                                                        updateProfile('metrics', 'weightLog', updated);
                                                                    }} style={{ color: '#ef4444', background: 'none', border: 'none', cursor: 'pointer' }}>√ó</button>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div style={{ flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', background: '#f8fafc', borderRadius: '8px', border: '1px dashed #cbd5e1', color: '#94a3b8' }}>
                                                {/* Placeholder for Chart - SVG Implementation */}
                                                {(metrics.weightLog || []).length > 1 ? (
                                                    <svg width="100%" height="250" viewBox="0 0 300 150">
                                                        {(() => {
                                                            const data = [...(metrics.weightLog || [])].sort((a, b) => new Date(a.date) - new Date(b.date));
                                                            const weights = data.map(d => parseInt(d.weight));
                                                            const minW = Math.min(...weights) - 5;
                                                            const maxW = Math.max(...weights) + 5;
                                                            const range = maxW - minW || 1;

                                                            const points = data.map((d, i) => {
                                                                const x = (i / (data.length - 1)) * 280 + 10;
                                                                const y = 140 - ((d.weight - minW) / range) * 130;
                                                                return `${x},${y}`;
                                                            }).join(' ');

                                                            return (
                                                                <>
                                                                    <polyline points={points} fill="none" stroke="var(--accent)" strokeWidth="3" />
                                                                    {data.map((d, i) => {
                                                                        const x = (i / (data.length - 1)) * 280 + 10;
                                                                        const y = 140 - ((d.weight - minW) / range) * 130;
                                                                        return <circle key={i} cx={x} cy={y} r="4" fill="var(--primary)" title={`${d.date}: ${d.weight}`} />
                                                                    })}
                                                                </>
                                                            );
                                                        })()}
                                                    </svg>
                                                ) : (
                                                    <div>Log at least 2 entries to see chart</div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* WARRIOR DIAL TAB */}
                            {activeTab === 'dial' && (
                                <div style={{ display: 'grid', gridTemplateColumns: '1.5fr 1fr', gap: '2rem' }}>
                                    <div className="card" style={{ padding: '2rem' }}>
                                        <h3 style={{ borderBottom: '2px solid #e2e8f0', paddingBottom: '0.5rem', marginBottom: '1.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                            Daily Check-In
                                        </h3>

                                        {/* Physical Wellness */}
                                        <div style={{ marginBottom: '1.5rem' }}>
                                            <h4 style={{ marginBottom: '1rem', color: 'var(--primary)' }}>Physical Wellness <span style={{ fontSize: '0.8rem', color: '#64748b' }}>(1 = Great, 10 = Terrible)</span></h4>
                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                                <div className="form-group">
                                                    <label className="form-label">Soreness (1-10)</label>
                                                    <input type="range" min="1" max="10" className="form-input" value={dialForm.soreness} onChange={e => setDialForm({ ...dialForm, soreness: parseInt(e.target.value) })} />
                                                    <div style={{ textAlign: 'center', fontWeight: 'bold' }}>{dialForm.soreness}</div>
                                                </div>
                                                <div className="form-group">
                                                    <label className="form-label">Fatigue (1-10)</label>
                                                    <input type="range" min="1" max="10" className="form-input" value={dialForm.fatigue} onChange={e => setDialForm({ ...dialForm, fatigue: parseInt(e.target.value) })} />
                                                    <div style={{ textAlign: 'center', fontWeight: 'bold' }}>{dialForm.fatigue}</div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Mental State */}
                                        <div style={{ marginBottom: '1.5rem' }}>
                                            <h4 style={{ marginBottom: '1rem', color: 'var(--primary)' }}>Mental State <span style={{ fontSize: '0.8rem', color: '#64748b' }}>(10 = Best)</span></h4>
                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                                <div className="form-group">
                                                    <label className="form-label">Stress Level (1-10)</label>
                                                    <div style={{ fontSize: '0.8rem', color: '#64748b', marginBottom: '4px' }}>1 = Low Stress, 10 = High Stress</div>
                                                    <input type="range" min="1" max="10" className="form-input" value={dialForm.stress} onChange={e => setDialForm({ ...dialForm, stress: parseInt(e.target.value) })} />
                                                    <div style={{ textAlign: 'center', fontWeight: 'bold' }}>{dialForm.stress}</div>
                                                </div>
                                                <div className="form-group">
                                                    <label className="form-label">Mood (1-10)</label>
                                                    <input type="range" min="1" max="10" className="form-input" value={dialForm.mood} onChange={e => setDialForm({ ...dialForm, mood: parseInt(e.target.value) })} />
                                                    <div style={{ textAlign: 'center', fontWeight: 'bold' }}>{dialForm.mood}</div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Sleep */}
                                        <div style={{ marginBottom: '1.5rem' }}>
                                            <h4 style={{ marginBottom: '1rem', color: 'var(--primary)' }}>Sleep</h4>
                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                                <div className="form-group">
                                                    <label className="form-label">Sleep Quality (1-10)</label>
                                                    <input type="range" min="1" max="10" className="form-input" value={dialForm.sleepQuality} onChange={e => setDialForm({ ...dialForm, sleepQuality: parseInt(e.target.value) })} />
                                                    <div style={{ textAlign: 'center', fontWeight: 'bold' }}>{dialForm.sleepQuality}</div>
                                                </div>
                                                <div className="form-group">
                                                    <label className="form-label">Hours Slept</label>
                                                    <select className="form-select" value={dialForm.sleepDuration} onChange={e => setDialForm({ ...dialForm, sleepDuration: e.target.value })}>
                                                        <option value="<5">&lt; 5 Hours</option>
                                                        <option value="5-6">5-6 Hours</option>
                                                        <option value="6-7">6-7 Hours</option>
                                                        <option value="7-8">7-8 Hours</option>
                                                        <option value=">8">&gt; 8 Hours</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Injury */}
                                        <div style={{ marginBottom: '1.5rem', background: '#fef2f2', padding: '1rem', borderRadius: '8px' }}>
                                            <h4 style={{ marginBottom: '1rem', color: '#ef4444', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                <input type="checkbox" checked={dialForm.pain} onChange={e => setDialForm({ ...dialForm, pain: e.target.checked })} style={{ width: '20px', height: '20px' }} />
                                                Injury / Discomfort?
                                            </h4>
                                            {dialForm.pain && (
                                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                                    <div className="form-group">
                                                        <label className="form-label">Location</label>
                                                        <input className="form-input" placeholder="e.g. Right Knee" value={dialForm.painLocation} onChange={e => setDialForm({ ...dialForm, painLocation: e.target.value })} />
                                                    </div>
                                                    <div className="form-group">
                                                        <label className="form-label">Pain Severity (1-10)</label>
                                                        <input type="number" min="1" max="10" className="form-input" value={dialForm.painSeverity} onChange={e => setDialForm({ ...dialForm, painSeverity: parseInt(e.target.value) })} />
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        {/* Training & Notes */}
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                            <div className="form-group">
                                                <label className="form-label">Yesterday's RPE (1-10)</label>
                                                <input type="number" min="1" max="10" className="form-input" value={dialForm.rpe} onChange={e => setDialForm({ ...dialForm, rpe: parseInt(e.target.value) })} />
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Readiness to Train (1-10)</label>
                                                <input type="number" min="1" max="10" className="form-input" value={dialForm.readiness} onChange={e => setDialForm({ ...dialForm, readiness: parseInt(e.target.value) })} />
                                            </div>
                                            <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                                <label className="form-label">Additional Notes</label>
                                                <textarea className="form-input" rows="2" placeholder="Anything else coaches should know?" value={dialForm.notes} onChange={e => setDialForm({ ...dialForm, notes: e.target.value })} />
                                            </div>
                                        </div>

                                        <button className="btn btn-primary" style={{ marginTop: '2rem', width: '100%', padding: '1rem', fontSize: '1.1rem' }} onClick={saveDialLog}>
                                            <Icon name="Save" /> Submit Daily Log
                                        </button>
                                    </div>

                                    {/* History Sidebar */}
                                    <div className="card" style={{ padding: '1.5rem', height: 'fit-content' }}>
                                        <h3 style={{ borderBottom: '2px solid #e2e8f0', paddingBottom: '0.5rem', marginBottom: '1rem' }}>Recent Logs</h3>
                                        {(metrics.warriorDialLogs || []).length === 0 ? (
                                            <div style={{ color: '#94a3b8', fontStyle: 'italic', textAlign: 'center' }}>No logs yet.</div>
                                        ) : (
                                            <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                                {(metrics.warriorDialLogs || []).slice(0, 5).map(log => (
                                                    <div key={log.id} style={{ border: '1px solid #e2e8f0', borderRadius: '8px', padding: '1rem' }}>
                                                        <div style={{ fontSize: '0.85rem', color: '#64748b', marginBottom: '0.5rem' }}>
                                                            {new Date(log.date).toLocaleDateString()}
                                                        </div>
                                                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.25rem' }}>
                                                            <span>Readiness:</span> <span style={{ fontWeight: 'bold', color: log.readiness >= 8 ? 'var(--success)' : log.readiness <= 4 ? 'var(--danger)' : 'var(--warning)' }}>{log.readiness}/10</span>
                                                        </div>
                                                        <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                                            <span>Soreness:</span> <span style={{ fontWeight: 'bold' }}>{log.soreness}/10</span>
                                                        </div>
                                                        {log.pain && (
                                                            <div style={{ marginTop: '0.5rem', color: '#ef4444', fontSize: '0.85rem', display: 'flex', alignItems: 'center', gap: '4px' }}>
                                                                <Icon name="AlertCircle" size={12} /> {log.painLocation}
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* VALHALLA TAB */}
                            {activeTab === 'valhalla' && (
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '2rem' }}>
                                    <div className="card" style={{ padding: '2rem', textAlign: 'center', color: '#64748b' }}>
                                        <Icon name="Swords" size={48} style={{ marginBottom: '1rem', opacity: 0.5 }} />
                                        <h3>Quest for Valhalla</h3>
                                        <p>XP Progess and Achievements will appear here.</p>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const PlayerProfileGallery = ({ roster, onUpdateRoster }) => {
            const [selectedProfileId, setSelectedProfileId] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');

            const filteredRoster = roster.filter(p =>
                p.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                p.number.toString().includes(searchTerm)
            ).sort((a, b) => parseInt(a.number) - parseInt(b.number));

            const updatePlayer = (id, field, value) => {
                // If updating off/def pos, also update the combined string for compat
                let updatedPlayer = roster.find(p => p.id === id);
                if (field === 'offPosition') {
                    const newPos = `${value}/${updatedPlayer.defPosition || 'NA'}`;
                    onUpdateRoster(roster.map(p => p.id === id ? { ...p, [field]: value, position: newPos } : p));
                } else if (field === 'defPosition') {
                    const newPos = `${updatedPlayer.offPosition || 'NA'}/${value}`;
                    onUpdateRoster(roster.map(p => p.id === id ? { ...p, [field]: value, position: newPos } : p));
                } else {
                    onUpdateRoster(roster.map(p => p.id === id ? { ...p, [field]: value } : p));
                }
            };

            return (
                <div style={{ height: '100%', display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                    <div className="card" style={{ padding: '1rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                            <Icon name="Users" size={24} color="var(--primary)" />
                            <h2 style={{ margin: 0 }}>Player Profiles</h2>
                        </div>
                        <div style={{ position: 'relative' }}>
                            <Icon name="Search" size={16} style={{ position: 'absolute', left: '10px', top: '50%', transform: 'translateY(-50%)', color: '#94a3b8' }} />
                            <input
                                type="text"
                                className="form-input"
                                placeholder="Search Name or #"
                                value={searchTerm}
                                onChange={e => setSearchTerm(e.target.value)}
                                style={{ paddingLeft: '2rem' }}
                            />
                        </div>
                    </div>

                    <div style={{ flex: 1, overflowY: 'auto', display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: '1rem', alignContent: 'start' }}>
                        {filteredRoster.map(player => (
                            <div
                                key={player.id}
                                className="card"
                                style={{ padding: '1.5rem', cursor: 'pointer', textAlign: 'center', transition: 'transform 0.2s', border: '1px solid transparent' }}
                                onMouseEnter={e => { e.currentTarget.style.transform = 'translateY(-4px)'; e.currentTarget.style.borderColor = 'var(--primary)'; }}
                                onMouseLeave={e => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.borderColor = 'transparent'; }}
                                onClick={() => setSelectedProfileId(player.id)}
                            >
                                <div style={{
                                    width: '80px', height: '80px', borderRadius: '50%', background: 'var(--surface)', margin: '0 auto 1rem auto',
                                    display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '2rem', fontWeight: 'bold', color: 'var(--text-secondary)'
                                }}>
                                    {player.jersey}
                                </div>
                                <h3 style={{ margin: '0 0 0.5rem 0', fontSize: '1.1rem' }}>{player.firstName} {player.lastName}</h3>
                                <div style={{ fontSize: '0.9rem', color: 'var(--text-secondary)' }}>{player.year} ‚Ä¢ {player.position}</div>
                            </div>
                        ))}
                    </div>

                    {selectedProfileId && (
                        <PlayerProfileView
                            player={roster.find(p => p.id === selectedProfileId)}
                            onClose={() => setSelectedProfileId(null)}
                            onUpdate={updatePlayer}
                        />
                    )}
                </div>
            )
        };

        const RosterManager = ({ roster, onUpdateRoster }) => {
            const [newPlayer, setNewPlayer] = useState({
                number: '', name: '', position: 'QB/LB', offPosition: 'QB', defPosition: 'LB', year: 'Fr', height: '', weight: '',
                injured: false, traveling: true, captain: false,
                offenseRoles: [], defenseRoles: [], specialRoles: [],
                varsity: true, jv: false, jv2: false
            });
            const [isEditing, setIsEditing] = useState(null);
            const [viewProfileId, setViewProfileId] = useState(null);

            const positions = ['QB', 'RB', 'WR', 'TE', 'OL', 'OT', 'OG', 'C', 'DE', 'DT', 'LB', 'CB', 'S', 'K', 'P', 'LS']; // Expanded primary list
            // Filter by Staff ID / Current User Roles
            // In Person-Centric view, we show tasks assigned to ANY of the user's roles.
            // const [selectedRole, setSelectedRole] = useState('ALL'); // Deprecated role selector, 'C', 'DE', 'DT', 'LB', 'CB', 'S', 'K', 'P', 'LS']; // Expanded primary list
            const years = ['Fr', 'So', 'Jr', 'Sr'];

            const OFFENSE_TAGS = ['QB', 'RB', 'WR', 'TE', 'OL'];
            const DEFENSE_TAGS = ['DL', 'LB', 'DB'];
            const SPECIAL_TAGS = ['K', 'P', 'LS', 'H', 'KR', 'PR'];

            const toggleTag = (category, tag) => {
                setNewPlayer(prev => {
                    const current = prev[category];
                    if (current.includes(tag)) {
                        return { ...prev, [category]: current.filter(t => t !== tag) };
                    } else {
                        return { ...prev, [category]: [...current, tag] };
                    }
                });
            };

            const addPlayer = () => {
                if (!newPlayer.number || !newPlayer.name) return;
                const position = `${newPlayer.offPosition}/${newPlayer.defPosition}`;
                onUpdateRoster([...roster, { ...newPlayer, position, id: Date.now().toString() }]);
                setNewPlayer({
                    number: '', name: '', position: 'QB/LB', offPosition: 'QB', defPosition: 'LB', year: 'Fr', height: '', weight: '',
                    injured: false, traveling: true, captain: false,
                    offenseRoles: [], defenseRoles: [], specialRoles: [],
                    varsity: true, jv: false, jv2: false
                });
            };

            const updatePlayer = (id, field, value) => {
                // If updating off/def pos, also update the combined string for compat
                let updatedPlayer = roster.find(p => p.id === id);
                if (field === 'offPosition') {
                    const newPos = `${value}/${updatedPlayer.defPosition || 'NA'}`;
                    onUpdateRoster(roster.map(p => p.id === id ? { ...p, [field]: value, position: newPos } : p));
                } else if (field === 'defPosition') {
                    const newPos = `${updatedPlayer.offPosition || 'NA'}/${value}`;
                    onUpdateRoster(roster.map(p => p.id === id ? { ...p, [field]: value, position: newPos } : p));
                } else {
                    onUpdateRoster(roster.map(p => p.id === id ? { ...p, [field]: value } : p));
                }
            };

            const deletePlayer = (id) => {
                onUpdateRoster(roster.filter(p => p.id !== id));
            };

            // Sort by number
            const sortedRoster = [...roster].sort((a, b) => parseInt(a.number) - parseInt(b.number));

            return (
                <div style={{ height: 'calc(100vh - 100px)', display: 'flex', flexDirection: 'column' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
                        <h2>Roster Management</h2>
                        <button className="btn btn-secondary" onClick={() => window.print()}>üñ®Ô∏è Print Attendance</button>
                    </div>

                    <div className="card" style={{ marginBottom: '2rem' }}>
                        <h4 style={{ marginBottom: '1rem', borderBottom: '1px solid var(--border)', paddingBottom: '0.5rem' }}>Add New Athlete</h4>

                        {/* Row 1: Basic Info */}
                        <div style={{ display: 'flex', gap: '1rem', marginBottom: '1rem' }}>
                            <div style={{ width: '80px' }}>
                                <label className="form-label">#</label>
                                <input type="number" className="form-input" value={newPlayer.number} onChange={e => setNewPlayer({ ...newPlayer, number: e.target.value })} placeholder="#" />
                            </div>
                            <div style={{ flex: 2 }}>
                                <label className="form-label">Name</label>
                                <input type="text" className="form-input" value={newPlayer.name} onChange={e => setNewPlayer({ ...newPlayer, name: e.target.value })} placeholder="Player Name" />
                            </div>
                            <div style={{ flex: 1 }}>
                                <label className="form-label">Off Pos</label>
                                <select className="form-select" value={newPlayer.offPosition} onChange={e => setNewPlayer({ ...newPlayer, offPosition: e.target.value })}>
                                    <option value="NA">--</option>
                                    {positions.map(p => <option key={p}>{p}</option>)}
                                </select>
                            </div>
                            <div style={{ flex: 1 }}>
                                <label className="form-label">Def Pos</label>
                                <select className="form-select" value={newPlayer.defPosition} onChange={e => setNewPlayer({ ...newPlayer, defPosition: e.target.value })}>
                                    <option value="NA">--</option>
                                    {positions.map(p => <option key={p}>{p}</option>)}
                                </select>
                            </div>
                            <div style={{ flex: 1 }}>
                                <label className="form-label">Year</label>
                                <select className="form-select" value={newPlayer.year} onChange={e => setNewPlayer({ ...newPlayer, year: e.target.value })}>
                                    {years.map(y => <option key={y}>{y}</option>)}
                                </select>
                            </div>
                            <div style={{ width: '80px' }}>
                                <label className="form-label">Ht</label>
                                <input type="text" className="form-input" value={newPlayer.height} onChange={e => setNewPlayer({ ...newPlayer, height: e.target.value })} placeholder="6'2" />
                            </div>
                            <div style={{ width: '80px' }}>
                                <label className="form-label">Wt</label>
                                <input type="text" className="form-input" value={newPlayer.weight} onChange={e => setNewPlayer({ ...newPlayer, weight: e.target.value })} placeholder="210" />
                            </div>
                        </div>

                        {/* Row 2: Tagging */}
                        <div style={{ display: 'flex', gap: '2rem', marginBottom: '1rem', flexWrap: 'wrap' }}>
                            <div style={{ flex: 1, minWidth: '200px' }}>
                                <label className="form-label" style={{ color: 'var(--accent)' }}>Offense Roles</label>
                                <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                                    {OFFENSE_TAGS.map(tag => (
                                        <label key={tag} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '0.85rem', cursor: 'pointer', background: newPlayer.offenseRoles.includes(tag) ? 'var(--highlight)' : 'rgba(255,255,255,0.05)', padding: '4px 8px', borderRadius: '4px', border: newPlayer.offenseRoles.includes(tag) ? '1px solid var(--accent)' : '1px solid transparent' }}>
                                            <input type="checkbox" checked={newPlayer.offenseRoles.includes(tag)} onChange={() => toggleTag('offenseRoles', tag)} style={{ display: 'none' }} />
                                            {tag}
                                        </label>
                                    ))}
                                </div>
                            </div>
                            <div style={{ flex: 1, minWidth: '200px' }}>
                                <label className="form-label" style={{ color: 'var(--accent)' }}>Defense Roles</label>
                                <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                                    {DEFENSE_TAGS.map(tag => (
                                        <label key={tag} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '0.85rem', cursor: 'pointer', background: newPlayer.defenseRoles.includes(tag) ? 'var(--highlight)' : 'rgba(255,255,255,0.05)', padding: '4px 8px', borderRadius: '4px', border: newPlayer.defenseRoles.includes(tag) ? '1px solid var(--accent)' : '1px solid transparent' }}>
                                            <input type="checkbox" checked={newPlayer.defenseRoles.includes(tag)} onChange={() => toggleTag('defenseRoles', tag)} style={{ display: 'none' }} />
                                            {tag}
                                        </label>
                                    ))}
                                </div>
                            </div>
                            <div style={{ flex: 1, minWidth: '200px' }}>
                                <label className="form-label" style={{ color: 'var(--accent)' }}>Special Teams</label>
                                <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                                    {SPECIAL_TAGS.map(tag => (
                                        <label key={tag} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '0.85rem', cursor: 'pointer', background: newPlayer.specialRoles.includes(tag) ? 'var(--highlight)' : 'rgba(255,255,255,0.05)', padding: '4px 8px', borderRadius: '4px', border: newPlayer.specialRoles.includes(tag) ? '1px solid var(--accent)' : '1px solid transparent' }}>
                                            <input type="checkbox" checked={newPlayer.specialRoles.includes(tag)} onChange={() => toggleTag('specialRoles', tag)} style={{ display: 'none' }} />
                                            {tag}
                                        </label>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Row 3: Actions */}
                        <div style={{ display: 'flex', justifyContent: 'flex-end', alignItems: 'center', gap: '1rem', borderTop: '1px solid var(--border)', paddingTop: '1rem' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', marginRight: 'auto' }}>
                                <label style={{ fontWeight: 'bold', color: 'var(--text-secondary)' }}>Squads:</label>
                                <label style={{ display: 'flex', alignItems: 'center', gap: '4px', cursor: 'pointer' }}>
                                    <input type="checkbox" checked={newPlayer.varsity} onChange={e => setNewPlayer({ ...newPlayer, varsity: e.target.checked })} style={{ width: '16px', height: '16px', accentColor: 'var(--accent)' }} /> Var
                                </label>
                                <label style={{ display: 'flex', alignItems: 'center', gap: '4px', cursor: 'pointer' }}>
                                    <input type="checkbox" checked={newPlayer.jv} onChange={e => setNewPlayer({ ...newPlayer, jv: e.target.checked })} style={{ width: '16px', height: '16px', accentColor: 'var(--accent)' }} /> JV
                                </label>
                                <label style={{ display: 'flex', alignItems: 'center', gap: '4px', cursor: 'pointer' }}>
                                    <input type="checkbox" checked={newPlayer.jv2} onChange={e => setNewPlayer({ ...newPlayer, jv2: e.target.checked })} style={{ width: '16px', height: '16px', accentColor: 'var(--accent)' }} /> JV2
                                </label>
                            </div>

                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                <input type="checkbox" checked={newPlayer.captain} onChange={e => setNewPlayer({ ...newPlayer, captain: e.target.checked })} style={{ width: '18px', height: '18px', accentColor: 'var(--accent)' }} />
                                <label>Team Captain</label>
                            </div>
                            <button className="btn btn-primary" onClick={addPlayer}>
                                <Icon name="PlusCircle" /> Add Athlete
                            </button>
                        </div>
                    </div>

                    <div style={{ flex: 1, overflowY: 'auto' }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead>
                                <tr style={{ borderBottom: '2px solid var(--border)', textAlign: 'left', color: 'var(--text-secondary)', fontSize: '0.9rem' }}>
                                    <th style={{ padding: '0.5rem' }}>#</th>
                                    <th style={{ padding: '0.5rem' }}>Name</th>
                                    <th style={{ padding: '0.5rem' }}>Pos (Off/Def)</th>
                                    <th style={{ padding: '0.5rem' }}>Roles / Tags</th>
                                    <th style={{ padding: '0.5rem' }}>Year</th>
                                    <th style={{ padding: '0.5rem' }}>Ht</th>
                                    <th style={{ padding: '0.5rem' }}>Wt</th>
                                    <th style={{ padding: '0.5rem', textAlign: 'center' }}>V</th>
                                    <th style={{ padding: '0.5rem', textAlign: 'center' }}>JV</th>
                                    <th style={{ padding: '0.5rem', textAlign: 'center' }}>J2</th>
                                    <th style={{ padding: '0.5rem', textAlign: 'center' }}>Cpt</th>
                                    <th style={{ padding: '0.5rem', textAlign: 'center' }}>Traveling</th>
                                    <th style={{ padding: '0.5rem', textAlign: 'right' }}>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {sortedRoster.map(player => (
                                    <tr key={player.id} style={{ borderBottom: '1px solid var(--border)' }}>
                                        <td style={{ padding: '0.75rem 0.5rem', fontWeight: 'bold', color: 'var(--accent)' }}>
                                            {isEditing === player.id ? (
                                                <input
                                                    type="number"
                                                    className="form-input"
                                                    style={{ width: '60px' }}
                                                    value={player.number}
                                                    onChange={e => updatePlayer(player.id, 'number', e.target.value)}
                                                />
                                            ) : `#${player.number}`}
                                        </td>
                                        <td style={{ padding: '0.75rem 0.5rem', fontWeight: 'bold' }}>
                                            {isEditing === player.id ? (
                                                <input
                                                    type="text"
                                                    className="form-input"
                                                    value={player.name}
                                                    onChange={e => updatePlayer(player.id, 'name', e.target.value)}
                                                />
                                            ) : (
                                                <span>
                                                    {player.name}
                                                    {player.captain && <span style={{ marginLeft: '0.5rem', fontSize: '0.8rem' }}>¬©Ô∏è</span>}
                                                </span>
                                            )}
                                        </td>
                                        <td style={{ padding: '0.75rem 0.5rem' }}>
                                            {isEditing === player.id ? (
                                                <div style={{ display: 'flex', gap: '4px', flexDirection: 'column' }}>
                                                    <select
                                                        className="form-select"
                                                        style={{ padding: '2px', fontSize: '0.8rem' }}
                                                        value={player.offPosition || 'NA'}
                                                        onChange={e => updatePlayer(player.id, 'offPosition', e.target.value)}
                                                    >
                                                        <option value="NA">--</option>
                                                        {positions.map(p => <option key={p}>{p}</option>)}
                                                    </select>
                                                    <select
                                                        className="form-select"
                                                        style={{ padding: '2px', fontSize: '0.8rem' }}
                                                        value={player.defPosition || 'NA'}
                                                        onChange={e => updatePlayer(player.id, 'defPosition', e.target.value)}
                                                    >
                                                        <option value="NA">--</option>
                                                        {positions.map(p => <option key={p}>{p}</option>)}
                                                    </select>
                                                </div>
                                            ) : (
                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>
                                                    <span style={{ fontWeight: 'bold', color: 'var(--text-primary)' }}>{player.offPosition}</span>
                                                    <span style={{ color: 'var(--text-secondary)', fontSize: '0.85rem' }}>{player.defPosition}</span>
                                                </div>
                                            )}
                                        </td>
                                        <td style={{ padding: '0.75rem 0.5rem' }}>
                                            <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap' }}>
                                                {(player.offenseRoles || []).map(t => (
                                                    <span key={t} style={{ fontSize: '0.7rem', background: 'rgba(255,255,255,0.1)', padding: '2px 6px', borderRadius: '4px' }}>{t}</span>
                                                ))}
                                                {(player.defenseRoles || []).map(t => (
                                                    <span key={t} style={{ fontSize: '0.7rem', background: 'rgba(239, 68, 68, 0.2)', padding: '2px 6px', borderRadius: '4px', color: '#fca5a5' }}>{t}</span>
                                                ))}
                                                {(player.specialRoles || []).map(t => (
                                                    <span key={t} style={{ fontSize: '0.7rem', background: 'rgba(59, 130, 246, 0.2)', padding: '2px 6px', borderRadius: '4px', color: '#93c5fd' }}>{t}</span>
                                                ))}
                                            </div>
                                        </td>
                                        <td style={{ padding: '0.75rem 0.5rem' }}>
                                            {isEditing === player.id ? (
                                                <select
                                                    className="form-select"
                                                    value={player.year}
                                                    onChange={e => updatePlayer(player.id, 'year', e.target.value)}
                                                >
                                                    {years.map(y => <option key={y}>{y}</option>)}
                                                </select>
                                            ) : player.year}
                                        </td>
                                        <td style={{ padding: '0.75rem 0.5rem' }}>
                                            {isEditing === player.id ? (
                                                <input
                                                    type="text"
                                                    className="form-input"
                                                    style={{ width: '60px' }}
                                                    value={player.height || ''}
                                                    onChange={e => updatePlayer(player.id, 'height', e.target.value)}
                                                />
                                            ) : player.height}
                                        </td>
                                        <td style={{ padding: '0.75rem 0.5rem' }}>
                                            {isEditing === player.id ? (
                                                <input
                                                    type="text"
                                                    className="form-input"
                                                    style={{ width: '60px' }}
                                                    value={player.weight || ''}
                                                    onChange={e => updatePlayer(player.id, 'weight', e.target.value)}
                                                />
                                            ) : player.weight}
                                        </td>
                                        <td style={{ padding: '0.75rem 0.5rem', textAlign: 'center' }}>
                                            <input type="checkbox" checked={player.varsity || false} onChange={e => updatePlayer(player.id, 'varsity', e.target.checked)} style={{ width: '16px', height: '16px', accentColor: 'var(--accent)' }} />
                                        </td>
                                        <td style={{ padding: '0.75rem 0.5rem', textAlign: 'center' }}>
                                            <input type="checkbox" checked={player.jv || false} onChange={e => updatePlayer(player.id, 'jv', e.target.checked)} style={{ width: '16px', height: '16px', accentColor: 'var(--accent)' }} />
                                        </td>
                                        <td style={{ padding: '0.75rem 0.5rem', textAlign: 'center' }}>
                                            <input type="checkbox" checked={player.jv2 || false} onChange={e => updatePlayer(player.id, 'jv2', e.target.checked)} style={{ width: '16px', height: '16px', accentColor: 'var(--accent)' }} />
                                        </td>
                                        <td style={{ padding: '0.75rem 0.5rem', textAlign: 'center' }}>
                                            <input
                                                type="checkbox"
                                                checked={player.captain || false}
                                                onChange={e => updatePlayer(player.id, 'captain', e.target.checked)}
                                                style={{ width: '18px', height: '18px', accentColor: 'var(--accent)' }}
                                            />
                                        </td>
                                        <td style={{ padding: '0.75rem 0.5rem', textAlign: 'center' }}>
                                            <input
                                                type="checkbox"
                                                checked={player.traveling !== false}
                                                onChange={e => updatePlayer(player.id, 'traveling', e.target.checked)}
                                                style={{ width: '18px', height: '18px', accentColor: '#10b981' }}
                                            />
                                        </td>
                                        <td style={{ padding: '0.75rem 1rem', textAlign: 'right' }}>
                                            {isEditing === player.id ? (
                                                <button className="btn btn-primary" style={{ padding: '0.25rem 0.75rem', fontSize: '0.8rem' }} onClick={() => setIsEditing(null)}>Done</button>
                                            ) : (
                                                <div style={{ display: 'flex', gap: '0.5rem', justifyContent: 'flex-end' }}>
                                                    <button className="btn btn-secondary" style={{ padding: '0.25rem 0.5rem', fontSize: '0.8rem' }} onClick={() => setIsEditing(player.id)}>Edit</button>
                                                    <button className="btn" style={{ padding: '0.25rem 0.5rem', fontSize: '0.8rem', color: '#ef4444' }} onClick={() => deletePlayer(player.id)}>Delete</button>
                                                </div>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };





        const DUTY_CATEGORIES = {
            "Leadership": [
                "Assistant Head Coach", "Director of Football Operations", "Strength & Cond Coordinator",
                "Defensive Coordinator", "Offensive Coordinator", "Special Teams Coordinator",
                "Technology Coordinator", "Recruiting Coordinator", "Middle School Head Coach", "Director of Youth Football"
            ],
            "General": [
                "Technology/Video", "Equipment", "Player Equipment", "Field Equipment", "Footballs",
                "Discipline", "Lockers", "Player Files", "Support Staff", "Academics",
                "Program Promotion", "Awards/Appreciations", "Social Media/Marketing", "Recruiting", "Sponsorships"
            ],
            "Scouting": [
                "Self-Scouting", "Statistics", "Goal Chart", "Each Position Graded",
                "Off Self-Scout Report", "Def Self-Scout Report", "Specialty Self-Scout",
                "Upcoming Opponent Scouting", "Personnel (O/D/K)", "Off. Scouting Report",
                "Def. Scouting Report", "Specialty Scout Report", "Practice/Game Planning",
                "Practice Plans", "Practice Scripts (O/D/K)", "Draw Cards", "Game Call Sheet"
            ],
            "Offense": {
                "Varsity": [
                    "Offensive Coordinator", "Quarterbacks", "Running Backs", "Receivers",
                    "Tight Ends", "Offensive Line (x2)", "Scout Defense", "Scout Defensive Skill", "Scout Defensive Front"
                ],
                "JV/Freshman": [
                    "JV Off. Coordinator", "9th Off. Coordinator", "JV/9th Off. Backs",
                    "JV/9th Receivers", "JV/9th Off. Line/TE (x2)"
                ]
            },
            "Defense": {
                "Varsity": [
                    "Defensive Coordinator", "Defensive Line", "Inside Backers", "Outside Backers",
                    "Cornerbacks", "Safeties", "Scout Offense", "Scout Offensive Line", "Scout Offensive Skill"
                ],
                "JV/Freshman": [
                    "JV Def. Coordinator", "9th Def. Coordinator", "JV/9th Def. Line",
                    "JV/9th Inside Backers", "JV/9th Outside Backers", "JV/9th Def. Backs"
                ]
            },
            "Medical": [
                "Athletic Trainer", "Team Doctors", "Athletic Trainers"
            ],
            "Special Teams": {
                "General": ["Special Teams Coordinator"],
                "Kickoff": ["Kickers", "Right Contain", "Right Coverage", "Left Contain", "Left Coverage", "Scout Kick Return"],
                "Kick Return": ["Kick Return", "Right Edge", "Left Edge", "Middle", "Up-Backs", "Returners", "Scout Kickoff"],
                "Punt": ["Punters", "Shooters", "Long Snappers", "Right Protection", "Left Protection", "Scout Punt Return"],
                "Punt Return": ["Punt Return", "Defensive Line", "Inside Backers", "Blockers", "Corners", "Returners", "Scout Punt"],
                "Xpt/FG": ["Kickers", "Hold/Snap", "Right Edge", "Interior OL", "Left Edge", "Scout Kick Block"],
                "Kick Block": ["Kick Block", "Interior Push", "Blockers", "Check Fake", "Scout Xpt/FG"],
                "Sub-Varsity": ["JV Specialty Coordinator", "Fresh. Specialty Coordinator"]
            },
            "Practice": {
                "Before Practice": [
                    "Supervision", "Equipment", "Field Set Up", "Footballs", "Press Box Set Up",
                    "Video Set Up", "Taping/Injury Maint", "Managers"
                ],
                "After Practice": [
                    "Distraction List", "Video", "Player Issues", "Footballs", "Press Box Clean Up",
                    "Field Clean Up", "Injury Maint", "Supervision"
                ]
            },
            "Games": {
                "During the Day": ["Water/Powerade", "Officials Room (home)", "Visitors‚Äô Room (home)", "Load Truck (away)", "Equipment"],
                "Pre-Game": ["Headsets", "Video", "Field Set Up", "Monitor Players"],
                "In-Game": [
                    "Call Offense/Defense", "Signal Offense/Defense", "Position Groups",
                    "Press Box Off/Def", "Specialty Organization", "Equipment", "Sideline Control",
                    "Hype Man", "Time Management", "Kickers", "Injuries"
                ],
                "Post-Game": [
                    "Field Clean Up", "Water Clean Up", "Headsets", "Video", "Player Supervision",
                    "Collect Cloth", "Officials Room (home)", "Visitor‚Äôs Room (home)", "Load Trailer (away)",
                    "Attendance (away)", "Injuries", "Media"
                ],
                "Sub-Varsity Games": ["Medical Kit", "Video", "Equipment Box", "Water", "Field Set Up/Clean Up"]
            },
            "Extra": [
                "Fundraising Team", "Feeder Team", "Program Promotion",
                "Misc. Responsibilities", "Program Evaluation & Meetings with Head Coach"
            ]
        };

        // --- VALHALLA UI COMPONENTS ---

        // --- VALHALLA 2.0 CONSTANTS & HELPERS ---
        const VALHALLA_CONSTANTS = {
            PILLARS: {
                CHARACTER: { id: 'CHARACTER', label: 'Character', color: '#8884d8', description: 'Discipline, integrity, grit, follow-through' },
                CONNECTION: { id: 'CONNECTION', label: 'Connection', color: '#82ca9d', description: 'Serving others, bonding, showing up' },
                COMPETENCE: { id: 'COMPETENCE', label: 'Competence', color: '#ffc658', description: 'Strength, skill, IQ, execution' }
            },
            SEASONS: {
                SUMMER: { id: 'SUMMER', label: 'Summer Quests', order: 1 },
                IN_SEASON: { id: 'IN_SEASON', label: 'In-Season Quests', order: 2 },
                OFF_SEASON: { id: 'OFF_SEASON', label: 'Off-Season Quests', order: 3 },
                CORE: { id: 'CORE', label: 'Core / Multipliers', order: 0 }
            },
            BADGE_XP: {
                Iron: 50,
                Bronze: 75,
                Silver: 100,
                Gold: 150,
                Platinum: 250
            },
            QUESTS: {
                // --- CORE / QUARTERLY (Available Year-Round) ---
                'bench_pr': {
                    id: 'bench_pr',
                    name: 'Bench Press PR (Quarterly)',
                    season: 'CORE',
                    pillars: ['COMPETENCE'],
                    badges: [
                        { name: 'Iron PR (+5 lbs)', tier: 'Iron' },
                        { name: 'Bronze PR (+10 lbs)', tier: 'Bronze' },
                        { name: 'Silver PR (+15 lbs)', tier: 'Silver' },
                        { name: 'Gold PR (+20 lbs)', tier: 'Gold' },
                        { name: 'Platinum PR (+25+ lbs)', tier: 'Platinum' }
                    ],
                    inputs: [{ name: 'Lbs Added', type: 'Number', xpPerUnit: 0 }]
                },
                'squat_pr': {
                    id: 'squat_pr',
                    name: 'Squat PR (Quarterly)',
                    season: 'CORE',
                    pillars: ['COMPETENCE'],
                    badges: [
                        { name: 'Iron PR (+10 lbs)', tier: 'Iron' },
                        { name: 'Bronze PR (+20 lbs)', tier: 'Bronze' },
                        { name: 'Silver PR (+30 lbs)', tier: 'Silver' },
                        { name: 'Gold PR (+40 lbs)', tier: 'Gold' },
                        { name: 'Platinum PR (+50+ lbs)', tier: 'Platinum' }
                    ],
                    inputs: [{ name: 'Lbs Added', type: 'Number', xpPerUnit: 0 }]
                },
                'pound_for_pound_bench': {
                    id: 'pound_for_pound_bench',
                    name: 'LB/LB Bench Press',
                    season: 'CORE',
                    pillars: ['COMPETENCE'],
                    badges: [
                        { name: 'Iron Ratio (1.0x)', tier: 'Iron' },
                        { name: 'Bronze Ratio (1.25x)', tier: 'Bronze' },
                        { name: 'Silver Ratio (1.50x)', tier: 'Silver' },
                        { name: 'Gold Ratio (1.75x)', tier: 'Gold' },
                        { name: 'Platinum Ratio (2.0x)', tier: 'Platinum' }
                    ],
                    inputs: [{ name: 'Ratio', type: 'Number', xpPerUnit: 0 }]
                },
                'pound_for_pound_squat': {
                    id: 'pound_for_pound_squat',
                    name: 'LB/LB Squat',
                    season: 'CORE',
                    pillars: ['COMPETENCE'],
                    badges: [
                        { name: 'Iron Ratio (1.25x)', tier: 'Iron' },
                        { name: 'Bronze Ratio (1.50x)', tier: 'Bronze' },
                        { name: 'Silver Ratio (1.75x)', tier: 'Silver' },
                        { name: 'Gold Ratio (2.00x)', tier: 'Gold' },
                        { name: 'Platinum Ratio (2.25x)', tier: 'Platinum' }
                    ],
                    inputs: [{ name: 'Ratio', type: 'Number', xpPerUnit: 0 }]
                },
                'competitive_lifting': {
                    id: 'competitive_lifting',
                    name: 'Competitive Lifting (Quarterly)',
                    season: 'CORE',
                    pillars: ['COMPETENCE', 'CHARACTER'],
                    badges: [
                        { name: 'Iron (Top 3 Pos)', tier: 'Iron' },
                        { name: 'Bronze (Best Pos)', tier: 'Bronze' },
                        { name: 'Silver (Best Grade)', tier: 'Silver' },
                        { name: 'Gold (Best Program)', tier: 'Gold' },
                        { name: 'Platinum (Record)', tier: 'Platinum' }
                    ],
                    inputs: []
                },
                'iron_man_attendance': {
                    id: 'iron_man_attendance',
                    name: 'Iron Man - Weight Room (Quarterly)',
                    season: 'CORE',
                    pillars: ['CHARACTER', 'COMPETENCE'],
                    badges: [
                        { name: 'Iron (85%)', tier: 'Iron' },
                        { name: 'Bronze (90%)', tier: 'Bronze' },
                        { name: 'Silver (95%)', tier: 'Silver' },
                        { name: 'Gold (98%)', tier: 'Gold' },
                        { name: 'Platinum (100%)', tier: 'Platinum' }
                    ],
                    inputs: [{ name: 'Attendance %', type: 'Number', xpPerUnit: 0 }]
                },
                'practice_attendance': {
                    id: 'practice_attendance',
                    name: 'Practice Attendance',
                    season: 'CORE',
                    pillars: ['CHARACTER'],
                    badges: [
                        { name: 'Iron (‚â§2 Abs)', tier: 'Iron' },
                        { name: 'Bronze (1 Abs)', tier: 'Bronze' },
                        { name: 'Silver (0 Unexc)', tier: 'Silver' },
                        { name: 'Gold (Zero Missed)', tier: 'Gold' },
                        { name: 'Platinum (0 Missed + 2 Cycles)', tier: 'Platinum' }
                    ],
                    inputs: []
                },
                'volunteer_hours_quarterly': {
                    id: 'volunteer_hours_quarterly',
                    name: 'Volunteer Hours (Quarterly)',
                    season: 'CORE',
                    pillars: ['CONNECTION'],
                    badges: [
                        { name: 'Iron (3 hrs)', tier: 'Iron' },
                        { name: 'Bronze (6 hrs)', tier: 'Bronze' },
                        { name: 'Silver (9 hrs)', tier: 'Silver' },
                        { name: 'Gold (12 hrs)', tier: 'Gold' },
                        { name: 'Platinum (15+ hrs)', tier: 'Platinum' }
                    ],
                    inputs: [{ name: 'Hours', type: 'Number', xpPerUnit: 0 }]
                },
                'volunteer_hours_annual': {
                    id: 'volunteer_hours_annual',
                    name: 'Volunteer Hours (Annual)',
                    season: 'CORE',
                    pillars: ['CONNECTION'],
                    badges: [
                        { name: 'Iron (10 hrs)', tier: 'Iron' },
                        { name: 'Bronze (20 hrs)', tier: 'Bronze' },
                        { name: 'Silver (30 hrs)', tier: 'Silver' },
                        { name: 'Gold (40 hrs)', tier: 'Gold' },
                        { name: 'Platinum (50+ hrs)', tier: 'Platinum' }
                    ],
                    inputs: [{ name: 'Total Hours', type: 'Number', xpPerUnit: 0 }]
                },
                'leadership_class_q': {
                    id: 'leadership_class_q',
                    name: 'Leadership Class (Quarterly)',
                    season: 'CORE',
                    pillars: ['CHARACTER', 'CONNECTION'],
                    badges: [
                        { name: 'Iron (1 Assign / Demo)', tier: 'Iron' },
                        { name: 'Bronze (2 Assign / Coach Rec)', tier: 'Bronze' },
                        { name: 'Silver (3 Assign / Team Rec)', tier: 'Silver' },
                        { name: 'Gold (4 Assign / Leads Group)', tier: 'Gold' },
                        { name: 'Platinum (Full / Runs Activity)', tier: 'Platinum' }
                    ],
                    inputs: []
                },
                'academics_core': {
                    id: 'academics_core',
                    name: 'Academics (Quarterly)',
                    season: 'CORE',
                    pillars: ['CHARACTER'],
                    badges: [
                        { name: 'GPA Iron (3.0)', tier: 'Iron' },
                        { name: 'GPA Bronze (3.25)', tier: 'Bronze' },
                        { name: 'GPA Silver (3.50)', tier: 'Silver' },
                        { name: 'GPA Gold (3.75)', tier: 'Gold' },
                        { name: 'GPA Platinum (4.0)', tier: 'Platinum' },
                        { name: 'Imp Iron (+.1)', tier: 'Iron' },
                        { name: 'Imp Bronze (+.2)', tier: 'Bronze' },
                        { name: 'Imp Silver (+.3)', tier: 'Silver' },
                        { name: 'Imp Gold (+.4)', tier: 'Gold' },
                        { name: 'Imp Platinum (+.5)', tier: 'Platinum' },
                        { name: 'Att Iron (95%)', tier: 'Iron' },
                        { name: 'Att Bronze (96%)', tier: 'Bronze' },
                        { name: 'Att Silver (97%)', tier: 'Silver' },
                        { name: 'Att Gold (98%)', tier: 'Gold' },
                        { name: 'Att Platinum (99%)', tier: 'Platinum' }
                    ],
                    inputs: [{ name: 'GPA', type: 'Number', xpPerUnit: 0 }]
                },
                'multisport_annual': {
                    id: 'multisport_annual',
                    name: 'Multi-Sport (Annual)',
                    season: 'CORE',
                    pillars: ['COMPETENCE'],
                    badges: [
                        { name: 'Iron (1 Extra)', tier: 'Iron' },
                        { name: 'Bronze (2 Extra)', tier: 'Bronze' },
                        { name: 'Silver (3 Extra)', tier: 'Silver' },
                        { name: 'Gold (2 Letters)', tier: 'Gold' },
                        { name: 'Platinum (3 Letters/State)', tier: 'Platinum' }
                    ],
                    inputs: []
                },

                // --- IN-SEASON SPECIFIC ---
                'postseason_honors': {
                    id: 'postseason_honors',
                    name: 'Postseason Honors',
                    season: 'IN_SEASON',
                    pillars: ['COMPETENCE'],
                    badges: [
                        { name: 'HM All-District', tier: 'Iron' },
                        { name: '2nd Team District', tier: 'Bronze' },
                        { name: '1st Team District', tier: 'Silver' },
                        { name: '2nd Team State', tier: 'Gold' },
                        { name: '1st Team State / Elite', tier: 'Platinum' }
                    ],
                    inputs: []
                },
                'film_iq': {
                    id: 'film_iq',
                    name: 'Film & IQ (Quarterly)',
                    season: 'IN_SEASON',
                    pillars: ['COMPETENCE'],
                    badges: [
                        { name: 'Film Iron (1)', tier: 'Iron' },
                        { name: 'Film Bronze (2)', tier: 'Bronze' },
                        { name: 'Film Silver (3)', tier: 'Silver' },
                        { name: 'Film Gold (4)', tier: 'Gold' },
                        { name: 'Film Platinum (5+)', tier: 'Platinum' },
                        { name: 'Quiz Iron (70%)', tier: 'Iron' },
                        { name: 'Quiz Bronze (80%)', tier: 'Bronze' },
                        { name: 'Quiz Silver (85%)', tier: 'Silver' },
                        { name: 'Quiz Gold (90%)', tier: 'Gold' },
                        { name: 'Quiz Platinum (95%)', tier: 'Platinum' }
                    ],
                    inputs: []
                },
                'game_performance': {
                    id: 'game_performance',
                    name: 'Game Performance',
                    season: 'IN_SEASON',
                    pillars: ['COMPETENCE'],
                    badges: [
                        { name: 'Warrior Badge', tier: 'Gold', description: 'First Varsity Start' },
                        { name: 'Battle Mastery', tier: 'Platinum', description: 'Perfect Assignment Game' },
                        { name: 'Explosive Maker', tier: 'Silver' },
                        { name: 'Two-Way Ironman', tier: 'Gold' }
                    ],
                    inputs: [
                        { name: 'Assignment Win %', type: 'Number', xpPerUnit: 1 },
                        { name: 'Big Play Prevention', type: 'Number', xpPerUnit: 30 }
                    ]
                },

                // --- SUMMER SPECIFIC (Legacy / Flavor) ---
                'summer_7on7': {
                    id: 'summer_7on7',
                    name: '7-on-7 / Team Comp',
                    season: 'SUMMER',
                    pillars: ['CONNECTION', 'COMPETENCE'],
                    badges: [
                        { name: 'Summer Skirmish Champ', tier: 'Gold' },
                        { name: '2-Minute Drill Master', tier: 'Silver' },
                        { name: 'Leadership Captain', tier: 'Platinum' }
                    ],
                    inputs: [{ name: 'Sessions Attended', type: 'Number', xpPerUnit: 15 }]
                }
            }
        };

        const calculatePillarXP = (progressData) => {
            const scores = { CHARACTER: 0, CONNECTION: 0, COMPETENCE: 0, TOTAL: 0 };

            if (!progressData) return scores;

            Object.entries(progressData).forEach(([questId, pData]) => {
                const questDef = VALHALLA_CONSTANTS.QUESTS[questId];
                if (!questDef) return;

                // Sum up inputs
                let questBaseXP = 0;
                if (pData.inputs) {
                    Object.entries(pData.inputs).forEach(([inputName, val]) => {
                        const inputDef = questDef.inputs.find(i => i.name === inputName);
                        if (inputDef) {
                            if (inputDef.type === 'Boolean' && val === true) {
                                questBaseXP += inputDef.xpPerUnit;
                            } else if (inputDef.type === 'Number' && typeof val === 'number') {
                                questBaseXP += (val * inputDef.xpPerUnit);
                            }
                        }
                    });
                }

                // Apply Multipliers
                let multiplier = 1.0;
                if (pData.multipliers) {
                    pData.multipliers.forEach(mLabel => {
                        const mDef = questDef.multipliers?.find(m => m.label === mLabel);
                        if (mDef) multiplier += mDef.value;
                    });
                }

                // Badge XP
                let badgeXP = 0;
                if (pData.badges) {
                    pData.badges.forEach(bName => {
                        const bDef = questDef.badges?.find(b => b.name === bName);
                        if (bDef && bDef.tier && VALHALLA_CONSTANTS.BADGE_XP[bDef.tier]) {
                            badgeXP += VALHALLA_CONSTANTS.BADGE_XP[bDef.tier];
                        }
                    });
                }

                const finalQuestXP = Math.floor((questBaseXP * multiplier) + badgeXP);
                scores.TOTAL += finalQuestXP;

                // Split XP among pillars
                const splitCount = questDef.pillars.length;
                const xpPerPillar = Math.floor(finalQuestXP / splitCount);
                questDef.pillars.forEach(pid => {
                    scores[pid] += xpPerPillar;
                });
            });

            return scores;
        };



        const StaffCalendar = () => {
            return (
                <div style={{ height: '100%', display: 'flex', flexDirection: 'column', gap: '1.5rem', padding: '1rem', overflowY: 'auto' }}>
                    <div className="card" style={{ padding: '2rem' }}>
                        <h2 style={{ margin: '0 0 0.5rem 0' }}>Annual Program Calendar</h2>
                        <p style={{ color: 'var(--text-secondary)', margin: 0 }}>
                            Master schedule for Staff, Program Events, and Valhalla XP Milestones.
                        </p>
                    </div>

                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))', gap: '1.5rem' }}>
                        {VALHALLA_CONSTANTS.ANNUAL_CALENDAR_DEFAULTS.map((month, idx) => (
                            <div key={idx} className="card" style={{ padding: 0, overflow: 'hidden', border: '1px solid var(--border)' }}>
                                <div style={{ background: 'var(--surface)', padding: '1rem', fontWeight: 'bold', fontSize: '1.2rem', borderBottom: '1px solid var(--border)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    {month.month}
                                    <span style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', fontWeight: 'normal' }}>{idx + 1}</span>
                                </div>
                                <div style={{ padding: '1.5rem' }}>
                                    {/* Program Events */}
                                    <div style={{ marginBottom: '1.5rem' }}>
                                        <div style={{
                                            fontSize: '0.75rem', color: '#60a5fa', fontWeight: 'bold',
                                            marginBottom: '0.75rem', textTransform: 'uppercase', letterSpacing: '0.05em',
                                            display: 'flex', alignItems: 'center', gap: '0.5rem'
                                        }}>
                                            <Icon name="Calendar" size={12} /> Program / Staff
                                        </div>
                                        <ul style={{ margin: 0, paddingLeft: '1.2rem', color: 'var(--text-primary)', fontSize: '0.9rem', lineHeight: '1.5' }}>
                                            {month.program.map((item, i) => (
                                                <li key={i} style={{ marginBottom: '6px' }}>{item}</li>
                                            ))}
                                        </ul>
                                    </div>

                                    {/* Valhalla XP */}
                                    <div style={{ borderTop: '1px dashed var(--border)', paddingTop: '1rem' }}>
                                        <div style={{
                                            fontSize: '0.75rem', color: '#ffd700', fontWeight: 'bold',
                                            marginBottom: '0.75rem', textTransform: 'uppercase', letterSpacing: '0.05em',
                                            display: 'flex', alignItems: 'center', gap: '0.5rem'
                                        }}>
                                            <Icon name="Award" size={12} /> Valhalla XP
                                        </div>
                                        <ul style={{ margin: 0, paddingLeft: '1.2rem', color: 'var(--text-primary)', fontSize: '0.9rem', lineHeight: '1.5' }}>
                                            {month.valhalla.map((item, i) => (
                                                <li key={i} style={{ marginBottom: '6px' }}>{item}</li>
                                            ))}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ValhallaDashboard = ({ roster, valhallaData, onUpdateValhalla, initialTab = 'player' }) => {
            const [activeTab, setActiveTab] = useState(initialTab); // player, quests, admin
            const [selectedPlayerId, setSelectedPlayerId] = useState(roster[0]?.id || null);
            const selectedPlayer = roster.find(p => p.id === selectedPlayerId);

            // Modal State
            const [showEventModal, setShowEventModal] = useState(false);
            const [editingEvent, setEditingEvent] = useState(null);

            // "Smart" Badge AI Logic
            const BADGE_SUGGESTIONS = {
                'fund': [
                    { name: 'Rainmaker', tier: 'Platinum' },
                    { name: 'The 500 Club', tier: 'Silver' },
                    { name: 'Golden Donor', tier: 'Gold' },
                    { name: 'Fundraising King', tier: 'Gold' },
                    { name: 'Community Hero', tier: 'Bronze' }
                ],
                'lift': [
                    { name: 'Iron Titan', tier: 'Platinum' },
                    { name: 'Bar Bender', tier: 'Silver' },
                    { name: 'Gym Rat', tier: 'Bronze' },
                    { name: 'Hercules', tier: 'Gold' },
                    { name: 'Plate Smashing', tier: 'Silver' }
                ],
                'strength': [
                    { name: 'Iron Titan', tier: 'Platinum' },
                    { name: 'Strongman', tier: 'Gold' },
                    { name: 'Powerhouse', tier: 'Silver' }
                ],
                'run': [
                    { name: 'Speed Demon', tier: 'Gold' },
                    { name: 'Flash', tier: 'Silver' },
                    { name: 'Road Runner', tier: 'Bronze' },
                    { name: 'Marathon Man', tier: 'Gold' }
                ],
                'speed': [
                    { name: 'Speed Demon', tier: 'Gold' },
                    { name: 'Flash', tier: 'Silver' },
                    { name: 'Lightning', tier: 'Bronze' },
                    { name: 'Afterburners', tier: 'Silver' }
                ],
                'camp': [
                    { name: 'Camp Beast', tier: 'Gold' },
                    { name: 'Survivor', tier: 'Bronze' },
                    { name: 'Leadership Council', tier: 'Platinum' },
                    { name: 'Tone Setter', tier: 'Silver' }
                ],
                'combine': [
                    { name: 'Combine King', tier: 'Platinum' },
                    { name: 'Off the Charts', tier: 'Gold' },
                    { name: 'Freak Athlete', tier: 'Silver' },
                    { name: 'Record Breaker', tier: 'Gold' }
                ],
                'community': [
                    { name: 'Community Hero', tier: 'Gold' },
                    { name: 'Ambassador', tier: 'Silver' },
                    { name: 'Servant Leader', tier: 'Platinum' }
                ],
                'default': [
                    { name: 'Valhalla Bound', tier: 'Bronze' },
                    { name: 'Points Machine', tier: 'Silver' },
                    { name: 'Program Legend', tier: 'Platinum' },
                    { name: 'Hard Hat', tier: 'Bronze' },
                    { name: 'Lunch Pail', tier: 'Bronze' }
                ]
            };

            const suggestBadges = (eventName) => {
                const lowerName = eventName.toLowerCase();
                let suggestions = [];
                const seen = new Set();

                // Helper to add unique by name
                const add = (list) => {
                    list.forEach(b => {
                        if (!seen.has(b.name)) {
                            seen.add(b.name);
                            suggestions.push(b);
                        }
                    });
                };

                Object.keys(BADGE_SUGGESTIONS).forEach(key => {
                    if (key !== 'default' && lowerName.includes(key)) {
                        add(BADGE_SUGGESTIONS[key]);
                    }
                });

                // If empty or few, add generic
                if (suggestions.length < 3) {
                    add(BADGE_SUGGESTIONS['default']);
                }

                return suggestions.slice(0, 5); // Return top 5 objects
            };

            // Tier Color Helper
            const getTierColor = (tier) => {
                switch (tier) {
                    case 'Platinum': return '#e5e4e2'; // Platinum/White
                    case 'Gold': return '#ffd700';
                    case 'Silver': return '#c0c0c0';
                    case 'Bronze': return '#cd7f32';
                    case 'Iron': return '#4a4a4a';
                    default: return '#3b82f6'; // Blue default
                }
            };

            // Calculate total XP for a player using new Pillar Logic + Custom Events
            const getPlayerScores = (pid) => {
                const pData = valhallaData.progress[pid] || {};
                const scores = calculatePillarXP(pData);

                // Add Custom Event XP
                const customEvents = valhallaData.programEvents || [];
                const participation = valhallaData.participation || {};

                customEvents.forEach(ev => {
                    const eventPart = participation[ev.id] || {};
                    const playerPart = eventPart[pid];

                    if (playerPart) {
                        // Base Points
                        const points = parseInt(ev.points || 0);
                        if (points > 0) {
                            scores.TOTAL += points;
                            // Split across pillars (default behavior for generic events)
                            const split = Math.floor(points / 3);
                            scores.CHARACTER += split;
                            scores.CONNECTION += split;
                            scores.COMPETENCE += split;
                            // Add remainder to Connection
                            scores.CONNECTION += (points % 3);
                        }

                        // Check for Custom Badges (if we implementing tracking specific badges per user later)
                        // For now assuming binary participation = all points
                    }
                });

                return scores;
            };

            const sortedRoster = [...roster].sort((a, b) => getPlayerScores(b.id).TOTAL - getPlayerScores(a.id).TOTAL);

            const updateQuestInput = (playerId, questId, inputName, value) => {
                const newData = { ...valhallaData };
                if (!newData.progress[playerId]) newData.progress[playerId] = {};
                if (!newData.progress[playerId][questId]) newData.progress[playerId][questId] = { inputs: {}, multipliers: [] };

                // Ensure inputs object exists
                if (!newData.progress[playerId][questId].inputs) newData.progress[playerId][questId].inputs = {};

                newData.progress[playerId][questId].inputs[inputName] = value;
                newData.progress[playerId][questId].lastUpdated = new Date().toISOString();

                onUpdateValhalla(newData);
            };

            const toggleQuestMultiplier = (playerId, questId, multiplierLabel) => {
                const newData = { ...valhallaData };
                if (!newData.progress[playerId]) newData.progress[playerId] = {};
                if (!newData.progress[playerId][questId]) newData.progress[playerId][questId] = { inputs: {}, multipliers: [] };

                const currentMultipliers = newData.progress[playerId][questId].multipliers || [];
                const idx = currentMultipliers.indexOf(multiplierLabel);

                if (idx >= 0) {
                    currentMultipliers.splice(idx, 1);
                } else {
                    currentMultipliers.push(multiplierLabel);
                }

                newData.progress[playerId][questId].multipliers = currentMultipliers;
                onUpdateValhalla(newData);
            };

            const toggleQuestBadge = (playerId, questId, badgeName) => {
                const newData = { ...valhallaData };
                if (!newData.progress[playerId]) newData.progress[playerId] = {};
                if (!newData.progress[playerId][questId]) newData.progress[playerId][questId] = { inputs: {}, multipliers: [], badges: [] };

                // ensure badges array exists
                if (!newData.progress[playerId][questId].badges) newData.progress[playerId][questId].badges = [];

                const currentBadges = newData.progress[playerId][questId].badges;
                const idx = currentBadges.indexOf(badgeName);

                if (idx >= 0) {
                    currentBadges.splice(idx, 1);
                } else {
                    currentBadges.push(badgeName);
                }

                newData.progress[playerId][questId].badges = currentBadges;
                onUpdateValhalla(newData);
            };

            return (
                <div style={{ height: '100%', display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                    <header style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div>
                            <h2 style={{ margin: 0, display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                <Icon name="Swords" color="#ffd700" /> The Quest for Valhalla
                            </h2>
                            <p style={{ margin: 0, color: 'var(--text-secondary)', fontSize: '0.9rem' }}>
                                Quest for Excellence. Earn it or you don't.
                            </p>
                        </div>
                        <div style={{ display: 'flex', gap: '0.5rem', background: 'var(--surface)', padding: '4px', borderRadius: '8px' }}>
                            {['player', 'events', 'leaderboard', 'admin'].map(tab => {
                                let label = tab;
                                if (tab === 'events') label = 'Badge & XP System';
                                return (
                                    <button
                                        key={tab}
                                        onClick={() => setActiveTab(tab)}
                                        style={{
                                            padding: '0.5rem 1rem', border: 'none', borderRadius: '6px',
                                            background: activeTab === tab ? 'var(--accent)' : 'transparent',
                                            color: activeTab === tab ? 'white' : 'var(--text-secondary)',
                                            cursor: 'pointer', fontWeight: 'bold', textTransform: 'capitalize'
                                        }}
                                    >
                                        {label}
                                    </button>
                                );
                            })}
                        </div>
                    </header>

                    {activeTab === 'player' && (
                        <div style={{ display: 'grid', gridTemplateColumns: '300px 1fr', gap: '1.5rem', flex: 1, overflow: 'hidden' }}>
                            {/* Roster List with XP */}
                            <div className="card" style={{ display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
                                <div style={{ padding: '1rem', borderBottom: '1px solid var(--border)', fontWeight: 'bold' }}>
                                    Roster (Ranked)
                                </div>
                                <div style={{ overflowY: 'auto', flex: 1 }}>
                                    {sortedRoster.map((p, idx) => {
                                        const scores = getPlayerScores(p.id);
                                        return (
                                            <div
                                                key={p.id}
                                                onClick={() => setSelectedPlayerId(p.id)}
                                                style={{
                                                    padding: '0.75rem 1rem', borderBottom: '1px solid var(--border)',
                                                    background: selectedPlayerId === p.id ? 'rgba(59, 130, 246, 0.1)' : 'transparent',
                                                    cursor: 'pointer', display: 'flex', justifyContent: 'space-between', alignItems: 'center'
                                                }}
                                            >
                                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                    <span style={{ color: 'var(--text-secondary)', width: '20px' }}>{idx + 1}</span>
                                                    <span>{p.name}</span>
                                                </div>
                                                <div style={{ textAlign: 'right' }}>
                                                    <div style={{ fontWeight: 'bold', color: '#ffd700' }}>{scores.TOTAL} XP</div>
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>

                            {/* Detailed Player View */}
                            <div className="card" style={{ padding: '2rem', overflowY: 'auto' }}>
                                {selectedPlayer ? (
                                    <div>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
                                            <div>
                                                <h1 style={{ margin: 0 }}>{selectedPlayer.name}</h1>
                                                <div style={{ color: 'var(--text-secondary)' }}>{selectedPlayer.position} ‚Ä¢ {selectedPlayer.year}</div>
                                            </div>
                                            <div style={{ textAlign: 'right' }}>
                                                <div style={{ fontSize: '2rem', fontWeight: 'bold', color: '#ffd700' }}>{getPlayerScores(selectedPlayer.id).TOTAL} XP</div>
                                                <div style={{ color: 'var(--text-secondary)' }}>Total Valhalla Points</div>
                                            </div>
                                        </div>

                                        {/* 3 Pillars Scoreboard */}
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '1rem', marginBottom: '2rem' }}>
                                            {Object.values(VALHALLA_CONSTANTS.PILLARS).map(pillar => {
                                                const score = getPlayerScores(selectedPlayer.id)[pillar.id];
                                                return (
                                                    <div key={pillar.id} style={{ background: 'var(--surface)', padding: '1rem', borderRadius: '8px', borderLeft: `4px solid ${pillar.color}` }}>
                                                        <div style={{ color: pillar.color, fontWeight: 'bold', marginBottom: '0.25rem' }}>{pillar.label}</div>
                                                        <div style={{ fontSize: '1.5rem', fontWeight: 'bold' }}>{score}</div>
                                                        <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>{pillar.description}</div>
                                                    </div>
                                                );
                                            })}
                                        </div>

                                        {/* Seasonal Quests Accordions */}
                                        {['CORE', 'SUMMER', 'IN_SEASON', 'OFF_SEASON'].map(seasonId => {
                                            const season = VALHALLA_CONSTANTS.SEASONS[seasonId];
                                            const seasonQuests = Object.values(VALHALLA_CONSTANTS.QUESTS).filter(q => q.season === seasonId);

                                            return (
                                                <div key={seasonId} style={{ marginBottom: '2rem' }}>
                                                    <h3 style={{ borderBottom: '1px solid var(--border)', paddingBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                        {season.label} <span style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', fontWeight: 'normal' }}>({seasonQuests.length} Quests)</span>
                                                    </h3>

                                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))', gap: '1rem' }}>
                                                        {seasonQuests.map(quest => {
                                                            const pProgress = valhallaData.progress[selectedPlayer.id]?.[quest.id] || { inputs: {}, multipliers: [] };

                                                            return (
                                                                <div key={quest.id} style={{ background: 'var(--bg-app)', padding: '1rem', borderRadius: '8px', border: '1px solid var(--border)' }}>
                                                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                                                                        <div style={{ fontWeight: 'bold' }}>{quest.name}</div>
                                                                        <div style={{ display: 'flex', gap: '4px' }}>
                                                                            {quest.pillars.map(pid => (
                                                                                <div key={pid} style={{ width: '8px', height: '8px', borderRadius: '50%', background: VALHALLA_CONSTANTS.PILLARS[pid].color, title: pid }}></div>
                                                                            ))}
                                                                        </div>
                                                                    </div>

                                                                    {/* Inputs */}
                                                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem', marginBottom: '1rem' }}>
                                                                        {quest.inputs.map((input, idx) => (
                                                                            <div key={idx} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontSize: '0.9rem' }}>
                                                                                <span title={`+${input.xpPerUnit} XP per unit`}>{input.name}</span>
                                                                                {input.type === 'Boolean' ? (
                                                                                    <input
                                                                                        type="checkbox"
                                                                                        checked={pProgress.inputs[input.name] === true}
                                                                                        onChange={e => updateQuestInput(selectedPlayer.id, quest.id, input.name, e.target.checked)}
                                                                                        style={{ width: '16px', height: '16px' }}
                                                                                    />
                                                                                ) : (
                                                                                    <input
                                                                                        type="number"
                                                                                        value={pProgress.inputs[input.name] || ''}
                                                                                        placeholder="0"
                                                                                        onChange={e => updateQuestInput(selectedPlayer.id, quest.id, input.name, parseFloat(e.target.value))}
                                                                                        style={{ width: '60px', padding: '2px 4px', borderRadius: '4px', border: '1px solid var(--border)', background: 'var(--bg-panel)', color: 'white', textAlign: 'right' }}
                                                                                    />
                                                                                )}
                                                                            </div>
                                                                        ))}
                                                                    </div>

                                                                    {/* Multipliers */}
                                                                    {quest.multipliers && quest.multipliers.length > 0 && (
                                                                        <div style={{ borderTop: '1px solid var(--border)', paddingTop: '0.5rem' }}>
                                                                            <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)', marginBottom: '4px' }}>Multipliers</div>
                                                                            {quest.multipliers.map((m, mIdx) => (
                                                                                <label key={mIdx} style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', fontSize: '0.85rem', cursor: 'pointer' }}>
                                                                                    <input
                                                                                        type="checkbox"
                                                                                        checked={(pProgress.multipliers || []).includes(m.label)}
                                                                                        onChange={() => toggleQuestMultiplier(selectedPlayer.id, quest.id, m.label)}
                                                                                    />
                                                                                    <span>{m.label} <span style={{ color: '#ffd700' }}>(+{m.value * 100}%)</span></span>
                                                                                </label>
                                                                            ))}
                                                                        </div>
                                                                    )}

                                                                    {/* Badges Toggles */}
                                                                    {quest.badges && (
                                                                        <div style={{ marginTop: '0.5rem', paddingTop: '0.5rem', borderTop: '1px solid var(--border)' }}>
                                                                            <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)', marginBottom: '4px' }}>Badges</div>
                                                                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                                                                                {quest.badges.map((b, bI) => (
                                                                                    <label key={bI} style={{ display: 'flex', alignItems: 'center', gap: '5px', fontSize: '0.8rem', cursor: 'pointer', background: 'rgba(255,255,255,0.05)', padding: '2px 6px', borderRadius: '4px' }}>
                                                                                        <input
                                                                                            type="checkbox"
                                                                                            checked={(pProgress.badges || []).includes(b.name)}
                                                                                            onChange={() => toggleQuestBadge(selectedPlayer.id, quest.id, b.name)}
                                                                                        />
                                                                                        <span style={{ color: getTierColor(b.tier), fontWeight: 'bold' }}>
                                                                                            {b.name}
                                                                                        </span>
                                                                                        {VALHALLA_CONSTANTS.BADGE_XP[b.tier] && (
                                                                                            <span style={{ fontSize: '0.7em', color: 'var(--text-secondary)' }}>
                                                                                                (+{VALHALLA_CONSTANTS.BADGE_XP[b.tier]})
                                                                                            </span>
                                                                                        )}
                                                                                    </label>
                                                                                ))}
                                                                            </div>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            );
                                        })}

                                        {/* Program Event Participation Tracker - Kept for Custom Events */}
                                        <div style={{ marginTop: '3rem', borderTop: '1px solid var(--border)', paddingTop: '2rem' }}>
                                            <div style={{ marginBottom: '1.5rem' }}>
                                                <h2 style={{ margin: 0 }}>Custom / Extra Events</h2>
                                                <p style={{ color: 'var(--text-secondary)', margin: '0.25rem 0 0 0' }}>
                                                    Additional events created in the Events tab.
                                                </p>
                                            </div>
                                            {/* ... existing Program Events rendering ... */}
                                            {/* Simplifying for this block replacement - just invoking the loop if needed or keeping standard */}
                                            <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                                {(valhallaData.programEvents || []).map(ev => {
                                                    const playerData = valhallaData.participation?.[ev.id]?.[selectedPlayer.id] || {};
                                                    return (
                                                        <div key={ev.id} style={{ padding: '1rem', background: 'var(--bg-app)', borderRadius: '8px', border: '1px solid var(--border)' }}>
                                                            <div style={{ fontWeight: 'bold' }}>{ev.name}</div>
                                                            {/* Simplified read-only for now or quick edit - keeping basic structure */}
                                                            <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>Event tracking is separate from Seasonal Quests directly</div>
                                                            { /* Re-implement fully if needed, but Valhalla 2.0 subsumes most generically */}
                                                        </div>
                                                    )
                                                })}
                                                {(!valhallaData.programEvents || valhallaData.programEvents.length === 0) && (
                                                    <div style={{ color: 'var(--text-secondary)', fontStyle: 'italic' }}>No custom events defined.</div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div style={{ color: 'var(--text-secondary)', fontStyle: 'italic' }}>Select a player to view details.</div>
                                )}
                            </div>
                        </div>
                    )}

                    {activeTab === 'events' && (
                        <div className="card" style={{ flex: 1, padding: '1.5rem', display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                                <div>
                                    <h2 style={{ margin: 0 }}>Valhalla Badge & XP System</h2>
                                    <p style={{ color: 'var(--text-secondary)', margin: '0.25rem 0 0 0' }}>
                                        Manage custom events and view system standards.
                                    </p>
                                </div>
                                <button
                                    className="btn btn-primary"
                                    onClick={() => {
                                        setEditingEvent({
                                            id: Date.now(),
                                            name: '',
                                            points: 0,
                                            metrics: [],
                                            badges: []
                                        });
                                        setShowEventModal(true);
                                    }}
                                >
                                    ‚ûï Add New Event
                                </button>
                            </div>
                            {/* Custom Events Header */}
                            <h3 style={{ borderBottom: '1px solid var(--border)', paddingBottom: '0.5rem', marginBottom: '1rem' }}>Custom Events</h3>
                            <div style={{ overflowY: 'auto', flex: 1 }}>
                                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                    <thead style={{ position: 'sticky', top: 0, background: 'var(--bg-panel)' }}>
                                        <tr style={{ borderBottom: '2px solid var(--border)', textAlign: 'left' }}>
                                            <th style={{ padding: '1rem' }}>Event Name</th>
                                            <th style={{ padding: '1rem' }}>Points</th>
                                            <th style={{ padding: '1rem' }}>Metrics</th>
                                            <th style={{ padding: '1rem' }}>Badges</th>
                                            <th style={{ padding: '1rem', textAlign: 'right' }}>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {(valhallaData.programEvents || []).map(ev => (
                                            <tr key={ev.id} style={{ borderBottom: '1px solid var(--border)' }}>
                                                <td style={{ padding: '1rem', fontWeight: 'bold' }}>{ev.name}</td>
                                                <td style={{ padding: '1rem', color: '#ffd700' }}>{ev.points}</td>
                                                <td style={{ padding: '1rem', fontSize: '0.85rem' }}>
                                                    {(ev.metrics || []).length > 0 ? (
                                                        <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                                                            {ev.metrics.map((m, i) => (
                                                                <span key={i} style={{ background: 'var(--surface)', padding: '2px 6px', borderRadius: '4px' }}>
                                                                    {m.name}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    ) : <span style={{ color: 'var(--text-secondary)' }}>None</span>}
                                                </td>
                                                <td style={{ padding: '1rem', fontSize: '0.85rem' }}>
                                                    {(ev.badges || []).length > 0 ? (
                                                        <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                                                            {ev.badges.map((b, i) => {
                                                                const bName = typeof b === 'string' ? b : b.name;
                                                                const bTier = typeof b === 'string' ? 'Blue' : b.tier;
                                                                return (
                                                                    <span key={i} style={{
                                                                        background: getTierColor(bTier),
                                                                        color: bTier === 'Platinum' || bTier === 'Silver' ? 'black' : 'white',
                                                                        padding: '2px 6px', borderRadius: '4px', display: 'flex', alignItems: 'center', gap: '4px'
                                                                    }}>
                                                                        <Icon name="Award" size={10} /> {bName}
                                                                    </span>
                                                                );
                                                            })}
                                                        </div>
                                                    ) : <span style={{ color: 'var(--text-secondary)' }}>None</span>}
                                                </td>

                                                <td style={{ padding: '1rem', textAlign: 'right' }}>
                                                    <button
                                                        className="btn btn-sm btn-secondary"
                                                        style={{ marginRight: '0.5rem' }}
                                                        title="Edit Event"
                                                        onClick={() => {
                                                            setEditingEvent({ ...ev });
                                                            setShowEventModal(true);
                                                        }}
                                                    >
                                                        <Icon name="Edit" size={14} />
                                                    </button>
                                                    <button
                                                        className="btn btn-sm btn-secondary"
                                                        style={{ marginRight: '0.5rem' }}
                                                        title="Duplicate Event"
                                                        onClick={() => {
                                                            const newEvent = {
                                                                ...ev,
                                                                id: Date.now(),
                                                                name: ev.name + " (Copy)",
                                                            };
                                                            const newData = { ...valhallaData };
                                                            newData.programEvents.push(newEvent);
                                                            onUpdateValhalla(newData);
                                                        }}
                                                    >
                                                        <Icon name="Copy" size={14} />
                                                    </button>
                                                    <button
                                                        style={{ background: 'none', border: 'none', color: 'var(--text-secondary)', cursor: 'pointer' }}
                                                        onClick={() => {
                                                            if (!confirm("Delete this event definition?")) return;
                                                            const newData = { ...valhallaData };
                                                            newData.programEvents = newData.programEvents.filter(e => e.id !== ev.id);
                                                            onUpdateValhalla(newData);
                                                        }}
                                                    >
                                                        ‚ûñ
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div >
                        </div >
                    )}

                    {
                        activeTab === 'leaderboard' && (
                            <div className="card" style={{ padding: '2rem' }}>
                                <h2>XP Leaderboard</h2>
                                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                    <thead>
                                        <tr style={{ borderBottom: '2px solid var(--border)', textAlign: 'left' }}>
                                            <th style={{ padding: '1rem' }}>Rank</th>
                                            <th style={{ padding: '1rem' }}>Player</th>
                                            <th style={{ padding: '1rem' }}>Level</th>
                                            <th style={{ padding: '1rem', textAlign: 'right' }}>Total XP</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {sortedRoster.map((p, i) => (
                                            <tr key={p.id} style={{ borderBottom: '1px solid var(--border)' }}>
                                                <td style={{ padding: '1rem' }}>#{i + 1}</td>
                                                <td style={{ padding: '1rem', fontWeight: 'bold' }}>{p.name}</td>
                                                <td style={{ padding: '1rem' }}>Warrior</td>
                                                <td style={{ padding: '1rem', textAlign: 'right', fontFamily: 'monospace', fontSize: '1.1rem', color: '#ffd700' }}>{getPlayerScores(p.id).TOTAL}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )
                    }

                    {
                        activeTab === 'admin' && (
                            <div className="card" style={{ padding: '2rem', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'var(--text-secondary)' }}>
                                Admin Panel Coming Soon - Use Player tab to manually update values for now.
                            </div>
                        )
                    }

                    {/* Event Editor Modal */}
                    {
                        showEventModal && editingEvent && (
                            <div style={{
                                position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                                background: 'rgba(0,0,0,0.8)', zIndex: 1000,
                                display: 'flex', alignItems: 'center', justifyContent: 'center'
                            }}>
                                <div style={{
                                    width: '600px', maxWidth: '95%',
                                    background: 'var(--bg-app)', border: '1px solid var(--border)',
                                    borderRadius: '12px', padding: '2rem',
                                    boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)'
                                }}>
                                    <h2 style={{ marginTop: 0 }}>{editingEvent.id ? 'Edit Event' : 'New Event'}</h2>

                                    <div style={{ marginBottom: '1rem' }}>
                                        <label style={{ display: 'block', marginBottom: '4px' }}>Event Name</label>
                                        <input
                                            type="text"
                                            value={editingEvent.name}
                                            onChange={e => setEditingEvent({ ...editingEvent, name: e.target.value })}
                                            style={{ width: '100%', padding: '0.75rem', borderRadius: '4px', border: '1px solid var(--border)', background: 'var(--bg-panel)', color: 'white' }}
                                        />
                                    </div>

                                    <div style={{ marginBottom: '1rem' }}>
                                        <label style={{ display: 'block', marginBottom: '4px' }}>Default Points</label>
                                        <input
                                            type="number"
                                            value={editingEvent.points}
                                            onChange={e => setEditingEvent({ ...editingEvent, points: parseInt(e.target.value) || 0 })}
                                            style={{ width: '100%', padding: '0.75rem', borderRadius: '4px', border: '1px solid var(--border)', background: 'var(--bg-panel)', color: 'white' }}
                                        />
                                    </div>

                                    {/* Metrics Section */}
                                    <div style={{ marginBottom: '1.5rem', borderTop: '1px solid var(--border)', paddingTop: '1rem' }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>
                                            <h3 style={{ margin: 0, fontSize: '1.1rem' }}>Metrics</h3>
                                            <button
                                                onClick={() => {
                                                    setEditingEvent({
                                                        ...editingEvent,
                                                        metrics: [...(editingEvent.metrics || []), { name: 'New Metric', type: 'Number' }]
                                                    });
                                                }}
                                                style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '1.2rem' }}
                                                title="Add Metric"
                                            >
                                                ‚ûï
                                            </button>
                                        </div>
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                            {(editingEvent.metrics || []).map((m, idx) => (
                                                <div key={idx} style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                                                    <input
                                                        type="text"
                                                        value={m.name}
                                                        onChange={e => {
                                                            const newM = [...editingEvent.metrics];
                                                            newM[idx].name = e.target.value;
                                                            setEditingEvent({ ...editingEvent, metrics: newM });
                                                        }}
                                                        style={{ flex: 1, padding: '0.5rem', borderRadius: '4px', border: '1px solid var(--border)', background: 'var(--bg-panel)', color: 'white' }}
                                                    />
                                                    <select
                                                        value={m.type}
                                                        onChange={e => {
                                                            const newM = [...editingEvent.metrics];
                                                            newM[idx].type = e.target.value;
                                                            setEditingEvent({ ...editingEvent, metrics: newM });
                                                        }}
                                                        style={{ padding: '0.5rem', borderRadius: '4px', border: '1px solid var(--border)', background: 'var(--bg-panel)', color: 'white' }}
                                                    >
                                                        <option value="Number">Number</option>
                                                        <option value="Boolean">Yes/No</option>
                                                        <option value="Text">Text</option>
                                                    </select>
                                                    <button
                                                        onClick={() => {
                                                            const newM = editingEvent.metrics.filter((_, i) => i !== idx);
                                                            setEditingEvent({ ...editingEvent, metrics: newM });
                                                        }}
                                                        style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '1.2rem' }}
                                                        title="Remove Metric"
                                                    >
                                                        ‚ûñ
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Badges Section */}
                                    <div style={{ marginBottom: '1.5rem', borderTop: '1px solid var(--border)', paddingTop: '1rem' }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>
                                            <h3 style={{ margin: 0, fontSize: '1.1rem' }}>Badges</h3>
                                            <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>Associate achievement badges</div>
                                        </div>

                                        {/* Badges List */}
                                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem', marginBottom: '1rem' }}>
                                            {(editingEvent.badges || []).map((b, idx) => {
                                                const bName = typeof b === 'string' ? b : b.name;
                                                const bTier = typeof b === 'string' ? 'Blue' : b.tier;
                                                return (
                                                    <div key={idx} style={{
                                                        background: 'var(--surface)', padding: '4px 8px', borderRadius: '4px', display: 'flex', alignItems: 'center', gap: '6px',
                                                        border: `1px solid ${getTierColor(bTier)}`
                                                    }}>
                                                        <span style={{ width: '8px', height: '8px', borderRadius: '50%', background: getTierColor(bTier) }}></span>
                                                        <span>{bName}</span>
                                                        <button
                                                            title="Edit Badge"
                                                            onClick={() => {
                                                                const newB = editingEvent.badges.filter((_, i) => i !== idx);
                                                                setEditingEvent({ ...editingEvent, badges: newB });
                                                                // Load into inputs
                                                                setTimeout(() => {
                                                                    const nameInput = document.getElementById('newBadgeName');
                                                                    const tierInput = document.getElementById('newBadgeTier');
                                                                    if (nameInput) {
                                                                        nameInput.value = bName;
                                                                        nameInput.focus();
                                                                    }
                                                                    if (tierInput) tierInput.value = bTier;
                                                                }, 0);
                                                            }}
                                                            style={{ background: 'none', border: 'none', cursor: 'pointer', marginLeft: '4px', fontSize: '1rem' }}
                                                        >
                                                            ‚úé
                                                        </button>
                                                        <button
                                                            title="Remove Badge"
                                                            onClick={() => {
                                                                const newB = editingEvent.badges.filter((_, i) => i !== idx);
                                                                setEditingEvent({ ...editingEvent, badges: newB });
                                                            }}
                                                            style={{ background: 'none', border: 'none', color: 'var(--text-secondary)', cursor: 'pointer', marginLeft: '4px' }}
                                                        >
                                                            ‚ûñ
                                                        </button>
                                                    </div>
                                                );
                                            })}
                                        </div>

                                        {/* Add Badge Control */}
                                        <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                                            <input
                                                id="newBadgeName"
                                                type="text"
                                                placeholder="Badge Name"
                                                style={{ flex: 1, padding: '0.5rem', borderRadius: '4px', border: '1px solid var(--border)', background: 'var(--bg-panel)', color: 'white' }}
                                            />
                                            <select
                                                id="newBadgeTier"
                                                defaultValue="Bronze"
                                                style={{ padding: '0.5rem', borderRadius: '4px', border: '1px solid var(--border)', background: 'var(--bg-panel)', color: 'white' }}
                                            >
                                                <option value="Iron">Iron</option>
                                                <option value="Bronze">Bronze</option>
                                                <option value="Silver">Silver</option>
                                                <option value="Gold">Gold</option>
                                                <option value="Platinum">Platinum</option>
                                            </select>
                                            <button
                                                className="btn btn-secondary"
                                                onClick={() => {
                                                    const nameInput = document.getElementById('newBadgeName');
                                                    const tierInput = document.getElementById('newBadgeTier');
                                                    if (nameInput.value) {
                                                        setEditingEvent({
                                                            ...editingEvent,
                                                            badges: [...(editingEvent.badges || []), { name: nameInput.value, tier: tierInput.value }]
                                                        });
                                                        nameInput.value = '';
                                                    }
                                                }}
                                            >
                                                ‚ûï
                                            </button>
                                        </div>

                                        {/* Smart Suggestions */}
                                        <div style={{ marginTop: '0.5rem' }}>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                <span style={{ fontSize: '0.9rem', color: 'var(--text-secondary)' }}>AI Suggestions:</span>
                                                <button
                                                    onClick={() => {
                                                        const suggestions = suggestBadges(editingEvent.name);
                                                        // Filter out already added
                                                        const currentNames = new Set((editingEvent.badges || []).map(b => typeof b === 'string' ? b : b.name));
                                                        const newSuggestions = suggestions.filter(s => !currentNames.has(s.name));

                                                        if (newSuggestions.length > 0) {
                                                            setEditingEvent({
                                                                ...editingEvent,
                                                                badges: [...(editingEvent.badges || []), ...newSuggestions]
                                                            });
                                                        } else {
                                                            alert("No new suggestions found based on event name.");
                                                        }
                                                    }}
                                                    style={{ background: 'none', border: '1px solid var(--accent)', color: 'var(--accent)', borderRadius: '12px', padding: '2px 8px', cursor: 'pointer', fontSize: '0.8rem' }}
                                                >
                                                    ‚ú® Auto-Suggest
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '1rem', marginTop: '2rem' }}>
                                        <button
                                            className="btn btn-secondary"
                                            onClick={() => setShowEventModal(false)}
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            className="btn btn-primary"
                                            onClick={() => {
                                                const newData = { ...valhallaData };
                                                if (!newData.programEvents) newData.programEvents = [];

                                                // Update or Add logic
                                                const existingIdx = newData.programEvents.findIndex(e => e.id === editingEvent.id);
                                                if (existingIdx >= 0) {
                                                    newData.programEvents[existingIdx] = editingEvent;
                                                } else {
                                                    newData.programEvents.push(editingEvent);
                                                }

                                                onUpdateValhalla(newData);
                                                setShowEventModal(false);
                                            }}
                                        >
                                            Save Event
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )
                    }
                </div >
            );
        };

        // --- SUMMER COMPETITION MANAGER ---
        const SummerCompetitionManager = ({ roster, compData, onUpdateComp }) => {
            const [activeTab, setActiveTab] = useState('draft'); // draft, attendance, challenges, standings

            // Helper to get defaults if data is empty
            const data = compData || {
                config: { numTeams: 4 },
                teams: [
                    { id: 't1', name: 'Team 1', color: '#EF4444', captainIds: [], rosterIds: [] },
                    { id: 't2', name: 'Team 2', color: '#3B82F6', captainIds: [], rosterIds: [] },
                    { id: 't3', name: 'Team 3', color: '#10B981', captainIds: [], rosterIds: [] },
                    { id: 't4', name: 'Team 4', color: '#F59E0B', captainIds: [], rosterIds: [] }
                ], // Default 4 teams
                attendance: [],
                challenges: []
            };

            const updateData = (newData) => {
                onUpdateComp({ ...data, ...newData });
            };

            // Calculate Standings
            const getTeamStats = (teamId) => {
                let attendancePoints = 0;
                let challengePoints = 0;

                // Attendance: 1 pt per player per day (example logic)
                data.attendance.forEach(entry => {
                    const presentCount = entry.records[teamId]?.length || 0;
                    attendancePoints += presentCount;
                });

                // Challenges: Points logged in challenges
                data.challenges.forEach(challenge => {
                    challenge.matchups.forEach(m => {
                        if (m.winnerId === teamId) challengePoints += (m.points || 50); // Default 50 for a win?
                    });
                });

                return { attendancePoints, challengePoints, total: attendancePoints + challengePoints };
            };

            // DRAFT COMPONENTS
            const DraftTab = () => {
                const [draftPoolSearch, setDraftPoolSearch] = useState('');

                // Players already on a team
                const assignedPlayerIds = new Set(data.teams.flatMap(t => [...t.captainIds, ...t.rosterIds]));

                // Available players
                const draftPool = roster.filter(p => !assignedPlayerIds.has(p.id))
                    .filter(p => p.name.toLowerCase().includes(draftPoolSearch.toLowerCase()))
                    .sort((a, b) => a.name.localeCompare(b.name));

                const assignPlayer = (playerId, teamId, isCaptain = false) => {
                    const newTeams = data.teams.map(t => {
                        if (t.id === teamId) {
                            return isCaptain
                                ? { ...t, captainIds: [...t.captainIds, playerId] }
                                : { ...t, rosterIds: [...t.rosterIds, playerId] };
                        }
                        return t;
                    });
                    updateData({ teams: newTeams });
                };

                const removePlayer = (playerId, teamId) => {
                    const newTeams = data.teams.map(t => {
                        if (t.id === teamId) {
                            return {
                                ...t,
                                captainIds: t.captainIds.filter(id => id !== playerId),
                                rosterIds: t.rosterIds.filter(id => id !== playerId)
                            };
                        }
                        return t;
                    });
                    updateData({ teams: newTeams });
                };

                const updateTeamName = (teamId, newName) => {
                    updateData({ teams: data.teams.map(t => t.id === teamId ? { ...t, name: newName } : t) });
                };

                // Config: Add/Remove Teams
                const setTeamCount = (count) => {
                    let newTeams = [...data.teams];
                    if (count > newTeams.length) {
                        // Add teams
                        for (let i = newTeams.length + 1; i <= count; i++) {
                            newTeams.push({ id: `t${Date.now()}_${i}`, name: `Team ${i}`, color: '#6B7280', captainIds: [], rosterIds: [] });
                        }
                    } else if (count < newTeams.length) {
                        // Remove teams (warn if players assigned?)
                        // simplified: just slice, players return to pool automatically because assignedPlayerIds is calc'd from existing teams
                        newTeams = newTeams.slice(0, count);
                    }
                    updateData({ config: { ...data.config, numTeams: count }, teams: newTeams });
                };

                return (
                    <div style={{ display: 'grid', gridTemplateColumns: '300px 1fr', gap: '1rem', height: '100%' }}>
                        {/* Draft Pool */}
                        <div className="card" style={{ display: 'flex', flexDirection: 'column', height: '100%' }}>
                            <div style={{ padding: '1rem', borderBottom: '1px solid var(--border)' }}>
                                <h3 style={{ margin: '0 0 0.5rem 0' }}>Draft Pool</h3>
                                <input
                                    type="text" placeholder="Search..."
                                    value={draftPoolSearch} onChange={e => setDraftPoolSearch(e.target.value)}
                                    style={{ width: '100%', padding: '0.5rem' }}
                                />
                                <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', marginTop: '0.5rem' }}>
                                    {draftPool.length} Remaining
                                </div>
                            </div>
                            <div style={{ flex: 1, overflowY: 'auto', padding: '0.5rem' }}>
                                {draftPool.map(p => (
                                    <div key={p.id} style={{ padding: '0.5rem', borderBottom: '1px solid var(--border)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                        <span>{p.name} <span style={{ fontSize: '0.7em', color: 'var(--text-secondary)' }}>{p.position}</span></span>
                                        <div className="dropdown" style={{ position: 'relative', display: 'inline-block' }}>
                                            <button style={{ fontSize: '0.8rem', padding: '2px 6px' }}>Assign</button>
                                            <div className="dropdown-content" style={{ right: 0 }}>
                                                {data.teams.map(t => (
                                                    <div key={t.id} onClick={() => assignPlayer(p.id, t.id)} style={{ padding: '4px 8px', cursor: 'pointer', hover: { background: '#eee' } }}>
                                                        To {t.name}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Teams Grid */}
                        <div style={{ overflowY: 'auto', display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                            <div style={{ padding: '1rem', background: 'var(--surface)', borderRadius: '8px', display: 'flex', alignItems: 'center', gap: '1rem' }}>
                                <label>Number of Teams (1-8):</label>
                                <input
                                    type="number" min="1" max="8"
                                    value={data.teams.length}
                                    onChange={e => setTeamCount(Math.min(8, Math.max(1, parseInt(e.target.value) || 1)))}
                                    style={{ width: '60px', padding: '0.25rem' }}
                                />
                            </div>

                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '1rem' }}>
                                {data.teams.map(team => (
                                    <div key={team.id} className="card" style={{ padding: '1rem', borderTop: `4px solid ${team.color}` }}>
                                        <input
                                            value={team.name}
                                            onChange={e => updateTeamName(team.id, e.target.value)}
                                            style={{ fontSize: '1.1rem', fontWeight: 'bold', width: '100%', border: 'none', background: 'transparent', marginBottom: '0.5rem' }}
                                        />

                                        {/* Captains */}
                                        <div style={{ marginBottom: '0.5rem' }}>
                                            <div style={{ fontSize: '0.75rem', textTransform: 'uppercase', color: 'var(--text-secondary)', marginBottom: '4px' }}>Captains</div>
                                            {team.captainIds.length === 0 && <div style={{ fontSize: '0.8rem', fontStyle: 'italic', opacity: 0.6 }}>No Captains</div>}
                                            {team.captainIds.map(pid => {
                                                const p = roster.find(x => x.id === pid);
                                                return (
                                                    <div key={pid} style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.9rem', marginBottom: '2px' }}>
                                                        <span>üëë {p?.name || 'Unknown'}</span>
                                                        <button onClick={() => removePlayer(pid, team.id)} style={{ border: 'none', background: 'none', color: 'red', cursor: 'pointer' }}>√ó</button>
                                                    </div>
                                                );
                                            })}
                                            <button
                                                style={{ fontSize: '0.75rem', marginTop: '4px', background: 'none', border: '1px dashed var(--text-secondary)', width: '100%' }}
                                                onClick={() => {
                                                    const pid = prompt("Enter Player Name to search correctly? actually drag drop is better. For now use the drafted pool.");
                                                    // Simplified: user promotes from roster
                                                }}
                                            >
                                                (Assign via Pool)
                                            </button>
                                        </div>

                                        {/* Roster */}
                                        <div>
                                            <div style={{ fontSize: '0.75rem', textTransform: 'uppercase', color: 'var(--text-secondary)', marginBottom: '4px' }}>Roster ({team.rosterIds.length})</div>
                                            {team.rosterIds.map(pid => {
                                                const p = roster.find(x => x.id === pid);
                                                return (
                                                    <div key={pid} style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.9rem', marginBottom: '2px' }}>
                                                        <span>{p?.name || 'Unknown'}</span>
                                                        <div style={{ display: 'flex', gap: '4px' }}>
                                                            <button onClick={() => { removePlayer(pid, team.id); assignPlayer(pid, team.id, true); }} title="Promote to Captain" style={{ border: 'none', background: 'none', cursor: 'pointer' }}>üëë</button>
                                                            <button onClick={() => removePlayer(pid, team.id)} style={{ border: 'none', background: 'none', color: 'red', cursor: 'pointer' }}>√ó</button>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };

            // ATTENDANCE COMPONENT
            const AttendanceTab = () => {
                const [date, setDate] = useState(new Date().toISOString().split('T')[0]);

                // Get existing record for this date
                const todayRecord = data.attendance.find(r => r.date === date) || { date, records: {} };

                const togglePresence = (teamId, playerId) => {
                    const currentTeamRecord = todayRecord.records[teamId] || [];
                    const newTeamRecord = currentTeamRecord.includes(playerId)
                        ? currentTeamRecord.filter(id => id !== playerId)
                        : [...currentTeamRecord, playerId];

                    const newRecords = { ...todayRecord.records, [teamId]: newTeamRecord };

                    // Update main data
                    const otherDates = data.attendance.filter(r => r.date !== date);
                    updateData({ attendance: [...otherDates, { date, records: newRecords }] });
                };

                return (
                    <div style={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
                        <div style={{ padding: '1rem', background: 'var(--surface)', marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '1rem' }}>
                            <label>Attendance Date:</label>
                            <input
                                type="date" value={date} onChange={e => setDate(e.target.value)}
                                style={{ padding: '0.5rem' }}
                            />
                        </div>

                        <div style={{ display: 'flex', gap: '1rem', overflowX: 'auto', paddingBottom: '1rem', flex: 1 }}>
                            {data.teams.map(team => {
                                const presentIds = todayRecord.records[team.id] || [];
                                const allTeamPlayers = [...team.captainIds, ...team.rosterIds];

                                return (
                                    <div key={team.id} className="card" style={{ minWidth: '250px', display: 'flex', flexDirection: 'column', borderTop: `4px solid ${team.color}` }}>
                                        <div style={{ padding: '0.75rem', borderBottom: '1px solid var(--border)', display: 'flex', justifyContent: 'space-between' }}>
                                            <span style={{ fontWeight: 'bold' }}>{team.name}</span>
                                            <span>{presentIds.length} / {allTeamPlayers.length}</span>
                                        </div>
                                        <div style={{ flex: 1, overflowY: 'auto', padding: '0.5rem' }}>
                                            {allTeamPlayers.map(pid => {
                                                const p = roster.find(x => x.id === pid);
                                                return (
                                                    <div
                                                        key={pid}
                                                        onClick={() => togglePresence(team.id, pid)}
                                                        style={{
                                                            padding: '0.5rem', marginBottom: '2px', cursor: 'pointer', borderRadius: '4px',
                                                            background: presentIds.includes(pid) ? 'rgba(16, 185, 129, 0.2)' : 'transparent',
                                                            display: 'flex', justifyContent: 'space-between'
                                                        }}
                                                    >
                                                        <span>{p?.name}</span>
                                                        {presentIds.includes(pid) && <Icon name="Check" size={14} />}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            // STANDINGS COMPONENT
            const StandingsTab = () => {
                const stats = data.teams.map(t => ({ ...t, stats: getTeamStats(t.id) }))
                    .sort((a, b) => b.stats.total - a.stats.total);

                return (
                    <div className="card" style={{ padding: '2rem' }}>
                        <h2>Summer Championship Standings</h2>
                        <table style={{ width: '100%', borderCollapse: 'collapse', marginTop: '1rem' }}>
                            <thead>
                                <tr style={{ borderBottom: '2px solid var(--border)', textAlign: 'left' }}>
                                    <th style={{ padding: '1rem' }}>Rank</th>
                                    <th style={{ padding: '1rem' }}>Team</th>
                                    <th style={{ padding: '1rem', textAlign: 'center' }}>Attendance Pts</th>
                                    <th style={{ padding: '1rem', textAlign: 'center' }}>Challenge Pts</th>
                                    <th style={{ padding: '1rem', textAlign: 'right' }}>Total Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                {stats.map((t, i) => (
                                    <tr key={t.id} style={{ borderBottom: '1px solid var(--border)' }}>
                                        <td style={{ padding: '1rem', fontSize: '1.2rem', fontWeight: 'bold' }}>{i + 1}</td>
                                        <td style={{ padding: '1rem' }}>
                                            <div style={{ fontWeight: 'bold', fontSize: '1.1rem', color: t.color }}>{t.name}</div>
                                            <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>
                                                {t.captainIds.length} C, {t.rosterIds.length} Players
                                            </div>
                                        </td>
                                        <td style={{ padding: '1rem', textAlign: 'center' }}>{t.stats.attendancePoints}</td>
                                        <td style={{ padding: '1rem', textAlign: 'center' }}>{t.stats.challengePoints}</td>
                                        <td style={{ padding: '1rem', textAlign: 'right', fontWeight: 'bold', fontSize: '1.5rem' }}>{t.stats.total}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                );
            };

            return (
                <div style={{ height: '100%', display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                    <header style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <h2 style={{ margin: 0 }}>Summer Competition</h2>
                        <div style={{ display: 'flex', gap: '0.5rem', background: 'var(--surface)', padding: '4px', borderRadius: '8px' }}>
                            {['draft', 'attendance', 'challenges', 'standings'].map(tab => (
                                <button
                                    key={tab}
                                    onClick={() => setActiveTab(tab)}
                                    style={{
                                        padding: '0.5rem 1rem', border: 'none', borderRadius: '6px',
                                        background: activeTab === tab ? 'var(--accent)' : 'transparent',
                                        color: activeTab === tab ? 'white' : 'var(--text-secondary)',
                                        cursor: 'pointer', fontWeight: 'bold', textTransform: 'capitalize'
                                    }}
                                >
                                    {tab}
                                </button>
                            ))}
                        </div>
                    </header>

                    <div style={{ flex: 1, overflow: 'hidden' }}>
                        {activeTab === 'draft' && <DraftTab />}
                        {activeTab === 'attendance' && <AttendanceTab />}
                        {activeTab === 'standings' && <StandingsTab />}
                        {activeTab === 'challenges' && <div className="card" style={{ padding: '2rem', textAlign: 'center' }}>Challenges Logic Coming Soon (Use Attendance/Standings for now)</div>}
                    </div>
                </div>
            );
        };


        const TravelManager = ({ roster, travelRoster, onUpdateTravel, currentWeekName }) => {
            const [searchTerm, setSearchTerm] = useState('');

            // Sort roster alphabetically
            const sortedRoster = [...roster].sort((a, b) => a.name.localeCompare(b.name));

            const filteredRoster = sortedRoster.filter(p =>
                p.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const toggleTravel = (playerId) => {
                if (travelRoster.includes(playerId)) {
                    onUpdateTravel(travelRoster.filter(id => id !== playerId));
                } else {
                    onUpdateTravel([...travelRoster, playerId]);
                }
            };

            const selectAll = () => {
                onUpdateTravel(roster.map(p => p.id));
            };

            const deselectAll = () => {
                onUpdateTravel([]);
            };

            // Get traveling players for print
            const travelingPlayers = sortedRoster.filter(p => travelRoster.includes(p.id));

            return (
                <div style={{ height: '100%', display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                        <h2 style={{ margin: 0 }}>Game Day Travel Roster</h2>
                        <div style={{ display: 'flex', gap: '0.5rem' }}>
                            <button onClick={() => window.print()} className="btn btn-primary" style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                <Icon name="Printer" size={16} /> Print List
                            </button>
                        </div>
                    </div>

                    <div className="card" style={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
                        <div style={{ padding: '1rem', borderBottom: '1px solid var(--border)', display: 'flex', gap: '1rem', alignItems: 'center' }}>
                            <input
                                type="text"
                                placeholder="Search roster..."
                                value={searchTerm}
                                onChange={e => setSearchTerm(e.target.value)}
                                style={{ flex: 1, padding: '0.5rem', borderRadius: '6px', border: '1px solid var(--border)', background: 'var(--surface)', color: 'white' }}
                            />
                            <button onClick={selectAll} className="btn" style={{ fontSize: '0.8rem' }}>Select All</button>
                            <button onClick={deselectAll} className="btn" style={{ fontSize: '0.8rem' }}>Clear All</button>
                        </div>

                        <div style={{ flex: 1, overflowY: 'auto', padding: '0.5rem' }}>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))', gap: '0.5rem' }}>
                                {filteredRoster.map(player => (
                                    <div
                                        key={player.id}
                                        onClick={() => toggleTravel(player.id)}
                                        style={{
                                            display: 'flex', alignItems: 'center', gap: '0.75rem', padding: '0.75rem',
                                            background: travelRoster.includes(player.id) ? 'rgba(59, 130, 246, 0.2)' : 'var(--surface)',
                                            border: travelRoster.includes(player.id) ? '1px solid var(--accent)' : '1px solid transparent',
                                            borderRadius: '6px', cursor: 'pointer', transition: 'all 0.15s'
                                        }}
                                    >
                                        <div style={{
                                            width: '20px', height: '20px', borderRadius: '4px',
                                            border: '2px solid ' + (travelRoster.includes(player.id) ? 'var(--accent)' : 'var(--text-secondary)'),
                                            background: travelRoster.includes(player.id) ? 'var(--accent)' : 'transparent',
                                            display: 'flex', alignItems: 'center', justifyContent: 'center'
                                        }}>
                                            {travelRoster.includes(player.id) && <Icon name="Check" size={14} color="white" />}
                                        </div>
                                        <div>
                                            <div style={{ fontWeight: 'bold' }}>{player.name}</div>
                                            <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>#{player.number} ‚Ä¢ {player.position}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div style={{ padding: '1rem', borderTop: '1px solid var(--border)', textAlign: 'right', color: 'var(--text-secondary)' }}>
                            {travelingPlayers.length} / {roster.length} Players Traveling
                        </div>
                    </div>

                    {/* PRINT CONTAINER */}
                    <div className="travel-print-container">
                        <div style={{ textAlign: 'center', marginBottom: '2rem', borderBottom: '2px solid black', paddingBottom: '1rem' }}>
                            <h1 style={{ margin: 0, fontSize: '24px' }}>TRAVEL ROSTER</h1>
                            <h3 style={{ margin: '0.5rem 0 0 0', fontWeight: 'normal' }}>{currentWeekName}</h3>
                        </div>

                        <div style={{ columnCount: 2, columnGap: '2rem', fontSize: '14px' }}>
                            {travelingPlayers.map(p => (
                                <div key={p.id} style={{ display: 'flex', justifyContent: 'space-between', padding: '0.5rem 0', borderBottom: '1px solid #eee', breakInside: 'avoid' }}>
                                    <span style={{ fontWeight: 'bold' }}>{p.name}</span>
                                    <span>#{p.number} {p.position}</span>
                                </div>
                            ))}
                        </div>

                        <div style={{ marginTop: '2rem', borderTop: '1px solid black', paddingTop: '1rem', textAlign: 'right', fontSize: '12px' }}>
                            Total Traveling: {travelingPlayers.length}
                        </div>
                    </div>
                </div>
            );
        };

        const StaffManager = ({ staff, onUpdateStaff, dutyAssignments, onUpdateDuties, view = 'roster' }) => {
            // view: 'roster' | 'duties'
            const [newMember, setNewMember] = useState({
                name: '', role: '', level: ['Varsity'],
                positions: { offense: '', defense: '', specials: { ko: '', kr: '', punt: '', pr: '', fg: '', block: '' } },
                otherDuties: ''
            });

            const [isEditing, setIsEditing] = useState(null);
            const [selectedCoach, setSelectedCoach] = useState(null);

            // Sorting Logic
            const getRoleWeight = (roleStr) => {
                if (!roleStr) return 99;
                const r = roleStr.toLowerCase();
                if (r.includes('hc') || r.includes('head coach')) return 1;
                if (r.includes('dc') || r.includes('defensive coordinator')) return 2;
                if (r.includes('ol') || r.includes('offensive line')) return 3;
                if (r.includes('special teams') || r.includes('stc')) return 4;
                return 99;
            };

            const sortedStaff = useMemo(() => {
                return [...staff].sort((a, b) => {
                    const weightA = getRoleWeight(a.role);
                    const weightB = getRoleWeight(b.role);
                    if (weightA !== weightB) return weightA - weightB;
                    return a.name.localeCompare(b.name);
                });
            }, [staff]);


            const addMember = () => {
                const id = 'coach_' + Date.now();
                onUpdateStaff([...staff, { ...newMember, id }]);
                setNewMember({
                    name: '', role: '', level: ['Varsity'],
                    positions: { offense: '', defense: '', specials: { ko: '', kr: '', punt: '', pr: '', fg: '', block: '' } },
                    otherDuties: ''
                });
            };

            const updateMember = (id, field, value) => {
                onUpdateStaff(staff.map(m => m.id === id ? { ...m, [field]: value } : m));
            };

            const updatePosition = (id, group, value) => {
                onUpdateStaff(staff.map(m => {
                    if (m.id !== id) return m;
                    return { ...m, positions: { ...m.positions, [group]: value } };
                }));
            };

            const updateSpecialsPosition = (id, unit, value) => {
                onUpdateStaff(staff.map(m => {
                    if (m.id !== id) return m;
                    return {
                        ...m,
                        positions: {
                            ...m.positions,
                            specials: { ...m.positions.specials, [unit]: value }
                        }
                    };
                }));
            };

            const deleteMember = (id) => {
                if (confirm('Are you sure you want to remove this staff member?')) {
                    onUpdateStaff(staff.filter(m => m.id !== id));
                }
            };

            const formatSpecials = (specials) => {
                if (!specials) return '-';
                return Object.entries(specials)
                    .filter(([_, val]) => val)
                    .map(([key, val]) => `${key.toUpperCase()}: ${val}`)
                    .join(', ');
            };

            // Duty Draft Logic
            const [expandedCategories, setExpandedCategories] = useState({});
            const [dutyTab, setDutyTab] = useState('seasonal'); // 'seasonal' or 'recurring'

            // --- Role Task Editor Component ---
            const RoleTaskEditor = () => {
                const [activeRole, setActiveRole] = useState('OC');
                const [roleTasks, setRoleTasks] = useState({});
                const [newRoleTask, setNewRoleTask] = useState({ task: '', day: 'Monday' });

                // Load Initial
                useEffect(() => {
                    const saved = localStorage.getItem('staff_role_tasks');
                    if (saved) setRoleTasks(JSON.parse(saved));
                }, []);

                // Save on Change
                const updateRoleTasks = (newTasks) => {
                    setRoleTasks(newTasks);
                    localStorage.setItem('staff_role_tasks', JSON.stringify(newTasks));
                };

                const addRoleTask = () => {
                    if (!newRoleTask.task.trim()) return;
                    const taskId = `rt_${Date.now()}`;
                    const currentTasks = roleTasks[activeRole] || [];
                    const updated = {
                        ...roleTasks,
                        [activeRole]: [...currentTasks, { id: taskId, task: newRoleTask.task, day: newRoleTask.day }]
                    };
                    updateRoleTasks(updated);
                    setNewRoleTask({ task: '', day: newRoleTask.day }); // Keep day for rapid entry
                };

                const removeRoleTask = (taskId) => {
                    const currentTasks = roleTasks[activeRole] || [];
                    const updated = {
                        ...roleTasks,
                        [activeRole]: currentTasks.filter(t => t.id !== taskId)
                    };
                    updateRoleTasks(updated);
                };

                const TASKS_BY_DAY = (roleTasks[activeRole] || []).reduce((acc, t) => {
                    if (!acc[t.day]) acc[t.day] = [];
                    acc[t.day].push(t);
                    return acc;
                }, {});

                const DAYS = ['Saturday', 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];

                // Build role options from staff
                const roleOptions = [
                    { id: 'HC', label: 'Head Coach', type: 'role' },
                    { id: 'OC', label: 'Offensive Coordinator', type: 'role' },
                    { id: 'DC', label: 'Defensive Coordinator', type: 'role' },
                    { id: 'Ops', label: 'Operations', type: 'role' },
                    { id: 'divider1', label: '--- Position Coaches ---', type: 'divider' },
                    { id: 'OL Coach', label: 'OL Coach', type: 'position' },
                    { id: 'DL Coach', label: 'DL Coach', type: 'position' },
                    { id: 'LB Coach', label: 'LB Coach', type: 'position' },
                    { id: 'DB Coach', label: 'DB Coach', type: 'position' },
                    { id: 'RB/WR Coach', label: 'RB/WR Coach', type: 'position' },
                    { id: 'QB Coach', label: 'QB Coach', type: 'position' },
                    { id: 'TE Coach', label: 'TE Coach', type: 'position' },
                    { id: 'ST Coach', label: 'Special Teams Coach', type: 'position' }
                ];

                // Add staff member names
                if (staff && staff.length > 0) {
                    roleOptions.push({ id: 'divider2', label: '--- Staff Members ---', type: 'divider' });
                    staff.forEach(member => {
                        if (member.name) {
                            roleOptions.push({
                                id: `staff_${member.name}`,
                                label: member.name + (member.role ? ` (${member.role})` : ''),
                                type: 'staff'
                            });
                        }
                    });
                }

                return (
                    <div style={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
                        <div style={{ marginBottom: '1.5rem', display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                            {roleOptions.map(option => {
                                if (option.type === 'divider') {
                                    return <div key={option.id} style={{ width: '100%', fontSize: '0.75rem', color: 'var(--text-secondary)', fontWeight: 'bold', marginTop: '0.5rem', marginBottom: '0.25rem' }}>{option.label}</div>;
                                }
                                return (
                                    <button
                                        key={option.id}
                                        onClick={() => setActiveRole(option.id)}
                                        className={`btn ${activeRole === option.id ? 'btn-primary' : 'btn-secondary'}`}
                                        style={{ fontSize: '0.85rem' }}
                                    >
                                        {option.label}
                                    </button>
                                );
                            })}
                        </div>

                        <div className="card" style={{ padding: '1.5rem', border: '1px solid var(--border)', marginBottom: '2rem' }}>
                            <div style={{ display: 'flex', gap: '1rem', alignItems: 'end' }}>
                                <div style={{ flex: 2 }}>
                                    <label className="form-label">New Recurring Task for {activeRole}</label>
                                    <input
                                        className="form-input"
                                        placeholder="E.g. Script 3rd Down..."
                                        value={newRoleTask.task}
                                        onChange={e => setNewRoleTask({ ...newRoleTask, task: e.target.value })}
                                    />
                                </div>
                                <div style={{ flex: 1 }}>
                                    <label className="form-label">Day</label>
                                    <select
                                        className="form-select"
                                        value={newRoleTask.day}
                                        onChange={e => setNewRoleTask({ ...newRoleTask, day: e.target.value })}
                                    >
                                        {DAYS.map(d => <option key={d} value={d}>{d}</option>)}
                                    </select>
                                </div>
                                <button className="btn btn-primary" onClick={addRoleTask}>
                                    <Icon name="PlusCircle" /> Add
                                </button>
                            </div>
                        </div>

                        <div style={{ flex: 1, overflowY: 'auto' }}>
                            {DAYS.map(day => {
                                const tasks = TASKS_BY_DAY[day];
                                if (!tasks || tasks.length === 0) return null;
                                return (
                                    <div key={day} style={{ marginBottom: '1.5rem' }}>
                                        <h4 style={{ borderBottom: '1px solid var(--border)', paddingBottom: '0.5rem', marginBottom: '0.5rem', color: 'var(--text-secondary)' }}>{day}</h4>
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                            {tasks.map(t => (
                                                <div key={t.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0.75rem', background: 'var(--bg-app)', borderRadius: '6px' }}>
                                                    <span>{t.task}</span>
                                                    <button
                                                        onClick={() => removeRoleTask(t.id)}
                                                        style={{ background: 'none', border: 'none', color: '#ef4444', cursor: 'pointer', opacity: 0.6 }}
                                                        onMouseEnter={e => e.target.style.opacity = 1}
                                                        onMouseLeave={e => e.target.style.opacity = 0.6}
                                                    >
                                                        Remove
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                            {(!roleTasks[activeRole] || roleTasks[activeRole].length === 0) && (
                                <div style={{ textAlign: 'center', color: 'var(--text-secondary)', marginTop: '2rem' }}>
                                    No recurring tasks defined for {activeRole}.
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const toggleCategory = (cat) => {
                setExpandedCategories(prev => ({ ...prev, [cat]: !prev[cat] }));
            };

            const handleDutyAssign = (cat, subcat, duty, coachId) => {
                const key = subcat ? `${cat} > ${subcat} > ${duty}` : `${cat} > ${duty}`;
                const current = dutyAssignments?.[key] || [];

                let updated;
                if (current.includes(coachId)) {
                    updated = current.filter(id => id !== coachId);
                } else {
                    updated = [...current, coachId];
                }
                onUpdateDuties({ ...dutyAssignments, [key]: updated });
            };

            const renderDutyRow = (cat, subcat, duty) => {
                const key = subcat ? `${cat} > ${subcat} > ${duty}` : `${cat} > ${duty}`;
                const assignedIds = dutyAssignments?.[key] || [];

                return (
                    <div key={key} style={{ display: 'flex', alignItems: 'center', padding: '0.5rem', borderBottom: '1px solid var(--border)' }}>
                        <div style={{ flex: 1, fontWeight: '500' }}>{duty}</div>
                        <div style={{ flex: 2, display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                            {staff.map(coach => {
                                const isAssigned = assignedIds.includes(coach.id);
                                return (
                                    <button
                                        key={coach.id}
                                        onClick={() => handleDutyAssign(cat, subcat, duty, coach.id)}
                                        style={{
                                            padding: '0.2rem 0.5rem',
                                            fontSize: '0.8rem',
                                            borderRadius: '4px',
                                            border: isAssigned ? '1px solid var(--accent)' : '1px solid var(--border)',
                                            background: isAssigned ? 'var(--accent)' : 'transparent',
                                            color: isAssigned ? 'white' : 'var(--text-primary)',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        {coach.name || 'Unnamed'}
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            const renderCategory = (catName, content) => {
                const isExpanded = expandedCategories[catName];
                return (
                    <div key={catName} style={{ marginBottom: '1rem', border: '1px solid var(--border)', borderRadius: '8px', overflow: 'hidden' }}>
                        <button
                            onClick={() => toggleCategory(catName)}
                            style={{
                                width: '100%', textAlign: 'left', padding: '1rem',
                                background: 'var(--surface)', border: 'none', borderBottom: isExpanded ? '1px solid var(--border)' : 'none',
                                fontWeight: 'bold', display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                                cursor: 'pointer'
                            }}
                        >
                            <span>{catName}</span>
                            <Icon name={isExpanded ? 'ChevronUp' : 'ChevronDown'} size={18} />
                        </button>

                        {isExpanded && (
                            <div style={{ background: 'var(--background)' }}>
                                {Array.isArray(content) ? (
                                    // Flat List
                                    content.map(duty => renderDutyRow(catName, null, duty))
                                ) : (
                                    // Nested Categories
                                    Object.entries(content).map(([subCatName, duties]) => (
                                        <div key={subCatName} style={{ padding: '0.5rem' }}>
                                            <h4 style={{ margin: '0.5rem 0', paddingLeft: '0.5rem', color: 'var(--accent)', fontSize: '0.9rem' }}>{subCatName}</h4>
                                            <div style={{ paddingLeft: '0.5rem' }}>
                                                {duties.map(duty => renderDutyRow(catName, subCatName, duty))}
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}
                    </div>
                );
            };

            return (
                <div className="card" style={{ padding: '1.5rem', height: '100%', display: 'flex', flexDirection: 'column' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                        <h2 style={{ margin: 0 }}>Staff Manager</h2>
                    </div>

                    {view === 'duties' ? (
                        <div style={{ flex: 1, display: 'flex', flexDirection: 'column', height: '100%', overflow: 'hidden' }}>
                            {/* Tabs */}
                            <div style={{ display: 'flex', gap: '1rem', borderBottom: '1px solid var(--border)', marginBottom: '1.5rem' }}>
                                <button
                                    onClick={() => setDutyTab('seasonal')}
                                    style={{
                                        padding: '0.75rem 1rem',
                                        background: 'none',
                                        border: 'none',
                                        borderBottom: dutyTab === 'seasonal' ? '2px solid var(--accent)' : '2px solid transparent',
                                        color: dutyTab === 'seasonal' ? 'var(--accent)' : 'var(--text-secondary)',
                                        fontWeight: 'bold',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Seasonal Assignments
                                </button>
                                <button
                                    onClick={() => setDutyTab('recurring')}
                                    style={{
                                        padding: '0.75rem 1rem',
                                        background: 'none',
                                        border: 'none',
                                        borderBottom: dutyTab === 'recurring' ? '2px solid var(--accent)' : '2px solid transparent',
                                        color: dutyTab === 'recurring' ? 'var(--accent)' : 'var(--text-secondary)',
                                        fontWeight: 'bold',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Recurring Role Tasks
                                </button>
                            </div>

                            {dutyTab === 'seasonal' ? (
                                <div style={{ flex: 1, overflowY: 'auto' }}>
                                    <div style={{ marginBottom: '1rem', color: 'var(--text-secondary)', fontSize: '0.9rem' }}>
                                        Assign coaches to specific duties. Click a coach's name to assign/unassign them.
                                    </div>
                                    {Object.entries(DUTY_CATEGORIES).map(([cat, content]) => renderCategory(cat, content))}
                                </div>
                            ) : (
                                <RoleTaskEditor />
                            )}
                        </div>
                    ) : selectedCoach ? (
                        <div style={{ flex: 1, overflowY: 'auto' }}>
                            <button className="btn btn-secondary" onClick={() => setSelectedCoach(null)} style={{ marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                <span>‚Üê</span> Back to Roster
                            </button>
                            <div className="card" style={{ marginBottom: '2rem', border: '1px solid var(--border)' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', marginBottom: '1.5rem', borderBottom: '1px solid var(--border)', paddingBottom: '1rem' }}>
                                    <div style={{ width: '60px', height: '60px', borderRadius: '50%', background: 'var(--accent)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '1.5rem', fontWeight: 'bold' }}>
                                        {selectedCoach.name.charAt(0)}
                                    </div>
                                    <div>
                                        <h2 style={{ margin: 0 }}>{selectedCoach.name}</h2>
                                        <div style={{ color: 'var(--text-secondary)' }}>
                                            {selectedCoach.role}
                                            {selectedCoach.type === 'Coach' && (
                                                <>
                                                    {(Array.isArray(selectedCoach.level) ? selectedCoach.level : [selectedCoach.level]).filter(Boolean).map(lvl => (
                                                        <span key={lvl} style={{
                                                            marginLeft: '0.5rem',
                                                            fontSize: '0.7rem',
                                                            padding: '2px 6px',
                                                            borderRadius: '4px',
                                                            background: 'var(--surface)',
                                                            border: '1px solid var(--border)',
                                                            verticalAlign: 'middle'
                                                        }}>
                                                            {lvl}
                                                        </span>
                                                    ))}
                                                </>
                                            )}
                                            {selectedCoach.type === 'Manager' && (
                                                <span style={{
                                                    marginLeft: '0.5rem',
                                                    fontSize: '0.7rem',
                                                    padding: '2px 6px',
                                                    borderRadius: '4px',
                                                    background: 'var(--surface)',
                                                    border: '1px solid var(--border)',
                                                    verticalAlign: 'middle'
                                                }}>
                                                    Manager
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '3rem' }}>
                                    <div>
                                        <h4 style={{ color: 'var(--accent)', marginBottom: '1rem', textTransform: 'uppercase', fontSize: '0.85rem', letterSpacing: '1px' }}>Coaching Responsibilities</h4>
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                            <div style={{ background: 'var(--surface)', padding: '0.75rem', borderRadius: '6px' }}>
                                                <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)', marginBottom: '0.25rem' }}>Offense</div>
                                                <div>{selectedCoach.positions?.offense || '-'}</div>
                                            </div>
                                            <div style={{ background: 'var(--surface)', padding: '0.75rem', borderRadius: '6px' }}>
                                                <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)', marginBottom: '0.25rem' }}>Defense</div>
                                                <div>{selectedCoach.positions?.defense || '-'}</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <h4 style={{ color: 'var(--accent)', marginBottom: '1rem', textTransform: 'uppercase', fontSize: '0.85rem', letterSpacing: '1px' }}>Special Teams</h4>
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.5rem' }}>
                                            {Object.entries(selectedCoach.positions?.specials || {}).map(([unit, role]) => (
                                                role && (
                                                    <div key={unit} style={{ background: 'var(--surface)', padding: '0.5rem', borderRadius: '4px', fontSize: '0.9rem' }}>
                                                        <strong style={{ textTransform: 'uppercase', marginRight: '0.5rem' }}>{unit}:</strong> {role}
                                                    </div>
                                                )
                                            ))}
                                            {(!selectedCoach.positions?.specials || Object.values(selectedCoach.positions.specials).every(v => !v)) && (
                                                <div style={{ gridColumn: '1 / -1', color: 'var(--text-secondary)', fontStyle: 'italic' }}>No special teams assigned</div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div style={{ flex: 1, overflowY: 'auto' }}>
                            {(() => {
                                const coaches = sortedStaff.filter(m => !m.type || m.type === 'Coach');
                                const managers = sortedStaff.filter(m => m.type === 'Manager');

                                const renderStaffTable = (list, title) => (
                                    <div style={{ marginBottom: '2rem' }}>
                                        <h3 style={{ borderBottom: '1px solid var(--border)', paddingBottom: '0.5rem', marginBottom: '1rem', color: 'var(--accent)' }}>{title} ({list.length})</h3>
                                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                            <thead>
                                                <tr style={{ textAlign: 'left', color: 'var(--text-secondary)', fontSize: '0.85rem', borderBottom: '1px solid var(--border)' }}>
                                                    <th style={{ padding: '0.5rem', width: '30%' }}>Name</th>
                                                    <th style={{ padding: '0.5rem', width: '20%' }}>Role</th>
                                                    <th style={{ padding: '0.5rem', width: '40%' }}>Assignments</th>
                                                    <th style={{ padding: '0.5rem', width: '10%' }}></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {list.map(member => (
                                                    <tr key={member.id} style={{ borderBottom: '1px solid var(--border)' }}>
                                                        <td style={{ padding: '0.75rem 0.5rem' }}>
                                                            {isEditing === member.id ? (
                                                                <input
                                                                    className="form-input"
                                                                    value={member.name}
                                                                    onChange={e => updateMember(member.id, 'name', e.target.value)}
                                                                />
                                                            ) : (
                                                                <button
                                                                    onClick={() => setSelectedCoach(member)}
                                                                    style={{
                                                                        background: 'none', border: 'none',
                                                                        color: 'var(--text-primary)', fontWeight: 'bold',
                                                                        cursor: 'pointer', textAlign: 'left', padding: 0,
                                                                        fontSize: '1rem'
                                                                    }}
                                                                >
                                                                    {member.name}
                                                                </button>
                                                            )}
                                                        </td>
                                                        <td style={{ padding: '0.75rem 0.5rem' }}>
                                                            {isEditing === member.id ? (
                                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                                                    <input
                                                                        className="form-input"
                                                                        value={member.role}
                                                                        onChange={e => updateMember(member.id, 'role', e.target.value)}
                                                                    />
                                                                    {member.type !== 'Manager' && (
                                                                        <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap' }}>
                                                                            {['Varsity', 'JV', 'JV2'].map(lvl => {
                                                                                // Normalize to array
                                                                                const currentLevels = Array.isArray(member.level) ? member.level : (member.level ? [member.level] : []);
                                                                                const isSelected = currentLevels.includes(lvl);
                                                                                return (
                                                                                    <button
                                                                                        key={lvl}
                                                                                        onClick={() => {
                                                                                            const newLevels = isSelected
                                                                                                ? currentLevels.filter(l => l !== lvl)
                                                                                                : [...currentLevels, lvl];
                                                                                            updateMember(member.id, 'level', newLevels);
                                                                                        }}
                                                                                        style={{
                                                                                            padding: '2px 6px',
                                                                                            fontSize: '0.7rem',
                                                                                            borderRadius: '4px',
                                                                                            border: isSelected ? '1px solid var(--accent)' : '1px solid var(--border)',
                                                                                            background: isSelected ? 'var(--accent)' : 'transparent',
                                                                                            color: isSelected ? 'white' : 'var(--text-secondary)',
                                                                                            cursor: 'pointer'
                                                                                        }}
                                                                                    >
                                                                                        {lvl}
                                                                                    </button>
                                                                                );
                                                                            })}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ) : (
                                                                <div>
                                                                    <div>{member.role}</div>
                                                                    {member.type !== 'Manager' && (
                                                                        <div style={{ display: 'flex', gap: '4px', marginTop: '4px', flexWrap: 'wrap' }}>
                                                                            {(Array.isArray(member.level) ? member.level : [member.level]).filter(Boolean).map(lvl => (
                                                                                <span key={lvl} style={{
                                                                                    fontSize: '0.7rem',
                                                                                    padding: '1px 5px',
                                                                                    borderRadius: '4px',
                                                                                    background: 'var(--surface)',
                                                                                    border: '1px solid var(--border)',
                                                                                    color: 'var(--text-secondary)'
                                                                                }}>
                                                                                    {lvl}
                                                                                </span>
                                                                            ))}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            )}
                                                        </td>
                                                        <td style={{ padding: '0.75rem 0.5rem', fontSize: '0.85rem' }}>
                                                            {isEditing === member.id ? (
                                                                <div style={{ display: 'grid', gap: '0.5rem' }}>
                                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                                        <span style={{ width: '30px', color: 'var(--text-secondary)' }}>Off:</span>
                                                                        <input className="form-input" value={member.positions?.offense || ''} onChange={e => updatePosition(member.id, 'offense', e.target.value)} />
                                                                    </div>
                                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                                        <span style={{ width: '30px', color: 'var(--text-secondary)' }}>Def:</span>
                                                                        <input className="form-input" value={member.positions?.defense || ''} onChange={e => updatePosition(member.id, 'defense', e.target.value)} />
                                                                    </div>
                                                                </div>
                                                            ) : (
                                                                <div style={{ display: 'grid', gap: '0.25rem' }}>
                                                                    {member.positions?.offense && <div><span style={{ color: 'var(--text-secondary)' }}>Off:</span> {member.positions.offense}</div>}
                                                                    {member.positions?.defense && <div><span style={{ color: 'var(--text-secondary)' }}>Def:</span> {member.positions.defense}</div>}
                                                                    {formatSpecials(member.positions?.specials) !== '-' && (
                                                                        <div style={{ fontSize: '0.75rem', color: 'var(--accent)' }}>Specials: {formatSpecials(member.positions.specials)}</div>
                                                                    )}
                                                                </div>
                                                            )}
                                                        </td>
                                                        <td style={{ padding: '0.75rem 0.5rem', textAlign: 'right' }}>
                                                            <div style={{ display: 'flex', gap: '0.5rem', justifyContent: 'flex-end' }}>
                                                                {isEditing === member.id ? (
                                                                    <button className="btn btn-primary" onClick={() => setIsEditing(null)}>Save</button>
                                                                ) : (
                                                                    <>
                                                                        <button className="btn btn-secondary" onClick={() => setIsEditing(member.id)}>
                                                                            <Icon name="Settings" size={14} />
                                                                        </button>
                                                                        <button className="btn btn-secondary" style={{ color: '#ef4444' }} onClick={() => deleteMember(member.id)}>
                                                                            <Icon name="Minus" size={14} />
                                                                        </button>
                                                                    </>
                                                                )}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                        {list.length === 0 && (
                                            <div style={{ padding: '2rem', textAlign: 'center', color: 'var(--text-secondary)', background: 'var(--surface)', borderRadius: '8px' }}>
                                                No {title.toLowerCase()} found.
                                            </div>
                                        )}
                                    </div>
                                );

                                return (
                                    <>
                                        {renderStaffTable(coaches, "Coaching Staff")}
                                        {renderStaffTable(managers, "Managers & Support Staff")}
                                    </>
                                );
                            })()}

                            <div className="card" style={{ marginTop: '2rem', padding: '1.5rem', border: '1px solid var(--border)' }}>
                                <h3 style={{ marginTop: 0, marginBottom: '1.5rem' }}>Add New Staff Member</h3>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem' }}>
                                    <div>
                                        <label className="form-label">Name</label>
                                        <input
                                            className="form-input"
                                            value={newMember.name}
                                            onChange={e => setNewMember({ ...newMember, name: e.target.value })}
                                            placeholder="Coach Name"
                                        />
                                    </div>
                                    <div>
                                        <label className="form-label">Role</label>
                                        <input
                                            className="form-input"
                                            value={newMember.role}
                                            onChange={e => setNewMember({ ...newMember, role: e.target.value })}
                                            placeholder="e.g. Offensive Coordinator"
                                        />
                                    </div>

                                    <div>
                                        <label className="form-label">Type</label>
                                        <select
                                            className="form-select"
                                            value={newMember.type || 'Coach'}
                                            onChange={e => setNewMember({ ...newMember, type: e.target.value })}
                                        >
                                            <option value="Coach">Coach</option>
                                            <option value="Manager">Manager</option>
                                        </select>
                                    </div>

                                    {(!newMember.type || newMember.type === 'Coach') && (
                                        <div>
                                            <label className="form-label">Level(s)</label>
                                            <div style={{ display: 'flex', gap: '0.5rem' }}>
                                                {['Varsity', 'JV', 'JV2'].map(lvl => {
                                                    const currentLevels = Array.isArray(newMember.level) ? newMember.level : (newMember.level ? [newMember.level] : ['Varsity']);
                                                    const isActive = currentLevels.includes(lvl);
                                                    return (
                                                        <button
                                                            key={lvl}
                                                            onClick={() => {
                                                                const newLevels = isActive
                                                                    ? currentLevels.filter(l => l !== lvl)
                                                                    : [...currentLevels, lvl];
                                                                setNewMember({ ...newMember, level: newLevels });
                                                            }}
                                                            style={{
                                                                flex: 1,
                                                                padding: '0.5rem',
                                                                borderRadius: '4px',
                                                                border: `1px solid ${isActive ? 'var(--accent)' : 'var(--border)'}`,
                                                                background: isActive ? 'var(--accent-bg)' : 'transparent',
                                                                color: isActive ? 'var(--accent)' : 'var(--text-secondary)',
                                                                cursor: 'pointer',
                                                                fontSize: '0.9rem',
                                                                transition: 'all 0.2s'
                                                            }}
                                                        >
                                                            {lvl}
                                                        </button>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    )}

                                    <div>
                                        <label className="form-label">Offensive Assignment</label>
                                        <input
                                            className="form-input"
                                            value={newMember.positions.offense}
                                            onChange={e => setNewMember({ ...newMember, positions: { ...newMember.positions, offense: e.target.value } })}
                                            placeholder="e.g. QBs"
                                        />
                                    </div>
                                    <div>
                                        <label className="form-label">Defensive Assignment</label>
                                        <input
                                            className="form-input"
                                            value={newMember.positions.defense}
                                            onChange={e => setNewMember({ ...newMember, positions: { ...newMember.positions, defense: e.target.value } })}
                                            placeholder="e.g. LBs"
                                        />
                                    </div>
                                </div>
                                <div style={{ marginTop: '1.5rem', textAlign: 'right' }}>
                                    <button
                                        className="btn btn-primary"
                                        onClick={addMember}
                                        disabled={!newMember.name || !newMember.role}
                                    >
                                        Add Staff Member
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Special Teams Dashboard Component
        const SpecialTeamsDashboard = ({ roster, depthCharts, onUpdateDepthChart, savedLayouts, onUpdateLayout, onResetLayout, opponentData, onUpdateOpponentData }) => {
            const [kickerDistance, setKickerDistance] = useState(opponentData?.kickerDistance || 50);
            const [punterDistance, setPunterDistance] = useState(opponentData?.punterDistance || 45);
            const [yardLine, setYardLine] = useState(35);
            const [searchQuery, setSearchQuery] = useState('');

            // Calculate returner placement
            const calculateReturnerPlacement = () => {
                // Simple calculation: where the ball will land minus a safety buffer
                const kickLandingZone = 100 - yardLine - kickerDistance;
                const puntLandingZone = 100 - yardLine - punterDistance;

                return {
                    kickReturn: Math.max(kickLandingZone - 5, 0), // 5 yard safety buffer
                    puntReturn: Math.max(puntLandingZone - 5, 0)
                };
            };

            const placement = calculateReturnerPlacement();

            // Update player status
            const updatePlayerStatus = (playerId, status) => {
                const currentAvailability = opponentData.playerAvailability || {};
                const updatedAvailability = {
                    ...currentAvailability,
                    [playerId]: {
                        status,
                        timestamp: new Date().toISOString()
                    }
                };
                onUpdateOpponentData({
                    ...opponentData,
                    playerAvailability: updatedAvailability
                });
            };

            // Update opponent data when values change
            useEffect(() => {
                if (onUpdateOpponentData) {
                    onUpdateOpponentData({ ...opponentData, kickerDistance, punterDistance });
                }
            }, [kickerDistance, punterDistance]);


            const stCharts = [
                { type: 'KICKOFF', title: 'Kickoff' },
                { type: 'KICK_RETURN', title: 'Kick Return' },
                { type: 'PUNT', title: 'Punt' },
                { type: 'PUNT_RETURN', title: 'Punt Return' },
                { type: 'FIELD_GOAL', title: 'Field Goal / PAT' },
                { type: 'HANDS_TEAM', title: 'Hands Team' },
                { type: 'ONSIDE_KICK', title: 'Onside Kick' },
                { type: 'PAT_BLOCK', title: 'PAT Block' }
            ];

            return (
                <div style={{ padding: '2rem' }}>
                    <h2 style={{ marginBottom: '2rem' }}>Special Teams Dashboard</h2>

                    {/* Player Availability Tracker */}
                    <div style={{
                        backgroundColor: 'rgba(255, 255, 255, 0.02)',
                        border: '1px solid var(--border)',
                        borderRadius: '8px',
                        padding: '1.5rem',
                        marginBottom: '2rem'
                    }}>
                        <h3 style={{ marginTop: 0, marginBottom: '1rem' }}>Player Availability</h3>

                        <div style={{ marginBottom: '1rem', display: 'flex', gap: '1rem', alignItems: 'center' }}>
                            <input
                                type="text"
                                className="form-input"
                                placeholder="Search players..."
                                value={searchQuery}
                                onChange={e => setSearchQuery(e.target.value)}
                                style={{ maxWidth: '300px' }}
                            />
                            <div style={{ display: 'flex', gap: '0.5rem', fontSize: '0.9rem' }}>
                                <span>Legend:</span>
                                <span style={{ color: '#10b981' }}>üü¢ Available</span>
                                <span style={{ color: '#f59e0b' }}>üü° Questionable</span>
                                <span style={{ color: '#ef4444' }}>üî¥ OUT</span>
                            </div>
                        </div>

                        <div style={{ maxHeight: '400px', overflowY: 'auto', border: '1px solid var(--border)', borderRadius: '4px' }}>
                            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                <thead style={{ position: 'sticky', top: 0, backgroundColor: 'var(--bg)', zIndex: 1 }}>
                                    <tr style={{ borderBottom: '2px solid var(--border)' }}>
                                        <th style={{ padding: '0.75rem', textAlign: 'left' }}>#</th>
                                        <th style={{ padding: '0.75rem', textAlign: 'left' }}>Name</th>
                                        <th style={{ padding: '0.75rem', textAlign: 'left' }}>Pos</th>
                                        <th style={{ padding: '0.75rem', textAlign: 'center' }}>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {roster
                                        .filter(player =>
                                            !searchQuery ||
                                            player.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                                            player.number.toString().includes(searchQuery) ||
                                            player.position.toLowerCase().includes(searchQuery.toLowerCase())
                                        )
                                        .sort((a, b) => a.name.localeCompare(b.name))
                                        .map(player => {
                                            const status = (opponentData.playerAvailability || {})[player.id]?.status || 'available';
                                            return (
                                                <tr key={player.id} style={{ borderBottom: '1px solid var(--border)' }}>
                                                    <td style={{ padding: '0.75rem' }}>{player.number}</td>
                                                    <td style={{ padding: '0.75rem', fontWeight: '500' }}>{player.name}</td>
                                                    <td style={{ padding: '0.75rem' }}>{player.position}</td>
                                                    <td style={{ padding: '0.75rem' }}>
                                                        <div style={{ display: 'flex', gap: '0.25rem', justifyContent: 'center' }}>
                                                            <button
                                                                onClick={() => updatePlayerStatus(player.id, 'available')}
                                                                style={{
                                                                    padding: '0.25rem 0.5rem',
                                                                    border: status === 'available' ? '2px solid #10b981' : '1px solid var(--border)',
                                                                    backgroundColor: status === 'available' ? 'rgba(16, 185, 129, 0.2)' : 'transparent',
                                                                    borderRadius: '4px',
                                                                    cursor: 'pointer',
                                                                    fontSize: '0.85rem'
                                                                }}
                                                            >
                                                                üü¢
                                                            </button>
                                                            <button
                                                                onClick={() => updatePlayerStatus(player.id, 'questionable')}
                                                                style={{
                                                                    padding: '0.25rem 0.5rem',
                                                                    border: status === 'questionable' ? '2px solid #f59e0b' : '1px solid var(--border)',
                                                                    backgroundColor: status === 'questionable' ? 'rgba(245, 158, 11, 0.2)' : 'transparent',
                                                                    borderRadius: '4px',
                                                                    cursor: 'pointer',
                                                                    fontSize: '0.85rem'
                                                                }}
                                                            >
                                                                üü°
                                                            </button>
                                                            <button
                                                                onClick={() => updatePlayerStatus(player.id, 'out')}
                                                                style={{
                                                                    padding: '0.25rem 0.5rem',
                                                                    border: status === 'out' ? '2px solid #ef4444' : '1px solid var(--border)',
                                                                    backgroundColor: status === 'out' ? 'rgba(239, 68, 68, 0.2)' : 'transparent',
                                                                    borderRadius: '4px',
                                                                    cursor: 'pointer',
                                                                    fontSize: '0.85rem'
                                                                }}
                                                            >
                                                                üî¥
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Returner Placement Calculator */}
                    <div style={{
                        backgroundColor: 'rgba(56, 189, 248, 0.1)',
                        border: '1px solid var(--accent)',
                        borderRadius: '8px',
                        padding: '1.5rem',
                        marginBottom: '2rem'
                    }}>
                        <h3 style={{ marginTop: 0, marginBottom: '1rem', color: 'var(--accent)' }}>Returner Placement Calculator</h3>

                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem', marginBottom: '1.5rem' }}>
                            <div>
                                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' }}>
                                    Opponent Kicker Max Distance (yds)
                                </label>
                                <input
                                    type="number"
                                    className="form-input"
                                    value={kickerDistance}
                                    onChange={e => setKickerDistance(parseInt(e.target.value) || 0)}
                                    style={{ width: '100%' }}
                                />
                            </div>

                            <div>
                                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' }}>
                                    Opponent Punter Max Distance (yds)
                                </label>
                                <input
                                    type="number"
                                    className="form-input"
                                    value={punterDistance}
                                    onChange={e => setPunterDistance(parseInt(e.target.value) || 0)}
                                    style={{ width: '100%' }}
                                />
                            </div>

                            <div>
                                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' }}>
                                    Line of Scrimmage (yard line)
                                </label>
                                <input
                                    type="number"
                                    className="form-input"
                                    value={yardLine}
                                    onChange={e => setYardLine(parseInt(e.target.value) || 0)}
                                    min="0"
                                    max="100"
                                    style={{ width: '100%' }}
                                />
                            </div>
                        </div>

                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: '1fr 1fr',
                            gap: '1rem',
                            padding: '1rem',
                            backgroundColor: 'rgba(0, 0, 0, 0.2)',
                            borderRadius: '4px'
                        }}>
                            <div>
                                <div style={{ fontSize: '0.9rem', color: 'var(--text-secondary)', marginBottom: '0.25rem' }}>
                                    Kick Return - Suggested Returner Depth:
                                </div>
                                <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: 'var(--accent)' }}>
                                    {placement.kickReturn} yards
                                </div>
                            </div>
                            <div>
                                <div style={{ fontSize: '0.9rem', color: 'var(--text-secondary)', marginBottom: '0.25rem' }}>
                                    Punt Return - Suggested Returner Depth:
                                </div>
                                <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: 'var(--accent)' }}>
                                    {placement.puntReturn} yards
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Special Teams Depth Charts */}
                    <h3 style={{ marginBottom: '1.5rem' }}>Special Teams Depth Charts</h3>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '2rem' }}>
                        {stCharts.map(chart => (
                            <div key={chart.type} style={{
                                border: '1px solid var(--border)',
                                borderRadius: '8px',
                                padding: '1rem',
                                backgroundColor: 'rgba(255, 255, 255, 0.02)'
                            }}>
                                <DepthChart
                                    roster={roster}
                                    depthChart={depthCharts[chart.type] || {}}
                                    onUpdateDepthChart={(updated) => onUpdateDepthChart(chart.type, updated)}
                                    chartType={chart.type}
                                    savedLayout={savedLayouts[chart.type] || {}}
                                    onUpdateLayout={(layout) => onUpdateLayout(chart.type, layout)}
                                    onResetLayout={() => onResetLayout(chart.type)}
                                />
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const DepthChart = ({ roster, depthChart, onUpdateDepthChart, chartType = 'OFFENSE', savedLayout = {}, onUpdateLayout, onResetLayout, positionNames = {} }) => {

            // Derive base type and squad level
            const formattedType = chartType || 'OFFENSE';
            const baseChartType = formattedType.replace(/^(V|JV|J2)_/, '');
            const squadPrefix = formattedType.match(/^(V|JV|J2)_/)?.[1] || '';
            const squadName = { 'V': 'Varsity', 'JV': 'JV', 'J2': 'JV2' }[squadPrefix] || 'Varsity';

            // Standard coordinate mappings for different formations
            const FORMATIONS = {
                'OFFENSE': [
                    { id: 'OFF_LWR', name: positionNames['X'] || 'X', x: 20, y: 100 },
                    { id: 'OFF_LT', name: positionNames['LT'] || 'LT', x: 340, y: 100 },
                    { id: 'OFF_LG', name: positionNames['LG'] || 'LG', x: 520, y: 100 },
                    { id: 'OFF_C', name: positionNames['C'] || 'C', x: 700, y: 100 },
                    { id: 'OFF_RG', name: positionNames['RG'] || 'RG', x: 880, y: 100 },
                    { id: 'OFF_RT', name: positionNames['RT'] || 'RT', x: 1060, y: 100 },
                    { id: 'OFF_RWR', name: positionNames['Z'] || 'Z', x: 1240, y: 200 },
                    { id: 'OFF_QB', name: positionNames['QB'] || 'QB', x: 700, y: 300 },
                    { id: 'OFF_RB', name: positionNames['RB'] || 'RB', x: 700, y: 500 },
                    { id: 'OFF_SWR', name: positionNames['A'] || 'A', x: 170, y: 200 },
                    { id: 'OFF_TE', name: positionNames['Y'] || 'Y', x: 1420, y: 100 }
                ],
                'DEFENSE': [
                    { id: 'DEF_LDE', name: 'DE', x: 340, y: 100 },
                    { id: 'DEF_LDT', name: 'DT', x: 520, y: 100 },
                    { id: 'DEF_RDT', name: 'NT', x: 880, y: 100 },
                    { id: 'DEF_RDE', name: 'DE', x: 1060, y: 100 },
                    { id: 'DEF_WLB', name: 'Will', x: 520, y: 300 },
                    { id: 'DEF_MLB', name: 'Mike', x: 880, y: 300 },
                    { id: 'DEF_LCB', name: 'CB', x: 20, y: 200 },
                    { id: 'DEF_RCB', name: 'CB', x: 1380, y: 200 },
                    { id: 'DEF_FS', name: 'FS', x: 520, y: 500 },
                    { id: 'DEF_SS', name: 'SS', x: 880, y: 500 },
                    { id: 'DEF_NICK', name: 'Nickel', x: 1100, y: 300 }
                ],
                'KICKOFF': [
                    { id: 'KO_K', name: 'K', x: 700, y: 500 },
                    { id: 'KO_L1', name: 'L1', x: 600, y: 300 }, { id: 'KO_R1', name: 'R1', x: 800, y: 300 },
                    { id: 'KO_L2', name: 'L2', x: 500, y: 300 }, { id: 'KO_R2', name: 'R2', x: 900, y: 300 },
                    { id: 'KO_L3', name: 'L3', x: 400, y: 300 }, { id: 'KO_R3', name: 'R3', x: 1000, y: 300 },
                    { id: 'KO_L4', name: 'L4', x: 300, y: 300 }, { id: 'KO_R4', name: 'R4', x: 1100, y: 300 },
                    { id: 'KO_L5', name: 'L5', x: 200, y: 300 }, { id: 'KO_R5', name: 'R5', x: 1200, y: 300 }
                ],
                'KICK_RETURN': [
                    { id: 'KR_R1', name: 'KR', x: 600, y: 600 }, { id: 'KR_R2', name: 'KR', x: 800, y: 600 },
                    { id: 'KR_FL1', name: 'Front', x: 200, y: 200 }, { id: 'KR_FL2', name: 'Front', x: 1200, y: 200 },
                    { id: 'KR_M1', name: 'Mid', x: 400, y: 300 }, { id: 'KR_M2', name: 'Mid', x: 1000, y: 300 },
                    { id: 'KR_M3', name: 'Mid', x: 600, y: 300 }, { id: 'KR_M4', name: 'Mid', x: 800, y: 300 },
                    { id: 'KR_B1', name: 'Back', x: 500, y: 450 }, { id: 'KR_B2', name: 'Back', x: 900, y: 450 },
                    { id: 'KR_OFF', name: 'Off', x: 700, y: 450 }
                ],
                'PUNT': [
                    { id: 'P_P', name: 'P', x: 700, y: 600 },
                    { id: 'P_PP', name: 'PP', x: 700, y: 400 },
                    { id: 'P_LS', name: 'LS', x: 700, y: 100 },
                    { id: 'P_L1', name: 'L1', x: 600, y: 100 }, { id: 'P_R1', name: 'R1', x: 800, y: 100 },
                    { id: 'P_L2', name: 'L2', x: 500, y: 100 }, { id: 'P_R2', name: 'R2', x: 900, y: 100 },
                    { id: 'P_L3', name: 'Wing', x: 400, y: 150 }, { id: 'P_R3', name: 'Wing', x: 1000, y: 150 },
                    { id: 'P_G1', name: 'Gunner', x: 100, y: 100 }, { id: 'P_G2', name: 'Gunner', x: 1300, y: 100 }
                ],
                'PUNT_RETURN': [
                    { id: 'PR_R', name: 'Ret', x: 700, y: 600 },
                    { id: 'PR_J1', name: 'Jam', x: 100, y: 200 }, { id: 'PR_J2', name: 'Jam', x: 1300, y: 200 },
                    { id: 'PR_L1', name: 'Rush', x: 300, y: 150 }, { id: 'PR_R1', name: 'Rush', x: 1100, y: 150 },
                    { id: 'PR_L2', name: 'Rush', x: 400, y: 150 }, { id: 'PR_R2', name: 'Rush', x: 1000, y: 150 },
                    { id: 'PR_L3', name: 'Rush', x: 500, y: 150 }, { id: 'PR_R3', name: 'Rush', x: 900, y: 150 },
                    { id: 'PR_L4', name: 'Rush', x: 600, y: 150 }, { id: 'PR_R4', name: 'Rush', x: 800, y: 150 }
                ],
                'HANDS_TEAM': [
                    { id: 'HT_FL1', name: 'Front', x: 200, y: 100 }, { id: 'HT_FL2', name: 'Front', x: 1200, y: 100 },
                    { id: 'HT_FL3', name: 'Front', x: 400, y: 100 }, { id: 'HT_FL4', name: 'Front', x: 1000, y: 100 },
                    { id: 'HT_FL5', name: 'Front', x: 600, y: 100 }, { id: 'HT_FL6', name: 'Front', x: 800, y: 100 },
                    { id: 'HT_M1', name: 'Mid', x: 300, y: 300 }, { id: 'HT_M2', name: 'Mid', x: 1100, y: 300 },
                    { id: 'HT_M3', name: 'Mid', x: 700, y: 300 },
                    { id: 'HT_D1', name: 'Deep', x: 500, y: 500 }, { id: 'HT_D2', name: 'Deep', x: 900, y: 500 }
                ],
                'ONSIDE_KICK': [
                    { id: 'OS_K', name: 'K', x: 700, y: 500 },
                    { id: 'OS_L1', name: 'L1', x: 650, y: 300 }, { id: 'OS_R1', name: 'R1', x: 750, y: 300 },
                    { id: 'OS_L2', name: 'L2', x: 600, y: 300 }, { id: 'OS_R2', name: 'R2', x: 800, y: 300 },
                    { id: 'OS_L3', name: 'L3', x: 550, y: 300 }, { id: 'OS_R3', name: 'R3', x: 850, y: 300 },
                    { id: 'OS_L4', name: 'L4', x: 500, y: 300 }, { id: 'OS_R4', name: 'R4', x: 900, y: 300 },
                    { id: 'OS_L5', name: 'L5', x: 450, y: 300 }, { id: 'OS_R5', name: 'R5', x: 950, y: 300 }
                ],
                'PAT_BLOCK': [
                    { id: 'PB_1', name: 'Rush', x: 100, y: 100 }, { id: 'PB_11', name: 'Rush', x: 1300, y: 100 },
                    { id: 'PB_2', name: 'Rush', x: 220, y: 100 }, { id: 'PB_10', name: 'Rush', x: 1180, y: 100 },
                    { id: 'PB_3', name: 'Rush', x: 340, y: 100 }, { id: 'PB_9', name: 'Rush', x: 1060, y: 100 },
                    { id: 'PB_4', name: 'Rush', x: 460, y: 100 }, { id: 'PB_8', name: 'Rush', x: 940, y: 100 },
                    { id: 'PB_5', name: 'Rush', x: 580, y: 100 }, { id: 'PB_7', name: 'Rush', x: 820, y: 100 },
                    { id: 'PB_6', name: 'Safe', x: 700, y: 400 }
                ]
            };

            const defaultPositions = FORMATIONS[baseChartType] || FORMATIONS['OFFENSE'];

            // Merge default positions with saved custom layout
            const positions = defaultPositions.map(pos => {
                const saved = savedLayout[pos.id];
                return saved ? { ...pos, x: saved.x, y: saved.y } : pos;
            });

            const getPlayer = (id) => roster.find(p => p.id === id);

            const handleSelectPlayer = (posId, depthIndex, playerId) => {
                const currentDepth = depthChart[posId] || [null, null, null];
                const newDepth = [...currentDepth];
                newDepth[depthIndex] = playerId;
                onUpdateDepthChart({ ...depthChart, [posId]: newDepth });
            };

            const chartTitles = {
                'OFFENSE': 'Offensive Depth Chart (Spread)',
                'DEFENSE': 'Defensive Depth Chart (4-2-5)',
                'KICKOFF': 'Kickoff Unit',
                'KICK_RETURN': 'Kick Return Unit',
                'PUNT': 'Punt Unit',
                'PUNT_RETURN': 'Punt Return / Block',
                'HANDS_TEAM': 'Hands Team',
                'ONSIDE_KICK': 'Onside Kick Unit',
                'PAT_BLOCK': 'PAT / FG Block'
            };

            // Draggable Logic
            const [draggingId, setDraggingId] = useState(null);
            const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
            const [tempPosition, setTempPosition] = useState(null); // { x, y } while dragging

            const handleMouseDown = (e, pos) => {
                // Prevent drag if clicking on select or anything that shouldn't be dragged
                if (e.target.tagName === 'SELECT' || e.target.tagName === 'OPTION') return;

                setDraggingId(pos.id);
                setDragOffset({
                    x: e.clientX - pos.x,
                    y: e.clientY - pos.y
                });
                setTempPosition({ x: pos.x, y: pos.y });
            };

            const handleMouseMove = (e) => {
                if (!draggingId || !tempPosition) return;

                const newX = e.clientX - dragOffset.x;
                const newY = e.clientY - dragOffset.y;

                setTempPosition({ x: newX, y: newY });
            };

            const handleMouseUp = () => {
                if (draggingId && tempPosition && onUpdateLayout) {
                    onUpdateLayout(draggingId, tempPosition.x, tempPosition.y);
                }
                setDraggingId(null);
                setTempPosition(null);
            };

            // Add listener to window for mouse up to catch drags that end outside container
            useEffect(() => {
                if (draggingId) {
                    window.addEventListener('mousemove', handleMouseMove);
                    window.addEventListener('mouseup', handleMouseUp);
                    return () => {
                        window.removeEventListener('mousemove', handleMouseMove);
                        window.removeEventListener('mouseup', handleMouseUp);
                    };
                }
            }, [draggingId, tempPosition]); // Dependency required for closure state access if not using functional updates, but simple enough here.

            return (
                <div style={{ height: 'calc(100vh - 100px)', display: 'flex', flexDirection: 'column' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
                        <h2>{squadName} {chartTitles[baseChartType] || chartTitles['OFFENSE']}</h2>
                        <div style={{ display: 'flex', gap: '1rem' }}>
                            <button className="btn btn-secondary" onClick={onResetLayout} title="Reset positions to default">Reset Layout</button>
                            <button className="btn btn-secondary" onClick={() => window.print()}>üñ®Ô∏è Print</button>
                        </div>
                    </div>

                    <div style={{ flex: 1, overflowY: 'auto', overflowX: 'auto', position: 'relative', minHeight: '600px', border: '1px solid var(--border)', borderRadius: '8px', background: 'var(--surface)', userSelect: 'none' }}>
                        {/* Field Background Hint */}
                        <div style={{
                            position: 'absolute', top: '50px', left: '0', right: '0', height: '2px', background: 'var(--border)',
                            display: 'flex', justifyContent: 'space-between', padding: '0 50px', minWidth: '1500px', pointerEvents: 'none'
                        }}></div>

                        {positions.map(pos => {
                            const isDragging = draggingId === pos.id;
                            const x = isDragging ? tempPosition.x : pos.x;
                            const y = isDragging ? tempPosition.y : pos.y;

                            return (
                                <div
                                    key={pos.id}
                                    onMouseDown={(e) => handleMouseDown(e, pos)}
                                    style={{
                                        position: 'absolute',
                                        left: `${x}px`,
                                        top: `${y}px`,
                                        width: '140px',
                                        transform: 'translateX(-50%)', // Center align relative to coords
                                        display: 'flex',
                                        flexDirection: 'column',
                                        gap: '4px',
                                        background: isDragging ? 'var(--highlight)' : 'rgba(0,0,0,0.5)',
                                        padding: '8px',
                                        borderRadius: '8px',
                                        cursor: isDragging ? 'grabbing' : 'grab',
                                        border: isDragging ? '1px solid var(--accent)' : '1px solid transparent',
                                        zIndex: isDragging ? 10 : 1
                                    }}
                                >
                                    <div style={{ textAlign: 'center', fontWeight: 'bold', color: 'var(--accent)', marginBottom: '4px' }}>{pos.name}</div>
                                    {[0, 1, 2].map(depth => {
                                        const playerId = depthChart[pos.id]?.[depth];
                                        return (
                                            <select
                                                key={depth}
                                                className="form-select"
                                                style={{ fontSize: '0.75rem', padding: '2px', width: '100%' }}
                                                value={playerId || ''}
                                                onChange={e => handleSelectPlayer(pos.id, depth, e.target.value)}
                                            // Mouse down on select handled by early return in parent handler
                                            >
                                                <option value="">--</option>
                                                {roster.map(p => (
                                                    <option key={p.id} value={p.id}>
                                                        #{p.number} {p.name}
                                                    </option>
                                                ))}
                                            </select>
                                        );
                                    })}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- Global Helper Functions for Metrics & Scoring ---
        const parseTime = (val) => {
            if (!val) return null;
            if (typeof val === 'number') return val;
            if (val.includes(':')) {
                const [m, s] = val.split(':').map(Number);
                return (m * 60) + s;
            }
            return parseFloat(val);
        };

        const calculateIronManScore = (id, value, weight) => {
            if (!value || !weight) return 0;
            const wt = parseFloat(weight);
            const val = parseTime(value);

            if (isNaN(wt) || isNaN(val)) return 0;

            // 40 Yard Dash (Linear Approximation)
            if (id === 'forty') {
                const standard1000 = 4.3 + (wt - 100) * 0.0056;
                const standard0 = standard1000 + 2.4;
                if (val <= standard1000) return 1000;
                if (val >= standard0) return 0;
                const range = standard0 - standard1000;
                const diff = standard0 - val;
                return Math.round((diff / range) * 1000);
            }

            // Bench Press & Squat
            if (id === 'bench' || id === 'squat') {
                const roundedWeight = Math.round(wt / 10) * 10;
                if (roundedWeight === 0) return 0;
                const rawScore = (val * 3 / roundedWeight) * 100;
                return Math.max(0, Math.min(1000, Math.round(rawScore)));
            }

            // Bag Jump (Board Jump)
            if (id === 'bagJump' || id === 'boardJump') {
                let threshold = 30;
                if (wt <= 150) threshold = 30;
                else if (wt < 160) threshold = 30;
                else if (wt < 170) threshold = 29;
                else if (wt < 180) threshold = 28;
                else if (wt < 190) threshold = 27;
                else if (wt < 200) threshold = 26;
                else if (wt < 210) threshold = 26;
                else if (wt < 220) threshold = 25;
                else if (wt < 230) threshold = 25;
                else if (wt < 240) threshold = 24;
                else if (wt < 250) threshold = 23;
                else if (wt < 260) threshold = 22;
                else if (wt < 270) threshold = 21;
                else if (wt < 280) threshold = 20;
                else if (wt < 290) threshold = 19;
                else if (wt < 300) threshold = 18;
                else if (wt < 310) threshold = 17;
                else if (wt < 320) threshold = 16;
                else threshold = 15;

                const rawScore = (val - threshold) * 20;
                return Math.max(0, Math.min(1000, Math.round(rawScore)));
            }

            // 800m Run
            if (id === 'run800') {
                const standard1000 = 125 + (wt - 100) * 0.15;
                const standard0 = standard1000 + 120;
                if (val <= standard1000) return 1000;
                if (val >= standard0) return 0;
                const range = standard0 - standard1000;
                const diff = standard0 - val;
                return Math.round((diff / range) * 1000);
            }

            // 30 Yard Shuttle
            if (id === 'shuttle30') {
                const rawScore = 4000 + (wt * 4) - (val * 80);
                return Math.max(0, Math.min(1000, Math.round(rawScore)));
            }

            return 0;
        };

        const MaddenRatings = ({ roster, ratings, onUpdateRatings, metrics }) => {
            const [selectedPlayerId, setSelectedPlayerId] = useState(null);

            // Full Attribute List from Image
            const ATTRIBUTES = [
                // Physical
                { id: 'SPD', name: 'Speed', group: 'Physical' },
                { id: 'ACC', name: 'Acceleration', group: 'Physical' },
                { id: 'STR', name: 'Strength', group: 'Physical' },
                { id: 'AGI', name: 'Agility', group: 'Physical' },
                { id: 'JMP', name: 'Jumping', group: 'Physical' },
                { id: 'STA', name: 'Stamina', group: 'Physical' },
                { id: 'TGH', name: 'Toughness', group: 'Physical' },
                { id: 'INJ', name: 'Injury', group: 'Physical' },
                // Mental
                { id: 'AWR', name: 'Awareness', group: 'Mental' },
                { id: 'PRC', name: 'Play Recognition', group: 'Mental' },
                { id: 'BCV', name: 'Ball Carrier Vision', group: 'Mental' },
                // Passing
                { id: 'THP', name: 'Throw Power', group: 'Passing' },
                { id: 'SAC', name: 'Short Accuracy', group: 'Passing' },
                { id: 'MAC', name: 'Med Accuracy', group: 'Passing' },
                { id: 'DAC', name: 'Deep Accuracy', group: 'Passing' },
                { id: 'RUN', name: 'Throw on Run', group: 'Passing' },
                { id: 'PAC', name: 'Play Action', group: 'Passing' },
                // Rushing
                { id: 'CAR', name: 'Carrying', group: 'Rushing' },
                { id: 'TRK', name: 'Trucking', group: 'Rushing' },
                { id: 'ELU', name: 'Elusiveness', group: 'Rushing' },
                { id: 'SFA', name: 'Stiff Arm', group: 'Rushing' },
                { id: 'SPM', name: 'Spin Move', group: 'Rushing' },
                { id: 'JKM', name: 'Juke Move', group: 'Rushing' },
                // Receiving
                { id: 'CTH', name: 'Catching', group: 'Receiving' },
                { id: 'SPC', name: 'Spectacular Catch', group: 'Receiving' },
                { id: 'CIT', name: 'Catch in Traffic', group: 'Receiving' },
                { id: 'RTE', name: 'Route Running', group: 'Receiving' },
                { id: 'RLS', name: 'Release', group: 'Receiving' },
                // Blocking
                { id: 'RBK', name: 'Run Block', group: 'Blocking' },
                { id: 'RBS', name: 'Run Block Power', group: 'Blocking' },
                { id: 'RBF', name: 'Run Block Finesse', group: 'Blocking' },
                { id: 'PBK', name: 'Pass Block', group: 'Blocking' },
                { id: 'PBS', name: 'Pass Block Power', group: 'Blocking' },
                { id: 'PBF', name: 'Pass Block Finesse', group: 'Blocking' },
                { id: 'IBL', name: 'Impact Blocking', group: 'Blocking' },
                // Defense
                { id: 'TAK', name: 'Tackle', group: 'Defense' },
                { id: 'POW', name: 'Hit Power', group: 'Defense' },
                { id: 'BSH', name: 'Block Shedding', group: 'Defense' },
                { id: 'PUR', name: 'Pursuit', group: 'Defense' },
                { id: 'PMV', name: 'Power Moves', group: 'Defense' },
                { id: 'FMV', name: 'Finesse Moves', group: 'Defense' },
                { id: 'MCV', name: 'Man Coverage', group: 'Defense' },
                { id: 'ZCV', name: 'Zone Coverage', group: 'Defense' },
                { id: 'PRS', name: 'Press', group: 'Defense' },
                // Special Teams
                { id: 'KPW', name: 'Kick Power', group: 'Special' },
                { id: 'KAC', name: 'Kick Accuracy', group: 'Special' },
                { id: 'RET', name: 'Return', group: 'Special' }
            ];

            // Weights from Image (Integers, Sum to 100)
            const MADDEN_WEIGHTS = {
                'QB': { weights: { THP: 18, SAC: 17, MAC: 16, DAC: 12, RUN: 10, AWR: 10, TGH: 5, PAC: 5, JKM: 4, BSH: 3 } }, // SHA->SAC
                'RB': { weights: { BCV: 21, CAR: 18, AWR: 13, ACC: 12, TRK: 6, SPD: 6, AGI: 5, SFA: 5, JKM: 5, CTH: 4, STR: 3, STA: 2 } },
                'FB': { weights: { RBK: 25, PBK: 20, STR: 15, CAR: 10, AWR: 10, CTH: 10, SPD: 5, ACC: 5 } }, // Default FB estimated
                'WR': { weights: { CTH: 20, AWR: 15, RTE: 15, RLS: 13, SPC: 10, SPD: 9, ACC: 5, CIT: 5, AGI: 5, JKM: 3 } }, // REL->RLS
                'TE': { weights: { CTH: 18, RTE: 17, AWR: 12, RBK: 10, SPD: 8, RLS: 7, CIT: 7, SPC: 6, PBK: 5, ACC: 4, IBL: 3, STR: 3 } }, // REL->RLS
                'OL': { weights: { PBK: 21, RBK: 21, IBL: 19, STR: 11, AWR: 11, STA: 10, AGI: 5, ACC: 2 } },
                'LT': { weights: { PBK: 21, RBK: 21, IBL: 19, STR: 11, AWR: 11, STA: 10, AGI: 5, ACC: 2 } },
                'LG': { weights: { PBK: 21, RBK: 21, IBL: 19, STR: 11, AWR: 11, STA: 10, AGI: 5, ACC: 2 } },
                'C': { weights: { PBK: 21, RBK: 21, IBL: 19, STR: 11, AWR: 11, STA: 10, AGI: 5, ACC: 2 } },
                'RG': { weights: { PBK: 21, RBK: 21, IBL: 19, STR: 11, AWR: 11, STA: 10, AGI: 5, ACC: 2 } },
                'RT': { weights: { PBK: 21, RBK: 21, IBL: 19, STR: 11, AWR: 11, STA: 10, AGI: 5, ACC: 2 } },
                'DE': { weights: { PMV: 17, FMV: 17, BSH: 15, PUR: 13, AWR: 10, STR: 8, ACC: 7, TAK: 7, SPD: 3, AGI: 3 } }, // PWM->PMV, FNM->FMV
                'DT': { weights: { BSH: 22, STR: 16, PMV: 14, PUR: 13, TAK: 11, AWR: 11, FMV: 7, ACC: 4, AGI: 1, SPD: 1 } },
                'MLB': { weights: { TAK: 17, PUR: 15, AWR: 14, PRC: 14, BSH: 12, ZCV: 9, POW: 7, SPD: 4, STR: 4, ACC: 2, AGI: 1, MCV: 1 } },
                'OLB': { weights: { PUR: 17, TAK: 16, AWR: 12, PRC: 12, BSH: 11, PMV: 11, FMV: 10, ZCV: 4, ACC: 2, SPD: 2, STR: 2, POW: 1 } },
                'CB': { weights: { MCV: 20, ZCV: 20, PRC: 17, AWR: 13, SPD: 11, ACC: 7, AGI: 4, JMP: 3, CTH: 2, TAK: 1 } },
                'S': { weights: { ZCV: 21, AWR: 16, PRC: 15, PUR: 13, TAK: 11, SPD: 10, POW: 5, ACC: 5, MCV: 2, BSH: 1, CTH: 1 } },
                'K': { weights: { KPW: 60, KAC: 40 } },
                'P': { weights: { KPW: 60, KAC: 40 } }
            };

            const getLatestStats = (playerId) => {
                const data = metrics[playerId];
                if (!data) return null;
                const results = Array.isArray(data) ? data : [{ date: 'Initial', ...data }];
                if (results.length === 0) return null;
                // Sort by date descending and get latest
                return results.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
            };

            const safeRatings = ratings || {};

            const getPlayerRating = (playerId) => {
                return safeRatings[playerId] || ATTRIBUTES.reduce((acc, attr) => ({ ...acc, [attr.id]: 50 }), {});
            };

            const calculateArchetype = (pos, ratings) => {
                const r = ratings || {};

                // Simplified Logic mirroring Column D cues
                if (pos === 'QB') {
                    if ((ratings.SPD || 0) >= 85) return 'Scrambler';
                    if ((ratings.THP || 0) >= 90) return 'Strong Arm';
                    if ((ratings.SAC || 0) >= 90) return 'Field General';
                    return 'Balanced';
                }
                if (pos === 'RB') {
                    if ((ratings.TRK || 0) > (ratings.ELU || 0)) return 'Power Back';
                    if ((ratings.CTH || 0) > 75) return 'Receiving Back';
                    if ((ratings.SPD || 0) >= 90) return 'Elusive Back';
                    return 'Balanced';
                }
                if (pos === 'WR') {
                    if ((ratings.SPD || 0) >= 92) return 'Speedster';
                    if ((ratings.CTH || 0) >= 90) return 'Possession';
                    if ((ratings.SPC || 0) >= 85) return 'Deep Threat';
                    return 'Balanced';
                }
                if (['OL', 'LT', 'LG', 'C', 'RG', 'RT'].includes(pos)) {
                    if ((ratings.AGI || 0) >= 70) return 'Agile';
                    if ((ratings.STR || 0) >= 90) return 'Power';
                    return 'Balanced';
                }
                if (['DE', 'DT'].includes(pos)) {
                    if ((ratings.SPD || 0) >= 80) return 'Speed Rusher';
                    if ((ratings.STR || 0) >= 90) return 'Power Rusher';
                    return 'Balanced';
                }
                if (['MLB', 'OLB'].includes(pos)) {
                    if ((ratings.ZCV || 0) >= 75) return 'Pass Coverage';
                    if ((ratings.TAK || 0) >= 90) return 'Run Stopper';
                    return 'Field General';
                }
                if (['CB', 'S'].includes(pos)) {
                    if ((ratings.MCV || 0) > (ratings.ZCV || 0)) return 'Man to Man';
                    if ((ratings.ZCV || 0) > (ratings.MCV || 0)) return 'Zone';
                    return 'Balanced';
                }

                return 'Balanced';
            };

            const calculateOVR = (player, playerRatings) => {
                if (!player || !playerRatings) return 50;

                // Allow specific positions or generic groups (e.g. OLB)
                let pos = player.position;
                if (['LOLB', 'ROLB'].includes(pos)) pos = 'OLB';
                if (['LE', 'RE'].includes(pos)) pos = 'DE';
                if (['FS', 'SS'].includes(pos)) pos = 'S';

                const formula = MADDEN_WEIGHTS[pos] || MADDEN_WEIGHTS['QB']; // Fallback

                let weightedSum = 0;
                let totalWeight = 0;

                if (formula && formula.weights) {
                    for (const [attr, weight] of Object.entries(formula.weights)) {
                        weightedSum += (playerRatings[attr] || 50) * weight;
                        totalWeight += weight;
                    }
                }

                // If weights sum to 100, dividing by 1 gives the score.
                // If they sum to < 100 or > 100, dividing by totalWeight normalizes it.
                // User sheet used integers summing mostly to 100.
                if (totalWeight === 0) return 50;

                const ovr = weightedSum / totalWeight;
                return Math.max(0, Math.min(99, Math.round(ovr)));
            };

            const syncRatings = () => {
                const newRatings = { ...safeRatings };
                let updatedCount = 0;

                roster.forEach(player => {
                    const stats = getLatestStats(player.id);
                    if (!stats) return;

                    const playerWeight = parseFloat(player.weight) || 180;
                    const currentPlayerRatings = newRatings[player.id] || ATTRIBUTES.reduce((acc, attr) => ({ ...acc, [attr.id]: 50 }), {});

                    const updates = {};

                    // SPD (Speed) from 40 Yard Dash
                    if (stats.forty) {
                        const score = calculateIronManScore('forty', stats.forty, playerWeight);
                        // Map 0-1000 score to roughly 40-99 rating
                        updates['SPD'] = 50 + Math.round((score / 1000) * 49);
                        updates['ACC'] = updates['SPD']; // Base ACC off SPD for now
                    }

                    // STR (Strength) from Bench/Squat
                    const benchScore = stats.bench ? calculateIronManScore('bench', stats.bench, playerWeight) : 0;
                    const squatScore = stats.squat ? calculateIronManScore('squat', stats.squat, playerWeight) : 0;
                    const maxPowerScore = Math.max(benchScore, squatScore);
                    if (maxPowerScore > 0) {
                        updates['STR'] = 50 + Math.round((maxPowerScore / 1000) * 49);
                        updates['POW'] = updates['STR']; // Hit Power
                        updates['TRK'] = updates['STR']; // Trucking
                        updates['BSH'] = updates['STR']; // Block Shedding
                    }

                    // AGI (Agility) from Shuttle/Pro Agility/Bag Jump
                    const shuttleScore = stats.shuttle30 ? calculateIronManScore('shuttle30', stats.shuttle30, playerWeight) : 0;
                    const bagScore = stats.bagJump ? calculateIronManScore('bagJump', stats.bagJump, playerWeight) : 0;
                    const maxAgilityScore = Math.max(shuttleScore, bagScore);
                    if (maxAgilityScore > 0) {
                        updates['AGI'] = 50 + Math.round((maxAgilityScore / 1000) * 49);
                        updates['COD'] = updates['AGI']; // Change of Direction (using AGI field for now if COD not explicit)
                    }

                    // JMP (Jumping) from Vertical
                    if (stats.vertical) {
                        const vert = parseFloat(stats.vertical);
                        updates['JMP'] = Math.min(99, Math.max(40, 50 + Math.round((vert - 15) * 2)));
                    }

                    if (Object.keys(updates).length > 0) {
                        newRatings[player.id] = { ...currentPlayerRatings, ...updates };
                        updatedCount++;
                    }
                });

                if (updatedCount > 0) {
                    onUpdateRatings(newRatings);
                    alert(`Synced ratings for ${updatedCount} players based on latest testing data.`);
                } else {
                    alert("No testing data found to sync.");
                }
            };

            const handleAttributeChange = (attrId, value) => {
                if (!selectedPlayerId) return;
                const currentRatings = getPlayerRating(selectedPlayerId);
                const newRatings = { ...safeRatings, [selectedPlayerId]: { ...currentRatings, [attrId]: parseInt(value) } };
                onUpdateRatings(newRatings);
            };

            const sortedRoster = [...roster].sort((a, b) => {
                const ovrA = calculateOVR(a, safeRatings[a.id]);
                const ovrB = calculateOVR(b, safeRatings[b.id]);
                return ovrB - ovrA;
            });

            const selectedPlayer = roster.find(p => p.id === selectedPlayerId);
            const currentStats = selectedPlayerId ? getPlayerRating(selectedPlayerId) : null;
            const currentOVR = selectedPlayer ? calculateOVR(selectedPlayer, currentStats) : 0;

            // Group attributes for display
            const groupedAttributes = ATTRIBUTES.reduce((acc, attr) => {
                if (!acc[attr.group]) acc[attr.group] = [];
                acc[attr.group].push(attr);
                return acc;
            }, {});

            return (
                <div style={{ height: 'calc(100vh - 100px)', display: 'flex', gap: '2rem' }}>
                    {/* Player List */}
                    <div className="card" style={{ width: '300px', display: 'flex', flexDirection: 'column', padding: '0' }}>
                        <div style={{ padding: '1rem', borderBottom: '1px solid var(--border)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h3 style={{ margin: 0 }}>Roster</h3>
                            <button className="btn btn-secondary" style={{ fontSize: '0.7rem', padding: '2px 6px' }} onClick={syncRatings}>Sync Tests</button>
                        </div>
                        <div style={{ flex: 1, overflowY: 'auto' }}>
                            {sortedRoster.map(player => {
                                const ovr = calculateOVR(player, safeRatings[player.id]);
                                const archetype = calculateArchetype(player.position, safeRatings[player.id]);
                                let ovrColor = '#ef4444'; // < 70
                                if (ovr >= 90) ovrColor = '#10b981'; // Elite
                                else if (ovr >= 80) ovrColor = '#3b82f6'; // Star
                                else if (ovr >= 70) ovrColor = '#f59e0b'; // Starter

                                return (
                                    <div
                                        key={player.id}
                                        onClick={() => setSelectedPlayerId(player.id)}
                                        style={{
                                            padding: '0.75rem 1rem',
                                            borderBottom: '1px solid var(--border)',
                                            cursor: 'pointer',
                                            background: selectedPlayerId === player.id ? 'var(--bg-body)' : 'transparent',
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center'
                                        }}
                                    >
                                        <div>
                                            <div style={{ fontWeight: 'bold' }}>{player.name}</div>
                                            <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>
                                                #{player.number} ‚Ä¢ {player.position} <span style={{ color: 'var(--accent)', marginLeft: '4px' }}>‚Ä¢ {archetype}</span>
                                            </div>
                                        </div>
                                        <div style={{
                                            background: ovrColor,
                                            color: '#fff',
                                            fontWeight: 'bold',
                                            borderRadius: '4px',
                                            width: '36px',
                                            height: '36px',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            fontSize: '1.1rem'
                                        }}>
                                            {ovr}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Editor */}
                    <div className="card" style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
                        {selectedPlayer ? (
                            <>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem', borderBottom: '1px solid var(--border)', paddingBottom: '1rem' }}>
                                    <div>
                                        <h2 style={{ margin: 0 }}>{selectedPlayer.name}</h2>
                                        <div style={{ fontSize: '1.1rem', color: 'var(--text-secondary)', marginTop: '0.25rem' }}>
                                            #{selectedPlayer.number} ‚Ä¢ {selectedPlayer.position} <span style={{ color: 'var(--accent)', fontWeight: 'bold' }}>‚Ä¢ {calculateArchetype(selectedPlayer.position, currentStats)}</span>
                                        </div>
                                        {(() => {
                                            const stats = getLatestStats(selectedPlayer.id);
                                            if (stats) {
                                                return (
                                                    <div style={{ display: 'flex', gap: '1rem', marginTop: '0.5rem', fontSize: '0.8rem', color: 'var(--text-secondary)' }}>
                                                        <span>40: <strong style={{ color: 'var(--text-primary)' }}>{stats.forty || '-'}</strong></span>
                                                        <span>Bench: <strong style={{ color: 'var(--text-primary)' }}>{stats.bench || '-'}</strong></span>
                                                        <span>Squat: <strong style={{ color: 'var(--text-primary)' }}>{stats.squat || '-'}</strong></span>
                                                        <span>Vert: <strong style={{ color: 'var(--text-primary)' }}>{stats.vertical || '-'}</strong></span>
                                                    </div>
                                                );
                                            }
                                            return null;
                                        })()}
                                    </div>
                                    <div style={{ textAlign: 'right' }}>
                                        <div style={{ fontSize: '0.9rem', color: 'var(--text-secondary)' }}>OVERALL</div>
                                        <div style={{ fontSize: '3rem', fontWeight: '900', lineHeight: 1, color: currentOVR >= 90 ? '#10b981' : currentOVR >= 80 ? '#3b82f6' : currentOVR >= 70 ? '#f59e0b' : '#ef4444' }}>
                                            {currentOVR}
                                        </div>
                                    </div>
                                </div>

                                <div style={{ overflowY: 'auto', paddingRight: '1rem' }}>
                                    {Object.entries(groupedAttributes).map(([group, attrs]) => (
                                        <div key={group} style={{ marginBottom: '2rem' }}>
                                            <h4 style={{ borderBottom: '1px solid var(--border)', paddingBottom: '0.5rem', marginBottom: '1rem', color: 'var(--accent)' }}>{group}</h4>
                                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: '1.5rem' }}>
                                                {attrs.map(attr => (
                                                    <div key={attr.id}>
                                                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                                                            <label style={{ fontWeight: 'bold' }}>{attr.id}</label>
                                                            <span style={{ fontWeight: 'bold' }}>{currentStats[attr.id]}</span>
                                                        </div>
                                                        <input
                                                            type="range"
                                                            min="0"
                                                            max="99"
                                                            value={currentStats[attr.id]}
                                                            onChange={e => handleAttributeChange(attr.id, e.target.value)}
                                                            style={{
                                                                width: '100%',
                                                                accentColor: 'var(--accent)'
                                                            }}
                                                        />
                                                        <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', marginTop: '0.25rem' }}>{attr.name}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </>
                        ) : (
                            <div style={{ flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'var(--text-secondary)', flexDirection: 'column' }}>
                                <Icon name="User" />
                                <p style={{ marginTop: '1rem' }}>Select a player to edit ratings</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const PressboxTracker = ({ plays, gameLog, onUpdateGameLog, roster, depthChart, situation, onUpdateSituation, formations }) => {
            // Helper to convert User Format (-49 to -1, 50, 49 to 1) to Linear (1-99)
            // Linear: 1 (Own 1) -> 50 (Mid) -> 99 (Opp 1)
            const toLinearYard = (userVal) => {
                if (userVal === 50) return 50;
                if (userVal < 0) return Math.abs(userVal); // -20 -> 20
                return 100 - userVal; // 20 -> 80
            };

            // Helper to convert Linear (1-99) to User Format
            const toUserYard = (linearVal) => {
                if (linearVal === 50) return 50;
                if (linearVal < 50) return -linearVal; // 20 -> -20
                return 100 - linearVal; // 80 -> 20
            };

            const formatYardLine = (linearVal) => {
                const userVal = toUserYard(linearVal);
                if (userVal === 50) return '50';
                if (userVal < 0) return `Own ${Math.abs(userVal)}`;
                return `Opp ${userVal}`;
            };

            // Situation state is now lifted to App
            const setSituation = onUpdateSituation;
            const [selectedPlayId, setSelectedPlayId] = useState('');
            const [result, setResult] = useState({
                yards: 0,
                type: 'Run',
                outcome: 'Tackle'
            });
            const [isSelectingPlay, setIsSelectingPlay] = useState(false);
            const [injuredPlayerId, setInjuredPlayerId] = useState('');

            // Formation Window State
            const getDefaultDefenderPositions = () => [
                { id: 'DL1', label: 'DL', x: 35, y: 48 },
                { id: 'DL2', label: 'DL', x: 42, y: 50 },
                { id: 'DL3', label: 'DL', x: 58, y: 50 },
                { id: 'DL4', label: 'DL', x: 65, y: 48 },
                { id: 'LB1', label: 'LB', x: 30, y: 35 },
                { id: 'LB2', label: 'LB', x: 50, y: 38 },
                { id: 'LB3', label: 'LB', x: 70, y: 35 },
                { id: 'DB1', label: 'CB', x: 15, y: 20 },
                { id: 'DB2', label: 'CB', x: 85, y: 20 },
                { id: 'DB3', label: 'S', x: 35, y: 15 },
                { id: 'DB4', label: 'S', x: 65, y: 15 },
            ];
            const [defenders, setDefenders] = useState(getDefaultDefenderPositions());
            const [draggingDefender, setDraggingDefender] = useState(null);
            const fieldRef = useRef(null);

            // Reset defender positions when play changes
            useEffect(() => {
                setDefenders(getDefaultDefenderPositions());
            }, [selectedPlayId]);

            // Special Teams Keys to Check
            const ST_KEYS = ['KICKOFF', 'KICK_RETURN', 'PUNT', 'PUNT_RETURN', 'FIELD_GOAL', 'HANDS_TEAM', 'ONSIDE_KICK', 'PAT_BLOCK'];

            const PENALTY_TYPES = [
                "Holding", "False Start", "Offsides", "Pass Interference", "Personal Foul",
                "Delay of Game", "Block in the Back", "Roughing the Passer", "Facemask", "Unsportsmanlike Conduct"
            ];

            const [penalty, setPenalty] = useState({
                active: false,
                playerId: '',
                type: ''
            });

            const reportInjury = () => {
                if (!injuredPlayerId) return;

                const player = roster.find(p => p.id === injuredPlayerId);
                const affectedUnits = [];

                ST_KEYS.forEach(key => {
                    const chart = depthChart[key] || {};
                    const isStarter = Object.values(chart).some(pid => pid === injuredPlayerId);
                    if (isStarter) affectedUnits.push(key.replace('_', ' '));
                });

                if (affectedUnits.length > 0) {
                    alert(`‚ö†Ô∏è ALERT: ${player.name} is a starter on: ${affectedUnits.join(', ')}.\n\nNotify Special Teams Coordinator immediately!`);
                } else {
                    alert(`Injury recorded for ${player.name}. No immediate Special Teams conflicts found.`);
                }

                // Reset
                setInjuredPlayerId('');
            };
            const handleLogPlay = () => {
                const play = plays.find(p => p.id === selectedPlayId);
                const newLogEntry = {
                    id: Date.now().toString(),
                    situation: { ...situation },
                    play: play ? { name: play.name, formation: play.formation } : { name: 'Unknown', formation: '' },
                    play: play ? { name: play.name, formation: play.formation } : { name: 'Unknown', formation: '' },
                    result: { ...result },
                    penalty: penalty.active ? { ...penalty } : null
                };

                // Calculate next situation
                let nextYardLine = situation.yardLine + result.yards;
                let nextDown = situation.down + 1;
                let nextDistance = situation.distance - result.yards;

                // Handle Touchdown
                if (result.type === 'Touchdown' || nextYardLine >= 100) {
                    nextYardLine = 100; // Endzone
                    // Reset for next drive (Kickoff? or PAT? Let's assume PAT/Kickoff sequence implies new drive starts at Own 25)
                    // For simplicity, let's just mark it. The user can manually reset or we can prompt.
                    // Let's auto-reset to Own 25 for next drive for now, or maybe just leave it at 100 to show TD.
                    // Better: Leave it, user changes drive number and yard line manually for next drive.
                }

                if (nextDistance <= 0 && nextYardLine < 100) {
                    nextDown = 1;
                    nextDistance = 10;
                }

                if (nextDown > 4) {
                    nextDown = 1;
                    nextDistance = 10;
                    // Turnover logic could go here
                }

                onUpdateGameLog([newLogEntry, ...gameLog]);

                // Update current situation
                setSituation({
                    ...situation,
                    down: nextDown,
                    distance: nextDistance,
                    yardLine: nextYardLine
                });

                // Reset result inputs
                setSelectedPlayId('');
                setResult({ yards: 0, type: 'Run', outcome: 'Tackle' });
                setPenalty({ active: false, playerId: '', type: '' });
            };

            return (
                <div style={{ height: 'calc(100vh - 100px)', display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <h2>Pressbox / Game Tracker</h2>
                        <div style={{ display: 'flex', gap: '1rem', alignItems: 'center' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', background: 'var(--surface)', padding: '0.25rem 0.5rem', borderRadius: '8px', border: '1px solid var(--border)' }}>
                                <span style={{ fontSize: '0.9rem', fontWeight: 'bold' }}>Drive:</span>
                                <button className="btn" style={{ padding: '0.25rem 0.5rem' }} onClick={() => setSituation({ ...situation, driveNumber: Math.max(1, situation.driveNumber - 1) })}>-</button>
                                <span style={{ fontWeight: 'bold', minWidth: '20px', textAlign: 'center' }}>{situation.driveNumber}</span>
                                <button className="btn" style={{ padding: '0.25rem 0.5rem' }} onClick={() => setSituation({ ...situation, driveNumber: situation.driveNumber + 1 })}>+</button>
                            </div>
                            <button className="btn btn-secondary" onClick={() => window.print()}>üñ®Ô∏è Print Log</button>
                        </div>
                    </div>

                    {/* Situation Input */}
                    <div className="card" style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '1rem', alignItems: 'end' }}>
                        <div>
                            <label className="form-label">Down</label>
                            <div className="situation-toggle">
                                {[1, 2, 3, 4].map(d => (
                                    <button
                                        key={d}
                                        className={situation.down === d ? 'active' : ''}
                                        onClick={() => setSituation({ ...situation, down: d })}
                                    >
                                        {d}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div>
                            <label className="form-label">Distance</label>
                            <input
                                type="number"
                                className="form-input"
                                value={situation.distance}
                                onChange={e => setSituation({ ...situation, distance: parseInt(e.target.value) || 0 })}
                            />
                        </div>
                        <div>
                            <label className="form-label">Ball On (-49 to 49)</label>
                            <input
                                type="number"
                                className="form-input"
                                value={toUserYard(situation.yardLine)}
                                onChange={e => setSituation({ ...situation, yardLine: toLinearYard(parseInt(e.target.value) || 0) })}
                                placeholder="-25 = Own 25"
                            />
                            <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)', marginTop: '0.25rem' }}>
                                {formatYardLine(situation.yardLine)}
                            </div>
                        </div>
                        <div>
                            <label className="form-label">Hash</label>
                            <div className="situation-toggle">
                                {['L', 'M', 'R'].map(h => (
                                    <button
                                        key={h}
                                        className={situation.hash === h ? 'active' : ''}
                                        onClick={() => setSituation({ ...situation, hash: h })}
                                    >
                                        {h}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Play Call & Result */}
                    <div className="card" style={{ display: 'flex', gap: '2rem', alignItems: 'flex-start' }}>
                        <div style={{ flex: 1 }}>
                            <label className="form-label">Call Play</label>
                            <div style={{ display: 'flex', gap: '0.5rem' }}>
                                <select
                                    className="form-select"
                                    value={selectedPlayId}
                                    onChange={e => setSelectedPlayId(e.target.value)}
                                >
                                    <option value="">-- Select Play --</option>
                                    {plays.map(p => (
                                        <option key={p.id} value={p.id}>{p.formation} - {p.name}</option>
                                    ))}
                                </select>
                            </div>
                        </div>

                        <div style={{ flex: 1, display: 'flex', gap: '1rem' }}>
                            <div style={{ flex: 1 }}>
                                <label className="form-label">Yards Gained</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    value={result.yards}
                                    onChange={e => setResult({ ...result, yards: parseInt(e.target.value) || 0 })}
                                />
                            </div>
                            <div style={{ flex: 1 }}>
                                <label className="form-label">Type</label>
                                <select
                                    className="form-select"
                                    value={result.type}
                                    onChange={e => setResult({ ...result, type: e.target.value })}
                                >
                                    <option>Run</option>
                                    <option>Pass</option>
                                    <option>Sack</option>
                                    <option>Special</option>
                                </select>
                            </div>
                            <div style={{ flex: 1 }}>
                                <label className="form-label">Result</label>
                                <select
                                    className="form-select"
                                    value={result.outcome}
                                    onChange={e => setResult({ ...result, outcome: e.target.value })}
                                >
                                    <option>Tackle</option>
                                    <option>Touchdown</option>
                                    <option>Fumble</option>
                                    <option>Interception</option>
                                    <option>Incomplete</option>
                                    <option>Out of Bounds</option>
                                    <option>Fair Catch</option>
                                    <option>Touchback</option>
                                    <option>Safety</option>
                                </select>
                            </div>
                        </div>

                        <div style={{ alignSelf: 'flex-end' }}>
                            <button
                                className="btn btn-primary"
                                style={{ height: '42px', padding: '0 2rem' }}
                                onClick={handleLogPlay}
                                disabled={!selectedPlayId}
                            >
                                Log Play
                            </button>
                        </div>
                    </div>

                    {/* Formation Window - Draggable Defenders */}
                    <div className="card" style={{ padding: '1rem', height: '500px', display: 'flex', flexDirection: 'column' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                            <div>
                                <h3 style={{ margin: 0, fontSize: '1.1rem' }}>Formation: {selectedPlayId ? plays.find(p => p.id === selectedPlayId)?.formation || 'Unknown' : 'No Play Selected'}</h3>
                                {selectedPlayId && plays.find(p => p.id === selectedPlayId) && (
                                    <div style={{ fontSize: '0.9rem', color: 'var(--text-secondary)', marginTop: '0.25rem' }}>
                                        {plays.find(p => p.id === selectedPlayId).name}
                                    </div>
                                )}
                            </div>
                            <button
                                className="btn btn-secondary"
                                onClick={() => setDefenders(getDefaultDefenderPositions())}
                                style={{ fontSize: '0.8rem', padding: '0.25rem 0.75rem' }}
                            >
                                Reset Defense
                            </button>
                        </div>

                        {/* Football Field */}
                        <div
                            ref={fieldRef}
                            style={{
                                flex: 1,
                                background: 'linear-gradient(180deg, #2d5016 0%, #1a3d0a 100%)',
                                borderRadius: '8px',
                                border: '3px solid #fff',
                                position: 'relative',
                                overflow: 'hidden',
                                cursor: draggingDefender ? 'grabbing' : 'default'
                            }}
                            onMouseMove={(e) => {
                                if (!draggingDefender || !fieldRef.current) return;
                                const rect = fieldRef.current.getBoundingClientRect();
                                const x = ((e.clientX - rect.left) / rect.width) * 100;
                                const y = ((e.clientY - rect.top) / rect.height) * 100;
                                const constrainedX = Math.max(2, Math.min(98, x));
                                const constrainedY = Math.max(2, Math.min(98, y));
                                setDefenders(prev => prev.map(d =>
                                    d.id === draggingDefender ? { ...d, x: constrainedX, y: constrainedY } : d
                                ));
                            }}
                            onMouseUp={() => setDraggingDefender(null)}
                            onMouseLeave={() => setDraggingDefender(null)}
                        >
                            {/* Hash Marks */}
                            <div style={{ position: 'absolute', left: '30%', top: 0, bottom: 0, width: '2px', borderLeft: '2px dashed rgba(255,255,255,0.3)' }} />
                            <div style={{ position: 'absolute', left: '70%', top: 0, bottom: 0, width: '2px', borderLeft: '2px dashed rgba(255,255,255,0.3)' }} />

                            {/* Line of Scrimmage */}
                            <div style={{ position: 'absolute', left: 0, right: 0, top: '50%', height: '3px', background: '#fff', opacity: 0.8 }} />
                            <div style={{ position: 'absolute', left: '50%', top: '50%', transform: 'translate(-50%, -50%)', color: '#fff', fontSize: '0.7rem', fontWeight: 'bold', background: 'rgba(0,0,0,0.5)', padding: '2px 6px', borderRadius: '4px' }}>
                                LOS
                            </div>

                            {/* Yard Line Markers */}
                            {[0, 25, 50, 75, 100].map(pct => (
                                <div key={pct} style={{ position: 'absolute', left: 0, right: 0, top: `${pct}%`, height: '1px', background: 'rgba(255,255,255,0.15)' }} />
                            ))}

                            {/* Offensive Players */}
                            {(() => {
                                const selectedPlay = selectedPlayId ? plays.find(p => p.id === selectedPlayId) : null;
                                if (!selectedPlay) return null;

                                // Find formation from database
                                let formationData = null;
                                if (selectedPlay.formation) {
                                    // Try exact match first
                                    formationData = formations.find(f =>
                                        f.name.toLowerCase() === selectedPlay.formation.toLowerCase()
                                    );

                                    // If no exact match, try fuzzy match
                                    if (!formationData) {
                                        const formationLower = selectedPlay.formation.toLowerCase();
                                        formationData = formations.find(f =>
                                            formationLower.includes(f.name.toLowerCase()) ||
                                            f.name.toLowerCase().includes(formationLower)
                                        );
                                    }
                                }

                                // Use formation positions if found, otherwise fallback to default
                                if (formationData && formationData.positions) {
                                    return formationData.positions.map((pos, idx) => (
                                        <div key={`off-${idx}`} style={{ position: 'absolute', left: `${pos.x}%`, top: `${pos.y}%`, transform: 'translate(-50%, -50%)', width: '24px', height: '24px', borderRadius: '50%', background: '#3b82f6', border: '2px solid #fff', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '0.6rem', fontWeight: 'bold', color: '#fff', pointerEvents: 'none', userSelect: 'none' }}>
                                            {pos.label}
                                        </div>
                                    ));
                                } else {
                                    // Fallback to default spread formation
                                    const defaultPositions = [
                                        { label: 'LT', x: 35, y: 52 }, { label: 'LG', x: 42, y: 52 }, { label: 'C', x: 50, y: 52 },
                                        { label: 'RG', x: 58, y: 52 }, { label: 'RT', x: 65, y: 52 }, { label: 'QB', x: 50, y: 58 },
                                        { label: 'RB', x: 50, y: 65 }, { label: 'X', x: 10, y: 52 }, { label: 'Z', x: 90, y: 52 },
                                        { label: 'A', x: 70, y: 56 }, { label: 'Y', x: 30, y: 56 }
                                    ];
                                    return defaultPositions.map((pos, idx) => (
                                        <div key={`off-${idx}`} style={{ position: 'absolute', left: `${pos.x}%`, top: `${pos.y}%`, transform: 'translate(-50%, -50%)', width: '24px', height: '24px', borderRadius: '50%', background: '#3b82f6', border: '2px solid #fff', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '0.6rem', fontWeight: 'bold', color: '#fff', pointerEvents: 'none', userSelect: 'none' }}>
                                            {pos.label}
                                        </div>
                                    ));
                                }
                            })()}

                            {/* Defensive Players (Draggable) */}
                            {defenders.map(defender => (
                                <div
                                    key={defender.id}
                                    style={{ position: 'absolute', left: `${defender.x}%`, top: `${defender.y}%`, transform: 'translate(-50%, -50%)', width: '28px', height: '28px', borderRadius: '50%', background: draggingDefender === defender.id ? '#ef4444' : '#dc2626', border: '3px solid #fff', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '0.65rem', fontWeight: 'bold', color: '#fff', cursor: 'grab', userSelect: 'none', boxShadow: draggingDefender === defender.id ? '0 4px 12px rgba(0,0,0,0.4)' : '0 2px 4px rgba(0,0,0,0.2)', transition: draggingDefender === defender.id ? 'none' : 'all 0.1s ease', zIndex: draggingDefender === defender.id ? 1000 : 10 }}
                                    onMouseDown={(e) => { e.preventDefault(); setDraggingDefender(defender.id); }}
                                >
                                    {defender.label}
                                </div>
                            ))}

                            {/* Legend */}
                            <div style={{ position: 'absolute', bottom: '8px', left: '8px', background: 'rgba(0,0,0,0.7)', borderRadius: '6px', padding: '6px 10px', display: 'flex', gap: '12px', fontSize: '0.7rem', color: '#fff' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                    <div style={{ width: '12px', height: '12px', borderRadius: '50%', background: '#3b82f6', border: '1px solid #fff' }} />
                                    <span>Offense</span>
                                </div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                    <div style={{ width: '12px', height: '12px', borderRadius: '50%', background: '#dc2626', border: '1px solid #fff' }} />
                                    <span>Defense (Drag to Move)</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Penalty Tracking */}
                    <div className="card">
                        <div style={{ display: 'flex', alignItems: 'center', gap: '2rem' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                <input
                                    type="checkbox"
                                    id="penaltyActive"
                                    checked={penalty.active}
                                    onChange={e => setPenalty({ ...penalty, active: e.target.checked })}
                                    style={{ width: '20px', height: '20px', display: 'block' }}
                                />
                                <label htmlFor="penaltyActive" style={{ fontWeight: 'bold', color: penalty.active ? '#ef4444' : 'inherit' }}>
                                    FLAG ON PLAY?
                                </label>
                            </div>

                            {penalty.active && (
                                <>
                                    <div style={{ flex: 1 }}>
                                        <select
                                            className="form-select"
                                            value={penalty.playerId}
                                            onChange={e => setPenalty({ ...penalty, playerId: e.target.value })}
                                        >
                                            <option value="">-- Who Committed Penalty? --</option>
                                            {roster.sort((a, b) => a.name.localeCompare(b.name)).map(p => (
                                                <option key={p.id} value={p.id}>#{p.number} {p.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div style={{ flex: 1 }}>
                                        <select
                                            className="form-select"
                                            value={penalty.type}
                                            onChange={e => setPenalty({ ...penalty, type: e.target.value })}
                                        >
                                            <option value="">-- Penalty Type --</option>
                                            {PENALTY_TYPES.map(t => (
                                                <option key={t} value={t}>{t}</option>
                                            ))}
                                        </select>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>

                    {/* Injury Report */}
                    <div className="card" style={{ display: 'flex', gap: '1rem', alignItems: 'center', background: '#ffe4e6', border: '1px solid #f43f5e' }}>
                        <div style={{ fontWeight: 'bold', color: '#be123c', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                            <Icon name="Activity" size={20} />
                            Injury Report
                        </div>
                        <div style={{ flex: 1 }}>
                            <select
                                className="form-select"
                                value={injuredPlayerId}
                                onChange={e => setInjuredPlayerId(e.target.value)}
                                style={{ background: 'white', borderColor: '#fca5a5' }}
                            >
                                <option value="">-- Start Typing or Select Player --</option>
                                {roster.sort((a, b) => a.name.localeCompare(b.name)).map(p => (
                                    <option key={p.id} value={p.id}>{p.name} #{p.number}</option>
                                ))}
                            </select>
                        </div>
                        <button
                            className="btn"
                            onClick={reportInjury}
                            disabled={!injuredPlayerId}
                            style={{
                                background: '#e11d48', color: 'white', border: 'none', fontWeight: 'bold'
                            }}
                        >
                            Mark & Check Depth
                        </button>
                    </div>

                    {/* Game Log */}
                    <div style={{ flex: 1, overflowY: 'auto' }}>
                        <h3>Game Log</h3>
                        <table style={{ width: '100%', borderCollapse: 'collapse', marginTop: '0.5rem' }}>
                            <thead>
                                <tr style={{ borderBottom: '2px solid var(--border)', textAlign: 'left', color: 'var(--text-secondary)', fontSize: '0.9rem' }}>
                                    <th style={{ padding: '0.5rem' }}>Drive</th>
                                    <th style={{ padding: '0.5rem' }}>Sit</th>
                                    <th style={{ padding: '0.5rem' }}>Ball</th>
                                    <th style={{ padding: '0.5rem' }}>Hash</th>
                                    <th style={{ padding: '0.5rem' }}>Play Call</th>
                                    <th style={{ padding: '0.5rem' }}>Result</th>
                                </tr>
                            </thead>
                            <tbody>
                                {gameLog.map(entry => (
                                    <tr key={entry.id} style={{ borderBottom: '1px solid var(--border)' }}>
                                        <td style={{ padding: '0.75rem 0.5rem', color: 'var(--text-secondary)' }}>#{entry.situation.driveNumber}</td>
                                        <td style={{ padding: '0.75rem 0.5rem' }}>
                                            <span className="tag">{entry.situation.down} & {entry.situation.distance}</span>
                                        </td>
                                        <td style={{ padding: '0.75rem 0.5rem' }}>{formatYardLine(entry.situation.yardLine)}</td>
                                        <td style={{ padding: '0.75rem 0.5rem' }}>{entry.situation.hash}</td>
                                        <td style={{ padding: '0.75rem 0.5rem', fontWeight: 'bold' }}>
                                            {entry.play.formation} - {entry.play.name}
                                        </td>
                                        <td style={{ padding: '0.75rem 0.5rem' }}>
                                            <span style={{ color: entry.result.yards >= 0 ? '#10b981' : '#ef4444', fontWeight: 'bold' }}>
                                                {entry.result.yards > 0 ? '+' : ''}{entry.result.yards}
                                            </span>
                                            <span style={{ marginLeft: '0.5rem', color: 'var(--text-secondary)', fontSize: '0.9rem' }}>
                                                {entry.result.type}
                                                {entry.result.outcome !== 'Tackle' && ` - ${entry.result.outcome}`}
                                            </span>
                                            {entry.penalty && (
                                                <div style={{ color: '#ef4444', fontSize: '0.8rem', fontWeight: 'bold' }}>
                                                    FLAG: {entry.penalty.type}
                                                    {(() => {
                                                        const p = roster.find(r => r.id === entry.penalty.playerId);
                                                        return p ? ` (#${p.number} ${p.name})` : '';
                                                    })()}
                                                </div>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const FormationManager = ({ formations, onAddFormation, onUpdateFormation, onDeleteFormation }) => {
            const [selectedFormationId, setSelectedFormationId] = useState(null);
            const [editingFormation, setEditingFormation] = useState(null);
            const [isCreatingNew, setIsCreatingNew] = useState(false);
            const fieldRef = useRef(null);
            const [draggingPlayer, setDraggingPlayer] = useState(null);

            const handleStartNew = () => {
                setIsCreatingNew(true);
                setSelectedFormationId(null);
                setEditingFormation({
                    id: Date.now().toString(),
                    name: '',
                    description: '',
                    positions: [
                        { label: 'LT', x: 35, y: 52 }, { label: 'LG', x: 42, y: 52 }, { label: 'C', x: 50, y: 52 },
                        { label: 'RG', x: 58, y: 52 }, { label: 'RT', x: 65, y: 52 }, { label: 'QB', x: 50, y: 58 },
                        { label: 'RB', x: 50, y: 65 }, { label: 'X', x: 10, y: 52 }, { label: 'Z', x: 90, y: 52 },
                        { label: 'A', x: 70, y: 56 }, { label: 'Y', x: 30, y: 56 }
                    ]
                });
            };

            const handleSelectFormation = (formationId) => {
                const formation = formations.find(f => f.id === formationId);
                if (formation) {
                    setSelectedFormationId(formationId);
                    setEditingFormation(JSON.parse(JSON.stringify(formation)));
                    setIsCreatingNew(false);
                }
            };

            const handleSave = () => {
                if (!editingFormation.name.trim()) {
                    alert('Please enter a formation number/name');
                    return;
                }
                if (isCreatingNew) onAddFormation(editingFormation);
                else onUpdateFormation(editingFormation.id, editingFormation);
                setIsCreatingNew(false);
                setSelectedFormationId(editingFormation.id);
            };

            const handleDelete = () => {
                if (!selectedFormationId) return;
                if (confirm(`Delete formation "${editingFormation.name}"?`)) {
                    onDeleteFormation(selectedFormationId);
                    setSelectedFormationId(null);
                    setEditingFormation(null);
                }
            };

            return (
                <div style={{ height: 'calc(100vh - 100px)', display: 'flex', gap: '2rem' }}>
                    <div className="card" style={{ width: '300px', display: 'flex', flexDirection: 'column', padding: '0' }}>
                        <div style={{ padding: '1rem', borderBottom: '1px solid var(--border)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h3 style={{ margin: 0 }}>Formations</h3>
                            <button className="btn btn-primary" style={{ fontSize: '0.8rem', padding: '0.25rem 0.75rem' }} onClick={handleStartNew}>+ New</button>
                        </div>
                        <div style={{ flex: 1, overflowY: 'auto' }}>
                            {formations.map(formation => (
                                <div key={formation.id} onClick={() => handleSelectFormation(formation.id)} style={{ padding: '0.75rem 1rem', borderBottom: '1px solid var(--border)', cursor: 'pointer', background: selectedFormationId === formation.id ? 'var(--bg-body)' : 'transparent' }}>
                                    <div style={{ fontWeight: 'bold', fontSize: '1.1rem' }}>{formation.name}</div>
                                    {formation.description && <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', marginTop: '0.25rem' }}>{formation.description}</div>}
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="card" style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
                        {editingFormation ? (
                            <>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', paddingBottom: '1rem', borderBottom: '1px solid var(--border)' }}>
                                    <h2 style={{ margin: 0 }}>{isCreatingNew ? 'Create Formation' : 'Edit Formation'}</h2>
                                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                                        <button className="btn btn-secondary" onClick={() => { setIsCreatingNew(false); setEditingFormation(null); setSelectedFormationId(null); }}>Cancel</button>
                                        {!isCreatingNew && <button className="btn" style={{ background: '#ef4444', color: 'white', border: 'none' }} onClick={handleDelete}>Delete</button>}
                                        <button className="btn btn-primary" onClick={handleSave}>Save</button>
                                    </div>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 2fr', gap: '1rem', marginBottom: '1.5rem' }}>
                                    <div>
                                        <label className="form-label">Formation Number</label>
                                        <input type="text" className="form-input" value={editingFormation.name} onChange={e => setEditingFormation({ ...editingFormation, name: e.target.value })} placeholder="e.g., 887, 983" />
                                    </div>
                                    <div>
                                        <label className="form-label">Description</label>
                                        <input type="text" className="form-input" value={editingFormation.description} onChange={e => setEditingFormation({ ...editingFormation, description: e.target.value })} placeholder="e.g., Trips right" />
                                    </div>
                                </div>
                                <div style={{ flex: 1, minHeight: '400px' }}>
                                    <label className="form-label" style={{ marginBottom: '0.5rem', display: 'block' }}>Player Positions (Drag to Adjust)</label>
                                    <div ref={fieldRef} style={{ width: '100%', height: '100%', background: 'linear-gradient(180deg, #2d5016 0%, #1a3d0a 100%)', borderRadius: '8px', border: '3px solid #fff', position: 'relative', cursor: draggingPlayer !== null ? 'grabbing' : 'default' }} onMouseMove={(e) => { if (draggingPlayer === null || !fieldRef.current || !editingFormation) return; const rect = fieldRef.current.getBoundingClientRect(); const x = ((e.clientX - rect.left) / rect.width) * 100; const y = ((e.clientY - rect.top) / rect.height) * 100; setEditingFormation(prev => ({ ...prev, positions: prev.positions.map((p, idx) => idx === draggingPlayer ? { ...p, x: Math.max(2, Math.min(98, x)), y: Math.max(2, Math.min(98, y)) } : p) })); }} onMouseUp={() => setDraggingPlayer(null)} onMouseLeave={() => setDraggingPlayer(null)}>
                                        <div style={{ position: 'absolute', left: '30%', top: 0, bottom: 0, width: '2px', borderLeft: '2px dashed rgba(255,255,255,0.3)' }} />
                                        <div style={{ position: 'absolute', left: '70%', top: 0, bottom: 0, width: '2px', borderLeft: '2px dashed rgba(255,255,255,0.3)' }} />
                                        <div style={{ position: 'absolute', left: 0, right: 0, top: '50%', height: '3px', background: '#fff', opacity: 0.8 }} />
                                        <div style={{ position: 'absolute', left: '50%', top: '50%', transform: 'translate(-50%, -50%)', color: '#fff', fontSize: '0.7rem', fontWeight: 'bold', background: 'rgba(0,0,0,0.5)', padding: '2px 6px', borderRadius: '4px' }}>LOS</div>
                                        {[0, 25, 50, 75, 100].map(pct => <div key={pct} style={{ position: 'absolute', left: 0, right: 0, top: `${pct}%`, height: '1px', background: 'rgba(255,255,255,0.15)' }} />)}
                                        {editingFormation.positions.map((pos, idx) => (
                                            <div key={idx} style={{ position: 'absolute', left: `${pos.x}%`, top: `${pos.y}%`, transform: 'translate(-50%, -50%)', width: '32px', height: '32px', borderRadius: '50%', background: draggingPlayer === idx ? '#60a5fa' : '#3b82f6', border: '3px solid #fff', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '0.7rem', fontWeight: 'bold', color: '#fff', cursor: 'grab', userSelect: 'none', boxShadow: draggingPlayer === idx ? '0 4px 12px rgba(0,0,0,0.4)' : '0 2px 4px rgba(0,0,0,0.2)', transition: draggingPlayer === idx ? 'none' : 'all 0.1s ease', zIndex: draggingPlayer === idx ? 1000 : 10 }} onMouseDown={(e) => { e.preventDefault(); setDraggingPlayer(idx); }}>{pos.label}</div>
                                        ))}
                                        <div style={{ position: 'absolute', bottom: '8px', left: '8px', background: 'rgba(0,0,0,0.7)', borderRadius: '6px', padding: '6px 10px', fontSize: '0.7rem', color: '#fff' }}>üí° Drag players to position</div>
                                    </div>
                                </div>
                            </>
                        ) : (
                            <div style={{ flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'var(--text-secondary)', flexDirection: 'column' }}>
                                <Icon name="Grid" size={48} />
                                <p style={{ marginTop: '1rem', fontSize: '1.1rem' }}>Select a formation or create a new one</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const UserGuide = () => {
            return (
                <div className="card" style={{ padding: '2rem', maxWidth: '800px', margin: '0 auto' }}>
                    <h1 style={{ marginBottom: '2rem' }}><Icon name="HelpCircle" size={32} /> User Guide</h1>

                    <section style={{ marginBottom: '3rem' }}>
                        <h2 style={{ color: 'var(--accent)', borderBottom: '1px solid var(--border)', paddingBottom: '0.5rem' }}>Head Coach Usage</h2>
                        <ul style={{ lineHeight: '1.6', fontSize: '1.1rem', color: 'var(--text-secondary)' }}>
                            <li><strong>Staff Management:</strong> Use "Task Assigner" and "Staff & Roles" to delegate responsibilities to your assistants.</li>
                            <li><strong>Weekly Schedule:</strong> Monitor the "Active Week" timeline to ensure the team is on track for the upcoming opponent.</li>
                            <li><strong>Travel & Logistics:</strong> Use the "Travel Roster" to manage personnel for away games.</li>
                            <li><strong>Oversight:</strong> View all depth charts and practice plans to ensure alignment with team goals.</li>
                        </ul>
                    </section>

                    <section style={{ marginBottom: '3rem' }}>
                        <h2 style={{ color: 'var(--accent)', borderBottom: '1px solid var(--border)', paddingBottom: '0.5rem' }}>Offensive Coordinator Usage</h2>
                        <ul style={{ lineHeight: '1.6', fontSize: '1.1rem', color: 'var(--text-secondary)' }}>
                            <li><strong>Playbook:</strong> Add and organize plays with tags (Formation, Concept, Situation). Use batch delete to clean up old plays.</li>
                            <li><strong>Game Planning:</strong> Build your "Smart Call Sheet" by tagging plays with specific situations (e.g., "3rd & Long").</li>
                            <li><strong>Practice Scripts:</strong> Generate scripts based on your installed playbook and daily focus.</li>
                            <li><strong>In-Game:</strong> Use the "OC Call Sheet" on the tablet app for real-time play calling and tracking.</li>
                        </ul>
                    </section>

                    <section style={{ marginBottom: '3rem' }}>
                        <h2 style={{ color: 'var(--accent)', borderBottom: '1px solid var(--border)', paddingBottom: '0.5rem' }}>Position Coach Usage</h2>
                        <ul style={{ lineHeight: '1.6', fontSize: '1.1rem', color: 'var(--text-secondary)' }}>
                            <li><strong>Depth Charts:</strong> Manage rotation and depth for your specific unit (Varsity, JV, etc.).</li>
                            <li><strong>Player Development:</strong> Track "Iron Man" stats and "Testing" results for your position group.</li>
                            <li><strong>Equipment:</strong> Manage "Checkouts" and "Inventory" for your specific position needs.</li>
                        </ul>
                    </section>
                </div>
            );
        };

        const TestingRecords = () => {
            const [selectedGrade, setSelectedGrade] = useState('12'); // Default to Senior

            // Generate Weight Classes: 100 to 320 in 10lb increments
            const weightClasses = [];
            weightClasses.push('< 100');
            for (let i = 100; i < 320; i += 10) {
                weightClasses.push(`${i}-${i + 9}`);
            }
            weightClasses.push('320+');

            // Mock Data Helper
            const getRecord = (grade, weightClass, test) => {
                // Mock Data for demonstration
                if (weightClass === '180-189' && test === 'Bench' && grade === '12') return { value: '315', holder: 'M. Finn', year: '2015' };
                if (weightClass === '220-229' && test === 'Squat' && grade === '12') return { value: '500', holder: 'B. Baker', year: '2023' };
                if (weightClass === '160-169' && test === '40 Yard' && grade === '11') return { value: '4.42', holder: 'T. Speed', year: '2024' };
                if (weightClass === '140-149' && test === 'Vertical' && grade === '10') return { value: '34"', holder: 'J. Jump', year: '2024' };

                return { value: '--', holder: '-', year: '-' };
            };

            const events = ['Bench', 'Squat', 'Clean', '40 Yard', 'Vertical'];

            return (
                <div className="card" style={{ padding: '2rem', height: '100%', overflowY: 'auto' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
                        <h1 style={{ display: 'flex', alignItems: 'center', gap: '1rem', fontSize: '1.5rem', margin: 0 }}>
                            <Icon name="Award" size={28} color="var(--accent)" />
                            Testing Records
                        </h1>

                        <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                            <label style={{ fontWeight: 'bold' }}>Grade Level:</label>
                            <select
                                className="form-select"
                                value={selectedGrade}
                                onChange={(e) => setSelectedGrade(e.target.value)}
                                style={{ width: '150px' }}
                            >
                                <option value="9">Freshman</option>
                                <option value="10">Sophomore</option>
                                <option value="11">Junior</option>
                                <option value="12">Senior</option>
                            </select>
                        </div>
                    </div>

                    <div style={{ overflowX: 'auto' }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '0.9rem', minWidth: '800px' }}>
                            <thead>
                                <tr style={{ backgroundColor: 'rgba(255,255,255,0.05)' }}>
                                    <th style={{ textAlign: 'left', padding: '1rem', borderBottom: '2px solid var(--border)', color: 'var(--text-secondary)' }}>Weight Class (lbs)</th>
                                    {events.map(evt => (
                                        <th key={evt} style={{ textAlign: 'center', padding: '1rem', borderBottom: '2px solid var(--border)', color: 'var(--text-secondary)' }}>{evt}</th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {weightClasses.map((wc, idx) => (
                                    <tr key={wc} style={{ borderBottom: '1px solid rgba(255,255,255,0.05)', backgroundColor: idx % 2 === 0 ? 'transparent' : 'rgba(255,255,255,0.02)' }}>
                                        <td style={{ padding: '1rem', fontWeight: 'bold', color: 'var(--accent)' }}>{wc}</td>
                                        {events.map(evt => {
                                            const record = getRecord(selectedGrade, wc, evt);
                                            return (
                                                <td key={evt} style={{ padding: '0.75rem', textAlign: 'center' }}>
                                                    {record.value !== '--' ? (
                                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>
                                                            <span style={{ fontWeight: 'bold', fontSize: '1.1rem', color: '#fff' }}>{record.value}</span>
                                                            <span style={{ fontSize: '0.8rem', color: 'var(--accent)' }}>{record.holder}</span>
                                                            <span style={{ fontSize: '0.7rem', color: 'var(--text-secondary)' }}>{record.year}</span>
                                                        </div>
                                                    ) : (
                                                        <span style={{ opacity: 0.1, fontSize: '1.2rem' }}>‚Äî</span>
                                                    )}
                                                </td>
                                            );
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const Settings = ({ teamLogo, onUpdateLogo, accentColor, onUpdateAccentColor, positionNames, onUpdatePositionNames, onImportData, onExportData, onImportDefaultData }) => {
            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        onUpdateLogo(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const PRESET_COLORS = [
                '#1e3a8a', // Navy
                '#1d4ed8', // Royal Blue
                '#60a5fa', // Light Blue (Columbia)
                '#b91c1c', // Crimson
                '#dc2626', // Red
                '#c2410c', // Burnt Orange
                '#ea580c', // Orange
                '#ca8a04', // Gold
                '#15803d', // Forest Green
                '#16a34a', // Kelly Green
                '#7e22ce', // Purple
                '#475569', // Silver/Grey
                '#000000', // Black
            ];

            return (
                <div style={{ height: 'calc(100vh - 100px)', display: 'flex', flexDirection: 'column', gap: '2rem' }}>
                    <h2>Settings</h2>

                    <div className="card">
                        <h3>Team Branding</h3>
                        <p style={{ color: 'var(--text-secondary)', marginBottom: '1rem' }}>Upload your team logo to appear on printed documents.</p>

                        <div style={{ display: 'flex', alignItems: 'center', gap: '2rem' }}>
                            <div style={{
                                width: '100px',
                                height: '100px',
                                border: '2px dashed var(--border)',
                                borderRadius: '8px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                overflow: 'hidden',
                                background: 'var(--surface)'
                            }}>
                                {teamLogo ? (
                                    <img src={teamLogo} alt="Team Logo" style={{ maxWidth: '100%', maxHeight: '100%' }} />
                                ) : (
                                    <span style={{ fontSize: '2rem' }}>üõ°Ô∏è</span>
                                )}
                            </div>
                            <div>
                                <input
                                    type="file"
                                    accept="image/*"
                                    onChange={handleImageUpload}
                                    style={{ marginBottom: '0.5rem' }}
                                />
                                {teamLogo && (
                                    <button
                                        className="btn"
                                        style={{ color: '#ef4444', display: 'block' }}
                                        onClick={() => onUpdateLogo(null)}
                                    >
                                        Remove Logo
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="card">
                        <h3>Position Names</h3>
                        <p style={{ color: 'var(--text-secondary)', marginBottom: '1rem' }}>Customize position labels for your offense.</p>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(150px, 1fr))', gap: '1rem' }}>
                            {[
                                { key: 'X', default: 'X', description: 'Left WR' },
                                { key: 'Z', default: 'Z', description: 'Right WR' },
                                { key: 'A', default: 'A', description: 'Slot WR' },
                                { key: 'Y', default: 'Y', description: 'Tight End' },
                                { key: 'QB', default: 'QB', description: 'Quarterback' },
                                { key: 'RB', default: 'RB', description: 'Running Back' },
                                { key: 'LT', default: 'LT', description: 'Left Tackle' },
                                { key: 'LG', default: 'LG', description: 'Left Guard' },
                                { key: 'C', default: 'C', description: 'Center' },
                                { key: 'RG', default: 'RG', description: 'Right Guard' },
                                { key: 'RT', default: 'RT', description: 'Right Tackle' },
                            ].map(pos => (
                                <div key={pos.key}>
                                    <label className="form-label" style={{ fontSize: '0.75rem' }}>{pos.description}</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={positionNames[pos.key] || pos.default}
                                        onChange={(e) => onUpdatePositionNames({ ...positionNames, [pos.key]: e.target.value.toUpperCase().slice(0, 3) })}
                                        placeholder={pos.default}
                                        maxLength="3"
                                        style={{ padding: '0.25rem 0.5rem', fontSize: '0.85rem' }}
                                        title={`Customize ${pos.description} label`}
                                    />
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="card">
                        <h3>Team Colors</h3>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem', marginTop: '1rem' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                                <input
                                    type="color"
                                    value={accentColor || '#38bdf8'}
                                    onChange={(e) => onUpdateAccentColor(e.target.value)}
                                    style={{ width: '50px', height: '50px', padding: '0', border: 'none', borderRadius: '4px', cursor: 'pointer', background: 'none' }}
                                />
                                <div>
                                    <div style={{ fontWeight: 'bold' }}>Accent Color</div>
                                    <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>Primary color for buttons, active states, and highlights.</div>
                                </div>
                            </div>

                            <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                                {PRESET_COLORS.map(color => (
                                    <button
                                        key={color}
                                        onClick={() => onUpdateAccentColor(color)}
                                        style={{
                                            width: '32px',
                                            height: '32px',
                                            borderRadius: '50%',
                                            backgroundColor: color,
                                            border: accentColor === color ? '2px solid white' : '2px solid transparent',
                                            boxShadow: accentColor === color ? '0 0 0 2px var(--accent)' : 'none',
                                            cursor: 'pointer'
                                        }}
                                        title={color}
                                    />
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="card">
                        <h3>Data Management</h3>
                        <p style={{ color: 'var(--text-secondary)', marginBottom: '1rem' }}>Backup your data or move it to another device.</p>

                        <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap' }}>
                            <button className="btn btn-primary" onClick={onExportData}>
                                üì• Export Data Backup
                            </button>
                            <label className="btn btn-secondary" style={{ cursor: 'pointer' }}>
                                üì§ Import Data
                                <input
                                    type="file"
                                    accept=".json"
                                    style={{ display: 'none' }}
                                    onChange={onImportData}
                                />
                            </label>
                            <button className="btn" style={{ background: '#059669', color: 'white' }} onClick={onImportDefaultData}>
                                üîÑ Load 2025 Roster/Staff
                            </button>
                        </div>
                    </div>
                </div>
            );
        };


        const MetricGraph = ({ history, field }) => {
            if (!history || history.length < 2) return null;

            const sortedHistory = [...history].sort((a, b) => new Date(a.date) - new Date(b.date));
            const dataPoints = sortedHistory.filter(h => h[field.id]).map(h => ({
                date: h.date,
                value: parseFloat(h[field.id])
            }));

            if (dataPoints.length < 2) return null;

            const width = 600;
            const height = 300;
            const padding = 40;

            const minVal = Math.min(...dataPoints.map(d => d.value));
            const maxVal = Math.max(...dataPoints.map(d => d.value));
            const range = maxVal - minVal || 1; // Prevent div by zero

            // Calculate coordinates
            const points = dataPoints.map((d, i) => {
                const x = padding + (i / (dataPoints.length - 1)) * (width - 2 * padding);
                // Lower value is better for timed events (40yd), Higher is better for others
                const isTimed = ['forty', 'flying10', 'proAgility'].includes(field.id);

                let yRatio;
                if (isTimed) {
                    // Invert: Max value (slowest) at bottom (height-padding), Min value (fastest) at top (padding)
                    yRatio = (d.value - minVal) / range;
                    // actually for SVG y=0 is top. So we want Min (Fast) at Top (0+padding), Max (Slow) at Bottom.
                    // y = padding + yRatio * height -> if yRatio is 0 (min), y=padding. Correct.
                    // Wait, if d.value = minVal (Fastest), yRatio = 0. y = padding.
                    // If d.value = maxVal (Slowest), yRatio = 1. y = height-padding. 
                } else {
                    // Normal: Max value (Strongest) at Top, Min at Bottom
                    // yRatio = 1 is Max. We want Max at padding. 
                    yRatio = 1 - ((d.value - minVal) / range);
                }

                const y = padding + yRatio * (height - 2 * padding);
                return { x, y, value: d.value, date: d.date };
            });

            return (
                <div style={{ marginTop: '2rem', border: '1px solid var(--border)', borderRadius: '8px', padding: '1rem', background: 'var(--bg-body)' }}>
                    <h4 style={{ textAlign: 'center', marginBottom: '1rem' }}>Progress: {field.name}</h4>
                    <svg width="100%" height="100%" viewBox={`0 0 ${width} ${height}`} style={{ overflow: 'visible' }}>
                        {/* Grid Lines */}
                        {[0, 0.25, 0.5, 0.75, 1].map(r => (
                            <line
                                key={r}
                                x1={padding}
                                y1={padding + r * (height - 2 * padding)}
                                x2={width - padding}
                                y2={padding + r * (height - 2 * padding)}
                                stroke="var(--border)"
                                strokeWidth="1"
                            />
                        ))}

                        {/* Line */}
                        <polyline
                            points={points.map(p => `${p.x},${p.y}`).join(' ')}
                            fill="none"
                            stroke="var(--accent)"
                            strokeWidth="2"
                        />
                        {/* Points */}
                        {points.map((p, i) => (
                            <g key={i}>
                                <circle cx={p.x} cy={p.y} r="5" fill="var(--bg-body)" stroke="var(--accent)" strokeWidth="2" />
                                <text x={p.x} y={p.y - 10} textAnchor="middle" fill="var(--text-primary)" fontSize="12">{p.value}</text>
                                <text x={p.x} y={height - 10} textAnchor="middle" fill="var(--text-secondary)" fontSize="10">{p.date}</text>
                            </g>
                        ))}
                    </svg>
                </div>
            );
        };


        const SmartCallSheet = ({ gamePlan, situation, plays, onUpdateSituation, zonePhilosophies, onUpdatePhilosophy, onUpdateGamePlan, onQuickAddPlay }) => {
            const [selectedSection, setSelectedSection] = useState(null); // null = main menu, otherwise section key
            const [selectedHash, setSelectedHash] = useState('left'); // For opening script submenu
            const [selected2MinCategory, setSelected2MinCategory] = useState('oob_yac'); // For 2-minute submenu
            const [selectedOneWordCategory, setSelectedOneWordCategory] = useState('form_adj'); // For one-word submenu
            const [selected2ndXLHash, setSelected2ndXLHash] = useState('lh'); // For 1st/2nd & XL submenu
            const [selectedConvertShortMed, setSelectedConvertShortMed] = useState('short'); // For Convert Short/Med submenu
            const [selectedConvertLongXL, setSelectedConvertLongXL] = useState('long'); // For Convert L/XL submenu
            const [viewMode, setViewMode] = useState('situations'); // 'situations', 'matrix', or 'player_touches'

            // Game Plan 2.0 State
            const [gamePlanMode, setGamePlanMode] = useState('full'); // 'guided' or 'full'
            const [currentPhase, setCurrentPhase] = useState(1); // 1-5
            const [currentSituationInPhase, setCurrentSituationInPhase] = useState(0); // Index within phase

            // In-Game Script Builder State
            const [isBuildingScript, setIsBuildingScript] = useState(false);
            const [currentScriptPlays, setCurrentScriptPlays] = useState([]);
            const [scriptName, setScriptName] = useState('');

            // Helper to add play to current building script
            const addToScript = (play) => {
                if (!isBuildingScript) return false;
                setCurrentScriptPlays(prev => [...prev, play]);
                return true;
            };

            // Save in-game script
            const saveInGameScript = () => {
                if (!scriptName || currentScriptPlays.length === 0) return;
                const newScript = {
                    id: `ms_ig_${Date.now()}`,
                    name: scriptName,
                    playIds: currentScriptPlays.map(p => p.id),
                    color: '#f43f5e' // Rose color for in-game scripts
                };

                // Update game plan via prop
                const newGamePlan = {
                    ...gamePlan,
                    miniScripts: [...(gamePlan.miniScripts || []), newScript]
                };
                // Assuming onUpdateSituation can propagate this up or we need onUpdateGamePlan passed down?
                // SmartCallSheet only has onUpdateSituation, we need onUpdateGamePlan or similar.
                // The prompt for SmartCallSheet props earlier showed it didn't have onUpdateGamePlan.
                // But we can check if it was added. If not, we might need to add it. 
                // Wait, I see gamePlan prop. But onUpdateGamePlan? 
                // Let's check props. 
                // Lines 11555 showed: <SmartCallSheet gamePlan=... onUpdateSituation=... zonePhilosophies=... onUpdatePhilosophy=... />
                // It does NOT have onUpdateGamePlan. I need to add that prop.
            };

            // Quick add play to a set
            const handleQuickAddToSet = (setId, playName) => {
                if (!playName.trim() || !onQuickAddPlay) return;

                // Create the incomplete play
                const newPlay = onQuickAddPlay(playName);

                // Add to the set
                const updatedSets = [...(gamePlan.sets || [])];
                const setIndex = updatedSets.findIndex(s => s.id === setId);

                if (setIndex >= 0) {
                    updatedSets[setIndex] = {
                        ...updatedSets[setIndex],
                        playIds: [...(updatedSets[setIndex].playIds || []), newPlay.id]
                    };
                } else {
                    // Create new set if it doesn't exist
                    updatedSets.push({
                        id: setId,
                        playIds: [newPlay.id]
                    });
                }

                onUpdateGamePlan({
                    ...gamePlan,
                    sets: updatedSets
                });
            };

            // Define all game plan sections - ORGANIZED BY CATEGORY
            const gamePlanSections = [
                // MINI SCRIPTS (Dynamic)
                ...((gamePlan.miniScripts || []).length > 0 ? [
                    { type: 'header', label: 'MINI SCRIPTS' },
                    ...(gamePlan.miniScripts || []).map(ms => ({
                        key: ms.id,
                        label: ms.name,
                        color: ms.color,
                        icon: 'FileText'
                    }))
                ] : []),

                // SCRIPTS & SERIES
                { type: 'header', label: 'SCRIPTS & SERIES' },
                { key: 'opening_script', label: 'üé¨ OPENING SCRIPT', color: '#10b981', icon: 'Play', hasSubmenu: true },
                { key: 'mini_script_1', label: 'üìù MINI SCRIPT 1', color: '#06b6d4', icon: 'FileText' },
                { key: 'mini_script_2', label: 'üìù MINI SCRIPT 2', color: '#06b6d4', icon: 'FileText' },
                { key: 'second_half_openers', label: 'üîÑ SECOND HALF OPENERS', color: '#f97316', icon: 'RefreshCw' },


                // DOWN & DISTANCE
                { type: 'header', label: 'Down and Distance' },
                { key: 'p_and_10', label: 'P&10', color: '#ef4444', icon: 'AlertCircle' },
                { key: 'base_downs', label: 'üìä BASE DOWNS', color: '#14b8a6', icon: 'BarChart2' },
                { key: '2nd_xl', label: 'GET HALF', color: '#3b82f6', icon: 'TrendingDown', hasSubmenu: true },
                { key: 'convert_short_med', label: 'üéØ CONVERT SHORT/MED', color: '#10b981', icon: 'Target', hasSubmenu: true },
                { key: 'convert_long_xl', label: 'üéØ CONVERT L/XL 7-12+', color: '#059669', icon: 'Crosshair', hasSubmenu: true },

                // FIELD ZONES
                { type: 'header', label: 'FIELD ZONES' },
                { key: 'backed_up', label: 'BACKED UP', color: '#1f2937', icon: 'AlertTriangle' },
                { key: 'coming_out', label: 'COMING OUT', color: '#6b7280', icon: 'TrendingUp' },
                { key: 'open_field', label: 'OPEN FIELD', color: '#16a34a', icon: 'Maximize2' },
                { key: 'fringe', label: 'FRINGE (+45-25)', color: '#f97316', icon: 'Navigation' },
                { key: 'high_red', label: 'HIGH RED (25-15)', color: '#ef4444', icon: 'Flag' },
                { key: 'low_red', label: 'LOW RED (15-6)', color: '#eab308', icon: 'Flag' },
                { key: 'goal_line', label: 'GOAL LINE (5-GL)', color: '#3b82f6', icon: 'Award' },

                // GAME SITUATIONS
                { type: 'header', label: 'GAME SITUATIONS' },
                { key: 'two_minute', label: '2-MINUTE', color: '#8b5cf6', icon: 'Zap', hasSubmenu: true },
                { key: 'two_point', label: '2-POINT', color: '#8b5cf6', icon: 'Star' },
                { key: 'four_minute', label: '4-MINUTE', color: '#8b5cf6', icon: 'Timer' }
            ];

            // Formation groups for matrix view
            const formationGroups = [
                { id: 'one_word', label: '1 WORD', color: '#f59e0b', icon: 'Hash', hasSubmenu: true },
                { id: '887', label: '887', color: '#ef4444', icon: 'Grid' },
                { id: '888', label: '888', color: '#ef4444', icon: 'Grid' },
                { id: '687', label: '687', color: '#fbbf24', icon: 'Grid' },
                { id: '688', label: '688', color: '#fbbf24', icon: 'Grid' },
                { id: '881', label: '881', color: '#facc15', icon: 'Grid' },
                { id: '984', label: '984', color: '#4ade80', icon: 'Grid' },
                { id: '983', label: '983', color: '#4ade80', icon: 'Grid' },
                { id: '488', label: '488', color: '#60a5fa', icon: 'Grid' },
                { id: '487', label: '487', color: '#60a5fa', icon: 'Grid' }
            ];

            // Play Type groups
            const playTypeGroups = [
                { id: 'Tank Runs', label: 'TANK RUNS', color: '#16a34a', icon: 'ChevronsRight' },
                { id: 'Perimeter Runs', label: 'PERIMETER RUNS', color: '#0ea5e9', icon: 'CornerUpRight' },
                { id: 'FLOW RPOS', label: 'FLOW RPOS', color: '#eab308', icon: 'Shuffle' },
                { id: 'FIT RPOS', label: 'FIT RPOS', color: '#f59e0b', icon: 'Target' },
                { id: 'Quick', label: 'QUICK GAME', color: '#8b5cf6', icon: 'Zap' },
                { id: 'Intermediate', label: 'INTERMEDIATE', color: '#d946ef', icon: 'Activity' },
                { id: 'PAP', label: 'PAP', color: '#ec4899', icon: 'PlayCircle' },
                { id: 'MOVEMENT', label: 'MOVEMENT', color: '#f43f5e', icon: 'Move' },
                { id: 'Deep', label: 'DEEP SHOTS', color: '#ef4444', icon: 'ArrowUpCircle' },
                { id: 'GADGET', label: 'GADGET', color: '#64748b', icon: 'Star' }
            ];

            // Get plays for selected section
            const getSectionPlays = () => {
                if (!selectedSection) return [];

                // Special handling for opening script with hash submenu
                if (selectedSection === 'opening_script') {
                    const setId = selectedHash === 'left' ? '1st_ten_lh' : '1st_ten_rh';
                    const sectionPlayIds = (gamePlan.sets || []).find(s => s.id === setId)?.playIds || [];
                    return sectionPlayIds.map(id => plays.find(p => p.id === id)).filter(Boolean);
                }

                // Special handling for 2-minute drill with category submenu
                if (selectedSection === 'two_minute') {
                    const setId = `two_minute_${selected2MinCategory}`;
                    const sectionPlayIds = (gamePlan.sets || []).find(s => s.id === setId)?.playIds || [];
                    return sectionPlayIds.map(id => plays.find(p => p.id === id)).filter(Boolean);
                }

                // Special handling for one_word in Strike 'Em Out view with category submenu
                if (selectedSection === 'one_word') {
                    const setId = selectedOneWordCategory; // 'form_adj', 'motion', or 'tag'
                    const sectionPlayIds = (gamePlan.sets || []).find(s => s.id === setId)?.playIds || [];
                    return sectionPlayIds.map(id => plays.find(p => p.id === id)).filter(Boolean);
                }

                // Special handling for 2nd_xl with hash submenu
                if (selectedSection === '2nd_xl') {
                    const setId = selected2ndXLHash === 'lh' ? '2nd_xl_lh' : '2nd_xl_rh';
                    const sectionPlayIds = (gamePlan.sets || []).find(s => s.id === setId)?.playIds || [];
                    return sectionPlayIds.map(id => plays.find(p => p.id === id)).filter(Boolean);
                }

                // Special handling for convert_short_med with distance submenu
                if (selectedSection === 'convert_short_med') {
                    const setId = selectedConvertShortMed === 'short' ? '3rd_short' : '3rd_med';
                    const sectionPlayIds = (gamePlan.sets || []).find(s => s.id === setId)?.playIds || [];
                    return sectionPlayIds.map(id => plays.find(p => p.id === id)).filter(Boolean);
                }

                // Special handling for convert_long_xl with distance submenu
                if (selectedSection === 'convert_long_xl') {
                    const setId = selectedConvertLongXL === 'long' ? '3rd_long' : '3rd_xl';
                    const sectionPlayIds = (gamePlan.sets || []).find(s => s.id === setId)?.playIds || [];
                    return sectionPlayIds.map(id => plays.find(p => p.id === id)).filter(Boolean);
                }

                // Check if this is a Play Type
                const isPlayType = playTypeGroups.some(pt => pt.id === selectedSection);
                if (isPlayType) {
                    return plays.filter(p => {
                        const allPlayTags = [...(p.tags || []), p.tag1, p.tag2].filter(Boolean);
                        return allPlayTags.includes(selectedSection);
                    });
                }

                // Check if this is a formation from Strike 'Em Out view
                const isFormation = formationGroups.some(f => f.id === selectedSection);
                if (isFormation) {
                    return plays.filter(p => p.formation && p.formation.includes(selectedSection));
                }

                const sectionPlayIds = (gamePlan.sets || []).find(s => s.id === selectedSection)?.playIds || [];
                // Check mini scripts if not found in sets
                if (sectionPlayIds.length === 0 && selectedSection.startsWith('ms_')) {
                    const script = (gamePlan.miniScripts || []).find(s => s.id === selectedSection);
                    if (script) {
                        return script.playIds.map(id => plays.find(p => p.id === id)).filter(Boolean);
                    }
                }
                return sectionPlayIds.map(id => plays.find(p => p.id === id)).filter(Boolean);
            };

            const sectionPlays = getSectionPlays();

            // Main Menu View
            if (!selectedSection) {
                return (
                    <div style={{ height: 'calc(100vh - 100px)', display: 'flex', flexDirection: 'column', gap: '1.5rem', padding: '1rem' }}>
                        <div style={{ textAlign: 'center' }}>
                            <h2 style={{ margin: 0, marginBottom: '0.5rem' }}>Smart Call Sheet</h2>

                            {/* View Toggle Buttons */}
                            <div style={{ display: 'flex', gap: '1rem', justifyContent: 'center', marginTop: '1rem' }}>
                                <button
                                    onClick={() => setViewMode('matrix')}
                                    className="btn"
                                    style={{
                                        background: viewMode === 'matrix' ? 'var(--accent)' : 'var(--bg-card)',
                                        color: viewMode === 'matrix' ? 'white' : 'var(--text-primary)',
                                        border: viewMode === 'matrix' ? 'none' : '2px solid var(--border)',
                                        fontWeight: 'bold',
                                        padding: '0.75rem 2rem',
                                        fontSize: '1rem'
                                    }}
                                >
                                    ‚öæ STRIKE 'EM OUT
                                </button>
                                <button
                                    onClick={() => setViewMode('situations')}
                                    className="btn"
                                    style={{
                                        background: viewMode === 'situations' ? 'var(--accent)' : 'var(--bg-card)',
                                        color: viewMode === 'situations' ? 'white' : 'var(--text-primary)',
                                        border: viewMode === 'situations' ? 'none' : '2px solid var(--border)',
                                        fontWeight: 'bold',
                                        padding: '0.75rem 2rem',
                                        fontSize: '1rem'
                                    }}
                                >
                                    üìã SITUATIONS
                                </button>
                                <button
                                    onClick={() => setViewMode('play_type')}
                                    className="btn"
                                    style={{
                                        background: viewMode === 'play_type' ? 'var(--accent)' : 'var(--bg-card)',
                                        color: viewMode === 'play_type' ? 'white' : 'var(--text-primary)',
                                        border: viewMode === 'play_type' ? 'none' : '2px solid var(--border)',
                                        fontWeight: 'bold',
                                        padding: '0.75rem 2rem',
                                        fontSize: '1rem'
                                    }}
                                >
                                    üéØ PLAY TYPE
                                </button>
                                <button
                                    onClick={() => setViewMode('player_touches')}
                                    className="btn"
                                    style={{
                                        background: viewMode === 'player_touches' ? 'var(--accent)' : 'var(--bg-card)',
                                        color: viewMode === 'player_touches' ? 'white' : 'var(--text-primary)',
                                        border: viewMode === 'player_touches' ? 'none' : '2px solid var(--border)',
                                        fontWeight: 'bold',
                                        padding: '0.75rem 2rem',
                                        fontSize: '1rem'
                                    }}
                                >
                                    üëê PLAYER TOUCHES
                                </button>
                            </div>

                            <p style={{ color: 'var(--text-secondary)', fontSize: '0.9rem', marginTop: '0.5rem' }}>
                                {viewMode === 'situations' ? 'Select a game situation to view plays' : viewMode === 'play_type' ? 'View plays organized by play type' : viewMode === 'player_touches' ? 'Manage plays designed to get the ball to key players' : 'View plays organized by formation'}
                            </p>
                        </div>

                        {viewMode === 'situations' ? (
                            // Situations View - organized with section headers
                            <div style={{
                                overflowY: 'auto',
                                flex: 1,
                                display: 'flex',
                                flexDirection: 'column',
                                gap: '2rem'
                            }}>
                                {(() => {
                                    const groupedSections = [];
                                    let currentGroup = { header: null, items: [] };

                                    gamePlanSections.forEach(section => {
                                        if (section.type === 'header') {
                                            if (currentGroup.items.length > 0) {
                                                groupedSections.push(currentGroup);
                                            }
                                            currentGroup = { header: section.label, items: [] };
                                        } else {
                                            currentGroup.items.push(section);
                                        }
                                    });

                                    if (currentGroup.items.length > 0) {
                                        groupedSections.push(currentGroup);
                                    }

                                    return groupedSections.map((group, groupIdx) => (
                                        <div key={groupIdx}>
                                            {/* Section Header */}
                                            <div style={{
                                                fontSize: '1.1rem',
                                                fontWeight: 'bold',
                                                color: 'var(--accent)',
                                                marginBottom: '1rem',
                                                paddingBottom: '0.5rem',
                                                borderBottom: '2px solid var(--accent)',
                                                textAlign: 'center'
                                            }}>
                                                {group.header}
                                            </div>

                                            {/* Buttons Grid */}
                                            <div style={{
                                                display: 'grid',
                                                gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))',
                                                gap: '1rem'
                                            }}>
                                                {group.items.map(section => {
                                                    // For opening script, combine LH and RH counts
                                                    let playCount = 0;
                                                    if (section.key === 'opening_script') {
                                                        playCount = ((gamePlan.sets || []).find(s => s.id === '1st_ten_lh')?.playIds?.length || 0) +
                                                            ((gamePlan.sets || []).find(s => s.id === '1st_ten_rh')?.playIds?.length || 0);
                                                    } else if (section.key === '2nd_xl') {
                                                        // For 1st/2nd & XL, combine LH and RH counts
                                                        playCount = ((gamePlan.sets || []).find(s => s.id === '2nd_xl_lh')?.playIds?.length || 0) +
                                                            ((gamePlan.sets || []).find(s => s.id === '2nd_xl_rh')?.playIds?.length || 0);
                                                    } else if (section.key === 'convert_short_med') {
                                                        // For Convert Short/Med, combine short and med counts
                                                        playCount = ((gamePlan.sets || []).find(s => s.id === '3rd_short')?.playIds?.length || 0) +
                                                            ((gamePlan.sets || []).find(s => s.id === '3rd_med')?.playIds?.length || 0);
                                                    } else if (section.key === 'convert_long_xl') {
                                                        // For Convert L/XL, combine long and xl counts
                                                        playCount = ((gamePlan.sets || []).find(s => s.id === '3rd_long')?.playIds?.length || 0) +
                                                            ((gamePlan.sets || []).find(s => s.id === '3rd_xl')?.playIds?.length || 0);
                                                    } else if (section.key === 'two_minute') {
                                                        // For 2-minute drill, combine all category counts
                                                        playCount = ['oob_yac', 'first_down', 'touchdown', 'final_play'].reduce((sum, cat) => {
                                                            return sum + ((gamePlan.sets || []).find(s => s.id === `two_minute_${cat}`)?.playIds?.length || 0);
                                                        }, 0);
                                                    } else {
                                                        playCount = (gamePlan.sets || []).find(s => s.id === section.key)?.playIds?.length || 0;
                                                    }

                                                    return (
                                                        <button
                                                            key={section.key}
                                                            onClick={() => setSelectedSection(section.key)}
                                                            style={{
                                                                background: section.color,
                                                                color: 'white',
                                                                border: 'none',
                                                                borderRadius: '12px',
                                                                padding: '1.5rem',
                                                                cursor: 'pointer',
                                                                transition: 'all 0.2s',
                                                                display: 'flex',
                                                                flexDirection: 'column',
                                                                alignItems: 'center',
                                                                gap: '0.75rem',
                                                                minHeight: '140px',
                                                                position: 'relative',
                                                                fontSize: '1rem',
                                                                fontWeight: 'bold',
                                                                textTransform: 'uppercase',
                                                                boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
                                                            }}
                                                            onMouseEnter={(e) => {
                                                                e.currentTarget.style.transform = 'translateY(-4px)';
                                                                e.currentTarget.style.boxShadow = '0 4px 16px rgba(0,0,0,0.25)';
                                                            }}
                                                            onMouseLeave={(e) => {
                                                                e.currentTarget.style.transform = 'translateY(0)';
                                                                e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
                                                            }}
                                                        >
                                                            <Icon name={section.icon} size={32} />
                                                            <div style={{ textAlign: 'center' }}>{section.label}</div>
                                                            <div style={{
                                                                fontSize: '0.75rem',
                                                                opacity: 0.9,
                                                                position: 'absolute',
                                                                bottom: '0.5rem',
                                                                right: '0.5rem',
                                                                background: 'rgba(0,0,0,0.2)',
                                                                padding: '0.25rem 0.5rem',
                                                                borderRadius: '4px'
                                                            }}>
                                                                {playCount} {playCount === 1 ? 'play' : 'plays'}
                                                            </div>
                                                        </button>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    ));
                                })()}
                            </div>
                        ) : viewMode === 'player_touches' ? (
                            // Player Touches View - single button
                            <div style={{
                                display: 'flex',
                                justifyContent: 'center',
                                alignItems: 'center',
                                overflowY: 'auto',
                                flex: 1,
                                padding: '2rem'
                            }}>
                                <button
                                    onClick={() => setSelectedSection('player_touches')}
                                    style={{
                                        background: '#8b5cf6',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '16px',
                                        padding: '3rem',
                                        cursor: 'pointer',
                                        transition: 'all 0.2s',
                                        display: 'flex',
                                        flexDirection: 'column',
                                        alignItems: 'center',
                                        gap: '1rem',
                                        minWidth: '300px',
                                        minHeight: '200px',
                                        position: 'relative',
                                        fontSize: '2rem',
                                        fontWeight: 'bold',
                                        boxShadow: '0 4px 16px rgba(139, 92, 246, 0.3)'
                                    }}
                                    onMouseEnter={(e) => {
                                        e.currentTarget.style.transform = 'scale(1.05)';
                                        e.currentTarget.style.boxShadow = '0 8px 24px rgba(139, 92, 246, 0.4)';
                                    }}
                                    onMouseLeave={(e) => {
                                        e.currentTarget.style.transform = 'scale(1)';
                                        e.currentTarget.style.boxShadow = '0 4px 16px rgba(139, 92, 246, 0.3)';
                                    }}
                                >
                                    <Icon name="Users" size={48} />
                                    <div style={{ textAlign: 'center' }}>üëê PLAYER TOUCHES</div>
                                    <div style={{
                                        fontSize: '0.85rem',
                                        opacity: 0.9,
                                        position: 'absolute',
                                        bottom: '1rem',
                                        background: 'rgba(0,0,0,0.2)',
                                        padding: '0.5rem 1rem',
                                        borderRadius: '6px'
                                    }}>
                                        {((gamePlan.sets || []).find(s => s.id === 'player_touches')?.playIds?.length || 0)} {((gamePlan.sets || []).find(s => s.id === 'player_touches')?.playIds?.length || 0) === 1 ? 'play' : 'plays'}
                                    </div>
                                </button>
                            </div>
                        ) : (
                            // Matrix View - formation buttons
                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))',
                                gap: '1rem',
                                overflowY: 'auto',
                                flex: 1
                            }}>
                                {(viewMode === 'play_type' ? playTypeGroups : formationGroups).map(group => {
                                    // Get play count
                                    let playCount = 0;

                                    if (viewMode === 'play_type') {
                                        playCount = plays.filter(p => {
                                            const allTags = [...(p.tags || []), p.tag1, p.tag2].filter(Boolean);
                                            return allTags.includes(group.id);
                                        }).length;
                                    } else if (group.id === 'one_word') {
                                        // For one_word, combine counts from all three categories
                                        playCount = ['form_adj', 'motion', 'tag'].reduce((sum, cat) => {
                                            return sum + ((gamePlan.sets || []).find(s => s.id === cat)?.playIds?.length || 0);
                                        }, 0);
                                    } else {
                                        const formationPlays = plays.filter(p => p.formation && p.formation.includes(group.id));
                                        playCount = formationPlays.length;
                                    }

                                    return (
                                        <button
                                            key={group.id}
                                            onClick={() => setSelectedSection(group.id)}
                                            style={{
                                                background: group.color,
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '12px',
                                                padding: '1.5rem',
                                                cursor: 'pointer',
                                                transition: 'all 0.2s',
                                                display: 'flex',
                                                flexDirection: 'column',
                                                alignItems: 'center',
                                                gap: '0.75rem',
                                                minHeight: '140px',
                                                position: 'relative',
                                                fontSize: '1.5rem',
                                                fontWeight: 'bold',
                                                boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
                                            }}
                                            onMouseEnter={(e) => {
                                                e.currentTarget.style.transform = 'translateY(-4px)';
                                                e.currentTarget.style.boxShadow = '0 4px 16px rgba(0,0,0,0.25)';
                                            }}
                                            onMouseLeave={(e) => {
                                                e.currentTarget.style.transform = 'translateY(0)';
                                                e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
                                            }}
                                        >
                                            <Icon name={group.icon} size={32} />
                                            <div style={{ textAlign: 'center' }}>{group.label}</div>
                                            <div style={{
                                                fontSize: '0.75rem',
                                                opacity: 0.9,
                                                position: 'absolute',
                                                bottom: '0.5rem',
                                                right: '0.5rem',
                                                background: 'rgba(0,0,0,0.2)',
                                                padding: '0.25rem 0.5rem',
                                                borderRadius: '4px'
                                            }}>
                                                {playCount} {playCount === 1 ? 'play' : 'plays'}
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                );
            }

            // Section Detail View
            const currentSection = gamePlanSections.find(s => s.key === selectedSection) ||
                formationGroups.find(f => f.id === selectedSection) ||
                playTypeGroups.find(pt => pt.id === selectedSection) ||
                (selectedSection === 'player_touches' ? { key: 'player_touches', label: 'üëê PLAYER TOUCHES', color: '#8b5cf6', icon: 'Users' } : null);

            return (
                <div style={{ height: 'calc(100vh - 100px)', display: 'flex', flexDirection: 'column' }}>
                    {/* Header with Home Button */}
                    <div style={{
                        background: currentSection.color,
                        color: 'white',
                        padding: '1rem 1.5rem',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
                    }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                            <Icon name={currentSection.icon} size={24} />
                            <h2 style={{ margin: 0 }}>{currentSection.label}</h2>
                            <span style={{
                                fontSize: '0.9rem',
                                opacity: 0.9,
                                background: 'rgba(0,0,0,0.2)',
                                padding: '0.25rem 0.75rem',
                                borderRadius: '12px'
                            }}>
                                {sectionPlays.length} {sectionPlays.length === 1 ? 'play' : 'plays'}
                            </span>
                        </div>
                        <button
                            onClick={() => setSelectedSection(null)}
                            className="btn"
                            style={{
                                background: 'rgba(255,255,255,0.2)',
                                color: 'white',
                                border: '2px solid rgba(255,255,255,0.3)',
                                fontWeight: 'bold',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '0.5rem'
                            }}
                        >
                            <Icon name="Home" size={18} />
                            HOME
                        </button>

                        {/* Build Script Toggle */}
                        <button
                            onClick={() => setIsBuildingScript(!isBuildingScript)}
                            className="btn"
                            style={{
                                background: isBuildingScript ? '#f43f5e' : 'rgba(255,255,255,0.2)',
                                color: 'white',
                                border: '2px solid rgba(255,255,255,0.3)',
                                fontWeight: 'bold',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '0.5rem'
                            }}
                        >
                            <Icon name="Edit3" size={18} />
                            {isBuildingScript ? 'BUILDING...' : 'BUILD SCRIPT'}
                        </button>
                    </div>

                    {/* Script Builder Panel */}
                    {isBuildingScript && (
                        <div style={{
                            background: 'var(--bg-panel)',
                            padding: '1rem',
                            borderBottom: '2px solid var(--border)',
                            animation: 'slideDown 0.2s ease-out'
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>
                                <div style={{ fontWeight: 'bold', color: '#f43f5e' }}>IN-GAME SCRIPT BUILDER</div>
                                <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>{currentScriptPlays.length} Plays Selected</div>
                            </div>

                            <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem' }}>
                                <input
                                    type="text"
                                    placeholder="Script Name (e.g. 2nd Half Openers)"
                                    value={scriptName}
                                    onChange={(e) => setScriptName(e.target.value)}
                                    style={{
                                        flex: 1,
                                        padding: '0.5rem',
                                        borderRadius: '4px',
                                        border: '1px solid var(--border)',
                                        background: 'var(--bg-card)',
                                        color: 'var(--text-primary)'
                                    }}
                                />
                                <button
                                    className="btn btn-primary"
                                    onClick={saveInGameScript}
                                    style={{ backgroundColor: '#f43f5e', opacity: (!scriptName || currentScriptPlays.length === 0) ? 0.5 : 1 }}
                                    disabled={!scriptName || currentScriptPlays.length === 0}
                                >
                                    SAVE SCRIPT
                                </button>
                            </div>

                            {/* Current Plays List */}
                            {currentScriptPlays.length > 0 && (
                                <div style={{ maxHeight: '100px', overflowY: 'auto', background: 'var(--bg-card)', padding: '0.5rem', borderRadius: '4px', display: 'flex', flexDirection: 'column', gap: '4px' }}>
                                    {currentScriptPlays.map((p, idx) => (
                                        <div key={`script-play-${idx}`} style={{ fontSize: '0.8rem', display: 'flex', justifyContent: 'space-between' }}>
                                            <span>{idx + 1}. {p.name}</span>
                                            <span style={{ cursor: 'pointer', color: '#ef4444' }} onClick={() => setCurrentScriptPlays(prev => prev.filter((_, i) => i !== idx))}>√ó</span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    {/* Quick Add Play Input */}
                    {onQuickAddPlay && selectedSection && !['play_type', 'player_touches'].includes(selectedSection) && (
                        <div style={{
                            marginTop: '2rem',
                            padding: '1.5rem',
                            background: 'var(--bg-panel)',
                            borderRadius: '8px',
                            border: '2px dashed var(--border)'
                        }}>
                            <div style={{ marginBottom: '0.75rem', fontWeight: 'bold', color: 'var(--text-secondary)', fontSize: '0.9rem' }}>
                                ‚ûï QUICK ADD PLAY
                            </div>
                            <input
                                type="text"
                                placeholder="Type play name and press Enter..."
                                style={{
                                    width: '100%',
                                    padding: '0.75rem',
                                    background: 'var(--bg-card)',
                                    border: '2px solid var(--border)',
                                    borderRadius: '6px',
                                    color: 'var(--text-primary)',
                                    fontSize: '1rem'
                                }}
                                onKeyDown={(e) => {
                                    if (e.key === 'Enter' && e.target.value.trim()) {
                                        // Determine the setId based on current section and submenus
                                        let setId = selectedSection;

                                        // Handle sections with submenus
                                        if (selectedSection === 'opening_script') {
                                            setId = `opening_script_${selectedHash}`;
                                        } else if (selectedSection === '2nd_xl') {
                                            setId = `2nd_xl_${selected2ndXLHash}`;
                                        } else if (selectedSection === '2_min') {
                                            setId = `2_min_${selected2MinCategory}`;
                                        } else if (selectedSection === 'one_word') {
                                            setId = `one_word_${selectedOneWordCategory}`;
                                        } else if (selectedSection === 'convert_short_med') {
                                            setId = selectedConvertShortMed === 'short' ? '3rd_short' : '3rd_med';
                                        } else if (selectedSection === 'convert_long_xl') {
                                            setId = selectedConvertLongXL === 'long' ? '3rd_long' : '3rd_xl';
                                        }

                                        handleQuickAddToSet(setId, e.target.value);
                                        e.target.value = '';
                                    }
                                }}
                            />
                            <div style={{ marginTop: '0.5rem', fontSize: '0.75rem', color: 'var(--text-secondary)' }}>
                                üí° Play will be created as incomplete - fill out details in the Playbook tab
                            </div>
                        </div>
                    )}

                    {/* Hash Toggle for Opening Script */}
                    {selectedSection === 'opening_script' && (
                        <div style={{
                            background: 'var(--bg-panel)',
                            padding: '1rem 1.5rem',
                            borderBottom: '2px solid var(--border)',
                            display: 'flex',
                            gap: '1rem'
                        }}>
                            <button
                                onClick={() => setSelectedHash('left')}
                                className="btn"
                                style={{
                                    background: selectedHash === 'left' ? currentSection.color : 'var(--bg-card)',
                                    color: selectedHash === 'left' ? 'white' : 'var(--text-primary)',
                                    border: selectedHash === 'left' ? 'none' : '2px solid var(--border)',
                                    fontWeight: 'bold',
                                    padding: '0.75rem 1.5rem',
                                    flex: 1
                                }}
                            >
                                ‚óÄ LEFT HASH
                            </button>
                            <button
                                onClick={() => setSelectedHash('right')}
                                className="btn"
                                style={{
                                    background: selectedHash === 'right' ? currentSection.color : 'var(--bg-card)',
                                    color: selectedHash === 'right' ? 'white' : 'var(--text-primary)',
                                    border: selectedHash === 'right' ? 'none' : '2px solid var(--border)',
                                    fontWeight: 'bold',
                                    padding: '0.75rem 1.5rem',
                                    flex: 1
                                }}
                            >
                                RIGHT HASH ‚ñ∂
                            </button>
                        </div>
                    )}

                    {/* Hash Toggle for 1st/2nd & XL */}
                    {selectedSection === '2nd_xl' && (
                        <div style={{
                            background: 'var(--bg-panel)',
                            padding: '1rem 1.5rem',
                            borderBottom: '2px solid var(--border)',
                            display: 'flex',
                            gap: '1rem'
                        }}>
                            <button
                                onClick={() => setSelected2ndXLHash('lh')}
                                className="btn"
                                style={{
                                    background: selected2ndXLHash === 'lh' ? currentSection.color : 'var(--bg-card)',
                                    color: selected2ndXLHash === 'lh' ? 'white' : 'var(--text-primary)',
                                    border: selected2ndXLHash === 'lh' ? 'none' : '2px solid var(--border)',
                                    fontWeight: 'bold',
                                    padding: '0.75rem 1.5rem',
                                    flex: 1
                                }}
                            >
                                ‚óÄ LEFT HASH
                            </button>
                            <button
                                onClick={() => setSelected2ndXLHash('rh')}
                                className="btn"
                                style={{
                                    background: selected2ndXLHash === 'rh' ? currentSection.color : 'var(--bg-card)',
                                    color: selected2ndXLHash === 'rh' ? 'white' : 'var(--text-primary)',
                                    border: selected2ndXLHash === 'rh' ? 'none' : '2px solid var(--border)',
                                    fontWeight: 'bold',
                                    padding: '0.75rem 1.5rem',
                                    flex: 1
                                }}
                            >
                                RIGHT HASH ‚ñ∂
                            </button>
                        </div>
                    )}

                    {/* Distance Toggle for Convert Short/Med */}
                    {selectedSection === 'convert_short_med' && (
                        <div style={{
                            background: 'var(--bg-panel)',
                            padding: '1rem 1.5rem',
                            borderBottom: '2px solid var(--border)',
                            display: 'flex',
                            gap: '1rem'
                        }}>
                            <button
                                onClick={() => setSelectedConvertShortMed('short')}
                                className="btn"
                                style={{
                                    background: selectedConvertShortMed === 'short' ? currentSection.color : 'var(--bg-card)',
                                    color: selectedConvertShortMed === 'short' ? 'white' : 'var(--text-primary)',
                                    border: selectedConvertShortMed === 'short' ? 'none' : '2px solid var(--border)',
                                    fontWeight: 'bold',
                                    padding: '0.75rem 1.5rem',
                                    flex: 1
                                }}
                            >
                                3RD & SHORT
                            </button>
                            <button
                                onClick={() => setSelectedConvertShortMed('med')}
                                className="btn"
                                style={{
                                    background: selectedConvertShortMed === 'med' ? currentSection.color : 'var(--bg-card)',
                                    color: selectedConvertShortMed === 'med' ? 'white' : 'var(--text-primary)',
                                    border: selectedConvertShortMed === 'med' ? 'none' : '2px solid var(--border)',
                                    fontWeight: 'bold',
                                    padding: '0.75rem 1.5rem',
                                    flex: 1
                                }}
                            >
                                3RD & MED
                            </button>
                        </div>
                    )}

                    {/* Distance Toggle for Convert L/XL */}
                    {selectedSection === 'convert_long_xl' && (
                        <div style={{
                            background: 'var(--bg-panel)',
                            padding: '1rem 1.5rem',
                            borderBottom: '2px solid var(--border)',
                            display: 'flex',
                            gap: '1rem'
                        }}>
                            <button
                                onClick={() => setSelectedConvertLongXL('long')}
                                className="btn"
                                style={{
                                    background: selectedConvertLongXL === 'long' ? currentSection.color : 'var(--bg-card)',
                                    color: selectedConvertLongXL === 'long' ? 'white' : 'var(--text-primary)',
                                    border: selectedConvertLongXL === 'long' ? 'none' : '2px solid var(--border)',
                                    fontWeight: 'bold',
                                    padding: '0.75rem 1.5rem',
                                    flex: 1
                                }}
                            >
                                3RD & LONG (7-12)
                            </button>
                            <button
                                onClick={() => setSelectedConvertLongXL('xl')}
                                className="btn"
                                style={{
                                    background: selectedConvertLongXL === 'xl' ? currentSection.color : 'var(--bg-card)',
                                    color: selectedConvertLongXL === 'xl' ? 'white' : 'var(--text-primary)',
                                    border: selectedConvertLongXL === 'xl' ? 'none' : '2px solid var(--border)',
                                    fontWeight: 'bold',
                                    padding: '0.75rem 1.5rem',
                                    flex: 1
                                }}
                            >
                                3RD & XL (12+)
                            </button>
                        </div>
                    )}

                    {/* 2-Minute Drill Category Toggle */}
                    {selectedSection === 'two_minute' && (
                        <div style={{
                            background: 'var(--bg-panel)',
                            padding: '1rem 1.5rem',
                            borderBottom: '2px solid var(--border)',
                            display: 'grid',
                            gridTemplateColumns: 'repeat(2, 1fr)',
                            gap: '0.75rem'
                        }}>
                            <button
                                onClick={() => setSelected2MinCategory('oob_yac')}
                                className="btn"
                                style={{
                                    background: selected2MinCategory === 'oob_yac' ? currentSection.color : 'var(--bg-card)',
                                    color: selected2MinCategory === 'oob_yac' ? 'white' : 'var(--text-primary)',
                                    border: selected2MinCategory === 'oob_yac' ? 'none' : '2px solid var(--border)',
                                    fontWeight: 'bold',
                                    padding: '0.75rem 1rem',
                                    fontSize: '0.85rem'
                                }}
                            >
                                üèÉ OOB / YAC
                            </button>
                            <button
                                onClick={() => setSelected2MinCategory('first_down')}
                                className="btn"
                                style={{
                                    background: selected2MinCategory === 'first_down' ? currentSection.color : 'var(--bg-card)',
                                    color: selected2MinCategory === 'first_down' ? 'white' : 'var(--text-primary)',
                                    border: selected2MinCategory === 'first_down' ? 'none' : '2px solid var(--border)',
                                    fontWeight: 'bold',
                                    padding: '0.75rem 1rem',
                                    fontSize: '0.85rem'
                                }}
                            >
                                üìç FIRST DOWN
                            </button>
                            <button
                                onClick={() => setSelected2MinCategory('touchdown')}
                                className="btn"
                                style={{
                                    background: selected2MinCategory === 'touchdown' ? currentSection.color : 'var(--bg-card)',
                                    color: selected2MinCategory === 'touchdown' ? 'white' : 'var(--text-primary)',
                                    border: selected2MinCategory === 'touchdown' ? 'none' : '2px solid var(--border)',
                                    fontWeight: 'bold',
                                    padding: '0.75rem 1rem',
                                    fontSize: '0.85rem'
                                }}
                            >
                                üéØ TOUCHDOWN
                            </button>
                            <button
                                onClick={() => setSelected2MinCategory('final_play')}
                                className="btn"
                                style={{
                                    background: selected2MinCategory === 'final_play' ? currentSection.color : 'var(--bg-card)',
                                    color: selected2MinCategory === 'final_play' ? 'white' : 'var(--text-primary)',
                                    border: selected2MinCategory === 'final_play' ? 'none' : '2px solid var(--border)',
                                    fontWeight: 'bold',
                                    padding: '0.75rem 1rem',
                                    fontSize: '0.85rem'
                                }}
                            >
                                ‚è±Ô∏è FINAL PLAY
                            </button>
                        </div>
                    )}

                    {/* One-Word Category Toggle */}
                    {selectedSection === 'one_word' && (
                        <div style={{
                            background: 'var(--bg-panel)',
                            padding: '1rem 1.5rem',
                            borderBottom: '2px solid var(--border)',
                            display: 'grid',
                            gridTemplateColumns: 'repeat(3, 1fr)',
                            gap: '0.75rem'
                        }}>
                            <button
                                onClick={() => setSelectedOneWordCategory('form_adj')}
                                className="btn"
                                style={{
                                    background: selectedOneWordCategory === 'form_adj' ? currentSection.color : 'var(--bg-card)',
                                    color: selectedOneWordCategory === 'form_adj' ? 'white' : 'var(--text-primary)',
                                    border: selectedOneWordCategory === 'form_adj' ? 'none' : '2px solid var(--border)',
                                    fontWeight: 'bold',
                                    padding: '0.75rem 1rem',
                                    fontSize: '0.85rem'
                                }}
                            >
                                üìê FORM ADJ
                            </button>
                            <button
                                onClick={() => setSelectedOneWordCategory('motion')}
                                className="btn"
                                style={{
                                    background: selectedOneWordCategory === 'motion' ? currentSection.color : 'var(--bg-card)',
                                    color: selectedOneWordCategory === 'motion' ? 'white' : 'var(--text-primary)',
                                    border: selectedOneWordCategory === 'motion' ? 'none' : '2px solid var(--border)',
                                    fontWeight: 'bold',
                                    padding: '0.75rem 1rem',
                                    fontSize: '0.85rem'
                                }}
                            >
                                üèÉ MOTION
                            </button>
                            <button
                                onClick={() => setSelectedOneWordCategory('tag')}
                                className="btn"
                                style={{
                                    background: selectedOneWordCategory === 'tag' ? currentSection.color : 'var(--bg-card)',
                                    color: selectedOneWordCategory === 'tag' ? 'white' : 'var(--text-primary)',
                                    border: selectedOneWordCategory === 'tag' ? 'none' : '2px solid var(--border)',
                                    fontWeight: 'bold',
                                    padding: '0.75rem 1rem',
                                    fontSize: '0.85rem'
                                }}
                            >
                                üè∑Ô∏è TAG
                            </button>
                        </div>
                    )}


                    {/* Zone Philosophy Editor (for field zones) */}
                    {['backed_up', 'coming_out', 'open_field', 'fringe', 'high_red', 'low_red', 'goal_line'].includes(selectedSection) && zonePhilosophies && (
                        <div style={{
                            background: 'var(--bg-panel)',
                            padding: '1.5rem',
                            borderBottom: '2px solid var(--border)'
                        }}>
                            <div style={{ marginBottom: '0.5rem', fontWeight: 'bold', fontSize: '0.9rem', color: 'var(--text-secondary)' }}>
                                üí° ZONE PHILOSOPHY
                            </div>
                            <textarea
                                value={zonePhilosophies[selectedSection] || ''}
                                onChange={(e) => onUpdatePhilosophy({
                                    ...zonePhilosophies,
                                    [selectedSection]: e.target.value
                                })}
                                placeholder="Enter your strategic philosophy for this field zone..."
                                style={{
                                    width: '100%',
                                    minHeight: '60px',
                                    padding: '0.75rem',
                                    borderRadius: '6px',
                                    border: '2px solid var(--border)',
                                    background: 'var(--bg-card)',
                                    color: 'var(--text-primary)',
                                    fontSize: '0.95rem',
                                    fontFamily: 'inherit',
                                    resize: 'vertical'
                                }}
                            />
                        </div>
                    )}

                    {/* Plays Grid */}
                    <div style={{ flex: 1, overflowY: 'auto', padding: '1.5rem' }}>
                        {sectionPlays.length === 0 ? (
                            <div style={{
                                height: '100%',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                color: 'var(--text-secondary)',
                                flexDirection: 'column',
                                gap: '1rem'
                            }}>
                                <Icon name="Clipboard" size={64} />
                                <div style={{ fontSize: '1.5rem', fontWeight: 'bold' }}>No plays in this section</div>
                                <p>Go to Game Plan ‚Üí Call Sheet to add plays to "{currentSection.label}"</p>
                            </div>
                        ) : selectedSection === 'opening_script' ? (
                            // Special grouped display for opening script
                            <>
                                {/* Group plays by script category */}
                                {(() => {
                                    // Define opening script sections
                                    const scriptSections = [
                                        { id: 'base', label: 'üéØ BASE PLAY', description: 'Your foundational play' },
                                        { id: 'formation', label: 'üîÑ FORMATION / MOTION / RULES', description: 'Formation adjustments and motion concepts' },
                                        { id: 'setup', label: '‚ö° SETUP PLAYS', description: 'Complementary and setup plays' }
                                    ];

                                    // Categorize plays
                                    const categorizedPlays = {
                                        base: [],
                                        formation: [],
                                        setup: [],
                                        uncategorized: []
                                    };

                                    sectionPlays.forEach(play => {
                                        // Determine category based on play tags or index
                                        if (play.tags && play.tags.some(t => t.toLowerCase().includes('base'))) {
                                            categorizedPlays.base.push(play);
                                        } else if (play.tags && (
                                            play.tags.some(t => t.toLowerCase().includes('formation')) ||
                                            play.tags.some(t => t.toLowerCase().includes('motion')) ||
                                            play.tags.some(t => t.toLowerCase().includes('rule'))
                                        )) {
                                            categorizedPlays.formation.push(play);
                                        } else if (play.tags && play.tags.some(t => t.toLowerCase().includes('setup'))) {
                                            categorizedPlays.setup.push(play);
                                        } else {
                                            categorizedPlays.uncategorized.push(play);
                                        }
                                    });

                                    return (
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '2rem' }}>
                                            {scriptSections.map(section => {
                                                const sectionPlaysFiltered = categorizedPlays[section.id] || [];
                                                if (sectionPlaysFiltered.length === 0) return null;

                                                return (
                                                    <div key={section.id}>
                                                        <div style={{
                                                            marginBottom: '1rem',
                                                            paddingBottom: '0.5rem',
                                                            borderBottom: `3px solid ${currentSection.color}`
                                                        }}>
                                                            <h3 style={{ margin: 0, fontSize: '1.3rem', color: currentSection.color }}>{section.label}</h3>
                                                            <p style={{ margin: '0.25rem 0 0 0', fontSize: '0.85rem', color: 'var(--text-secondary)' }}>
                                                                {section.description}
                                                            </p>
                                                        </div>
                                                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '1.5rem' }}>
                                                            {sectionPlaysFiltered.map((play, idx) => (
                                                                <div
                                                                    key={play.id || idx}
                                                                    className="play-card"
                                                                    onClick={() => isBuildingScript && addToScript(play)}
                                                                    style={{
                                                                        cursor: 'pointer',
                                                                        borderLeft: `4px solid ${currentSection.color}`,
                                                                        transition: 'all 0.2s'
                                                                    }}
                                                                    onMouseEnter={(e) => {
                                                                        e.currentTarget.style.transform = 'translateY(-4px)';
                                                                        e.currentTarget.style.boxShadow = '0 8px 16px rgba(0,0,0,0.2)';
                                                                    }}
                                                                    onMouseLeave={(e) => {
                                                                        e.currentTarget.style.transform = 'translateY(0)';
                                                                        e.currentTarget.style.boxShadow = '';
                                                                    }}
                                                                >
                                                                    <div style={{ padding: '1.5rem' }}>
                                                                        <div style={{ fontWeight: 'bold', fontSize: '1.3rem', marginBottom: '0.5rem' }}>{play.name}</div>
                                                                        <div style={{ fontSize: '1rem', color: 'var(--text-secondary)', marginBottom: '1rem' }}>{play.formation}</div>
                                                                        {play.concept && <div style={{ fontSize: '0.9rem', marginBottom: '0.75rem' }}>Concept: {play.concept}</div>}
                                                                        {play.sequenceName && (
                                                                            <div style={{ marginTop: '0.5rem', marginBottom: '0.75rem', padding: '0.5rem', background: 'rgba(59, 130, 246, 0.1)', border: '1px solid #3b82f6', borderRadius: '4px' }}>
                                                                                <div style={{ fontSize: '0.8rem', fontWeight: 'bold', color: '#3b82f6', display: 'flex', alignItems: 'center', gap: '4px' }}>
                                                                                    <Icon name="Link" size={12} />
                                                                                    {play.sequenceName} #{play.sequenceOrder}
                                                                                </div>
                                                                                {(() => {
                                                                                    const nextPlay = plays.find(p => p.sequenceName === play.sequenceName && parseInt(p.sequenceOrder) === parseInt(play.sequenceOrder) + 1);
                                                                                    if (nextPlay) return (
                                                                                        <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)', marginTop: '2px' }}>
                                                                                            Next: <strong>{nextPlay.name}</strong>
                                                                                        </div>
                                                                                    );
                                                                                    return null;
                                                                                })()}
                                                                            </div>
                                                                        )}
                                                                        {play.mirrorPlay && (
                                                                            <div style={{
                                                                                fontSize: '0.85rem',
                                                                                color: 'var(--accent)',
                                                                                background: 'var(--surface)',
                                                                                padding: '0.5rem',
                                                                                borderRadius: '6px',
                                                                                marginTop: '0.75rem'
                                                                            }}>
                                                                                <Icon name="ArrowLeftRight" size={14} style={{ marginRight: '0.5rem' }} />
                                                                                Mirror: {play.mirrorPlay}
                                                                            </div>
                                                                        )}
                                                                        <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap', marginTop: '1rem' }}>
                                                                            {play.hashPreference && (
                                                                                <span className="mini-tag" style={{ background: currentSection.color, color: 'white' }}>
                                                                                    {play.hashPreference}
                                                                                </span>
                                                                            )}
                                                                            {play.tags && play.tags.slice(0, 4).map(t => (
                                                                                <span key={t} className="mini-tag">{t}</span>
                                                                            ))}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                );
                                            })}

                                            {/* Uncategorized plays */}
                                            {categorizedPlays.uncategorized.length > 0 && (
                                                <div>
                                                    <div style={{
                                                        marginBottom: '1rem',
                                                        paddingBottom: '0.5rem',
                                                        borderBottom: '3px solid var(--border)'
                                                    }}>
                                                        <h3 style={{ margin: 0, fontSize: '1.3rem', color: 'var(--text-secondary)' }}>üìã OTHER PLAYS</h3>
                                                        <p style={{ margin: '0.25rem 0 0 0', fontSize: '0.85rem', color: 'var(--text-secondary)' }}>
                                                            Add tags "base", "formation", "motion", or "setup" to organize these plays
                                                        </p>
                                                    </div>
                                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '1.5rem' }}>
                                                        {categorizedPlays.uncategorized.map((play, idx) => (
                                                            <div
                                                                key={play.id || idx}
                                                                className="play-card"
                                                                onClick={() => isBuildingScript && addToScript(play)}
                                                                style={{
                                                                    cursor: 'pointer',
                                                                    borderLeft: `4px solid var(--border)`,
                                                                    transition: 'all 0.2s',
                                                                    opacity: 0.8
                                                                }}
                                                                onMouseEnter={(e) => {
                                                                    e.currentTarget.style.transform = 'translateY(-4px)';
                                                                    e.currentTarget.style.boxShadow = '0 8px 16px rgba(0,0,0,0.2)';
                                                                    e.currentTarget.style.opacity = '1';
                                                                }}
                                                                onMouseLeave={(e) => {
                                                                    e.currentTarget.style.transform = 'translateY(0)';
                                                                    e.currentTarget.style.boxShadow = '';
                                                                    e.currentTarget.style.opacity = '0.8';
                                                                }}
                                                            >
                                                                <div style={{ padding: '1.5rem' }}>
                                                                    <div style={{ fontWeight: 'bold', fontSize: '1.3rem', marginBottom: '0.5rem' }}>{play.name}</div>
                                                                    <div style={{ fontSize: '1rem', color: 'var(--text-secondary)', marginBottom: '1rem' }}>{play.formation}</div>
                                                                    {play.concept && <div style={{ fontSize: '0.9rem', marginBottom: '0.75rem' }}>Concept: {play.concept}</div>}
                                                                    {play.sequenceName && (
                                                                        <div style={{ marginTop: '0.5rem', marginBottom: '0.75rem', padding: '0.5rem', background: 'rgba(59, 130, 246, 0.1)', border: '1px solid #3b82f6', borderRadius: '4px' }}>
                                                                            <div style={{ fontSize: '0.8rem', fontWeight: 'bold', color: '#3b82f6', display: 'flex', alignItems: 'center', gap: '4px' }}>
                                                                                <Icon name="Link" size={12} />
                                                                                {play.sequenceName} #{play.sequenceOrder}
                                                                            </div>
                                                                            {(() => {
                                                                                const nextPlay = plays.find(p => p.sequenceName === play.sequenceName && parseInt(p.sequenceOrder) === parseInt(play.sequenceOrder) + 1);
                                                                                if (nextPlay) return (
                                                                                    <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)', marginTop: '2px' }}>
                                                                                        Next: <strong>{nextPlay.name}</strong>
                                                                                    </div>
                                                                                );
                                                                                return null;
                                                                            })()}
                                                                        </div>
                                                                    )}
                                                                    {play.mirrorPlay && (
                                                                        <div style={{
                                                                            fontSize: '0.85rem',
                                                                            color: 'var(--accent)',
                                                                            background: 'var(--surface)',
                                                                            padding: '0.5rem',
                                                                            borderRadius: '6px',
                                                                            marginTop: '0.75rem'
                                                                        }}>
                                                                            <Icon name="ArrowLeftRight" size={14} style={{ marginRight: '0.5rem' }} />
                                                                            Mirror: {play.mirrorPlay}
                                                                        </div>
                                                                    )}
                                                                    <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap', marginTop: '1rem' }}>
                                                                        {play.hashPreference && (
                                                                            <span className="mini-tag" style={{ background: currentSection.color, color: 'white' }}>
                                                                                {play.hashPreference}
                                                                            </span>
                                                                        )}
                                                                        {play.tags && play.tags.slice(0, 4).map(t => (
                                                                            <span key={t} className="mini-tag">{t}</span>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })()}
                            </>
                        ) : ['fringe', 'high_red', 'low_red', 'goal_line'].includes(selectedSection) ? (
                            // Field zones with BASE / CONVERT / EXPLOSIVE matrix
                            <div style={{ overflowX: 'auto' }}>
                                <table style={{
                                    width: '100%',
                                    borderCollapse: 'separate',
                                    borderSpacing: '0.5rem',
                                    marginTop: '1rem'
                                }}>
                                    <thead>
                                        <tr>
                                            <th style={{
                                                background: 'var(--bg-panel)',
                                                padding: '1rem',
                                                borderRadius: '8px',
                                                textAlign: 'left',
                                                fontWeight: 'bold',
                                                color: 'var(--text-secondary)',
                                                minWidth: '120px'
                                            }}>DOWN</th>
                                            <th style={{
                                                background: '#10b981',
                                                color: 'white',
                                                padding: '1rem',
                                                borderRadius: '8px',
                                                textAlign: 'center',
                                                fontWeight: 'bold',
                                                minWidth: '250px'
                                            }}>BASE</th>
                                            <th style={{
                                                background: '#f59e0b',
                                                color: 'white',
                                                padding: '1rem',
                                                borderRadius: '8px',
                                                textAlign: 'center',
                                                fontWeight: 'bold',
                                                minWidth: '250px'
                                            }}>CONVERT</th>
                                            <th style={{
                                                background: '#ef4444',
                                                color: 'white',
                                                padding: '1rem',
                                                borderRadius: '8px',
                                                textAlign: 'center',
                                                fontWeight: 'bold',
                                                minWidth: '250px'
                                            }}>EXPLOSIVE</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {['1st', '2nd', '3rd', '4th'].map(down => (
                                            <tr key={down}>
                                                <td style={{
                                                    background: currentSection.color,
                                                    color: 'white',
                                                    padding: '1rem',
                                                    borderRadius: '8px',
                                                    fontWeight: 'bold',
                                                    fontSize: '1.1rem',
                                                    textAlign: 'center'
                                                }}>
                                                    {down}
                                                </td>
                                                {['base', 'convert', 'explosive'].map(category => {
                                                    const setId = `${selectedSection}_${down}_${category}`;
                                                    const cellPlays = (gamePlan.sets || []).find(s => s.id === setId)?.playIds || [];
                                                    const cellPlayObjects = cellPlays.map(id => plays.find(p => p.id === id)).filter(Boolean);

                                                    return (
                                                        <td key={category} style={{
                                                            background: 'var(--bg-panel)',
                                                            padding: '1rem',
                                                            borderRadius: '8px',
                                                            verticalAlign: 'top'
                                                        }}>
                                                            {cellPlayObjects.length > 0 ? (
                                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                                                    {cellPlayObjects.map(play => (
                                                                        <div
                                                                            key={play.id}
                                                                            style={{
                                                                                background: 'var(--bg-card)',
                                                                                padding: '0.75rem',
                                                                                borderRadius: '6px',
                                                                                cursor: 'pointer',
                                                                                border: '2px solid transparent',
                                                                                transition: 'all 0.2s'
                                                                            }}
                                                                            onClick={() => isBuildingScript && addToScript(play)}
                                                                            onMouseEnter={(e) => {
                                                                                e.currentTarget.style.borderColor = currentSection.color;
                                                                                e.currentTarget.style.transform = 'translateY(-2px)';
                                                                            }}
                                                                            onMouseLeave={(e) => {
                                                                                e.currentTarget.style.borderColor = 'transparent';
                                                                                e.currentTarget.style.transform = 'translateY(0)';
                                                                            }}
                                                                        >
                                                                            <div style={{ fontWeight: 'bold', marginBottom: '0.25rem', color: 'var(--text-primary)' }}>
                                                                                {play.wristbandSlot && <span style={{ color: currentSection.color, marginRight: '0.5rem' }}>{play.wristbandSlot}</span>}
                                                                                {play.name}
                                                                            </div>
                                                                            {play.formation && (
                                                                                <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>
                                                                                    {play.formation}
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            ) : (
                                                                <div style={{
                                                                    color: 'var(--text-secondary)',
                                                                    fontSize: '0.85rem',
                                                                    fontStyle: 'italic',
                                                                    textAlign: 'center',
                                                                    padding: '1rem'
                                                                }}>
                                                                    No plays
                                                                </div>
                                                            )}

                                                            {/* Quick Add Input */}
                                                            {onQuickAddPlay && (
                                                                <div style={{ marginTop: '0.5rem' }}>
                                                                    <input
                                                                        type="text"
                                                                        placeholder="Add play..."
                                                                        style={{
                                                                            width: '100%',
                                                                            padding: '0.5rem',
                                                                            background: 'var(--bg-card)',
                                                                            border: '1px solid var(--border)',
                                                                            borderRadius: '4px',
                                                                            color: 'var(--text-primary)',
                                                                            fontSize: '0.85rem'
                                                                        }}
                                                                        onKeyDown={(e) => {
                                                                            if (e.key === 'Enter' && e.target.value.trim()) {
                                                                                handleQuickAddToSet(setId, e.target.value);
                                                                                e.target.value = '';
                                                                            }
                                                                        }}
                                                                    />
                                                                </div>
                                                            )}
                                                        </td>
                                                    );
                                                })}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        ) : (
                            // Standard grid for other sections
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '1.5rem' }}>
                                {sectionPlays.map((play, idx) => (
                                    <div
                                        key={play.id || idx}
                                        className="play-card"
                                        onClick={() => isBuildingScript && addToScript(play)}
                                        style={{
                                            cursor: 'pointer',
                                            borderLeft: `4px solid ${currentSection.color}`,
                                            transition: 'all 0.2s'
                                        }}
                                        onMouseEnter={(e) => {
                                            e.currentTarget.style.transform = 'translateY(-4px)';
                                            e.currentTarget.style.boxShadow = '0 8px 16px rgba(0,0,0,0.2)';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.currentTarget.style.transform = 'translateY(0)';
                                            e.currentTarget.style.boxShadow = '';
                                        }}
                                    >
                                        <div style={{ padding: '1.5rem' }}>
                                            <div style={{ fontWeight: 'bold', fontSize: '1.3rem', marginBottom: '0.5rem' }}>{play.name}</div>
                                            <div style={{ fontSize: '1rem', color: 'var(--text-secondary)', marginBottom: '1rem' }}>{play.formation}</div>
                                            {play.concept && <div style={{ fontSize: '0.9rem', marginBottom: '0.75rem' }}>Concept: {play.concept}</div>}
                                            {play.sequenceName && (
                                                <div style={{ marginTop: '0.5rem', marginBottom: '0.75rem', padding: '0.5rem', background: 'rgba(59, 130, 246, 0.1)', border: '1px solid #3b82f6', borderRadius: '4px' }}>
                                                    <div style={{ fontSize: '0.8rem', fontWeight: 'bold', color: '#3b82f6', display: 'flex', alignItems: 'center', gap: '4px' }}>
                                                        <Icon name="Link" size={12} />
                                                        {play.sequenceName} #{play.sequenceOrder}
                                                    </div>
                                                    {(() => {
                                                        const nextPlay = plays.find(p => p.sequenceName === play.sequenceName && parseInt(p.sequenceOrder) === parseInt(play.sequenceOrder) + 1);
                                                        if (nextPlay) return (
                                                            <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)', marginTop: '2px' }}>
                                                                Next: <strong>{nextPlay.name}</strong>
                                                            </div>
                                                        );
                                                        return null;
                                                    })()}
                                                </div>
                                            )}
                                            {play.mirrorPlay && (
                                                <div style={{
                                                    fontSize: '0.85rem',
                                                    color: 'var(--accent)',
                                                    background: 'var(--surface)',
                                                    padding: '0.5rem',
                                                    borderRadius: '6px',
                                                    marginTop: '0.75rem'
                                                }}>
                                                    <Icon name="ArrowLeftRight" size={14} style={{ marginRight: '0.5rem' }} />
                                                    Mirror: {play.mirrorPlay}
                                                </div>
                                            )}
                                            <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap', marginTop: '1rem' }}>
                                                {play.hashPreference && (
                                                    <span className="mini-tag" style={{ background: currentSection.color, color: 'white' }}>
                                                        {play.hashPreference}
                                                    </span>
                                                )}
                                                {play.tag1 && (
                                                    <span className="mini-tag">
                                                        {(TAG_CATEGORIES["Motion"] || []).includes(play.tag1) ? `"${play.tag1}"` : play.tag1}
                                                    </span>
                                                )}
                                                {play.tag2 && <span className="mini-tag">({play.tag2})</span>}
                                                {play.tags && play.tags.slice(0, 4).map(t => {
                                                    if (t === play.tag1 || t === play.tag2) return null;
                                                    const isMotion = (TAG_CATEGORIES["Motion"] || []).includes(t);
                                                    return <span key={t} className="mini-tag">{isMotion ? `"${t}"` : t}</span>
                                                })}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const PlayerMetrics = ({ roster, metrics, onUpdateMetrics, viewCategory }) => {
            const [selectedPlayerId, setSelectedPlayerId] = useState(null);
            const [entryDate, setEntryDate] = useState(new Date().toISOString().split('T')[0]);
            const [currentEntry, setCurrentEntry] = useState({});
            const [graphMetric, setGraphMetric] = useState('bench');
            const [editingEntryIndex, setEditingEntryIndex] = useState(null);

            const METRIC_FIELDS = [
                // Strength (Combine)
                { id: 'bench', name: 'Bench Press', unit: 'lbs', type: 'number', group: 'Strength', categories: ['combine', 'ironman'] },
                { id: 'squat', name: 'Squat', unit: 'lbs', type: 'number', group: 'Strength', categories: ['combine', 'ironman'] },
                { id: 'deadlift', name: 'Deadlift', unit: 'lbs', type: 'number', group: 'Strength', categories: ['combine'] },

                // Speed & Conditioning (Mixed)
                { id: 'forty', name: '40 Yard Dash', unit: 'sec', type: 'number', step: '0.01', group: 'Speed & Conditioning', categories: ['combine', 'ironman'] },
                { id: 'flying10', name: 'Flying 10', unit: 'sec', type: 'number', step: '0.01', group: 'Speed & Conditioning', categories: ['combine'] },
                { id: 'run800', name: '800m Run', unit: 'min:sec', type: 'text', group: 'Speed & Conditioning', categories: ['ironman'] },

                // Agility & Explosiveness (Mixed)
                { id: 'proAgility', name: 'Pro Agility', unit: 'sec', type: 'number', step: '0.01', group: 'Agility & Explosiveness', categories: ['combine'] },
                { id: 'shuttle30', name: '30 Yd Shuttle', unit: 'sec', type: 'number', step: '0.01', group: 'Agility & Explosiveness', categories: ['ironman'] },
                { id: 'vertical', name: 'Vertical Jump', unit: 'in', type: 'number', step: '0.5', group: 'Agility & Explosiveness', categories: ['combine'] },
                { id: 'broad', name: 'Broad Jump', unit: 'in', type: 'number', step: '1', group: 'Agility & Explosiveness', categories: ['combine'] },
                { id: 'bagJump', name: 'Bag Jump', unit: 'reps', type: 'number', group: 'Agility & Explosiveness', categories: ['ironman'] }
            ];

            // Filter fields based on viewCategory
            const activeFields = METRIC_FIELDS.filter(f => f.categories.includes(viewCategory));

            // Group fields for display
            const groupedFields = activeFields.reduce((acc, field) => {
                if (!acc[field.group]) acc[field.group] = [];
                acc[field.group].push(field);
                return acc;
            }, {});

            // Helper functions moved to global scope
            // parseTime and calculateIronManScore are now available globally

            // ... (rest of logic: handlesave, handleentrychange) ...
            const getPlayerHistory = (id) => {
                const data = metrics[id];
                if (!data) return [];
                if (Array.isArray(data)) return data;
                return [{ date: 'Initial', ...data }];
            };

            const selectedPlayer = roster.find(p => p.id === selectedPlayerId);
            const playerWeight = selectedPlayer?.weight || 180;

            const handleSaveEntry = () => {
                if (!selectedPlayerId) return;
                const history = getPlayerHistory(selectedPlayerId);

                // Calculate scores for this entry
                const scores = {};
                let totalScore = 0;
                METRIC_FIELDS.forEach(f => {
                    if (currentEntry[f.id]) {
                        const s = calculateIronManScore(f.id, currentEntry[f.id], playerWeight);
                        if (s > 0) {
                            scores[f.id] = s;
                            totalScore += s;
                        }
                    }
                });

                const entryData = { date: entryDate, ...currentEntry, scores, totalScore };
                let newHistory;

                if (editingEntryIndex !== null) {
                    newHistory = [...history];
                    newHistory[editingEntryIndex] = entryData;
                } else {
                    newHistory = [...history, entryData];
                }

                onUpdateMetrics({
                    ...metrics,
                    [selectedPlayerId]: newHistory
                });

                // Reset
                setCurrentEntry({});
                setEditingEntryIndex(null);
                setEntryDate(new Date().toISOString().split('T')[0]);
            };

            const handleEditEntry = (index, entry) => {
                setEditingEntryIndex(index);
                setEntryDate(entry.date);
                // Filter out calculated fields key like 'scores' or 'totalScore' if we want cleaner state,
                // but keeping them is fine as they get overwritten on save.
                // We mainly need the input values.
                const { scores, totalScore, date, ...inputValues } = entry;
                setCurrentEntry(inputValues);
            };

            const handleCancelEdit = () => {
                setEditingEntryIndex(null);
                setCurrentEntry({});
                setEntryDate(new Date().toISOString().split('T')[0]);
            };

            const handleEntryChange = (fieldId, value) => {
                setCurrentEntry(prev => ({ ...prev, [fieldId]: value }));
            };

            const history = selectedPlayer ? getPlayerHistory(selectedPlayerId) : [];

            const getLatestStats = (id) => {
                const h = getPlayerHistory(id);
                if (h.length === 0) return {};
                const sorted = [...h].sort((a, b) => new Date(b.date) - new Date(a.date));
                return sorted[0];
            };

            return (
                <div style={{ height: 'calc(100vh - 100px)', display: 'flex', gap: '2rem' }}>
                    {/* Player List */}
                    <div className="card" style={{ width: '300px', display: 'flex', flexDirection: 'column', padding: '0' }}>
                        <div style={{ padding: '1rem', borderBottom: '1px solid var(--border)' }}>
                            <h3 style={{ margin: 0 }}>{viewCategory === 'ironman' ? 'Iron Man' : 'Combine Data'}</h3>
                        </div>
                        <div style={{ flex: 1, overflowY: 'auto' }}>
                            {roster.map(player => {
                                const stats = getLatestStats(player.id);
                                return (
                                    <div
                                        key={player.id}
                                        onClick={() => { setSelectedPlayerId(player.id); setCurrentEntry({}); }}
                                        style={{
                                            padding: '0.75rem 1rem',
                                            borderBottom: '1px solid var(--border)',
                                            cursor: 'pointer',
                                            background: selectedPlayerId === player.id ? 'var(--bg-body)' : 'transparent',
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center'
                                        }}
                                    >
                                        <div>
                                            <div style={{ fontWeight: 'bold' }}>{player.name}</div>
                                            <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>#{player.number} ‚Ä¢ {player.position}</div>
                                        </div>
                                        <div>
                                            {viewCategory === 'ironman' && stats.totalScore > 0 &&
                                                <span style={{ fontSize: '0.8rem', fontWeight: 'bold', color: 'var(--success)' }}>{stats.totalScore} pts</span>
                                            }
                                            {viewCategory === 'combine' && stats.forty &&
                                                <span style={{ fontSize: '0.8rem', fontWeight: 'bold', color: 'var(--accent)' }}>{stats.forty}s</span>
                                            }
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                    </div>

                    {/* Editor & Graph */}
                    <div className="card" style={{ flex: 1, overflowY: 'auto' }}>
                        {selectedPlayer ? (
                            <>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                                    <h2 style={{ margin: 0 }}>{selectedPlayer.name} - {viewCategory === 'ironman' ? 'Iron Man' : 'Combine'}</h2>
                                    <div style={{ background: 'rgba(255,255,255,0.05)', padding: '0.5rem 1rem', borderRadius: '8px' }}>
                                        <span style={{ color: 'var(--text-secondary)', fontSize: '0.9rem' }}>Est. Weight: </span>
                                        <strong style={{ color: 'var(--accent)' }}>{playerWeight} lbs</strong>
                                    </div>
                                </div>

                                <div style={{ display: 'flex', gap: '2rem', flexWrap: 'wrap' }}>
                                    {/* Input Form */}
                                    <div style={{ flex: 1, minWidth: '350px' }}>
                                        <h4 style={{ borderBottom: '1px solid var(--border)', paddingBottom: '0.5rem', marginBottom: '1rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                            {editingEntryIndex !== null ? 'Edit Entry' : 'New Entry'}
                                            {editingEntryIndex !== null && (
                                                <button className="btn btn-secondary" style={{ fontSize: '0.8rem', padding: '2px 8px' }} onClick={handleCancelEdit}>Cancel</button>
                                            )}
                                        </h4>

                                        <div style={{ marginBottom: '1rem' }}>
                                            <label className="form-label">Session Date</label>
                                            <input
                                                type="date"
                                                className="form-input"
                                                value={entryDate}
                                                onChange={e => setEntryDate(e.target.value)}
                                            />
                                        </div>

                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>
                                            {Object.entries(groupedFields).map(([groupName, fields]) => (
                                                <div key={groupName}>
                                                    <h5 style={{ color: 'var(--accent)', borderBottom: '1px dashed var(--border)', paddingBottom: '0.25rem', marginBottom: '0.5rem' }}>{groupName}</h5>
                                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.5rem 1rem' }}>
                                                        {fields.map(field => {
                                                            const currentVal = currentEntry[field.id];
                                                            const score = calculateIronManScore(field.id, currentVal, playerWeight);
                                                            return (
                                                                <div key={field.id}>
                                                                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                                                        <label className="form-label" style={{ fontSize: '0.8rem' }}>{field.name}</label>
                                                                        {score > 0 && <span style={{ fontSize: '0.75rem', color: 'var(--success)' }}>{score} pts</span>}
                                                                    </div>
                                                                    <input
                                                                        type={field.type}
                                                                        step={field.step}
                                                                        className="form-input"
                                                                        value={currentVal || ''}
                                                                        onChange={e => handleEntryChange(field.id, e.target.value)}
                                                                        placeholder={field.unit}
                                                                        style={{ padding: '0.5rem' }}
                                                                    />
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>

                                        <button className={`btn ${editingEntryIndex !== null ? 'btn-warning' : 'btn-primary'}`} style={{ marginTop: '1.5rem', width: '100%' }} onClick={handleSaveEntry}>
                                            {editingEntryIndex !== null ? 'Update Entry' : 'Save Entry'}
                                        </button>
                                    </div>

                                    {/* History Table */}
                                    <div style={{ flex: 1, minWidth: '300px' }}>
                                        <h4 style={{ borderBottom: '1px solid var(--border)', paddingBottom: '0.5rem', marginBottom: '1rem' }}>History</h4>
                                        <div style={{ maxHeight: '600px', overflowY: 'auto' }}>
                                            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '0.85rem' }}>
                                                <thead>
                                                    <tr style={{ textAlign: 'left', borderBottom: '1px solid var(--border)' }}>
                                                        <th style={{ padding: '0.5rem' }}>Date</th>
                                                        {viewCategory === 'ironman' && <th style={{ padding: '0.5rem' }}>Score</th>}
                                                        {activeFields.slice(0, 3).map(f => <th key={f.id} style={{ padding: '0.5rem' }}>{f.name}</th>)}
                                                        <th style={{ padding: '0.5rem' }}>Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {history.map((e, i) => ({ ...e, originalIndex: i })).reverse().map((entry, idx) => (
                                                        <tr key={idx} style={{ borderBottom: '1px solid var(--border)' }}>
                                                            <td style={{ padding: '0.5rem', color: 'var(--text-secondary)' }}>{entry.date}</td>
                                                            {viewCategory === 'ironman' && <td style={{ padding: '0.5rem', fontWeight: 'bold', color: 'var(--accent)' }}>{entry.totalScore || '-'}</td>}
                                                            {activeFields.slice(0, 3).map(f => (
                                                                <td key={f.id} style={{ padding: '0.5rem', fontWeight: entry[f.id] ? 'bold' : 'normal' }}>
                                                                    {entry[f.id] || '-'}
                                                                    {entry.scores && entry.scores[f.id] && viewCategory === 'ironman' && <div style={{ fontSize: '0.7rem', color: 'var(--text-secondary)' }}>{entry.scores[f.id]} pts</div>}
                                                                </td>
                                                            ))}
                                                            <td style={{ padding: '0.5rem' }}>
                                                                <button
                                                                    className="btn btn-secondary"
                                                                    style={{ padding: '2px 6px', fontSize: '0.75rem' }}
                                                                    onClick={() => handleEditEntry(entry.originalIndex, entry)}
                                                                >
                                                                    Edit
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                {/* Graph Section */}
                                {history.length >= 2 && (
                                    <div style={{ marginTop: '2rem' }}>
                                        <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem', overflowX: 'auto', paddingBottom: '0.5rem' }}>
                                            {activeFields.map(f => (
                                                <button
                                                    key={f.id}
                                                    className={`btn ${graphMetric === f.id ? 'btn-primary' : 'btn-secondary'}`}
                                                    style={{ fontSize: '0.8rem', padding: '0.25rem 0.5rem', whiteSpace: 'nowrap' }}
                                                    onClick={() => setGraphMetric(f.id)}
                                                >
                                                    {f.name}
                                                </button>
                                            ))}
                                        </div>
                                        <MetricGraph history={history} field={METRIC_FIELDS.find(f => f.id === graphMetric)} />
                                    </div>
                                )}
                            </>
                        ) : (
                            <div style={{ height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'var(--text-secondary)', flexDirection: 'column' }}>
                                <Icon name="Activity" />
                                <p style={{ marginTop: '1rem' }}>Select a player to manage testing data</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };


        const CollapsibleCategory = ({ title, icon, children, defaultOpen = false, nested = false }) => {
            const [isOpen, setIsOpen] = useState(defaultOpen);
            return (
                <div style={{ marginBottom: '0.5rem' }}>
                    <div
                        onClick={() => setIsOpen(!isOpen)}
                        style={{
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'space-between',
                            padding: nested ? '0.5rem 0.5rem 0.5rem 2rem' : '0.75rem 0.5rem',
                            cursor: 'pointer',
                            color: 'var(--text-secondary)',
                            fontWeight: nested ? '500' : 'bold',
                            fontSize: '0.9rem',
                            borderRadius: '6px',
                            transition: 'background 0.2s',
                            userSelect: 'none'
                        }}
                        className="nav-category-header"
                        onMouseEnter={e => e.currentTarget.style.background = 'rgba(255,255,255,0.05)'}
                        onMouseLeave={e => e.currentTarget.style.background = 'transparent'}
                    >
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                            {icon && <Icon name={icon} size={nested ? 16 : 18} />}
                            <span style={{
                                textTransform: nested ? 'none' : 'uppercase',
                                letterSpacing: nested ? 'normal' : '0.05em',
                                fontSize: nested ? '0.9rem' : '0.8rem'
                            }}>{title}</span>
                        </div>
                        <span style={{ fontSize: '0.8rem' }}>
                            <Icon name={isOpen ? "ChevronDown" : "ChevronRight"} />
                        </span>
                    </div>
                    {isOpen && (
                        <div style={{ paddingLeft: '0.5rem', display: 'flex', flexDirection: 'column', gap: '0.25rem' }}>
                            {children}
                        </div>
                    )}
                </div>
            );
        };

        const useLocalStorage = (key, initialValue) => {
            const [storedValue, setStoredValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    console.error(error);
                    return initialValue;
                }
            });

            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch (error) {
                    console.error(error);
                }
            };

            return [storedValue, setValue];
        };


        const DRILL_DATA = [
            // OFFENSE
            { id: 'off_1', title: 'QB Drops & Footwork', type: 'offense', category: 'QB', videoUrl: 'https://www.youtube.com/embed/dQw4w9WgXcQ', description: 'Focus on 3-step, 5-step, and rollout mechanics. Maintain eye level.' },
            { id: 'off_2', title: 'RB Ball Security Gauntlet', type: 'offense', category: 'RB', videoUrl: '', description: 'High and tight. Rip attempts by defenders. Finish through the line.' },
            { id: 'off_3', title: 'WR Stalk Blocking', type: 'offense', category: 'WR', videoUrl: '', description: 'Break down in space. Mirror the defender. Hands inside.' },
            { id: 'off_4', title: 'OL Combo Blocks', type: 'offense', category: 'OL', videoUrl: '', description: 'Hip to hip. Overtake technique. Communication is key.' },
            { id: 'off_5', title: 'Route Tree Precision', type: 'offense', category: 'WR', videoUrl: '', description: 'Sharp cuts at correct depths. Speed out, Post, Dig, Comeback.' },
            { id: 'off_6', title: 'Mesh Point Drill', type: 'offense', category: 'QB', videoUrl: '', description: 'QB/RB exchange work. Read key defenders for RPO actions.' },

            // DEFENSE
            { id: 'def_1', title: 'Tackling: Profile & Drive', type: 'defense', category: 'LB', videoUrl: '', description: 'Heads up tackling. Near foot, near shoulder. Drive for 5.' },
            { id: 'def_2', title: 'DB Backpedal & Break', type: 'defense', category: 'DB', videoUrl: '', description: 'Smooth pedal. Low hips. Explode out of the break on receiver visual.' },
            { id: 'def_3', title: 'DL Get Off', type: 'defense', category: 'DL', videoUrl: '', description: 'React to ball movement. Low pad level. Hand violence.' },
            { id: 'def_4', title: 'Shed & Scrape', type: 'defense', category: 'LB', videoUrl: '', description: 'Disengage blocks. Lateral movement to gap. Flow to the ball.' },
            { id: 'def_5', title: 'Open Field Tackle', type: 'defense', category: 'DB', videoUrl: '', description: 'Closing space. Coming to balance. Angle preservation.' },

            // SPECIAL / CIRCUIT / GROUP
            { id: 'spec_1', title: 'Gunner Release', type: 'special', category: 'Punt', videoUrl: '', description: 'Beating the jam. Stack and restack. Speed to the ball.' },
            { id: 'grp_1', title: 'Inside Run (9-on-7)', type: 'group', category: 'Run', videoUrl: '', description: 'Physical run game work. Focus on double teams and LB fills.' },
            { id: 'circ_1', title: 'Agility Station', type: 'circuit', category: 'Agility', videoUrl: '', description: 'Cone drills. Pro agility. L-Drill. Ladder work.' },
            { id: 'circ_2', title: 'Turnover Circuit', type: 'circuit', category: 'Ball', videoUrl: '', description: 'Must have ball drills. Strip sacks. Interceptions. Fumble recovery.' },
            { id: 'grp_2', title: '7-on-7 Pass Skelly', type: 'group', category: 'Pass', videoUrl: '', description: 'Passing concepts vs coverage. No pass rush. Timing focus.' },
        ];

        const DrillLibraryView = () => {
            const [selectedDrill, setSelectedDrill] = useState(null);
            const [activeOffFilter, setActiveOffFilter] = useState('ALL');
            const [activeDefFilter, setActiveDefFilter] = useState('ALL');

            const offCategories = ['ALL', 'QB', 'RB', 'WR', 'OL', 'TE'];
            const defCategories = ['ALL', 'DL', 'LB', 'DB'];

            const filterDrills = (type, categoryFilter) => {
                return DRILL_DATA.filter(d => d.type === type && (categoryFilter === 'ALL' || d.category === categoryFilter));
            };

            const renderDrillList = (drills, title) => (
                <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: '8px', padding: '1rem', height: '100%' }}>
                    <h3 style={{ borderBottom: '1px solid var(--border)', paddingBottom: '0.5rem', marginBottom: '1rem', color: 'var(--text-secondary)', fontSize: '1rem', textTransform: 'uppercase', letterSpacing: '0.05em' }}>
                        {title}
                    </h3>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                        {drills.length === 0 && <div style={{ color: 'var(--text-secondary)', fontStyle: 'italic', fontSize: '0.9rem' }}>No drills found.</div>}
                        {drills.map(drill => (
                            <div
                                key={drill.id}
                                onClick={() => setSelectedDrill(drill)}
                                className="drill-card"
                                style={{
                                    padding: '0.75rem',
                                    background: 'rgba(255,255,255,0.05)',
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s',
                                    border: '1px solid transparent'
                                }}
                                onMouseEnter={e => {
                                    e.currentTarget.style.background = 'rgba(255,255,255,0.1)';
                                    e.currentTarget.style.transform = 'translateX(4px)';
                                }}
                                onMouseLeave={e => {
                                    e.currentTarget.style.background = 'rgba(255,255,255,0.05)';
                                    e.currentTarget.style.transform = 'translateX(0)';
                                }}
                            >
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.25rem' }}>
                                    <span style={{ fontWeight: '600', color: 'var(--text-primary)' }}>{drill.title}</span>
                                    <span style={{ fontSize: '0.7rem', background: 'var(--accent)', color: 'white', padding: '2px 6px', borderRadius: '4px' }}>{drill.category}</span>
                                </div>
                                <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                    {drill.description}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            return (
                <div className="animate-fade-in" style={{ padding: '2rem', height: '100%', display: 'flex', flexDirection: 'column', gap: '2rem', overflowY: 'auto' }}>

                    <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                        <h1 style={{ fontSize: '2rem' }}>Practice <span style={{ color: 'var(--accent)' }}>Drill Library</span></h1>
                    </div>

                    {/* TOP SECTION: OFFENSE vs DEFENSE */}
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '2rem' }}>

                        {/* OFFENSE COLUMN */}
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                                <h2 style={{ fontSize: '1.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}><Icon name="Swords" color="#ef4444" /> Offensive Drills</h2>
                                <div style={{ display: 'flex', gap: '0.25rem' }}>
                                    {offCategories.map(cat => (
                                        <button
                                            key={cat}
                                            onClick={() => setActiveOffFilter(cat)}
                                            style={{
                                                padding: '4px 8px',
                                                fontSize: '0.75rem',
                                                borderRadius: '4px',
                                                border: 'none',
                                                background: activeOffFilter === cat ? 'var(--accent)' : 'rgba(255,255,255,0.1)',
                                                color: activeOffFilter === cat ? 'white' : 'var(--text-secondary)',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            {cat}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            {renderDrillList(filterDrills('offense', activeOffFilter), 'Position Drills')}
                        </div>

                        {/* DEFENSE COLUMN */}
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                                <h2 style={{ fontSize: '1.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}><Icon name="Shield" color="#3b82f6" /> Defensive Drills</h2>
                                <div style={{ display: 'flex', gap: '0.25rem' }}>
                                    {defCategories.map(cat => (
                                        <button
                                            key={cat}
                                            onClick={() => setActiveDefFilter(cat)}
                                            style={{
                                                padding: '4px 8px',
                                                fontSize: '0.75rem',
                                                borderRadius: '4px',
                                                border: 'none',
                                                background: activeDefFilter === cat ? 'var(--accent)' : 'rgba(255,255,255,0.1)',
                                                color: activeDefFilter === cat ? 'white' : 'var(--text-secondary)',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            {cat}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            {renderDrillList(filterDrills('defense', activeDefFilter), 'Position Drills')}
                        </div>
                    </div>

                    {/* BOTTOM SECTION: TEAM & SPECIAL */}
                    <div>
                        <h2 style={{ fontSize: '1.5rem', marginBottom: '1rem', borderBottom: '1px solid var(--border)', paddingBottom: '0.5rem' }}>Team, Circuit & Special Teams</h2>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '1.5rem' }}>
                            {renderDrillList(filterDrills('special', 'ALL'), 'Special Teams')}
                            {renderDrillList(filterDrills('group', 'ALL'), 'Group / Team')}
                            {renderDrillList(filterDrills('circuit', 'ALL'), 'Circuits')}
                        </div>
                    </div>

                    {/* VIDEO MODAL */}
                    {selectedDrill && (
                        <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.85)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, backdropFilter: 'blur(5px)' }} onClick={() => setSelectedDrill(null)}>
                            <div style={{ width: '800px', maxWidth: '90%', background: '#1e1e1e', borderRadius: '12px', padding: '0', overflow: 'hidden', boxShadow: '0 20px 50px rgba(0,0,0,0.5)', border: '1px solid var(--border)' }} onClick={e => e.stopPropagation()}>
                                <div style={{ padding: '1.5rem', borderBottom: '1px solid var(--border)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <h2 style={{ margin: 0, fontSize: '1.5rem' }}>{selectedDrill.title}</h2>
                                    <button onClick={() => setSelectedDrill(null)} style={{ background: 'none', border: 'none', color: 'var(--text-secondary)', fontSize: '1.5rem', cursor: 'pointer' }}>&times;</button>
                                </div>

                                <div style={{ padding: '2rem', display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>
                                    {/* Video Placeholder or Embed */}
                                    <div style={{ width: '100%', aspectRatio: '16/9', background: 'black', display: 'flex', alignItems: 'center', justifyContent: 'center', borderRadius: '8px', overflow: 'hidden' }}>
                                        {selectedDrill.videoUrl ? (
                                            <iframe width="100%" height="100%" src={selectedDrill.videoUrl} frameBorder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowFullScreen></iframe>
                                        ) : (
                                            <div style={{ textAlign: 'center', color: 'var(--text-secondary)' }}>
                                                <Icon name="Monitor" size={48} style={{ marginBottom: '1rem', opacity: 0.5 }} />
                                                <p>No video available for this drill.</p>
                                            </div>
                                        )}
                                    </div>

                                    <div>
                                        <h4 style={{ color: 'var(--accent)', marginBottom: '0.5rem', textTransform: 'uppercase', fontSize: '0.85rem' }}>Description / Key Coaching Points</h4>
                                        <p style={{ lineHeight: '1.6', color: 'var(--text-secondary)' }}>{selectedDrill.description}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const DailyReportsView = ({ roster, attendance, setAttendance, permissions = { view: true, edit: true } }) => {
            const [injuries, setInjuries] = useLocalStorage('oc-dashboard-injuries', []);
            const [scheduledEvents, setScheduledEvents] = useLocalStorage('oc-dashboard-scheduled-events', []);
            const [activeSection, setActiveSection] = useState('attendance'); // attendance, injuries, wellness

            // Attendance Events
            const ATTENDANCE_EVENTS = ['Weights', 'Film', 'Practice', 'Bus to', 'Bus home', 'Install'];
            const [attendanceDate, setAttendanceDate] = useState(new Date().toISOString().split('T')[0]);
            const [selectedEvent, setSelectedEvent] = useState('Practice');
            const [attendanceForm, setAttendanceForm] = useState({ playerId: '', status: 'Absent', notes: '' });

            // Event Scheduling
            const [showEventScheduler, setShowEventScheduler] = useState(false);
            const [schedulerDate, setSchedulerDate] = useState(new Date().toISOString().split('T')[0]);
            const [selectedEvents, setSelectedEvents] = useState([]);

            // Helper: Get scheduled events for a specific date
            const getEventsForDate = (date) => {
                const events = scheduledEvents.filter(e => e.date === date);
                return events.map(e => e.eventType);
            };

            // Helper: Add scheduled event
            const addScheduledEvent = (date, eventType, time = '') => {
                const newEvent = {
                    id: `evt_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    date,
                    eventType,
                    time
                };
                setScheduledEvents([...scheduledEvents, newEvent]);
            };

            // Helper: Remove scheduled events for a date
            const removeScheduledEventsForDate = (date) => {
                setScheduledEvents(scheduledEvents.filter(e => e.date !== date));
            };

            // Helper: Copy events from one date to another
            const copyEventsFromDate = (fromDate, toDate) => {
                const eventsToCopy = scheduledEvents.filter(e => e.date === fromDate);
                const newEvents = eventsToCopy.map(e => ({
                    ...e,
                    id: `evt_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    date: toDate
                }));
                setScheduledEvents([...scheduledEvents, ...newEvents]);
            };

            // Helper: Apply events to entire week
            const applyEventsToWeek = (startDate, events) => {
                const date = new Date(startDate);
                const newEvents = [];
                for (let i = 0; i < 7; i++) {
                    const currentDate = new Date(date);
                    currentDate.setDate(date.getDate() + i);
                    const dateStr = currentDate.toISOString().split('T')[0];
                    events.forEach(eventType => {
                        newEvents.push({
                            id: `evt_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            date: dateStr,
                            eventType,
                            time: ''
                        });
                    });
                }
                // Remove existing events for the week first
                const weekDates = [];
                for (let i = 0; i < 7; i++) {
                    const currentDate = new Date(date);
                    currentDate.setDate(date.getDate() + i);
                    weekDates.push(currentDate.toISOString().split('T')[0]);
                }
                const filteredEvents = scheduledEvents.filter(e => !weekDates.includes(e.date));
                setScheduledEvents([...filteredEvents, ...newEvents]);
            };

            // Injury Form
            const [injuryForm, setInjuryForm] = useState({
                playerId: '',
                description: '',
                status: 'active',
                followUpDate: '',
                returnToPlayDate: '',
                participationLevel: 'out',
                notes: ''
            });
            const [editingInjuryId, setEditingInjuryId] = useState(null);

            // Warrior Dial
            const [selectedWeek, setSelectedWeek] = useState(() => {
                const today = new Date();
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay());
                return startOfWeek.toISOString().split('T')[0];
            });
            const [selectedPlayerId, setSelectedPlayerId] = useState(null);

            const canEdit = permissions.edit;

            // --- Attendance Logic ---
            const markAttendance = (playerId, status) => {
                const player = roster.find(p => p.id === playerId);
                const existing = attendance.find(a =>
                    a.date === attendanceDate &&
                    a.eventType === selectedEvent &&
                    a.playerId === playerId
                );

                if (existing) {
                    setAttendance(attendance.map(a =>
                        a.id === existing.id ? { ...a, status } : a
                    ));
                } else {
                    const record = {
                        id: Date.now() + Math.random(),
                        date: attendanceDate,
                        eventType: selectedEvent,
                        playerId,
                        playerName: player ? `${player.firstName} ${player.lastName}` : 'Unknown',
                        status,
                        notes: ''
                    };
                    setAttendance([record, ...attendance]);
                }
            };

            const getAttendanceStatus = (playerId) => {
                const record = attendance.find(a =>
                    a.date === attendanceDate &&
                    a.eventType === selectedEvent &&
                    a.playerId === playerId
                );
                return record?.status || 'present';
            };

            const dailyAttendance = attendance.filter(a => a.date === attendanceDate && a.eventType === selectedEvent);
            const presentCount = roster.filter(p => getAttendanceStatus(p.id) === 'present').length;
            const absentCount = roster.filter(p => getAttendanceStatus(p.id) === 'absent').length;
            const excusedCount = roster.filter(p => getAttendanceStatus(p.id) === 'excused').length;

            // --- Injury Logic ---
            const addInjury = () => {
                if (!injuryForm.playerId || !injuryForm.description) return;
                const player = roster.find(p => p.id === injuryForm.playerId);

                if (editingInjuryId) {
                    setInjuries(injuries.map(i => i.id === editingInjuryId ? {
                        ...i,
                        playerId: injuryForm.playerId,
                        playerName: player ? `${player.firstName} ${player.lastName}` : 'Unknown',
                        description: injuryForm.description,
                        status: injuryForm.status,
                        followUpDate: injuryForm.followUpDate,
                        returnToPlayDate: injuryForm.returnToPlayDate,
                        participationLevel: injuryForm.participationLevel,
                        notes: injuryForm.notes
                    } : i));
                    setEditingInjuryId(null);
                } else {
                    const injury = {
                        id: Date.now(),
                        date: new Date().toISOString().split('T')[0],
                        playerId: injuryForm.playerId,
                        playerName: player ? `${player.firstName} ${player.lastName}` : 'Unknown',
                        description: injuryForm.description,
                        status: injuryForm.status,
                        followUpDate: injuryForm.followUpDate,
                        returnToPlayDate: injuryForm.returnToPlayDate,
                        participationLevel: injuryForm.participationLevel,
                        notes: injuryForm.notes
                    };
                    setInjuries([injury, ...injuries]);
                }
                setInjuryForm({ playerId: '', description: '', status: 'active', followUpDate: '', returnToPlayDate: '', participationLevel: 'out', notes: '' });
            };

            const editInjury = (id) => {
                const injury = injuries.find(i => i.id === id);
                if (!injury) return;
                setInjuryForm({
                    playerId: injury.playerId,
                    description: injury.description || injury.notes || '',
                    status: injury.status || 'active',
                    followUpDate: injury.followUpDate || '',
                    returnToPlayDate: injury.returnToPlayDate || injury.returnDate || '',
                    participationLevel: injury.participationLevel || 'out',
                    notes: injury.notes || ''
                });
                setEditingInjuryId(id);
            };

            const removeInjury = (id) => {
                if (confirm("Remove this injury report?")) {
                    setInjuries(injuries.filter(i => i.id !== id));
                    if (editingInjuryId === id) {
                        setEditingInjuryId(null);
                        setInjuryForm({ playerId: '', description: '', status: 'active', followUpDate: '', returnToPlayDate: '', participationLevel: 'out', notes: '' });
                    }
                }
            };

            const activeInjuries = injuries.filter(i => i.status === 'active' || i.status === 'recovering');

            // --- Warrior Dial Logic ---
            const getWeekLogs = () => {
                const weekStart = new Date(selectedWeek);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 7);

                const logs = [];
                roster.forEach(player => {
                    const playerLogs = (player.metrics?.warriorDialLogs || []).filter(log => {
                        const logDate = new Date(log.date);
                        return logDate >= weekStart && logDate < weekEnd;
                    });
                    if (playerLogs.length > 0) {
                        logs.push({ player, logs: playerLogs });
                    }
                });
                return logs;
            };

            const calculateTeamAverages = () => {
                const weekLogs = getWeekLogs();
                if (weekLogs.length === 0) return null;

                const allLogs = weekLogs.flatMap(w => w.logs);
                const avg = (field) => {
                    const values = allLogs.map(l => l[field]).filter(v => v != null);
                    return values.length > 0 ? (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1) : 'N/A';
                };

                return {
                    readiness: avg('readiness'),
                    soreness: avg('soreness'),
                    fatigue: avg('fatigue'),
                    sleepQuality: avg('sleepQuality'),
                    mood: avg('mood')
                };
            };

            const teamAvg = calculateTeamAverages();
            const weekLogs = getWeekLogs();

            const selectedPlayerData = selectedPlayerId ? weekLogs.find(w => w.player.id === selectedPlayerId) : null;

            return (
                <div className="animate-fade-in" style={{ padding: '1rem', maxWidth: '1400px', margin: '0 auto' }}>
                    <h1 style={{ marginBottom: '1.5rem', borderBottom: '1px solid var(--border)', paddingBottom: '0.5rem', color: 'var(--accent)' }}>
                        Daily Reports
                    </h1>

                    {/* Section Tabs */}
                    <div style={{ display: 'flex', gap: '1rem', marginBottom: '2rem', borderBottom: '2px solid var(--border)' }}>
                        {[
                            { id: 'attendance', label: 'Attendance', icon: 'Clipboard' },
                            { id: 'injuries', label: 'Injury Report', icon: 'Activity' },
                            { id: 'wellness', label: 'Warrior Dial Dashboard', icon: 'Heart' }
                        ].map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => setActiveSection(tab.id)}
                                style={{
                                    padding: '0.75rem 1.5rem',
                                    background: 'none',
                                    border: 'none',
                                    borderBottom: activeSection === tab.id ? '3px solid var(--accent)' : '3px solid transparent',
                                    color: activeSection === tab.id ? 'var(--accent)' : 'var(--text-secondary)',
                                    fontWeight: activeSection === tab.id ? 'bold' : 'normal',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '0.5rem'
                                }}
                            >
                                <Icon name={tab.icon} size={18} />
                                {tab.label}
                            </button>
                        ))}
                    </div>

                    {/* ATTENDANCE SECTION */}
                    {activeSection === 'attendance' && (
                        <div>
                            {/* Controls */}
                            <div className="card" style={{ marginBottom: '1.5rem', padding: '1.5rem' }}>
                                <div style={{ display: 'flex', gap: '1rem', alignItems: 'center', flexWrap: 'wrap' }}>
                                    <div>
                                        <label style={{ color: 'var(--text-secondary)', fontSize: '0.9rem', marginRight: '0.5rem' }}>Date:</label>
                                        <input
                                            type="date"
                                            className="form-input"
                                            value={attendanceDate}
                                            onChange={e => {
                                                setAttendanceDate(e.target.value);
                                                // Auto-select first event for the new date
                                                const eventsForDate = getEventsForDate(e.target.value);
                                                if (eventsForDate.length > 0) {
                                                    setSelectedEvent(eventsForDate[0]);
                                                }
                                            }}
                                        />
                                    </div>
                                    <div>
                                        <label style={{ color: 'var(--text-secondary)', fontSize: '0.9rem', marginRight: '0.5rem' }}>Event:</label>
                                        <select
                                            className="form-input"
                                            value={selectedEvent}
                                            onChange={e => setSelectedEvent(e.target.value)}
                                        >
                                            {getEventsForDate(attendanceDate).map(event => (
                                                <option key={event} value={event}>{event}</option>
                                            ))}
                                        </select>
                                        {scheduledEvents.filter(e => e.date === attendanceDate).length > 0 && (
                                            <span style={{ marginLeft: '0.5rem', fontSize: '0.85rem', color: 'var(--accent)' }}>
                                                ({scheduledEvents.filter(e => e.date === attendanceDate).length} scheduled)
                                            </span>
                                        )}
                                    </div>
                                    {canEdit && (
                                        <button
                                            className="btn"
                                            onClick={() => {
                                                setSchedulerDate(attendanceDate);
                                                const eventsForDate = scheduledEvents.filter(e => e.date === attendanceDate);
                                                setSelectedEvents(eventsForDate.map(e => e.eventType));
                                                setShowEventScheduler(true);
                                            }}
                                            style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}
                                        >
                                            <Icon name="Calendar" size={16} />
                                            Manage Events
                                        </button>
                                    )}
                                    <div style={{ marginLeft: 'auto', display: 'flex', gap: '1.5rem', fontSize: '0.9rem' }}>
                                        <div><strong style={{ color: '#22c55e' }}>{presentCount}</strong> Present</div>
                                        <div><strong style={{ color: '#ef4444' }}>{absentCount}</strong> Absent</div>
                                        <div><strong style={{ color: '#eab308' }}>{excusedCount}</strong> Excused</div>
                                    </div>
                                </div>
                            </div>

                            {/* Roster Grid */}
                            {getEventsForDate(attendanceDate).length === 0 ? (
                                <div className="card" style={{ padding: '3rem', textAlign: 'center' }}>
                                    <Icon name="Calendar" size={48} color="var(--text-secondary)" style={{ opacity: 0.5, marginBottom: '1rem' }} />
                                    <h3 style={{ color: 'var(--text-secondary)', marginBottom: '0.5rem' }}>No Events Scheduled</h3>
                                    <p style={{ color: 'var(--text-secondary)', marginBottom: '1.5rem' }}>
                                        There are no events scheduled for {new Date(attendanceDate).toLocaleDateString()}.
                                    </p>
                                    {canEdit && (
                                        <button
                                            className="btn btn-primary"
                                            onClick={() => {
                                                setSchedulerDate(attendanceDate);
                                                setSelectedEvents([]);
                                                setShowEventScheduler(true);
                                            }}
                                            style={{ display: 'inline-flex', alignItems: 'center', gap: '0.5rem' }}
                                        >
                                            <Icon name="Calendar" size={16} />
                                            Schedule Events for This Date
                                        </button>
                                    )}
                                </div>
                            ) : (
                                <div className="card">
                                    <h3 style={{ marginBottom: '1rem' }}>Mark Attendance for {selectedEvent}</h3>
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))', gap: '0.5rem' }}>
                                        {roster.sort((a, b) => a.lastName.localeCompare(b.lastName)).map(player => {
                                            const status = getAttendanceStatus(player.id);
                                            return (
                                                <div
                                                    key={player.id}
                                                    style={{
                                                        padding: '0.75rem',
                                                        background: status === 'present' ? 'rgba(34, 197, 94, 0.1)' :
                                                            status === 'absent' ? 'rgba(239, 68, 68, 0.1)' :
                                                                status === 'excused' ? 'rgba(234, 179, 8, 0.1)' :
                                                                    'rgba(255,255,255,0.02)',
                                                        borderRadius: '6px',
                                                        borderLeft: `4px solid ${status === 'present' ? '#22c55e' :
                                                            status === 'absent' ? '#ef4444' :
                                                                status === 'excused' ? '#eab308' : '#64748b'
                                                            }`,
                                                        display: 'flex',
                                                        justifyContent: 'space-between',
                                                        alignItems: 'center'
                                                    }}
                                                >
                                                    <div>
                                                        <div style={{ fontWeight: 'bold' }}>#{player.jersey} {player.lastName}</div>
                                                        <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>{player.firstName}</div>
                                                    </div>
                                                    {canEdit && (
                                                        <div style={{ display: 'flex', gap: '0.25rem' }}>
                                                            <button
                                                                onClick={() => markAttendance(player.id, 'present')}
                                                                style={{
                                                                    padding: '0.25rem 0.5rem',
                                                                    background: status === 'present' ? '#22c55e' : 'rgba(34, 197, 94, 0.2)',
                                                                    border: 'none',
                                                                    borderRadius: '4px',
                                                                    cursor: 'pointer',
                                                                    fontSize: '0.75rem',
                                                                    color: 'white'
                                                                }}
                                                            >‚úì</button>
                                                            <button
                                                                onClick={() => markAttendance(player.id, 'absent')}
                                                                style={{
                                                                    padding: '0.25rem 0.5rem',
                                                                    background: status === 'absent' ? '#ef4444' : 'rgba(239, 68, 68, 0.2)',
                                                                    border: 'none',
                                                                    borderRadius: '4px',
                                                                    cursor: 'pointer',
                                                                    fontSize: '0.75rem',
                                                                    color: 'white'
                                                                }}
                                                            >‚úó</button>
                                                            <button
                                                                onClick={() => markAttendance(player.id, 'excused')}
                                                                style={{
                                                                    padding: '0.25rem 0.5rem',
                                                                    background: status === 'excused' ? '#eab308' : 'rgba(234, 179, 8, 0.2)',
                                                                    border: 'none',
                                                                    borderRadius: '4px',
                                                                    cursor: 'pointer',
                                                                    fontSize: '0.75rem',
                                                                    color: 'white'
                                                                }}
                                                            >E</button>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* EVENT SCHEDULER MODAL */}
                    {showEventScheduler && (
                        <div
                            style={{
                                position: 'fixed',
                                top: 0,
                                left: 0,
                                width: '100%',
                                height: '100%',
                                background: 'rgba(0,0,0,0.8)',
                                zIndex: 3000,
                                display: 'flex',
                                justifyContent: 'center',
                                alignItems: 'center'
                            }}
                            onClick={() => setShowEventScheduler(false)}
                        >
                            <div
                                className="card"
                                style={{ width: '90%', maxWidth: '600px', padding: '2rem' }}
                                onClick={e => e.stopPropagation()}
                            >
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                                    <h2 style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                        <Icon name="Calendar" color="var(--accent)" />
                                        Manage Events
                                    </h2>
                                    <button onClick={() => setShowEventScheduler(false)} style={{ background: 'none', border: 'none', fontSize: '1.5rem', cursor: 'pointer' }}>√ó</button>
                                </div>

                                {/* Date Selector */}
                                <div style={{ marginBottom: '1.5rem' }}>
                                    <label style={{ display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' }}>Select Date:</label>
                                    <input
                                        type="date"
                                        className="form-input"
                                        value={schedulerDate}
                                        onChange={e => {
                                            setSchedulerDate(e.target.value);
                                            const eventsForDate = scheduledEvents.filter(ev => ev.date === e.target.value);
                                            setSelectedEvents(eventsForDate.map(ev => ev.eventType));
                                        }}
                                        style={{ width: '100%' }}
                                    />
                                </div>

                                {/* Event Checklist */}
                                <div style={{ marginBottom: '1.5rem' }}>
                                    <label style={{ display: 'block', marginBottom: '0.75rem', fontWeight: 'bold' }}>Select Events for this Date:</label>
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '0.75rem' }}>
                                        {ATTENDANCE_EVENTS.map(event => (
                                            <label
                                                key={event}
                                                style={{
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '0.5rem',
                                                    padding: '0.75rem',
                                                    background: selectedEvents.includes(event) ? 'rgba(59, 130, 246, 0.2)' : 'rgba(255,255,255,0.05)',
                                                    borderRadius: '6px',
                                                    cursor: 'pointer',
                                                    border: selectedEvents.includes(event) ? '2px solid var(--accent)' : '2px solid transparent',
                                                    transition: 'all 0.2s'
                                                }}
                                            >
                                                <input
                                                    type="checkbox"
                                                    checked={selectedEvents.includes(event)}
                                                    onChange={e => {
                                                        if (e.target.checked) {
                                                            setSelectedEvents([...selectedEvents, event]);
                                                        } else {
                                                            setSelectedEvents(selectedEvents.filter(ev => ev !== event));
                                                        }
                                                    }}
                                                    style={{ cursor: 'pointer' }}
                                                />
                                                <span style={{ fontWeight: selectedEvents.includes(event) ? 'bold' : 'normal' }}>{event}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>

                                {/* Convenience Features */}
                                <div style={{ marginBottom: '1.5rem', padding: '1rem', background: 'rgba(255,255,255,0.03)', borderRadius: '8px' }}>
                                    <div style={{ fontSize: '0.9rem', fontWeight: 'bold', marginBottom: '0.75rem', color: 'var(--text-secondary)' }}>Quick Actions:</div>
                                    <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                                        <button
                                            className="btn"
                                            onClick={() => {
                                                const yesterday = new Date(schedulerDate);
                                                yesterday.setDate(yesterday.getDate() - 1);
                                                const yesterdayStr = yesterday.toISOString().split('T')[0];
                                                const yesterdayEvents = scheduledEvents.filter(e => e.date === yesterdayStr);
                                                if (yesterdayEvents.length > 0) {
                                                    setSelectedEvents(yesterdayEvents.map(e => e.eventType));
                                                }
                                            }}
                                            style={{ fontSize: '0.85rem' }}
                                        >
                                            Copy from Yesterday
                                        </button>
                                        <button
                                            className="btn"
                                            onClick={() => {
                                                if (selectedEvents.length > 0) {
                                                    const weekStart = new Date(schedulerDate);
                                                    applyEventsToWeek(weekStart.toISOString().split('T')[0], selectedEvents);
                                                    setShowEventScheduler(false);
                                                }
                                            }}
                                            style={{ fontSize: '0.85rem', background: 'var(--accent)', color: 'white' }}
                                        >
                                            Apply to Entire Week
                                        </button>
                                        <button
                                            className="btn"
                                            onClick={() => {
                                                removeScheduledEventsForDate(schedulerDate);
                                                setSelectedEvents([]);
                                            }}
                                            style={{ fontSize: '0.85rem', background: '#ef4444', color: 'white' }}
                                        >
                                            Clear All
                                        </button>
                                    </div>
                                </div>

                                {/* Action Buttons */}
                                <div style={{ display: 'flex', gap: '0.75rem', justifyContent: 'flex-end' }}>
                                    <button
                                        className="btn"
                                        onClick={() => setShowEventScheduler(false)}
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        className="btn btn-primary"
                                        onClick={() => {
                                            // Remove existing events for this date
                                            removeScheduledEventsForDate(schedulerDate);
                                            // Add selected events
                                            selectedEvents.forEach(eventType => {
                                                addScheduledEvent(schedulerDate, eventType);
                                            });
                                            setShowEventScheduler(false);
                                        }}
                                    >
                                        Save Events
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* INJURY REPORT SECTION */}
                    {activeSection === 'injuries' && (
                        <div className="card">
                            <h2 style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '1rem', color: '#ef4444' }}>
                                <Icon name="Activity" color="#ef4444" /> Injury Report
                            </h2>

                            {/* Form */}
                            {canEdit && (
                                <div style={{ background: 'rgba(255,255,255,0.03)', padding: '1.5rem', borderRadius: '8px', marginBottom: '1.5rem', border: '1px solid rgba(255,255,255,0.05)' }}>
                                    <div style={{ display: 'grid', gridTemplateColumns: '2fr 2fr 1fr', gap: '0.75rem', marginBottom: '0.75rem' }}>
                                        <select
                                            className="form-input"
                                            value={injuryForm.playerId}
                                            onChange={e => setInjuryForm({ ...injuryForm, playerId: e.target.value })}
                                        >
                                            <option value="">Select Player...</option>
                                            {roster.sort((a, b) => a.lastName.localeCompare(b.lastName)).map(p => (
                                                <option key={p.id} value={p.id}>{p.lastName}, {p.firstName} (#{p.jersey})</option>
                                            ))}
                                        </select>
                                        <input
                                            className="form-input"
                                            placeholder="Injury description (e.g., Ankle sprain)"
                                            value={injuryForm.description}
                                            onChange={e => setInjuryForm({ ...injuryForm, description: e.target.value })}
                                        />
                                        <select
                                            className="form-input"
                                            value={injuryForm.participationLevel}
                                            onChange={e => setInjuryForm({ ...injuryForm, participationLevel: e.target.value })}
                                        >
                                            <option value="full">Full</option>
                                            <option value="limited">Limited</option>
                                            <option value="non-contact">Non-Contact</option>
                                            <option value="out">Out</option>
                                        </select>
                                    </div>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '0.75rem', marginBottom: '0.75rem' }}>
                                        <div>
                                            <label style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>Follow-Up Date</label>
                                            <input
                                                type="date"
                                                className="form-input"
                                                value={injuryForm.followUpDate}
                                                onChange={e => setInjuryForm({ ...injuryForm, followUpDate: e.target.value })}
                                            />
                                        </div>
                                        <div>
                                            <label style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>Return to Play Date</label>
                                            <input
                                                type="date"
                                                className="form-input"
                                                value={injuryForm.returnToPlayDate}
                                                onChange={e => setInjuryForm({ ...injuryForm, returnToPlayDate: e.target.value })}
                                            />
                                        </div>
                                        <div>
                                            <label style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>Status</label>
                                            <select
                                                className="form-input"
                                                value={injuryForm.status}
                                                onChange={e => setInjuryForm({ ...injuryForm, status: e.target.value })}
                                            >
                                                <option value="active">Active</option>
                                                <option value="recovering">Recovering</option>
                                                <option value="cleared">Cleared</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                                        <input
                                            className="form-input"
                                            placeholder="Additional notes..."
                                            value={injuryForm.notes}
                                            onChange={e => setInjuryForm({ ...injuryForm, notes: e.target.value })}
                                            style={{ flex: 1 }}
                                        />
                                        <button className="btn btn-primary" onClick={addInjury}>
                                            {editingInjuryId ? 'Update' : 'Add Injury'}
                                        </button>
                                        {editingInjuryId && (
                                            <button className="btn" onClick={() => {
                                                setEditingInjuryId(null);
                                                setInjuryForm({ playerId: '', description: '', status: 'active', followUpDate: '', returnToPlayDate: '', participationLevel: 'out', notes: '' });
                                            }}>Cancel</button>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* Active Injuries Table */}
                            <div style={{ overflowX: 'auto' }}>
                                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                    <thead>
                                        <tr style={{ background: 'rgba(255,255,255,0.05)', borderBottom: '2px solid var(--border)' }}>
                                            <th style={{ padding: '0.75rem', textAlign: 'left' }}>Player</th>
                                            <th style={{ padding: '0.75rem', textAlign: 'left' }}>Injury</th>
                                            <th style={{ padding: '0.75rem', textAlign: 'center' }}>Participation</th>
                                            <th style={{ padding: '0.75rem', textAlign: 'center' }}>Follow-Up</th>
                                            <th style={{ padding: '0.75rem', textAlign: 'center' }}>Return Date</th>
                                            <th style={{ padding: '0.75rem', textAlign: 'left' }}>Notes</th>
                                            {canEdit && <th style={{ padding: '0.75rem', textAlign: 'center' }}>Actions</th>}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {activeInjuries.length === 0 ? (
                                            <tr>
                                                <td colSpan="7" style={{ padding: '2rem', textAlign: 'center', color: 'var(--text-secondary)', fontStyle: 'italic' }}>
                                                    No active injuries reported.
                                                </td>
                                            </tr>
                                        ) : (
                                            activeInjuries.sort((a, b) => {
                                                if (!a.returnToPlayDate && !b.returnToPlayDate) return 0;
                                                if (!a.returnToPlayDate) return 1;
                                                if (!b.returnToPlayDate) return -1;
                                                return new Date(a.returnToPlayDate) - new Date(b.returnToPlayDate);
                                            }).map(injury => {
                                                const levelColor = {
                                                    'full': '#22c55e',
                                                    'limited': '#eab308',
                                                    'non-contact': '#f97316',
                                                    'out': '#ef4444'
                                                }[injury.participationLevel || 'out'];

                                                return (
                                                    <tr key={injury.id} style={{ borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                                        <td style={{ padding: '0.75rem', fontWeight: 'bold' }}>{injury.playerName}</td>
                                                        <td style={{ padding: '0.75rem' }}>{injury.description || injury.notes}</td>
                                                        <td style={{ padding: '0.75rem', textAlign: 'center' }}>
                                                            <span style={{
                                                                padding: '0.25rem 0.75rem',
                                                                borderRadius: '12px',
                                                                background: levelColor + '20',
                                                                color: levelColor,
                                                                fontSize: '0.85rem',
                                                                fontWeight: 'bold',
                                                                textTransform: 'capitalize'
                                                            }}>
                                                                {injury.participationLevel || 'out'}
                                                            </span>
                                                        </td>
                                                        <td style={{ padding: '0.75rem', textAlign: 'center', fontSize: '0.9rem' }}>
                                                            {injury.followUpDate || '-'}
                                                        </td>
                                                        <td style={{ padding: '0.75rem', textAlign: 'center', fontSize: '0.9rem', color: 'var(--accent)' }}>
                                                            {injury.returnToPlayDate || injury.returnDate || '-'}
                                                        </td>
                                                        <td style={{ padding: '0.75rem', fontSize: '0.85rem', color: 'var(--text-secondary)' }}>
                                                            {injury.notes || '-'}
                                                        </td>
                                                        {canEdit && (
                                                            <td style={{ padding: '0.75rem', textAlign: 'center' }}>
                                                                <div style={{ display: 'flex', gap: '0.5rem', justifyContent: 'center' }}>
                                                                    <button onClick={() => editInjury(injury.id)} style={{ background: 'none', border: 'none', cursor: 'pointer', opacity: 0.7 }}>‚úèÔ∏è</button>
                                                                    <button onClick={() => removeInjury(injury.id)} style={{ background: 'none', border: 'none', cursor: 'pointer', opacity: 0.7 }}>‚ùå</button>
                                                                </div>
                                                            </td>
                                                        )}
                                                    </tr>
                                                );
                                            })
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* WARRIOR DIAL DASHBOARD */}
                    {activeSection === 'wellness' && (
                        <div>
                            {/* Week Selector */}
                            <div className="card" style={{ marginBottom: '1.5rem', padding: '1rem' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                                    <label style={{ color: 'var(--text-secondary)' }}>Week Starting:</label>
                                    <input
                                        type="date"
                                        className="form-input"
                                        value={selectedWeek}
                                        onChange={e => setSelectedWeek(e.target.value)}
                                    />
                                </div>
                            </div>

                            {/* Team Averages */}
                            {teamAvg && (
                                <div className="card" style={{ marginBottom: '1.5rem', padding: '1.5rem', background: 'linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1))' }}>
                                    <h3 style={{ marginBottom: '1rem', color: 'var(--accent)' }}>Team Averages (This Week)</h3>
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '1rem' }}>
                                        {[
                                            { label: 'Readiness', value: teamAvg.readiness, color: '#22c55e' },
                                            { label: 'Soreness', value: teamAvg.soreness, color: '#f97316' },
                                            { label: 'Fatigue', value: teamAvg.fatigue, color: '#ef4444' },
                                            { label: 'Sleep Quality', value: teamAvg.sleepQuality, color: '#3b82f6' },
                                            { label: 'Mood', value: teamAvg.mood, color: '#a855f7' }
                                        ].map(metric => (
                                            <div key={metric.label} style={{ textAlign: 'center', padding: '1rem', background: 'rgba(255,255,255,0.05)', borderRadius: '8px' }}>
                                                <div style={{ fontSize: '2rem', fontWeight: 'bold', color: metric.color }}>{metric.value}</div>
                                                <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)', marginTop: '0.25rem' }}>{metric.label}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Individual Player Cards */}
                            <div className="card">
                                <h3 style={{ marginBottom: '1rem' }}>Individual Player Wellness</h3>
                                {weekLogs.length === 0 ? (
                                    <div style={{ padding: '2rem', textAlign: 'center', color: 'var(--text-secondary)', fontStyle: 'italic' }}>
                                        No wellness data for this week.
                                    </div>
                                ) : (
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', gap: '1rem' }}>
                                        {weekLogs.sort((a, b) => {
                                            const avgA = a.logs.reduce((sum, l) => sum + (l.readiness || 0), 0) / a.logs.length;
                                            const avgB = b.logs.reduce((sum, l) => sum + (l.readiness || 0), 0) / b.logs.length;
                                            return avgA - avgB; // Lowest readiness first
                                        }).map(({ player, logs }) => {
                                            const latestLog = logs[logs.length - 1];
                                            const avgReadiness = (logs.reduce((sum, l) => sum + (l.readiness || 0), 0) / logs.length).toFixed(1);
                                            const trend = logs.length >= 2 ?
                                                (logs[logs.length - 1].readiness > logs[logs.length - 2].readiness ? '‚Üë' :
                                                    logs[logs.length - 1].readiness < logs[logs.length - 2].readiness ? '‚Üì' : '‚Üí') : '‚Üí';

                                            return (
                                                <div
                                                    key={player.id}
                                                    onClick={() => setSelectedPlayerId(player.id)}
                                                    style={{
                                                        padding: '1rem',
                                                        background: avgReadiness < 5 ? 'rgba(239, 68, 68, 0.1)' : 'rgba(255,255,255,0.02)',
                                                        borderRadius: '8px',
                                                        borderLeft: `4px solid ${avgReadiness < 5 ? '#ef4444' : avgReadiness < 7 ? '#eab308' : '#22c55e'}`,
                                                        cursor: 'pointer',
                                                        transition: 'all 0.2s'
                                                    }}
                                                    onMouseEnter={e => e.currentTarget.style.background = 'rgba(255,255,255,0.08)'}
                                                    onMouseLeave={e => e.currentTarget.style.background = avgReadiness < 5 ? 'rgba(239, 68, 68, 0.1)' : 'rgba(255,255,255,0.02)'}
                                                >
                                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>
                                                        <div style={{ fontWeight: 'bold' }}>#{player.jersey} {player.lastName}</div>
                                                        <div style={{ fontSize: '1.5rem' }}>{trend}</div>
                                                    </div>
                                                    <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)', marginBottom: '0.75rem' }}>
                                                        {logs.length} log{logs.length !== 1 ? 's' : ''} this week
                                                    </div>
                                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.5rem', fontSize: '0.85rem' }}>
                                                        <div>
                                                            <div style={{ color: 'var(--text-secondary)' }}>Avg Readiness</div>
                                                            <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: avgReadiness < 5 ? '#ef4444' : avgReadiness < 7 ? '#eab308' : '#22c55e' }}>
                                                                {avgReadiness}/10
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <div style={{ color: 'var(--text-secondary)' }}>Latest</div>
                                                            <div style={{ fontSize: '1.25rem', fontWeight: 'bold' }}>{latestLog.readiness}/10</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>

                            {/* Player Detail Modal */}
                            {selectedPlayerData && (
                                <div
                                    style={{
                                        position: 'fixed',
                                        top: 0,
                                        left: 0,
                                        width: '100%',
                                        height: '100%',
                                        background: 'rgba(0,0,0,0.8)',
                                        zIndex: 3000,
                                        display: 'flex',
                                        justifyContent: 'center',
                                        alignItems: 'center'
                                    }}
                                    onClick={() => setSelectedPlayerId(null)}
                                >
                                    <div
                                        className="card"
                                        style={{ width: '90%', maxWidth: '800px', maxHeight: '80vh', overflowY: 'auto', padding: '2rem' }}
                                        onClick={e => e.stopPropagation()}
                                    >
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                                            <h2>#{selectedPlayerData.player.jersey} {selectedPlayerData.player.firstName} {selectedPlayerData.player.lastName}</h2>
                                            <button onClick={() => setSelectedPlayerId(null)} style={{ background: 'none', border: 'none', fontSize: '1.5rem', cursor: 'pointer' }}>√ó</button>
                                        </div>
                                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem' }}>
                                            {selectedPlayerData.logs.sort((a, b) => new Date(b.date) - new Date(a.date)).map(log => (
                                                <div key={log.id} style={{ padding: '1rem', background: 'rgba(255,255,255,0.05)', borderRadius: '8px' }}>
                                                    <div style={{ fontWeight: 'bold', marginBottom: '0.5rem', color: 'var(--accent)' }}>
                                                        {new Date(log.date).toLocaleDateString()}
                                                    </div>
                                                    <div style={{ fontSize: '0.85rem', display: 'grid', gap: '0.25rem' }}>
                                                        <div>Readiness: <strong>{log.readiness}/10</strong></div>
                                                        <div>Soreness: {log.soreness}/10</div>
                                                        <div>Fatigue: {log.fatigue}/10</div>
                                                        <div>Sleep: {log.sleepQuality}/10</div>
                                                        <div>Mood: {log.mood}/10</div>
                                                        {log.pain && <div style={{ color: '#ef4444' }}>‚ö†Ô∏è {log.painLocation}</div>}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };


        // ============================================
        // PLAYER-FACING APP PREVIEW
        // ============================================
        const PlayerApp = ({ roster, attendance, setRoster, setAttendance }) => {
            const [selectedPlayerId, setSelectedPlayerId] = useState(roster.length > 0 ? roster[0].id : '');
            const [activeTab, setActiveTab] = useState('wellness'); // wellness, profile, attendance, achievements
            const [showCoachAlert, setShowCoachAlert] = useState(false);

            // Warrior Dial Form State
            const [wellnessForm, setWellnessForm] = useState({
                soreness: 5,
                fatigue: 5,
                stress: 5,
                mood: 5,
                sleepQuality: 5,
                sleepDuration: 7,
                pain: false,
                painLocation: '',
                painSeverity: 5,
                rpe: 5,
                notes: ''
            });

            const selectedPlayer = roster.find(p => p.id === selectedPlayerId);
            if (!selectedPlayer) return <div>No players found</div>;

            // Calculate readiness score
            const calculateReadiness = (form) => {
                const physical = (10 - form.soreness + 10 - form.fatigue) / 2;
                const mental = (10 - form.stress + form.mood) / 2;
                const sleep = form.sleepQuality;
                const readiness = ((physical + mental + sleep) / 3).toFixed(1);
                return parseFloat(readiness);
            };

            // Submit Warrior Dial
            const submitWellnessLog = () => {
                const readiness = calculateReadiness(wellnessForm);
                const newLog = {
                    id: `wdl_${Date.now()}`,
                    date: new Date().toISOString().split('T')[0],
                    ...wellnessForm,
                    readiness
                };

                const updatedRoster = roster.map(p => {
                    if (p.id === selectedPlayerId) {
                        return {
                            ...p,
                            metrics: {
                                ...p.metrics,
                                warriorDialLogs: [...(p.metrics.warriorDialLogs || []), newLog]
                            }
                        };
                    }
                    return p;
                });
                setRoster(updatedRoster);

                // Show alert if readiness is low
                if (readiness < 5) {
                    setShowCoachAlert(true);
                }

                // Reset form
                setWellnessForm({
                    soreness: 5,
                    fatigue: 5,
                    stress: 5,
                    mood: 5,
                    sleepQuality: 5,
                    sleepDuration: 7,
                    pain: false,
                    painLocation: '',
                    painSeverity: 5,
                    rpe: 5,
                    notes: ''
                });
            };

            // Get player's attendance records
            const playerAttendance = attendance.filter(a => a.playerId === selectedPlayerId);
            const attendanceStats = {
                total: playerAttendance.length,
                present: playerAttendance.filter(a => a.status === 'present').length,
                absent: playerAttendance.filter(a => a.status === 'absent').length,
                excused: playerAttendance.filter(a => a.status === 'excused').length
            };
            const attendancePercentage = attendanceStats.total > 0
                ? ((attendanceStats.present / attendanceStats.total) * 100).toFixed(1)
                : 0;

            // Calculate current streak
            const calculateStreak = () => {
                const sorted = [...playerAttendance].sort((a, b) => new Date(b.date) - new Date(a.date));
                let streak = 0;
                for (const record of sorted) {
                    if (record.status === 'present') streak++;
                    else break;
                }
                return streak;
            };

            return (
                <div style={{ maxWidth: '600px', margin: '0 auto', padding: '1rem' }}>
                    {/* Player Selector */}
                    <div className="card" style={{ marginBottom: '1.5rem', padding: '1.5rem', background: 'linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(99, 102, 241, 0.2))' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', marginBottom: '1rem' }}>
                            <div style={{
                                width: '60px',
                                height: '60px',
                                borderRadius: '50%',
                                background: 'var(--accent)',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '1.5rem',
                                fontWeight: 'bold',
                                color: 'white'
                            }}>
                                {selectedPlayer.jersey}
                            </div>
                            <div style={{ flex: 1 }}>
                                <select
                                    className="form-input"
                                    value={selectedPlayerId}
                                    onChange={e => setSelectedPlayerId(e.target.value)}
                                    style={{ fontSize: '1.1rem', fontWeight: 'bold' }}
                                >
                                    {roster.sort((a, b) => a.lastName.localeCompare(b.lastName)).map(p => (
                                        <option key={p.id} value={p.id}>
                                            {p.firstName} {p.lastName} (#{p.jersey})
                                        </option>
                                    ))}
                                </select>
                                <div style={{ fontSize: '0.9rem', color: 'var(--text-secondary)', marginTop: '0.25rem' }}>
                                    {selectedPlayer.position} ‚Ä¢ {selectedPlayer.year}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Tab Navigation */}
                    <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1.5rem', borderBottom: '2px solid var(--border)', overflowX: 'auto' }}>
                        {[
                            { id: 'wellness', label: 'Daily Check-In', icon: 'Heart' },
                            { id: 'profile', label: 'My Profile', icon: 'User' },
                            { id: 'attendance', label: 'Attendance', icon: 'Calendar' },
                            { id: 'achievements', label: 'Progress', icon: 'Award' }
                        ].map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)}
                                style={{
                                    padding: '0.75rem 1rem',
                                    background: 'none',
                                    border: 'none',
                                    borderBottom: activeTab === tab.id ? '3px solid var(--accent)' : '3px solid transparent',
                                    color: activeTab === tab.id ? 'var(--accent)' : 'var(--text-secondary)',
                                    fontWeight: activeTab === tab.id ? 'bold' : 'normal',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    flexDirection: 'column',
                                    alignItems: 'center',
                                    gap: '0.25rem',
                                    fontSize: '0.85rem',
                                    whiteSpace: 'nowrap'
                                }}
                            >
                                <Icon name={tab.icon} size={20} />
                                {tab.label}
                            </button>
                        ))}
                    </div>

                    {/* WELLNESS TAB */}
                    {activeTab === 'wellness' && (
                        <div className="card" style={{ padding: '1.5rem' }}>
                            <h2 style={{ marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                <Icon name="Heart" color="var(--accent)" />
                                Daily Wellness Check-In
                            </h2>
                            <p style={{ color: 'var(--text-secondary)', marginBottom: '1.5rem', fontSize: '0.9rem' }}>
                                How are you feeling today? Move the sliders to rate each area.
                            </p>

                            {/* Wellness Sliders */}
                            <div style={{ display: 'grid', gap: '1.5rem' }}>
                                {[
                                    { key: 'soreness', label: 'Muscle Soreness', color: '#f97316', inverse: true },
                                    { key: 'fatigue', label: 'Fatigue', color: '#ef4444', inverse: true },
                                    { key: 'stress', label: 'Stress Level', color: '#a855f7', inverse: true },
                                    { key: 'mood', label: 'Mood', color: '#22c55e', inverse: false },
                                    { key: 'sleepQuality', label: 'Sleep Quality', color: '#3b82f6', inverse: false }
                                ].map(item => (
                                    <div key={item.key}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                                            <label style={{ fontWeight: '500' }}>{item.label}</label>
                                            <span style={{
                                                fontWeight: 'bold',
                                                fontSize: '1.25rem',
                                                color: item.color
                                            }}>
                                                {wellnessForm[item.key]}/10
                                            </span>
                                        </div>
                                        <input
                                            type="range"
                                            min="1"
                                            max="10"
                                            value={wellnessForm[item.key]}
                                            onChange={e => setWellnessForm({ ...wellnessForm, [item.key]: parseInt(e.target.value) })}
                                            style={{
                                                width: '100%',
                                                height: '8px',
                                                borderRadius: '4px',
                                                outline: 'none',
                                                background: `linear-gradient(to right, ${item.color} 0%, ${item.color} ${wellnessForm[item.key] * 10}%, rgba(255,255,255,0.1) ${wellnessForm[item.key] * 10}%, rgba(255,255,255,0.1) 100%)`
                                            }}
                                        />
                                        <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.75rem', color: 'var(--text-secondary)', marginTop: '0.25rem' }}>
                                            <span>{item.inverse ? 'None' : 'Poor'}</span>
                                            <span>{item.inverse ? 'Extreme' : 'Excellent'}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* Pain Checkbox */}
                            <div style={{ marginTop: '1.5rem', padding: '1rem', background: 'rgba(239, 68, 68, 0.1)', borderRadius: '8px', border: '1px solid rgba(239, 68, 68, 0.3)' }}>
                                <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer' }}>
                                    <input
                                        type="checkbox"
                                        checked={wellnessForm.pain}
                                        onChange={e => setWellnessForm({ ...wellnessForm, pain: e.target.checked })}
                                    />
                                    <span style={{ fontWeight: 'bold' }}>I'm experiencing pain or discomfort</span>
                                </label>
                                {wellnessForm.pain && (
                                    <div style={{ marginTop: '1rem', display: 'grid', gap: '0.75rem' }}>
                                        <input
                                            className="form-input"
                                            placeholder="Where does it hurt? (e.g., Left knee, Right shoulder)"
                                            value={wellnessForm.painLocation}
                                            onChange={e => setWellnessForm({ ...wellnessForm, painLocation: e.target.value })}
                                        />
                                    </div>
                                )}
                            </div>

                            {/* Notes */}
                            <div style={{ marginTop: '1.5rem' }}>
                                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '500' }}>Additional Notes (Optional)</label>
                                <textarea
                                    className="form-input"
                                    placeholder="Anything else you want to share with the coaching staff?"
                                    value={wellnessForm.notes}
                                    onChange={e => setWellnessForm({ ...wellnessForm, notes: e.target.value })}
                                    rows={3}
                                    style={{ width: '100%', resize: 'vertical' }}
                                />
                            </div>

                            {/* Submit Button */}
                            <button
                                className="btn btn-primary"
                                onClick={submitWellnessLog}
                                style={{ width: '100%', marginTop: '1.5rem', padding: '1rem', fontSize: '1.1rem', fontWeight: 'bold' }}
                            >
                                Submit Daily Check-In
                            </button>

                            {/* Recent Logs */}
                            {selectedPlayer.metrics.warriorDialLogs && selectedPlayer.metrics.warriorDialLogs.length > 0 && (
                                <div style={{ marginTop: '2rem', paddingTop: '1.5rem', borderTop: '1px solid var(--border)' }}>
                                    <h3 style={{ marginBottom: '1rem' }}>Recent Check-Ins</h3>
                                    <div style={{ display: 'grid', gap: '0.75rem' }}>
                                        {selectedPlayer.metrics.warriorDialLogs.slice(-5).reverse().map(log => (
                                            <div key={log.id} style={{ padding: '0.75rem', background: 'rgba(255,255,255,0.05)', borderRadius: '6px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                <div>
                                                    <div style={{ fontWeight: 'bold' }}>{new Date(log.date).toLocaleDateString()}</div>
                                                    <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>
                                                        Soreness: {log.soreness} ‚Ä¢ Fatigue: {log.fatigue} ‚Ä¢ Sleep: {log.sleepQuality}
                                                    </div>
                                                </div>
                                                <div style={{
                                                    fontSize: '1.5rem',
                                                    fontWeight: 'bold',
                                                    color: log.readiness < 5 ? '#ef4444' : log.readiness < 7 ? '#eab308' : '#22c55e'
                                                }}>
                                                    {log.readiness}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Low Score Alert Modal */}
                    {showCoachAlert && (
                        <div
                            style={{
                                position: 'fixed',
                                top: 0,
                                left: 0,
                                width: '100%',
                                height: '100%',
                                background: 'rgba(0,0,0,0.8)',
                                zIndex: 3000,
                                display: 'flex',
                                justifyContent: 'center',
                                alignItems: 'center'
                            }}
                            onClick={() => setShowCoachAlert(false)}
                        >
                            <div
                                className="card"
                                style={{ width: '90%', maxWidth: '400px', padding: '2rem', textAlign: 'center' }}
                                onClick={e => e.stopPropagation()}
                            >
                                <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>‚ö†Ô∏è</div>
                                <h2 style={{ marginBottom: '1rem', color: '#ef4444' }}>Low Wellness Score</h2>
                                <p style={{ marginBottom: '1.5rem', color: 'var(--text-secondary)' }}>
                                    Your wellness score is lower than usual. Would you like to reach out to a coach for support?
                                </p>
                                <div style={{ display: 'flex', gap: '0.75rem' }}>
                                    <button
                                        className="btn"
                                        onClick={() => setShowCoachAlert(false)}
                                        style={{ flex: 1 }}
                                    >
                                        Not Now
                                    </button>
                                    <button
                                        className="btn btn-primary"
                                        onClick={() => {
                                            alert('Coach notification sent! A coach will reach out to you soon.');
                                            setShowCoachAlert(false);
                                        }}
                                        style={{ flex: 1 }}
                                    >
                                        Contact Coach
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* PROFILE TAB */}
                    {activeTab === 'profile' && (
                        <div className="card" style={{ padding: '1.5rem' }}>
                            <h2 style={{ marginBottom: '1rem' }}>My Profile</h2>
                            <p style={{ color: 'var(--text-secondary)' }}>Profile editing coming soon...</p>
                        </div>
                    )}

                    {/* ATTENDANCE TAB */}
                    {activeTab === 'attendance' && (
                        <div className="card" style={{ padding: '1.5rem' }}>
                            <h2 style={{ marginBottom: '1rem' }}>My Attendance</h2>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '1rem', marginBottom: '1.5rem' }}>
                                <div style={{ textAlign: 'center', padding: '1rem', background: 'rgba(34, 197, 94, 0.1)', borderRadius: '8px' }}>
                                    <div style={{ fontSize: '2rem', fontWeight: 'bold', color: '#22c55e' }}>{attendancePercentage}%</div>
                                    <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>Attendance</div>
                                </div>
                                <div style={{ textAlign: 'center', padding: '1rem', background: 'rgba(59, 130, 246, 0.1)', borderRadius: '8px' }}>
                                    <div style={{ fontSize: '2rem', fontWeight: 'bold', color: '#3b82f6' }}>{calculateStreak()}</div>
                                    <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>Day Streak</div>
                                </div>
                                <div style={{ textAlign: 'center', padding: '1rem', background: 'rgba(168, 85, 247, 0.1)', borderRadius: '8px' }}>
                                    <div style={{ fontSize: '2rem', fontWeight: 'bold', color: '#a855f7' }}>{attendanceStats.total}</div>
                                    <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>Total Events</div>
                                </div>
                            </div>
                            <p style={{ color: 'var(--text-secondary)' }}>Detailed attendance history coming soon...</p>
                        </div>
                    )}

                    {/* ACHIEVEMENTS TAB */}
                    {activeTab === 'achievements' && (
                        <div className="card" style={{ padding: '1.5rem' }}>
                            <h2 style={{ marginBottom: '1rem' }}>My Progress</h2>
                            <p style={{ color: 'var(--text-secondary)' }}>Achievements and progress tracking coming soon...</p>
                        </div>
                    )}
                </div>
            );
        };


        // ============================================
        // PLAY-CALLING SIMULATOR COMPONENT
        // ============================================

        const PlayCallSimulator = ({ plays, roster, gamePlan, onUpdateGamePlan }) => {
            // ===== GAME STATE =====
            const [gameState, setGameState] = useState({
                quarter: 1,
                timeRemaining: 720, // 12 minutes in seconds
                down: 1,
                distance: 10,
                yardLine: 25, // Start at own 25
                hash: 'middle',
                score: { home: 0, away: 0 },
                driveNumber: 1,
                playClockRemaining: 40,
                playClockActive: false,
                possession: 'home'
            });

            const [playHistory, setPlayHistory] = useState([]);
            const [selectedPlay, setSelectedPlay] = useState(null);
            const [showResult, setShowResult] = useState(false);
            const [lastResult, setLastResult] = useState(null);
            const [isSimulating, setIsSimulating] = useState(false);
            const [simulatorActive, setSimulatorActive] = useState(false);

            // ===== SCOUT TEAM STATE =====
            const [difficulty, setDifficulty] = useState('medium'); // easy, medium, hard, elite
            const [scoutTeam, setScoutTeam] = useState([]);

            // ===== PERFORMANCE TRACKING =====
            const [sessionStats, setSessionStats] = useState({
                playsRun: 0,
                avgDecisionTime: 0,
                successRate: 0,
                totalYards: 0,
                touchdowns: 0,
                turnovers: 0,
                startTime: null
            });

            // ===== OVERLAY POSITION =====
            const [overlayPosition, setOverlayPosition] = useState({ x: 20, y: 20 });
            const [isDragging, setIsDragging] = useState(false);
            const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });

            // ===== GENERATE SCOUT TEAM =====
            useEffect(() => {
                if (simulatorActive && scoutTeam.length === 0) {
                    generateScoutTeam();
                }
            }, [simulatorActive]);

            const generateScoutTeam = () => {
                const positions = ['DL', 'DL', 'DL', 'DL', 'LB', 'LB', 'LB', 'CB', 'CB', 'S', 'S'];
                const difficultyMultipliers = {
                    easy: 0.6,
                    medium: 0.75,
                    hard: 0.9,
                    elite: 1.0
                };
                const mult = difficultyMultipliers[difficulty];

                const team = positions.map((pos, idx) => ({
                    id: `scout_${idx}`,
                    position: pos,
                    jersey: idx + 1,
                    name: generatePlayerName(),
                    ratings: {
                        overall: Math.floor((60 + Math.random() * 35) * mult),
                        speed: Math.floor((55 + Math.random() * 40) * mult),
                        strength: Math.floor((55 + Math.random() * 40) * mult),
                        ability: Math.floor((55 + Math.random() * 40) * mult)
                    }
                }));
                setScoutTeam(team);
            };

            const generatePlayerName = () => {
                const firstNames = ['Mike', 'John', 'Chris', 'David', 'James', 'Robert', 'Tyler', 'Brandon', 'Kevin', 'Marcus'];
                const lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez'];
                return `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`;
            };

            // ===== PLAY CLOCK COUNTDOWN =====
            useEffect(() => {
                if (!gameState.playClockActive || !simulatorActive) return;

                const interval = setInterval(() => {
                    setGameState(prev => {
                        if (prev.playClockRemaining <= 0) {
                            // Delay of game penalty
                            alert('‚ö†Ô∏è DELAY OF GAME! 5 yard penalty');
                            return {
                                ...prev,
                                playClockRemaining: 40,
                                playClockActive: false,
                                yardLine: Math.max(0, prev.yardLine - 5),
                                distance: prev.distance + 5
                            };
                        }
                        return { ...prev, playClockRemaining: prev.playClockRemaining - 1 };
                    });
                }, 1000);

                return () => clearInterval(interval);
            }, [gameState.playClockActive, simulatorActive]);

            // ===== START PLAY CLOCK =====
            const startPlayClock = () => {
                setGameState(prev => ({ ...prev, playClockActive: true, playClockRemaining: 40 }));
                if (!sessionStats.startTime) {
                    setSessionStats(prev => ({ ...prev, startTime: Date.now() }));
                }
            };

            // ===== SIMULATE PLAY RESULT =====
            const simulatePlay = async () => {
                if (!selectedPlay) {
                    alert('Please select a play from the call sheet first!');
                    return;
                }

                setIsSimulating(true);
                setGameState(prev => ({ ...prev, playClockActive: false }));

                // Calculate decision time
                const decisionTime = 40 - gameState.playClockRemaining;

                // Wait 2-3 seconds to simulate play execution
                await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 1000));

                // Calculate result based on ratings
                const result = calculatePlayResult(selectedPlay);

                setLastResult(result);
                setShowResult(true);

                // Update game state
                updateGameStateAfterPlay(result);

                // Update session stats
                updateSessionStats(result, decisionTime);

                // Add to play history
                setPlayHistory(prev => [{
                    playNumber: prev.length + 1,
                    down: gameState.down,
                    distance: gameState.distance,
                    yardLine: gameState.yardLine,
                    playName: selectedPlay.name,
                    result: result,
                    timestamp: Date.now()
                }, ...prev]);

                setIsSimulating(false);
                setSelectedPlay(null);

                // Auto-hide result after 3 seconds and start next play clock
                setTimeout(() => {
                    setShowResult(false);
                    startPlayClock();
                }, 3000);
            };

            // ===== CALCULATE PLAY RESULT =====
            const calculatePlayResult = (play) => {
                // Get offensive player ratings (simplified - using average of roster)
                const offenseRating = roster.reduce((sum, p) => sum + (p.metrics?.maddenRating || 70), 0) / roster.length;

                // Get defensive rating (average of scout team)
                const defenseRating = scoutTeam.reduce((sum, p) => sum + p.ratings.overall, 0) / scoutTeam.length;

                // Base success probability
                let successProb = 0.5 + (offenseRating - defenseRating) / 200;

                // Situational modifiers
                if (gameState.distance >= 10) successProb -= 0.1; // Harder on long distance
                if (gameState.yardLine < 10) successProb -= 0.15; // Harder near goal line
                if (gameState.down >= 3) successProb -= 0.1; // Harder on 3rd/4th down

                // Play type modifiers (check tags)
                const playTags = play.tags || [];
                const isRun = playTags.some(t => ['Strong Run', 'Weak Run'].includes(t));
                const isPass = playTags.some(t => ['Drop Back', 'Quick Game'].includes(t));

                // Determine outcome type
                const roll = Math.random();
                let outcome, yards;

                if (roll > successProb) {
                    // Unsuccessful play
                    if (isPass && Math.random() > 0.7) {
                        outcome = 'Incomplete';
                        yards = 0;
                    } else if (Math.random() > 0.95) {
                        outcome = 'Turnover';
                        yards = 0;
                    } else if (Math.random() > 0.9) {
                        outcome = 'Sack';
                        yards = -(3 + Math.floor(Math.random() * 5));
                    } else {
                        outcome = 'Tackle';
                        yards = Math.floor(Math.random() * Math.max(1, gameState.distance * 0.4));
                    }
                } else {
                    // Successful play
                    const baseYards = gameState.distance + Math.floor(Math.random() * 8);
                    yards = Math.max(0, baseYards - Math.floor(Math.random() * 5));

                    // Check for touchdown
                    if (gameState.yardLine + yards >= 100) {
                        outcome = 'TOUCHDOWN!';
                        yards = 100 - gameState.yardLine;
                    } else if (yards >= gameState.distance) {
                        outcome = 'First Down';
                    } else {
                        outcome = 'Tackle';
                    }
                }

                // Time elapsed (run plays take more time)
                const timeElapsed = isRun ? (25 + Math.floor(Math.random() * 10)) : (5 + Math.floor(Math.random() * 8));

                return {
                    playId: play.id,
                    playName: play.name,
                    yardsGained: yards,
                    outcome: outcome,
                    timeElapsed: timeElapsed,
                    turnover: outcome === 'Turnover',
                    touchdown: outcome === 'TOUCHDOWN!'
                };
            };

            // ===== UPDATE GAME STATE AFTER PLAY =====
            const updateGameStateAfterPlay = (result) => {
                setGameState(prev => {
                    let newDown = prev.down;
                    let newDistance = prev.distance;
                    let newYardLine = Math.min(100, Math.max(0, prev.yardLine + result.yardsGained));
                    let newScore = { ...prev.score };
                    let newTimeRemaining = Math.max(0, prev.timeRemaining - result.timeElapsed);

                    if (result.touchdown) {
                        newScore.home += 7; // Assuming extra point
                        newDown = 1;
                        newDistance = 10;
                        newYardLine = 25; // Kickoff
                    } else if (result.turnover) {
                        // Turnover - opponent gets ball
                        newDown = 1;
                        newDistance = 10;
                        newYardLine = 100 - newYardLine; // Flip field position
                    } else {
                        // Normal play progression
                        const yardsToGo = prev.distance - result.yardsGained;

                        if (yardsToGo <= 0) {
                            // First down!
                            newDown = 1;
                            newDistance = Math.min(10, 100 - newYardLine);
                        } else {
                            newDown = prev.down + 1;
                            newDistance = yardsToGo;

                            if (newDown > 4) {
                                // Turnover on downs
                                newDown = 1;
                                newDistance = 10;
                                newYardLine = 100 - newYardLine;
                            }
                        }
                    }

                    return {
                        ...prev,
                        down: newDown,
                        distance: newDistance,
                        yardLine: newYardLine,
                        score: newScore,
                        timeRemaining: newTimeRemaining,
                        playClockRemaining: 40
                    };
                });
            };

            // ===== UPDATE SESSION STATS =====
            const updateSessionStats = (result, decisionTime) => {
                setSessionStats(prev => {
                    const newPlaysRun = prev.playsRun + 1;
                    const newAvgDecisionTime = ((prev.avgDecisionTime * prev.playsRun) + decisionTime) / newPlaysRun;
                    const wasSuccessful = result.outcome === 'First Down' || result.outcome === 'TOUCHDOWN!';
                    const newSuccessRate = ((prev.successRate * prev.playsRun) + (wasSuccessful ? 1 : 0)) / newPlaysRun;

                    return {
                        ...prev,
                        playsRun: newPlaysRun,
                        avgDecisionTime: newAvgDecisionTime,
                        successRate: newSuccessRate,
                        totalYards: prev.totalYards + result.yardsGained,
                        touchdowns: prev.touchdowns + (result.touchdown ? 1 : 0),
                        turnovers: prev.turnovers + (result.turnover ? 1 : 0)
                    };
                });
            };

            // ===== RESET SIMULATION =====
            const resetSimulation = () => {
                if (!confirm('Reset the simulation? This will clear all progress.')) return;

                setGameState({
                    quarter: 1,
                    timeRemaining: 720,
                    down: 1,
                    distance: 10,
                    yardLine: 25,
                    hash: 'middle',
                    score: { home: 0, away: 0 },
                    driveNumber: 1,
                    playClockRemaining: 40,
                    playClockActive: false,
                    possession: 'home'
                });
                setPlayHistory([]);
                setSessionStats({
                    playsRun: 0,
                    avgDecisionTime: 0,
                    successRate: 0,
                    totalYards: 0,
                    touchdowns: 0,
                    turnovers: 0,
                    startTime: null
                });
                setShowResult(false);
                setSelectedPlay(null);
                generateScoutTeam();
            };

            // ===== DRAGGING HANDLERS =====
            const handleMouseDown = (e) => {
                if (e.target.closest('.simulator-drag-handle')) {
                    setIsDragging(true);
                    setDragOffset({
                        x: e.clientX - overlayPosition.x,
                        y: e.clientY - overlayPosition.y
                    });
                }
            };

            const handleMouseMove = (e) => {
                if (isDragging) {
                    setOverlayPosition({
                        x: e.clientX - dragOffset.x,
                        y: e.clientY - dragOffset.y
                    });
                }
            };

            const handleMouseUp = () => {
                setIsDragging(false);
            };

            useEffect(() => {
                if (isDragging) {
                    window.addEventListener('mousemove', handleMouseMove);
                    window.addEventListener('mouseup', handleMouseUp);
                    return () => {
                        window.removeEventListener('mousemove', handleMouseMove);
                        window.removeEventListener('mouseup', handleMouseUp);
                    };
                }
            }, [isDragging, dragOffset]);

            // ===== RENDER =====
            if (!simulatorActive) {
                return (
                    <div className="card" style={{ padding: '2rem', textAlign: 'center', maxWidth: '600px', margin: '2rem auto' }}>
                        <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>üéÆ</div>
                        <h2 style={{ marginBottom: '1rem' }}>Play-Calling Simulator</h2>
                        <p style={{ color: 'var(--text-secondary)', marginBottom: '2rem' }}>
                            Practice using your call sheet in realistic game scenarios. Select plays, manage the play clock,
                            and see how your calls perform against a simulated scout team defense.
                        </p>

                        <div style={{ marginBottom: '2rem', padding: '1.5rem', background: 'var(--surface)', borderRadius: '8px' }}>
                            <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' }}>Scout Team Difficulty</label>
                            <select
                                className="form-select"
                                value={difficulty}
                                onChange={e => setDifficulty(e.target.value)}
                                style={{ fontSize: '1.1rem', padding: '0.75rem' }}
                            >
                                <option value="easy">Easy (60-70 OVR)</option>
                                <option value="medium">Medium (70-80 OVR)</option>
                                <option value="hard">Hard (80-90 OVR)</option>
                                <option value="elite">Elite (90+ OVR)</option>
                            </select>
                        </div>

                        <button
                            className="btn btn-primary"
                            onClick={() => {
                                setSimulatorActive(true);
                                startPlayClock();
                            }}
                            style={{ fontSize: '1.2rem', padding: '1rem 2rem' }}
                        >
                            Start Simulation
                        </button>
                    </div>
                );
            }

            return (
                <div style={{ position: 'relative', height: '100%' }}>
                    {/* Game Situation Overlay */}
                    <div
                        style={{
                            position: 'fixed',
                            left: `${overlayPosition.x}px`,
                            top: `${overlayPosition.y}px`,
                            zIndex: 1000,
                            background: '#1a1a1a',
                            border: '2px solid var(--accent)',
                            borderRadius: '12px',
                            boxShadow: '0 8px 32px rgba(0,0,0,0.4)',
                            minWidth: '320px',
                            cursor: isDragging ? 'grabbing' : 'default',
                            userSelect: 'none'
                        }}
                        onMouseDown={handleMouseDown}
                    >
                        {/* Drag Handle */}
                        <div
                            className="simulator-drag-handle"
                            style={{
                                padding: '0.5rem 1rem',
                                background: 'var(--accent)',
                                borderRadius: '10px 10px 0 0',
                                cursor: 'grab',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center'
                            }}
                        >
                            <span style={{ fontWeight: 'bold', color: 'white' }}>üéÆ SIMULATION</span>
                            <button
                                className="btn"
                                onClick={() => setSimulatorActive(false)}
                                style={{ padding: '0.25rem 0.5rem', fontSize: '0.8rem' }}
                            >
                                Exit
                            </button>
                        </div>

                        {/* Game Info */}
                        <div style={{ padding: '1rem' }}>
                            {/* Score */}
                            <div style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                marginBottom: '1rem',
                                padding: '0.75rem',
                                background: 'var(--surface)',
                                borderRadius: '8px'
                            }}>
                                <div style={{ textAlign: 'center', flex: 1 }}>
                                    <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>YOUR TEAM</div>
                                    <div style={{ fontSize: '2rem', fontWeight: 'bold', color: 'var(--accent)' }}>{gameState.score.home}</div>
                                </div>
                                <div style={{ display: 'flex', alignItems: 'center', padding: '0 1rem', fontSize: '1.5rem', fontWeight: 'bold' }}>-</div>
                                <div style={{ textAlign: 'center', flex: 1 }}>
                                    <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>OPPONENT</div>
                                    <div style={{ fontSize: '2rem', fontWeight: 'bold' }}>{gameState.score.away}</div>
                                </div>
                            </div>

                            {/* Situation */}
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.5rem', marginBottom: '1rem' }}>
                                <div style={{ padding: '0.5rem', background: 'var(--surface)', borderRadius: '6px', textAlign: 'center' }}>
                                    <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>DOWN & DISTANCE</div>
                                    <div style={{ fontSize: '1.25rem', fontWeight: 'bold' }}>
                                        {gameState.down}{['st', 'nd', 'rd', 'th'][gameState.down - 1]} & {gameState.distance}
                                    </div>
                                </div>
                                <div style={{ padding: '0.5rem', background: 'var(--surface)', borderRadius: '6px', textAlign: 'center' }}>
                                    <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>FIELD POSITION</div>
                                    <div style={{ fontSize: '1.25rem', fontWeight: 'bold' }}>
                                        {gameState.yardLine < 50 ? `Own ${gameState.yardLine}` : `Opp ${100 - gameState.yardLine}`}
                                    </div>
                                </div>
                            </div>

                            {/* Time */}
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.5rem', marginBottom: '1rem' }}>
                                <div style={{ padding: '0.5rem', background: 'var(--surface)', borderRadius: '6px', textAlign: 'center' }}>
                                    <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>QUARTER</div>
                                    <div style={{ fontSize: '1.25rem', fontWeight: 'bold' }}>Q{gameState.quarter}</div>
                                </div>
                                <div style={{ padding: '0.5rem', background: 'var(--surface)', borderRadius: '6px', textAlign: 'center' }}>
                                    <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>TIME</div>
                                    <div style={{ fontSize: '1.25rem', fontWeight: 'bold' }}>
                                        {Math.floor(gameState.timeRemaining / 60)}:{String(gameState.timeRemaining % 60).padStart(2, '0')}
                                    </div>
                                </div>
                            </div>

                            {/* Play Clock */}
                            <div style={{
                                padding: '1rem',
                                background: gameState.playClockRemaining <= 10 ? 'rgba(239, 68, 68, 0.2)' : 'var(--surface)',
                                borderRadius: '8px',
                                border: gameState.playClockRemaining <= 10 ? '2px solid #ef4444' : 'none',
                                marginBottom: '1rem',
                                textAlign: 'center'
                            }}>
                                <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)', marginBottom: '0.25rem' }}>PLAY CLOCK</div>
                                <div style={{
                                    fontSize: '2.5rem',
                                    fontWeight: 'bold',
                                    color: gameState.playClockRemaining <= 10 ? '#ef4444' : 'var(--accent)',
                                    fontFamily: 'monospace'
                                }}>
                                    {gameState.playClockRemaining}
                                </div>
                            </div>

                            {/* Selected Play Display */}
                            {selectedPlay && (
                                <div style={{
                                    padding: '0.75rem',
                                    background: 'rgba(59, 130, 246, 0.1)',
                                    border: '1px solid #3b82f6',
                                    borderRadius: '6px',
                                    marginBottom: '1rem'
                                }}>
                                    <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>SELECTED PLAY</div>
                                    <div style={{ fontWeight: 'bold', color: '#3b82f6' }}>{selectedPlay.name}</div>
                                </div>
                            )}

                            {/* Submit Play Button */}
                            <button
                                className="btn btn-primary"
                                onClick={simulatePlay}
                                disabled={!selectedPlay || isSimulating}
                                style={{
                                    width: '100%',
                                    padding: '0.75rem',
                                    fontSize: '1.1rem',
                                    fontWeight: 'bold',
                                    marginBottom: '0.5rem'
                                }}
                            >
                                {isSimulating ? '‚è≥ Running Play...' : '‚ñ∂Ô∏è Submit Play'}
                            </button>

                            {/* Quick Actions */}
                            <div style={{ display: 'flex', gap: '0.5rem' }}>
                                <button
                                    className="btn btn-secondary"
                                    onClick={resetSimulation}
                                    style={{ flex: 1, fontSize: '0.85rem' }}
                                >
                                    üîÑ Reset
                                </button>
                                <button
                                    className="btn btn-secondary"
                                    onClick={() => alert(`Stats:\n\nPlays: ${sessionStats.playsRun}\nAvg Decision Time: ${sessionStats.avgDecisionTime.toFixed(1)}s\nSuccess Rate: ${(sessionStats.successRate * 100).toFixed(1)}%\nTotal Yards: ${sessionStats.totalYards}\nTDs: ${sessionStats.touchdowns}\nTurnovers: ${sessionStats.turnovers}`)}
                                    style={{ flex: 1, fontSize: '0.85rem' }}
                                >
                                    üìä Stats
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Result Popup */}
                    {showResult && lastResult && (
                        <div style={{
                            position: 'fixed',
                            top: '50%',
                            left: '50%',
                            transform: 'translate(-50%, -50%)',
                            zIndex: 2000,
                            background: 'var(--bg-card)',
                            border: `3px solid ${lastResult.touchdown ? '#10b981' : lastResult.turnover ? '#ef4444' : '#3b82f6'}`,
                            borderRadius: '16px',
                            padding: '2rem',
                            minWidth: '400px',
                            textAlign: 'center',
                            boxShadow: '0 16px 64px rgba(0,0,0,0.6)',
                            animation: 'fadeIn 0.3s ease-in'
                        }}>
                            <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>
                                {lastResult.touchdown ? 'üéâ' : lastResult.turnover ? 'üò±' : lastResult.outcome === 'First Down' ? '‚úÖ' : '‚ö°'}
                            </div>
                            <h2 style={{
                                marginBottom: '1rem',
                                color: lastResult.touchdown ? '#10b981' : lastResult.turnover ? '#ef4444' : 'inherit'
                            }}>
                                {lastResult.outcome}
                            </h2>
                            <div style={{ fontSize: '2rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                {lastResult.yardsGained > 0 ? '+' : ''}{lastResult.yardsGained} yards
                            </div>
                            <div style={{ color: 'var(--text-secondary)' }}>
                                {lastResult.playName}
                            </div>
                        </div>
                    )}

                    {/* The actual call sheet component will render here */}
                    <div style={{ paddingTop: '1rem' }}>
                        <SmartCallSheet
                            gamePlan={gamePlan}
                            situation={gameState}
                            plays={plays}
                            onUpdateSituation={setGameState}
                            onUpdateGamePlan={onUpdateGamePlan}
                            onPlaySelected={setSelectedPlay}
                        />
                    </div>
                </div>
            );
        };



        const ProgramDashboard = ({ currentWeek, roster, userRole = 'Head Coach', permissions = { view: true, edit: true } }) => {
            // Checklist State (Daily, Weekly, Monthly)
            const [dailyFocus, setDailyFocus] = useState([]);
            const [weeklyFocus, setWeeklyFocus] = useState([]);
            const [monthlyFocus, setMonthlyFocus] = useState([]);

            const [inputs, setInputs] = useState({ daily: '', weekly: '', monthly: '' });

            // Task State
            // Task State
            const [tasks, setTasks] = useState([]);

            // Helper: Wellness Alerts
            const getWellnessAlerts = (currentRoster) => {
                const alerts = [];
                const now = new Date();
                const oneDay = 24 * 60 * 60 * 1000;

                currentRoster.forEach(player => {
                    const logs = (player.metrics?.warriorDialLogs || []).sort((a, b) => new Date(b.date) - new Date(a.date));
                    if (logs.length === 0) return;

                    const latest = logs[0];
                    const latestDate = new Date(latest.date);

                    // Only check logs from last 48 hours to be relevant
                    if ((now - latestDate) > (oneDay * 2)) return;

                    // 1. Low Readiness
                    if (latest.readiness <= 4) {
                        alerts.push({ id: player.id + '-readiness', player, type: 'Low Readiness', level: 'high', message: `Readiness: ${latest.readiness}/10` });
                    }

                    // 2. Injury / Pain
                    if (latest.pain) {
                        alerts.push({ id: player.id + '-pain', player, type: 'Injury Report', level: 'high', message: `${latest.painLocation} (${latest.painSeverity}/10)` });
                    }

                    // 3. Negative Trend (3 days)
                    if (logs.length >= 3) {
                        const d1 = logs[0].readiness;
                        const d2 = logs[1].readiness;
                        const d3 = logs[2].readiness;
                        if (d1 < d2 && d2 < d3) {
                            alerts.push({ id: player.id + '-trend', player, type: 'Trending Down', level: 'medium', message: `${d3} -> ${d2} -> ${d1}` });
                        }
                    }
                });
                return alerts;
            };

            const wellnessAlerts = useMemo(() => getWellnessAlerts(roster), [roster]);



            // Outreach State
            const [outreach, setOutreach] = useLocalStorage('oc-dashboard-outreach', []);
            const [newOutreach, setNewOutreach] = useState('');
            const [outreachAssignee, setOutreachAssignee] = useState('ALL'); // New: Assignee selection

            // Program Focus Persistence (Role & Type Specific)
            useEffect(() => {
                if (!currentWeek || !currentWeek.id) return;

                const loadList = (type) => {
                    const key = `program-focus-${currentWeek.id}-${userRole}-${type}`;
                    const saved = localStorage.getItem(key);
                    return saved ? JSON.parse(saved) : [];
                };

                setDailyFocus(loadList('daily'));
                setWeeklyFocus(loadList('weekly'));
                setMonthlyFocus(loadList('monthly'));
            }, [currentWeek?.id, userRole]);

            const saveList = (type, items) => {
                const key = `program-focus-${currentWeek.id}-${userRole}-${type}`;
                localStorage.setItem(key, JSON.stringify(items));

                if (type === 'daily') setDailyFocus(items);
                if (type === 'weekly') setWeeklyFocus(items);
                if (type === 'monthly') setMonthlyFocus(items);
            };

            const addItem = (type) => {
                if (!inputs[type].trim()) return;
                const currentList = type === 'daily' ? dailyFocus : type === 'weekly' ? weeklyFocus : monthlyFocus;
                saveList(type, [...currentList, { id: Date.now(), text: inputs[type], completed: false }]);
                setInputs(prev => ({ ...prev, [type]: '' }));
            };

            const toggleItem = (type, id) => {
                const currentList = type === 'daily' ? dailyFocus : type === 'weekly' ? weeklyFocus : monthlyFocus;
                saveList(type, currentList.map(i => i.id === id ? { ...i, completed: !i.completed } : i));
            };

            const removeItem = (type, id) => {
                const currentList = type === 'daily' ? dailyFocus : type === 'weekly' ? weeklyFocus : monthlyFocus;
                saveList(type, currentList.filter(i => i.id !== id));
            };



            // Outreach Logic
            const addOutreach = () => {
                if (!newOutreach.trim()) return;
                const item = {
                    id: Date.now(),
                    text: newOutreach,
                    completed: false,
                    date: new Date().toISOString().split('T')[0],
                    assignedTo: outreachAssignee // New: Save assignee
                };
                setOutreach([item, ...outreach]);
                setNewOutreach('');
            };

            const removeOutreach = (id) => {
                setOutreach(outreach.filter(i => i.id !== id));
            };

            const toggleOutreach = (id) => {
                setOutreach(outreach.map(i => i.id === id ? { ...i, completed: !i.completed } : i));
            };


            // Tasks / Priorities Loading
            useEffect(() => {
                if (!currentWeek) return;
                const periodName = currentWeek.name;
                const storageKey = `director_ops_tasks_${periodName}`;
                const saved = localStorage.getItem(storageKey);

                if (saved) {
                    setTasks(JSON.parse(saved));
                } else {
                    setTasks([]);
                }
            }, [currentWeek?.name]);

            if (!currentWeek) return <div>Loading...</div>;

            const isWeek = currentWeek.name.startsWith("Week") || currentWeek.name === "Camp Week";
            const canEdit = permissions.edit;

            // Map full role names to short codes used in tasks
            const roleMap = {
                'Head Coach': 'HC',
                'Offensive Coordinator': 'OC',
                'Defensive Coordinator': 'DC',
                'Special Teams Coordinator': 'ST', // Assuming ST code
                'Position Coach': 'Position Coach', // Or specific position
                'Director of Ops': 'Ops',
                'Recruiting Coordinator': 'Recruiting'
            };

            const userRoleShort = roleMap[userRole] || userRole;

            // Filter tasks: HC & Ops see all. Others see assigned tasks + 'ALL'.
            const displayedTasks = (userRole === 'Head Coach' || userRole === 'Director of Ops')
                ? tasks
                : tasks.filter(t => !t.roles || t.roles.length === 0 || t.roles.includes('ALL') || t.roles.includes(userRoleShort));

            return (
                <div style={{ padding: '2rem', height: '100%', display: 'flex', flexDirection: 'column', overflowY: 'auto' }}>
                    <div style={{ marginBottom: '2rem' }}>
                        <h1 style={{ fontSize: '2.5rem', marginBottom: '0.5rem' }}>
                            <span style={{ color: 'var(--accent)' }}>{currentWeek.name}</span> Focus
                            {currentWeek.opponent && <span style={{ fontSize: '1.5rem', color: 'var(--text-secondary)', marginLeft: '1rem' }}>vs {currentWeek.opponent}</span>}
                        </h1>
                        <div style={{ color: 'var(--text-secondary)' }}>
                            Program Dashboard {userRole !== 'Head Coach' && <span style={{ opacity: 0.7 }}>‚Äî Viewing as {userRole}</span>}
                        </div>
                    </div>

                    {/* WELLNESS ALERTS */}
                    {wellnessAlerts.length > 0 && (
                        <div className="card" style={{ marginBottom: '2rem', borderLeft: '6px solid #ef4444', background: '#fef2f2' }}>
                            <h2 style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '1rem', color: '#b91c1c' }}>
                                <Icon name="AlertTriangle" size={24} /> Wellness Checks ({wellnessAlerts.length})
                            </h2>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '1rem' }}>
                                {wellnessAlerts.map(alert => (
                                    <div key={alert.id} style={{ background: 'white', padding: '1rem', borderRadius: '8px', border: '1px solid #fee2e2', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                        <div>
                                            <div style={{ fontWeight: 'bold' }}>{alert.player.name}</div>
                                            <div style={{ fontSize: '0.9rem', color: alert.level === 'high' ? '#dc2626' : '#ea580c' }}>
                                                {alert.type}: {alert.message}
                                            </div>
                                        </div>
                                        <button className="btn-sm" onClick={() => {
                                            // Ideally open profile, but for now we rely on user manually going there.
                                            // Since we can't easily switch view AND open modal from here without prop drilling 'setView' and 'setModal'.
                                            // A simple way is to just show info.
                                        }}>
                                            #{alert.player.jersey}
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '1.5rem', marginBottom: '2rem' }}>
                        {['daily', 'weekly', 'monthly'].map(type => {
                            const list = type === 'daily' ? dailyFocus : type === 'weekly' ? weeklyFocus : monthlyFocus;
                            const title = type.charAt(0).toUpperCase() + type.slice(1) + ' Checklist';
                            const icon = type === 'daily' ? 'Sun' : type === 'weekly' ? 'Calendar' : 'Target';

                            return (
                                <div key={type} className="card" style={{ display: 'flex', flexDirection: 'column', height: '400px' }}>
                                    <h2 style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', borderBottom: '1px solid var(--border)', paddingBottom: '1rem', marginBottom: '1rem', fontSize: '1.2rem' }}>
                                        <Icon name={icon} color="var(--accent)" size={20} />
                                        {title}
                                    </h2>

                                    <div style={{ flex: 1, overflowY: 'auto' }}>
                                        {list.length === 0 && (
                                            <div style={{ textAlign: 'center', padding: '2rem', color: 'var(--text-secondary)', fontStyle: 'italic', fontSize: '0.9rem' }}>
                                                No {type} items for {userRole}.
                                            </div>
                                        )}
                                        <ul style={{ listStyle: 'none', padding: 0 }}>
                                            {list.map(item => (
                                                <li key={item.id} style={{
                                                    display: 'flex', alignItems: 'center', gap: '0.5rem',
                                                    padding: '0.5rem 0', borderBottom: '1px solid rgba(255,255,255,0.05)',
                                                    background: item.completed ? 'rgba(0,255,0,0.05)' : 'transparent'
                                                }}>
                                                    <button
                                                        onClick={() => canEdit && toggleItem(type, item.id)}
                                                        style={{
                                                            background: 'none', border: 'none', cursor: canEdit ? 'pointer' : 'default',
                                                            color: item.completed ? 'var(--accent)' : 'var(--text-secondary)',
                                                            opacity: canEdit ? 1 : 0.7, padding: '0 0.25rem'
                                                        }}
                                                    >
                                                        {item.completed ? <Icon name="Check" size={18} /> : <div style={{ width: '18px', height: '18px', border: '2px solid var(--text-secondary)', borderRadius: '4px' }}></div>}
                                                    </button>
                                                    <span style={{ flex: 1, textDecoration: item.completed ? 'line-through' : 'none', color: item.completed ? 'var(--text-secondary)' : 'var(--text-primary)', fontSize: '0.95rem' }}>
                                                        {item.text}
                                                    </span>
                                                    {canEdit && (
                                                        <button
                                                            onClick={() => removeItem(type, item.id)}
                                                            style={{ background: 'none', border: 'none', color: '#ef4444', opacity: 0.5, cursor: 'pointer' }}
                                                        >
                                                            <Icon name="Minus" size={14} />
                                                        </button>
                                                    )}
                                                </li>
                                            ))}
                                        </ul>
                                    </div>

                                    {canEdit && (
                                        <div style={{ marginTop: '0.5rem', paddingTop: '0.5rem', borderTop: '1px solid var(--border)', display: 'flex', gap: '0.5rem' }}>
                                            <input
                                                className="form-input"
                                                style={{ fontSize: '0.9rem', padding: '0.4rem' }}
                                                placeholder={`Add ${type} item...`}
                                                value={inputs[type]}
                                                onChange={e => setInputs(prev => ({ ...prev, [type]: e.target.value }))}
                                                onKeyDown={e => e.key === 'Enter' && addItem(type)}
                                            />
                                            <button className="btn-sm btn-primary" onClick={() => addItem(type)} style={{ padding: '0 0.5rem' }}>
                                                <Icon name="Plus" size={16} />
                                            </button>
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>





                    {/* OUTREACH / RECRUITING */}
                    <div className="card" style={{ display: 'flex', flexDirection: 'column' }}>
                        <h2 style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', borderBottom: '1px solid var(--border)', paddingBottom: '1rem', marginBottom: '1rem' }}>
                            <Icon name="MessageCircle" color="#3b82f6" />
                            Reach Out To
                        </h2>

                        {
                            canEdit && (
                                <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem' }}>
                                    <div style={{ flex: 1, display: 'flex', gap: '0.5rem' }}>
                                        <select
                                            className="form-select"
                                            value={outreachAssignee}
                                            onChange={e => setOutreachAssignee(e.target.value)}
                                            style={{ flex: '0 0 120px' }}
                                        >
                                            <option value="ALL">Everyone</option>
                                            <option value="HC">Head Coach</option>
                                            <option value="OC">Off. Coord</option>
                                            <option value="DC">Def. Coord</option>
                                            <option value="Ops">Dir. Ops</option>
                                            <option value="Recruiting">Recruiting</option>
                                        </select>
                                        <input
                                            className="form-input"
                                            placeholder="Name / Note..."
                                            value={newOutreach}
                                            onChange={e => setNewOutreach(e.target.value)}
                                            onKeyDown={e => e.key === 'Enter' && addOutreach()}
                                            style={{ flex: 1 }}
                                        />
                                    </div>
                                    <button className="btn btn-primary" onClick={addOutreach}><Icon name="Plus" size={18} /></button>
                                </div>
                            )
                        }

                        <div style={{ flex: 1, overflowY: 'auto', maxHeight: '300px' }}>
                            {outreach.filter(item => userRole === 'Head Coach' || !item.assignedTo || item.assignedTo === 'ALL' || item.assignedTo === userRoleShort).length === 0 && <div style={{ color: 'var(--text-secondary)', fontStyle: 'italic', textAlign: 'center', padding: '1rem' }}>No outreach tasks.</div>}
                            <ul style={{ listStyle: 'none', padding: 0 }}>
                                {outreach.filter(item => userRole === 'Head Coach' || !item.assignedTo || item.assignedTo === 'ALL' || item.assignedTo === userRoleShort).map(item => (
                                    <li key={item.id} style={{
                                        display: 'flex', alignItems: 'center', gap: '0.75rem',
                                        padding: '0.75rem', borderBottom: '1px solid rgba(255,255,255,0.05)',
                                        background: item.completed ? 'rgba(0,255,0,0.05)' : 'transparent'
                                    }}>
                                        <button
                                            onClick={() => canEdit && toggleOutreach(item.id)}
                                            style={{
                                                background: 'none', border: 'none', cursor: canEdit ? 'pointer' : 'default',
                                                color: item.completed ? 'var(--accent)' : 'var(--text-secondary)',
                                                opacity: canEdit ? 1 : 0.7
                                            }}
                                        >
                                            {item.completed ? <Icon name="Check" size={18} /> : <div style={{ width: '18px', height: '18px', border: '2px solid var(--text-secondary)', borderRadius: '4px' }}></div>}
                                        </button>
                                        <div style={{ flex: 1 }}>
                                            <div style={{ textDecoration: item.completed ? 'line-through' : 'none', color: item.completed ? 'var(--text-secondary)' : 'var(--text-primary)' }}>{item.text}</div>
                                            {item.assignedTo && item.assignedTo !== 'ALL' && <div style={{ fontSize: '0.7em', color: 'var(--accent)', marginTop: '2px' }}>üëâ {item.assignedTo}</div>}
                                        </div>
                                        {canEdit && (
                                            <button onClick={() => removeOutreach(item.id)} style={{ background: 'none', border: 'none', cursor: 'pointer', color: 'var(--text-secondary)', opacity: 0.5 }}><Icon name="X" size={14} /></button>
                                        )}
                                    </li>
                                ))}
                            </ul>
                        </div>
                    </div>
                </div>
            );
        };



        const GAME_PLAN_LAYOUTS = {
            CALL_SHEET: {
                id: 'CALL_SHEET',
                name: 'Call Sheet',
                sections: [
                    // Top Row: Scripts, Opening, 2nd & XL, End of Half
                    {
                        type: 'grid',
                        cols: 10,
                        rows: [
                            { header: 'PLAYER TOUCHES', setId: 'player_touches', colSpan: 1, color: '#8b5cf6' },
                            { header: 'OPENING SCRIPT LH', setId: '1st_ten_lh', colSpan: 1, color: '#10b981' },
                            { header: 'OPENING SCRIPT RH', setId: '1st_ten_rh', colSpan: 1, color: '#10b981' },
                            { header: 'MINI SCRIPT 1', setId: 'mini_script_1', colSpan: 1, color: '#06b6d4' },
                            { header: 'MINI SCRIPT 2', setId: 'mini_script_2', colSpan: 1, color: '#06b6d4' },
                            { header: '2ND HALF OPENERS', setId: 'second_half_openers', colSpan: 1, color: '#f97316' },
                            { header: 'P&10', setId: 'p_and_10', colSpan: 1, color: '#ef4444' },
                            { header: '2ND & XL (LH)', setId: '2nd_xl_lh', colSpan: 1, color: '#3b82f6' },
                            { header: '2ND & XL RH', setId: '2nd_xl_rh', colSpan: 1, color: '#3b82f6' },
                            { header: 'END OF HALF', setId: 'eoh', colSpan: 1, color: '#8b5cf6' },
                        ]
                    },
                    // Situational Rows
                    {
                        type: 'grid',
                        cols: 4,
                        rows: [
                            // Formations / Motion / Tag / Strikeout
                            { header: '1 WORD', setId: 'one_word', colSpan: 1, color: '#f59e0b' },
                            { header: 'FORM ADJ', setId: 'form_adj', colSpan: 1, color: '#f59e0b' },
                            { header: 'MOTION', setId: 'motion', colSpan: 1, color: '#f59e0b' },
                            { header: 'TAG', setId: 'tag', colSpan: 1, color: '#f59e0b' },

                            // 3rd Downs
                            { header: '3RD & SHORT', setId: '3rd_short', colSpan: 1, color: '#10b981' },
                            { header: '3RD & MED', setId: '3rd_med', colSpan: 1, color: '#10b981' },
                            { header: '3RD & LONG', setId: '3rd_long', colSpan: 1, color: '#10b981' },
                            { header: '3RD & XL', setId: '3rd_xl', colSpan: 1, color: '#10b981' },

                            // Field Zones
                            { header: 'BACKED UP', setId: 'backed_up', colSpan: 1, color: '#dc2626' },
                            { header: 'COMING OUT', setId: 'coming_out', colSpan: 1, color: '#ea580c' },
                            { header: 'OPEN FIELD', setId: 'open_field', colSpan: 1, color: '#16a34a' },
                            { header: 'FRINGE (+45-25)', setId: 'fringe', colSpan: 1, color: '#ca8a04' },
                            { header: 'HIGH RED (25-15)', setId: 'high_red', colSpan: 1, color: '#ef4444' },
                            { header: 'LOW RED (15-6)', setId: 'low_red', colSpan: 1, color: '#ef4444' },
                            { header: 'GOAL LINE (5-GL)', setId: 'goal_line', colSpan: 1, color: '#ef4444' },
                            { header: '2-POINT', setId: 'two_point', colSpan: 1, color: '#8b5cf6' },

                            // 2-Minute Drill Categories
                            { header: '2-MIN: OOB/YAC', setId: 'two_minute_oob_yac', colSpan: 1, color: '#8b5cf6' },
                            { header: '2-MIN: 1st DOWN', setId: 'two_minute_first_down', colSpan: 1, color: '#8b5cf6' },
                            { header: '2-MIN: TD', setId: 'two_minute_touchdown', colSpan: 1, color: '#8b5cf6' },
                            { header: '2-MIN: FINAL PLAY', setId: 'two_minute_final_play', colSpan: 1, color: '#8b5cf6' },

                            // Other Time Situations
                            { header: '4-MINUTE', setId: 'four_minute', colSpan: 1, color: '#8b5cf6' },
                        ]
                    }
                ]
            },
            MATRIX: {
                id: 'MATRIX',
                name: "Strike 'Em Out",
                cols: [
                    { id: 'FB_L', label: 'FB L', fullLabel: 'Fastball Left' },
                    { id: 'FB_R', label: 'FB R', fullLabel: 'Fastball Right' },
                    { id: 'CB_L', label: 'CB L', fullLabel: 'Curveball Left' },
                    { id: 'CB_R', label: 'CB R', fullLabel: 'Curveball Right' },
                    { id: 'CU_L', label: 'CU L', fullLabel: 'Change Up Left' },
                    { id: 'CU_R', label: 'CU R', fullLabel: 'Change Up Right' },
                    { id: 'SO_L', label: 'SO L', fullLabel: 'Strikeout Left' },
                    { id: 'SO_R', label: 'SO R', fullLabel: 'Strikeout Right' }
                ],
                formations: [
                    { id: '887', label: '887', color: '#ef4444' },
                    { id: '888', label: '888', color: '#ef4444' },
                    { id: '687', label: '687', color: '#fbbf24' },
                    { id: '688', label: '688', color: '#fbbf24' },
                    { id: '881', label: '881', color: '#facc15' },
                    { id: '984', label: '984', color: '#4ade80' },
                    { id: '983', label: '983', color: '#4ade80' },
                    { id: '488', label: '488', color: '#60a5fa' },
                    { id: '487', label: '487', color: '#60a5fa' },
                    { id: 'jets', label: 'Jets/Specials', color: '#a8a29e' }
                ],
                playTypes: [
                    { id: 'inside_run_rt', label: 'Inside Run RT' },
                    { id: 'inside_run_lt', label: 'Inside Run LT' },
                    { id: 'perimeter_run_rt', label: 'Perimeter Run RT' },
                    { id: 'perimeter_run_lt', label: 'Perimeter Run LT' },
                    { id: 'fit_rpo', label: 'FIT RPO' },
                    { id: 'flow_rpo', label: 'FLOW RPO' },
                    { id: 'quick_game', label: 'Quick Game' },
                    { id: 'drop_back', label: 'Drop Back' },
                    { id: 'movement_pass', label: 'Movement Pass' },
                    { id: 'screens', label: 'Screens' }
                ]
            }
        };

        // Game Plan 2.0 Component
        const GamePlan2 = ({ plays, gamePlan, onUpdateGamePlan, onQuickAddPlay }) => {
            const [mode, setMode] = useState('full'); // 'guided' or 'full'
            const [currentPhase, setCurrentPhase] = useState(1);
            const [currentSituationIndex, setCurrentSituationIndex] = useState(0);

            // Phase definitions
            const phases = [
                {
                    id: 1,
                    name: 'Core Downs & Distance',
                    description: 'Start with your base plays that work in multiple situations',
                    situations: ['base_downs', 'p_and_10', '2nd_xl']
                },
                {
                    id: 2,
                    name: 'Third Down Conversions',
                    description: 'Add 3-5 plays for each distance category',
                    situations: ['convert_short_med', 'convert_long_xl']
                },
                {
                    id: 3,
                    name: 'Field Zones',
                    description: 'Many plays can work in multiple zones - reuse when possible',
                    situations: ['backed_up', 'coming_out', 'open_field', 'fringe', 'high_red', 'low_red', 'goal_line']
                },
                {
                    id: 4,
                    name: 'Game Management',
                    description: 'Critical situations - ensure you have go-to plays ready',
                    situations: ['two_minute', 'four_minute', 'two_point']
                },
                {
                    id: 5,
                    name: 'Special Situations',
                    description: 'Pre-scripted sequences for key moments',
                    situations: ['opening_script', 'one_word']
                }
            ];

            // All situation definitions (reusing from SmartCallSheet)
            const allSituations = [
                { key: 'base_downs', label: 'üìä BASE DOWNS', color: '#14b8a6', recommended: '5-8 plays' },
                { key: 'p_and_10', label: 'P&10', color: '#ef4444', recommended: '3-5 plays' },
                { key: '2nd_xl', label: 'GET HALF', color: '#3b82f6', recommended: '4-6 plays', hasSubmenu: true },
                { key: 'convert_short_med', label: 'üéØ CONVERT SHORT/MED', color: '#10b981', recommended: '6-8 plays', hasSubmenu: true },
                { key: 'convert_long_xl', label: 'üéØ CONVERT L/XL 7-12+', color: '#059669', recommended: '4-6 plays', hasSubmenu: true },
                { key: 'backed_up', label: 'BACKED UP', color: '#1f2937', recommended: '3-4 plays' },
                { key: 'coming_out', label: 'COMING OUT', color: '#6b7280', recommended: '3-4 plays' },
                { key: 'open_field', label: 'OPEN FIELD', color: '#16a34a', recommended: '4-5 plays' },
                { key: 'fringe', label: 'FRINGE (+45-25)', color: '#f97316', recommended: '3-4 plays' },
                { key: 'high_red', label: 'HIGH RED (25-15)', color: '#ef4444', recommended: '4-5 plays' },
                { key: 'low_red', label: 'LOW RED (15-6)', color: '#eab308', recommended: '4-5 plays' },
                { key: 'goal_line', label: 'GOAL LINE (5-GL)', color: '#3b82f6', recommended: '5-6 plays' },
                { key: 'two_minute', label: '2-MINUTE', color: '#8b5cf6', recommended: '8-10 plays', hasSubmenu: true },
                { key: 'four_minute', label: '4-MINUTE', color: '#8b5cf6', recommended: '4-5 plays' },
                { key: 'two_point', label: '2-POINT', color: '#8b5cf6', recommended: '3-4 plays' },
                { key: 'opening_script', label: 'OPENING SCRIPT', color: '#ec4899', recommended: '10-15 plays', hasSubmenu: true },
                { key: 'one_word', label: 'ONE-WORD CALLS', color: '#f59e0b', recommended: '5-8 plays', hasSubmenu: true }
            ];

            // Helper to get play count for a situation
            const getPlayCount = (situationKey) => {
                if (situationKey === '2nd_xl') {
                    return ((gamePlan.sets || []).find(s => s.id === '2nd_xl_lh')?.playIds?.length || 0) +
                        ((gamePlan.sets || []).find(s => s.id === '2nd_xl_rh')?.playIds?.length || 0);
                } else if (situationKey === 'convert_short_med') {
                    return ((gamePlan.sets || []).find(s => s.id === '3rd_short')?.playIds?.length || 0) +
                        ((gamePlan.sets || []).find(s => s.id === '3rd_med')?.playIds?.length || 0);
                } else if (situationKey === 'convert_long_xl') {
                    return ((gamePlan.sets || []).find(s => s.id === '3rd_long')?.playIds?.length || 0) +
                        ((gamePlan.sets || []).find(s => s.id === '3rd_xl')?.playIds?.length || 0);
                } else if (situationKey === 'two_minute') {
                    return ['oob_yac', 'first_down', 'touchdown', 'final_play'].reduce((sum, cat) => {
                        return sum + ((gamePlan.sets || []).find(s => s.id === `2min_${cat}`)?.playIds?.length || 0);
                    }, 0);
                } else if (situationKey === 'opening_script') {
                    return ((gamePlan.sets || []).find(s => s.id === 'opening_script_left')?.playIds?.length || 0) +
                        ((gamePlan.sets || []).find(s => s.id === 'opening_script_right')?.playIds?.length || 0);
                } else if (situationKey === 'one_word') {
                    return ['form_adj', 'pers_adj', 'motion_adj', 'explosive'].reduce((sum, cat) => {
                        return sum + ((gamePlan.sets || []).find(s => s.id === `one_word_${cat}`)?.playIds?.length || 0);
                    }, 0);
                } else {
                    return (gamePlan.sets || []).find(s => s.id === situationKey)?.playIds?.length || 0;
                }
            };

            // Helper to get status for a situation
            const getStatus = (situationKey) => {
                const count = getPlayCount(situationKey);
                if (count >= 3) return 'complete';
                if (count > 0) return 'needs-plays';
                return 'empty';
            };

            // Calculate overall completion
            const calculateCompletion = () => {
                const allSituationKeys = phases.flatMap(p => p.situations);
                const completed = allSituationKeys.filter(key => getStatus(key) === 'complete').length;
                return {
                    completed,
                    total: allSituationKeys.length,
                    percentage: Math.round((completed / allSituationKeys.length) * 100)
                };
            };

            const completion = calculateCompletion();
            const currentPhaseData = phases.find(p => p.id === currentPhase);
            const currentSituation = currentPhaseData ? allSituations.find(s => s.key === currentPhaseData.situations[currentSituationIndex]) : null;

            // Navigation handlers for guided mode
            const handleNext = () => {
                if (currentSituationIndex < currentPhaseData.situations.length - 1) {
                    setCurrentSituationIndex(currentSituationIndex + 1);
                } else if (currentPhase < phases.length) {
                    setCurrentPhase(currentPhase + 1);
                    setCurrentSituationIndex(0);
                }
            };

            const handlePrevious = () => {
                if (currentSituationIndex > 0) {
                    setCurrentSituationIndex(currentSituationIndex - 1);
                } else if (currentPhase > 1) {
                    setCurrentPhase(currentPhase - 1);
                    const prevPhase = phases.find(p => p.id === currentPhase - 1);
                    setCurrentSituationIndex(prevPhase.situations.length - 1);
                }
            };

            const handleSkip = () => {
                handleNext();
            };

            return (
                <div style={{ height: '100%', display: 'flex', flexDirection: 'column', background: 'var(--bg-primary)' }}>
                    {/* Header with Mode Toggle */}
                    <div style={{
                        background: 'var(--bg-card)',
                        borderBottom: '2px solid var(--border)',
                        padding: '1.5rem'
                    }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                            <h2 style={{ margin: 0, color: 'var(--text-primary)' }}>‚ö° Game Plan 2.0</h2>
                            <div style={{ display: 'flex', gap: '0.5rem' }}>
                                <button
                                    onClick={() => setMode('guided')}
                                    className="btn"
                                    style={{
                                        background: mode === 'guided' ? 'var(--accent)' : 'var(--bg-panel)',
                                        color: mode === 'guided' ? 'white' : 'var(--text-primary)',
                                        border: mode === 'guided' ? 'none' : '2px solid var(--border)',
                                        fontWeight: 'bold',
                                        padding: '0.75rem 1.5rem'
                                    }}
                                >
                                    üß≠ GUIDED MODE
                                </button>
                                <button
                                    onClick={() => setMode('full')}
                                    className="btn"
                                    style={{
                                        background: mode === 'full' ? 'var(--accent)' : 'var(--bg-panel)',
                                        color: mode === 'full' ? 'white' : 'var(--text-primary)',
                                        border: mode === 'full' ? 'none' : '2px solid var(--border)',
                                        fontWeight: 'bold',
                                        padding: '0.75rem 1.5rem'
                                    }}
                                >
                                    üìã FULL MENU
                                </button>
                            </div>
                        </div>

                        {/* Progress Bar */}
                        <div style={{ marginTop: '1rem' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                                <span style={{ color: 'var(--text-secondary)', fontSize: '0.9rem' }}>
                                    {completion.completed} of {completion.total} situations complete
                                </span>
                                <span style={{ color: 'var(--accent)', fontWeight: 'bold', fontSize: '0.9rem' }}>
                                    {completion.percentage}%
                                </span>
                            </div>
                            <div style={{
                                width: '100%',
                                height: '8px',
                                background: 'var(--bg-panel)',
                                borderRadius: '4px',
                                overflow: 'hidden'
                            }}>
                                <div style={{
                                    width: `${completion.percentage}%`,
                                    height: '100%',
                                    background: 'linear-gradient(90deg, var(--accent), #10b981)',
                                    transition: 'width 0.3s ease'
                                }} />
                            </div>
                        </div>
                    </div>

                    {/* Content Area */}
                    <div style={{ flex: 1, overflowY: 'auto', padding: '2rem' }}>
                        {mode === 'guided' ? (
                            // GUIDED MODE
                            <div style={{ maxWidth: '800px', margin: '0 auto' }}>
                                {/* Phase Progress */}
                                <div style={{
                                    background: 'var(--bg-card)',
                                    padding: '1.5rem',
                                    borderRadius: '8px',
                                    marginBottom: '2rem',
                                    border: '2px solid var(--border)'
                                }}>
                                    <div style={{ fontSize: '0.9rem', color: 'var(--text-secondary)', marginBottom: '0.5rem' }}>
                                        Phase {currentPhase} of {phases.length}
                                    </div>
                                    <h3 style={{ margin: '0 0 0.5rem 0', color: 'var(--text-primary)' }}>
                                        {currentPhaseData?.name}
                                    </h3>
                                    <p style={{ margin: 0, color: 'var(--text-secondary)', fontSize: '0.95rem' }}>
                                        {currentPhaseData?.description}
                                    </p>
                                    <div style={{ marginTop: '1rem', fontSize: '0.85rem', color: 'var(--text-secondary)' }}>
                                        Situation {currentSituationIndex + 1} of {currentPhaseData?.situations.length}
                                    </div>
                                </div>

                                {/* Current Situation Card */}
                                {currentSituation && (
                                    <div style={{
                                        background: 'var(--bg-card)',
                                        padding: '2rem',
                                        borderRadius: '12px',
                                        border: `3px solid ${currentSituation.color}`,
                                        marginBottom: '2rem'
                                    }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', marginBottom: '1.5rem' }}>
                                            <div style={{
                                                width: '48px',
                                                height: '48px',
                                                borderRadius: '50%',
                                                background: currentSituation.color,
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontSize: '1.5rem'
                                            }}>
                                                {getStatus(currentSituation.key) === 'complete' ? '‚úÖ' :
                                                    getStatus(currentSituation.key) === 'needs-plays' ? '‚ö†Ô∏è' : '‚ùå'}
                                            </div>
                                            <div>
                                                <h2 style={{ margin: 0, color: 'var(--text-primary)' }}>
                                                    {currentSituation.label}
                                                </h2>
                                                <div style={{ color: 'var(--text-secondary)', fontSize: '0.9rem', marginTop: '0.25rem' }}>
                                                    Recommended: {currentSituation.recommended}
                                                </div>
                                            </div>
                                        </div>

                                        <div style={{
                                            background: 'var(--bg-panel)',
                                            padding: '1.5rem',
                                            borderRadius: '8px',
                                            marginBottom: '1.5rem'
                                        }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                <span style={{ color: 'var(--text-primary)', fontWeight: 'bold' }}>
                                                    Current Play Count:
                                                </span>
                                                <span style={{
                                                    fontSize: '1.5rem',
                                                    fontWeight: 'bold',
                                                    color: getStatus(currentSituation.key) === 'complete' ? '#10b981' :
                                                        getStatus(currentSituation.key) === 'needs-plays' ? '#eab308' : '#ef4444'
                                                }}>
                                                    {getPlayCount(currentSituation.key)}
                                                </span>
                                            </div>
                                        </div>

                                        <div style={{
                                            background: '#1e40af20',
                                            border: '2px solid #3b82f6',
                                            borderRadius: '8px',
                                            padding: '1rem',
                                            marginBottom: '1rem'
                                        }}>
                                            <div style={{ color: '#3b82f6', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                                üí° Quick Tip
                                            </div>
                                            <div style={{ color: 'var(--text-secondary)', fontSize: '0.9rem' }}>
                                                {currentSituation.hasSubmenu ?
                                                    'This situation has multiple categories. Use the Full Menu to add plays to each category.' :
                                                    'Click "Go to Call Sheet" below to add plays to this situation.'}
                                            </div>
                                        </div>

                                        <button
                                            className="btn"
                                            style={{
                                                width: '100%',
                                                background: currentSituation.color,
                                                color: 'white',
                                                border: 'none',
                                                fontWeight: 'bold',
                                                padding: '1rem',
                                                fontSize: '1rem'
                                            }}
                                        >
                                            üìã Go to Call Sheet
                                        </button>
                                    </div>
                                )}

                                {/* Navigation Buttons */}
                                <div style={{ display: 'flex', gap: '1rem' }}>
                                    <button
                                        onClick={handlePrevious}
                                        disabled={currentPhase === 1 && currentSituationIndex === 0}
                                        className="btn"
                                        style={{
                                            flex: 1,
                                            padding: '1rem',
                                            fontWeight: 'bold',
                                            opacity: currentPhase === 1 && currentSituationIndex === 0 ? 0.5 : 1
                                        }}
                                    >
                                        ‚Üê Previous
                                    </button>
                                    <button
                                        onClick={handleSkip}
                                        className="btn"
                                        style={{
                                            flex: 1,
                                            padding: '1rem',
                                            fontWeight: 'bold'
                                        }}
                                    >
                                        Skip for Now
                                    </button>
                                    <button
                                        onClick={handleNext}
                                        disabled={currentPhase === phases.length && currentSituationIndex === currentPhaseData?.situations.length - 1}
                                        className="btn"
                                        style={{
                                            flex: 1,
                                            padding: '1rem',
                                            fontWeight: 'bold',
                                            background: 'var(--accent)',
                                            color: 'white',
                                            border: 'none',
                                            opacity: currentPhase === phases.length && currentSituationIndex === currentPhaseData?.situations.length - 1 ? 0.5 : 1
                                        }}
                                    >
                                        Next ‚Üí
                                    </button>
                                </div>
                            </div>
                        ) : (
                            // FULL MENU MODE
                            <div>
                                <p style={{ color: 'var(--text-secondary)', textAlign: 'center', marginBottom: '2rem' }}>
                                    View all situations with status indicators. Click any situation to add plays.
                                </p>

                                {phases.map(phase => (
                                    <div key={phase.id} style={{ marginBottom: '3rem' }}>
                                        <div style={{
                                            background: 'var(--bg-card)',
                                            padding: '1rem 1.5rem',
                                            borderRadius: '8px 8px 0 0',
                                            borderBottom: '2px solid var(--accent)'
                                        }}>
                                            <h3 style={{ margin: 0, color: 'var(--text-primary)' }}>
                                                Phase {phase.id}: {phase.name}
                                            </h3>
                                            <p style={{ margin: '0.5rem 0 0 0', color: 'var(--text-secondary)', fontSize: '0.9rem' }}>
                                                {phase.description}
                                            </p>
                                        </div>

                                        <div style={{
                                            display: 'grid',
                                            gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))',
                                            gap: '1rem',
                                            padding: '1.5rem',
                                            background: 'var(--bg-panel)',
                                            borderRadius: '0 0 8px 8px'
                                        }}>
                                            {phase.situations.map(sitKey => {
                                                const sit = allSituations.find(s => s.key === sitKey);
                                                if (!sit) return null;
                                                const status = getStatus(sitKey);
                                                const count = getPlayCount(sitKey);

                                                return (
                                                    <button
                                                        key={sitKey}
                                                        className="btn"
                                                        style={{
                                                            background: 'var(--bg-card)',
                                                            border: `2px solid ${sit.color}`,
                                                            borderRadius: '8px',
                                                            padding: '1.5rem',
                                                            textAlign: 'left',
                                                            position: 'relative',
                                                            transition: 'all 0.2s ease'
                                                        }}
                                                    >
                                                        {/* Status Indicator */}
                                                        <div style={{
                                                            position: 'absolute',
                                                            top: '0.75rem',
                                                            right: '0.75rem',
                                                            fontSize: '1.25rem'
                                                        }}>
                                                            {status === 'complete' ? '‚úÖ' :
                                                                status === 'needs-plays' ? '‚ö†Ô∏è' : '‚ùå'}
                                                        </div>

                                                        <div style={{
                                                            color: sit.color,
                                                            fontWeight: 'bold',
                                                            fontSize: '1rem',
                                                            marginBottom: '0.5rem',
                                                            paddingRight: '2rem'
                                                        }}>
                                                            {sit.label}
                                                        </div>

                                                        <div style={{
                                                            display: 'flex',
                                                            justifyContent: 'space-between',
                                                            alignItems: 'center',
                                                            marginTop: '0.75rem'
                                                        }}>
                                                            <span style={{ color: 'var(--text-secondary)', fontSize: '0.85rem' }}>
                                                                {count} plays
                                                            </span>
                                                            <span style={{ color: 'var(--text-secondary)', fontSize: '0.75rem' }}>
                                                                {sit.recommended}
                                                            </span>
                                                        </div>
                                                    </button>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ScoutingView = ({ data, onUpdate }) => {
            const [activeTab, setActiveTab] = useState('defense'); // Default to defense (scouting opponent)
            const [editingPlayer, setEditingPlayer] = useState(null);

            // Configuration
            const SCOUTING_CONFIG = {
                offense: {
                    label: 'Opponent Offense',
                    positions: ['QB', 'RB', 'WR1', 'WR2', 'WR3', 'TE', 'LT', 'LG', 'C', 'RG', 'RT'],
                    archetypes: ['Balanced', 'Pocket Passer', 'Scrambler', 'Power', 'Speed', 'Possession', 'Blocking', 'Receiving'],
                    ratingFields: ['Speed', 'Agility', 'Strength', 'Awareness', 'Catching', 'Blocking']
                },
                defense: {
                    label: 'Opponent Defense',
                    positions: ['DE', 'DT', 'NT', 'DE2', 'WLB', 'MLB', 'SLB', 'CB1', 'CB2', 'FS', 'SS'],
                    archetypes: ['Balanced', 'Speed Rusher', 'Run Stopper', 'Power Rusher', 'Coverage', 'Blitzer', 'Ball Hawk', 'Hard Hitter', 'Man Specialist', 'Zone Specialist'],
                    // Dynamic fields based on pos
                },
                specialTeams: {
                    label: 'Opponent Special Teams',
                    positions: ['K', 'P', 'LS', 'KR', 'PR'],
                    archetypes: ['Power', 'Accuracy', 'Speed/Returner'],
                    ratingFields: ['Kick Power', 'Kick Accuracy', 'Speed', 'Return Ability']
                }
            };

            // Helper to get rating fields
            const getRatingFields = (pos, phase) => {
                if (phase === 'defense') {
                    if (pos.startsWith('D') && !pos.startsWith('DB')) return ['Speed', 'Strength', 'Block Shed', 'Power Move']; // DL/DE/DT
                    if (pos.includes('LB')) return ['Speed', 'Pursuit', 'Awareness', 'Tackling'];
                    return ['Speed', 'Collision', 'Coverage', 'Ball Skills']; // DBs
                }
                if (phase === 'specialTeams') return SCOUTING_CONFIG.specialTeams.ratingFields;
                return SCOUTING_CONFIG.offense.ratingFields;
            };

            const handleSavePlayer = (playerData) => {
                const newData = { ...data };
                const list = [...(newData[activeTab] || [])];
                const idx = list.findIndex(p => p.position === playerData.position);

                if (idx >= 0) {
                    list[idx] = playerData;
                } else {
                    list.push(playerData);
                }

                newData[activeTab] = list;
                onUpdate(newData);
                setEditingPlayer(null);
            };

            const getPlayer = (pos) => {
                return (data[activeTab] || []).find(p => p.position === pos) || { position: pos, name: '', jersey: '', archetype: '', ratings: {} };
            };

            return (
                <div style={{ padding: '2rem', height: '100%', display: 'flex', flexDirection: 'column' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
                        <h1>Opponent Scouting</h1>
                        <div className="btn-group">
                            {['offense', 'defense', 'specialTeams'].map(tab => (
                                <button
                                    key={tab}
                                    className={`btn ${activeTab === tab ? 'btn-primary' : 'btn-secondary'}`}
                                    onClick={() => setActiveTab(tab)}
                                >
                                    {SCOUTING_CONFIG[tab].label}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))',
                        gap: '1.5rem',
                        alignContent: 'start'
                    }}>
                        {SCOUTING_CONFIG[activeTab].positions.map(pos => {
                            const player = getPlayer(pos);
                            const hasData = player.name || player.jersey;

                            return (
                                <div
                                    key={pos}
                                    className="card"
                                    onClick={() => setEditingPlayer(player)}
                                    style={{
                                        padding: '1.5rem',
                                        cursor: 'pointer',
                                        border: hasData ? '2px solid var(--accent)' : '1px solid var(--border)',
                                        background: hasData ? 'var(--bg-panel)' : 'var(--bg-card)',
                                        transition: 'all 0.2s'
                                    }}
                                >
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                                        <span style={{ fontWeight: 'bold', color: 'var(--text-secondary)' }}>{pos}</span>
                                        {player.jersey && (
                                            <span style={{
                                                background: 'var(--accent)',
                                                color: 'white',
                                                padding: '2px 8px',
                                                borderRadius: '12px',
                                                fontSize: '0.8rem',
                                                fontWeight: 'bold'
                                            }}>
                                                #{player.jersey}
                                            </span>
                                        )}
                                    </div>

                                    {hasData ? (
                                        <>
                                            <div style={{ fontSize: '1.2rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                                {player.name}
                                            </div>
                                            <div style={{ fontSize: '0.9rem', color: 'var(--text-secondary)', fontStyle: 'italic', marginBottom: '1rem' }}>
                                                {player.archetype || 'No Archetype'}
                                            </div>
                                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                                                {Object.entries(player.ratings || {}).slice(0, 4).map(([key, val]) => (
                                                    <div key={key} style={{
                                                        background: 'var(--bg-body)',
                                                        padding: '4px 8px',
                                                        borderRadius: '4px',
                                                        fontSize: '0.8rem'
                                                    }}>
                                                        <span style={{ opacity: 0.7 }}>{key.substring(0, 3)}:</span> <b>{val}</b>
                                                    </div>
                                                ))}
                                            </div>
                                        </>
                                    ) : (
                                        <div style={{
                                            height: '80px',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            color: 'var(--text-tertiary)',
                                            border: '2px dashed var(--border)',
                                            borderRadius: '8px'
                                        }}>
                                            <Icon name="Plus" size={24} />
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>

                    {/* Edit Player Modal */}
                    {editingPlayer && (
                        <div className="modal-overlay" onClick={() => setEditingPlayer(null)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth: '500px' }}>
                                <h2>Edit {editingPlayer.position}</h2>

                                <div className="form-group">
                                    <label className="form-label">Full Name</label>
                                    <input
                                        className="form-input"
                                        value={editingPlayer.name}
                                        onChange={e => setEditingPlayer({ ...editingPlayer, name: e.target.value })}
                                        placeholder="Enter name"
                                        autoFocus
                                    />
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Jersey Number</label>
                                    <input
                                        className="form-input"
                                        value={editingPlayer.jersey}
                                        onChange={e => setEditingPlayer({ ...editingPlayer, jersey: e.target.value })}
                                        placeholder="#"
                                    />
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Archetype</label>
                                    <select
                                        className="form-select"
                                        value={editingPlayer.archetype}
                                        onChange={e => setEditingPlayer({ ...editingPlayer, archetype: e.target.value })}
                                    >
                                        <option value="">Select Archetype...</option>
                                        {SCOUTING_CONFIG[activeTab].archetypes.map(arch => (
                                            <option key={arch} value={arch}>{arch}</option>
                                        ))}
                                    </select>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Ratings (0-99)</label>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                        {getRatingFields(editingPlayer.position, activeTab).map(field => (
                                            <div key={field}>
                                                <label style={{ fontSize: '0.85rem', marginBottom: '4px', display: 'block' }}>{field}</label>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    max="99"
                                                    className="form-input"
                                                    value={(editingPlayer.ratings || {})[field] || ''}
                                                    onChange={e => {
                                                        const newRatings = { ...(editingPlayer.ratings || {}) };
                                                        newRatings[field] = e.target.value;
                                                        setEditingPlayer({ ...editingPlayer, ratings: newRatings });
                                                    }}
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '1rem', marginTop: '2rem' }}>
                                    <button className="btn btn-secondary" onClick={() => setEditingPlayer(null)}>Cancel</button>
                                    <button className="btn btn-primary" onClick={() => handleSavePlayer(editingPlayer)}>Save Player</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const OffensiveGamePlan = ({ plays, gamePlan, onUpdateGamePlan, onQuickAddPlay }) => {

            const [viewMode, setViewMode] = useState('call-sheet'); // 'call-sheet', 'matrix', 'list'
            const [selectedSetId, setSelectedSetId] = useState(null);
            const [showPlaySelector, setShowPlaySelector] = useState(false);
            const [playSelectorFilters, setPlaySelectorFilters] = useState({ formation: '', concept: '', tag: '', situation: '' });

            // For Matrix/Grid Cell Editing
            const [activeCellSetId, setActiveCellSetId] = useState(null); // The setId currently being edited via modal

            // For Strike 'Em Out matrix collapsible groups
            const [collapsedGroups, setCollapsedGroups] = useState(new Set());

            // Helper to get play objects for a set ID
            const getPlaysForSet = (setId) => {
                let set = gamePlan.sets?.find(s => s.id === setId);
                if (!set && setId.startsWith('ms_')) {
                    set = gamePlan.miniScripts?.find(s => s.id === setId);
                }
                if (!set) return [];
                return set.playIds.map(id => plays.find(p => p.id === id)).filter(Boolean);
            };

            // Helper to get the set object (or create if implicit)
            const getSet = (setId) => {
                if (setId.startsWith('ms_')) {
                    return gamePlan.miniScripts?.find(s => s.id === setId);
                }
                return gamePlan.sets?.find(s => s.id === setId);
            };

            const handleAddPlayToSet = (setId, playId) => {
                if (setId.startsWith('ms_')) {
                    // Handle Mini Script Update
                    const newMiniScripts = (gamePlan.miniScripts || []).map(s =>
                        s.id === setId ? { ...s, playIds: [...s.playIds, playId] } : s
                    );
                    onUpdateGamePlan({ ...gamePlan, miniScripts: newMiniScripts });
                } else {
                    // Handle Standard Set Update
                    const existingSet = gamePlan.sets?.find(s => s.id === setId);
                    let newSets;
                    if (existingSet) {
                        newSets = gamePlan.sets.map(s => s.id === setId ? { ...s, playIds: [...s.playIds, playId] } : s);
                    } else {
                        // Implicit creation for grid cells
                        newSets = [...(gamePlan.sets || []), { id: setId, name: setId, playIds: [playId] }];
                    }
                    onUpdateGamePlan({ ...gamePlan, sets: newSets });
                }
            };

            const handleRemovePlayFromSet = (setId, playId) => {
                if (setId.startsWith('ms_')) {
                    const existingScript = gamePlan.miniScripts?.find(s => s.id === setId);
                    if (!existingScript) return;
                    const newPlayIds = existingScript.playIds.filter(id => id !== playId);
                    const newMiniScripts = gamePlan.miniScripts.map(s => s.id === setId ? { ...s, playIds: newPlayIds } : s);
                    onUpdateGamePlan({ ...gamePlan, miniScripts: newMiniScripts });
                } else {
                    const existingSet = gamePlan.sets?.find(s => s.id === setId);
                    if (!existingSet) return;
                    const newPlayIds = existingSet.playIds.filter(id => id !== playId);
                    const newSets = gamePlan.sets.map(s => s.id === setId ? { ...s, playIds: newPlayIds } : s);
                    onUpdateGamePlan({ ...gamePlan, sets: newSets });
                }
            };

            // Quick add play to a set
            const handleQuickAddToSet = (setId, playName) => {
                if (!playName.trim() || !onQuickAddPlay) return;

                // Create the incomplete play
                const newPlay = onQuickAddPlay(playName);

                // Add to the set
                handleAddPlayToSet(setId, newPlay.id);
            };


            // Selector Logic (Shared)
            const filteredSelectorPlays = plays.filter(play => {
                const matchFormation = !playSelectorFilters.formation || play.formation === playSelectorFilters.formation;
                const matchConcept = !playSelectorFilters.concept || play.concept === playSelectorFilters.concept;
                const matchTag = !playSelectorFilters.tag || [play.tag1, play.tag2, ...(play.tags || [])].includes(playSelectorFilters.tag);
                const matchSituation = !playSelectorFilters.situation ||
                    (TAG_CATEGORIES["Field Position"] && TAG_CATEGORIES["Field Position"].includes(playSelectorFilters.situation) && play.tags.includes(playSelectorFilters.situation)) ||
                    (TAG_CATEGORIES["Down & Distance"] && TAG_CATEGORIES["Down & Distance"].includes(playSelectorFilters.situation) && play.tags.includes(playSelectorFilters.situation));
                const matchSearch = !playSelectorFilters.search ||
                    play.name.toLowerCase().includes(playSelectorFilters.search.toLowerCase());
                return matchFormation && matchConcept && matchTag && matchSituation && matchSearch;
            });
            const uniqueFormations = [...new Set(plays.map(p => p.formation).filter(Boolean))].sort();
            const uniqueConcepts = [...new Set(plays.map(p => p.concept).filter(Boolean))].sort();
            const allTags = [...new Set(plays.flatMap(p => [p.tag1, p.tag2, ...(p.tags || [])]))].filter(Boolean).sort();
            const situationTags = [...(TAG_CATEGORIES["Field Position"] || []), ...(TAG_CATEGORIES["Down & Distance"] || [])];

            const openPlaySelector = (setId) => {
                setActiveCellSetId(setId);
                setShowPlaySelector(true);
            };

            // --- RENDERERS ---

            const renderPlayListSimple = (setId) => {
                const playsInSet = getPlaysForSet(setId);
                return (
                    <div style={{ padding: '0.25rem' }}>
                        {playsInSet.map(p => (
                            <div key={p.id} style={{ fontSize: '0.7rem', marginBottom: '2px', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                                {p.name}
                            </div>
                        ))}
                        {playsInSet.length === 0 && <div style={{ fontSize: '0.7rem', color: '#ccc', fontStyle: 'italic' }}>+ Add Play</div>}
                    </div>
                );
            };

            const handleCreateMiniScript = () => {
                const name = prompt("Enter Mini Script Name (e.g. 'Red Zone Series'):");
                if (!name) return;

                const newScript = {
                    id: `ms_${Date.now()}`,
                    name,
                    playIds: [],
                    color: '#8b5cf6' // Default purple
                };

                const newGamePlan = {
                    ...gamePlan,
                    miniScripts: [...(gamePlan.miniScripts || []), newScript]
                };
                onUpdateGamePlan(newGamePlan);
            };

            const handleDeleteMiniScript = (scriptId, e) => {
                e.stopPropagation();
                if (!confirm('Delete this mini script?')) return;

                const newGamePlan = {
                    ...gamePlan,
                    miniScripts: (gamePlan.miniScripts || []).filter(s => s.id !== scriptId)
                };
                onUpdateGamePlan(newGamePlan);
            };

            const renderCallSheet = () => {
                const layout = GAME_PLAN_LAYOUTS.CALL_SHEET;
                const miniScripts = gamePlan.miniScripts || [];

                return (
                    <div className="animate-fade-in" style={{ height: '100%', overflowY: 'auto', paddingRight: '1rem' }}>
                        {/* MINI SCRIPTS SECTION */}
                        <div style={{ marginBottom: '2rem' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>
                                <h3 style={{ margin: 0, fontSize: '0.9rem', color: 'var(--text-secondary)' }}>MINI SCRIPTS</h3>
                                <button onClick={handleCreateMiniScript} className="btn-sm" style={{ padding: '0.25rem 0.5rem', fontSize: '0.75rem' }}>
                                    + ADD SCRIPT
                                </button>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '4px' }}>
                                {miniScripts.map(script => (
                                    <div
                                        key={script.id}
                                        style={{ gridColumn: 'span 1', border: '1px solid var(--border)', borderRadius: '4px', overflow: 'hidden', minHeight: '150px', backgroundColor: 'var(--bg-panel)' }}
                                        onClick={() => openPlaySelector(script.id)}
                                    >
                                        <div style={{ backgroundColor: script.color, color: 'white', padding: '0.25rem 0.5rem', fontWeight: 'bold', fontSize: '0.8rem', textAlign: 'center', textTransform: 'uppercase', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                            <span>{script.name}</span>
                                            <span
                                                onClick={(e) => handleDeleteMiniScript(script.id, e)}
                                                style={{ cursor: 'pointer', opacity: 0.8, fontSize: '1rem', lineHeight: 1 }}
                                            >√ó</span>
                                        </div>
                                        <div style={{ padding: '0.5rem' }}>
                                            {renderPlayListSimple(script.id)}
                                        </div>
                                    </div>
                                ))}
                                {miniScripts.length === 0 && (
                                    <div style={{ gridColumn: 'span 4', padding: '1rem', border: '1px dashed var(--border)', borderRadius: '4px', textAlign: 'center', color: 'var(--text-secondary)', fontSize: '0.8rem' }}>
                                        No mini scripts created. Click "+ ADD SCRIPT" to create custom play sequences.
                                    </div>
                                )}
                            </div>
                        </div>

                        {layout.sections.map((section, idx) => (
                            <div key={idx} style={{ marginBottom: '2rem' }}>
                                <div style={{ display: 'grid', gridTemplateColumns: `repeat(${section.cols}, 1fr)`, gap: '4px' }}>
                                    {section.rows.map((cell, cellIdx) => (
                                        <div
                                            key={cell.setId}
                                            style={{ gridColumn: `span ${cell.colSpan}`, border: '1px solid var(--border)', borderRadius: '4px', overflow: 'hidden', minHeight: '150px', backgroundColor: 'var(--bg-panel)' }}
                                            onClick={() => openPlaySelector(cell.setId)}
                                        >
                                            <div style={{ backgroundColor: cell.color, color: 'white', padding: '0.25rem 0.5rem', fontWeight: 'bold', fontSize: '0.8rem', textAlign: 'center', textTransform: 'uppercase' }}>
                                                {cell.header}
                                            </div>
                                            <div style={{ padding: '0.5rem' }}>
                                                {renderPlayListSimple(cell.setId)}
                                                {onQuickAddPlay && (
                                                    <input
                                                        type="text"
                                                        placeholder="+"
                                                        style={{
                                                            width: '100%',
                                                            marginTop: '6px',
                                                            padding: '4px 6px',
                                                            fontSize: '0.8rem',
                                                            border: '1px dashed var(--border)',
                                                            borderRadius: '4px',
                                                            background: 'rgba(255,255,255,0.1)'
                                                        }}
                                                        onClick={(e) => e.stopPropagation()}
                                                        onKeyDown={(e) => {
                                                            if (e.key === 'Enter' && e.target.value.trim()) {
                                                                handleQuickAddToSet(cell.setId, e.target.value);
                                                                e.target.value = '';
                                                                e.preventDefault();
                                                            }
                                                        }}
                                                    />
                                                )}

                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                );
            };

            const renderMatrix = () => {
                const layout = GAME_PLAN_LAYOUTS.MATRIX;

                // Group columns by pitch type
                const columnGroups = [
                    { id: 'FB', label: 'FASTBALL', cols: layout.cols.slice(0, 2) },
                    { id: 'CB', label: 'CURVEBALL', cols: layout.cols.slice(2, 4) },
                    { id: 'CU', label: 'CHANGE UP', cols: layout.cols.slice(4, 6) },
                    { id: 'SO', label: 'STRIKEOUT', cols: layout.cols.slice(6, 8) }
                ];

                const toggleGroup = (groupId) => {
                    setCollapsedGroups(prev => {
                        const newCollapsed = new Set(prev);
                        if (newCollapsed.has(groupId)) {
                            newCollapsed.delete(groupId);
                        } else {
                            newCollapsed.add(groupId);
                        }
                        return newCollapsed;
                    });
                };

                return (
                    <div className="animate-fade-in" style={{ height: '100%', overflowX: 'auto', overflowY: 'auto' }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '0.75rem' }}>
                            <thead>
                                <tr>
                                    <th style={{ padding: '0.5rem', border: '1px solid var(--border)', width: '120px', position: 'sticky', left: 0, backgroundColor: 'var(--bg-card)', zIndex: 10 }}>Formation / Type</th>
                                    {columnGroups.map(group => {
                                        const isCollapsed = collapsedGroups.has(group.id);
                                        return (
                                            <React.Fragment key={group.id}>
                                                {isCollapsed ? (
                                                    <th
                                                        style={{ padding: '0.5rem', border: '1px solid var(--border)', backgroundColor: '#334155', color: 'white', cursor: 'pointer', minWidth: '60px' }}
                                                        onClick={() => toggleGroup(group.id)}
                                                        title={`Click to expand ${group.label}`}
                                                    >
                                                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.25rem' }}>
                                                            <span>‚ñ∂</span>
                                                            <span style={{ writingMode: 'vertical-rl', transform: 'rotate(180deg)' }}>{group.label}</span>
                                                        </div>
                                                    </th>
                                                ) : (
                                                    <>
                                                        {group.cols.map((col, idx) => (
                                                            <th
                                                                key={col.id}
                                                                style={{
                                                                    padding: '0.5rem',
                                                                    border: '1px solid var(--border)',
                                                                    backgroundColor: '#334155',
                                                                    color: 'white',
                                                                    minWidth: '100px',
                                                                    cursor: idx === 0 ? 'pointer' : 'default'
                                                                }}
                                                                onClick={idx === 0 ? () => toggleGroup(group.id) : undefined}
                                                                title={idx === 0 ? `Click to collapse ${group.label}` : col.fullLabel}
                                                            >
                                                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.25rem', justifyContent: 'center' }}>
                                                                    {idx === 0 && <span style={{ fontSize: '0.7rem' }}>‚ñº</span>}
                                                                    <span>{col.fullLabel}</span>
                                                                </div>
                                                            </th>
                                                        ))}
                                                    </>
                                                )}
                                            </React.Fragment>
                                        );
                                    })}
                                </tr>
                            </thead>
                            <tbody>
                                {layout.formations.map(formation => (
                                    <React.Fragment key={formation.id}>
                                        {/* Formation Header Row */}
                                        <tr>
                                            <td colSpan={columnGroups.reduce((acc, g) => acc + (collapsedGroups.has(g.id) ? 1 : g.cols.length), 1)} style={{ padding: '0.5rem', border: '1px solid var(--border)', fontWeight: 'bold', backgroundColor: formation.color, color: 'white', fontSize: '0.9rem' }}>
                                                {formation.label}
                                            </td>
                                        </tr>
                                        {/* Play Type Rows */}
                                        {layout.playTypes.map(playType => {
                                            return (
                                                <tr key={`${formation.id}_${playType.id}`}>
                                                    <td style={{ padding: '0.5rem', border: '1px solid var(--border)', fontWeight: '500', backgroundColor: 'var(--surface)', position: 'sticky', left: 0, zIndex: 5 }}>
                                                        {playType.label}
                                                    </td>
                                                    {columnGroups.map(group => {
                                                        const isCollapsed = collapsedGroups.has(group.id);
                                                        if (isCollapsed) {
                                                            // Show collapsed placeholder
                                                            return (
                                                                <td
                                                                    key={group.id}
                                                                    style={{ padding: '0.25rem', border: '1px solid var(--border)', backgroundColor: '#e5e7eb', textAlign: 'center' }}
                                                                >
                                                                    <span style={{ fontSize: '0.7rem', color: '#6b7280' }}>‚Ä¢‚Ä¢‚Ä¢</span>
                                                                </td>
                                                            );
                                                        } else {
                                                            // Show expanded columns
                                                            return group.cols.map(col => {
                                                                const setId = `matrix_${formation.id}_${playType.id}_${col.id}`;
                                                                return (
                                                                    <td
                                                                        key={setId}
                                                                        style={{ padding: '0.25rem', border: '1px solid var(--border)', verticalAlign: 'top', cursor: 'pointer', minHeight: '60px', backgroundColor: 'var(--bg-card)' }}
                                                                        onClick={() => openPlaySelector(setId)}
                                                                    >
                                                                        {renderPlayListSimple(setId)}
                                                                        {onQuickAddPlay && (
                                                                            <input
                                                                                type="text"
                                                                                placeholder="+"
                                                                                style={{
                                                                                    width: '100%',
                                                                                    marginTop: '4px',
                                                                                    padding: '2px 4px',
                                                                                    fontSize: '0.75rem',
                                                                                    border: '1px dashed var(--border)',
                                                                                    borderRadius: '3px',
                                                                                    background: 'rgba(255,255,255,0.1)'
                                                                                }}
                                                                                onClick={(e) => e.stopPropagation()}
                                                                                onKeyDown={(e) => {
                                                                                    if (e.key === 'Enter' && e.target.value.trim()) {
                                                                                        handleQuickAddToSet(setId, e.target.value);
                                                                                        e.target.value = '';
                                                                                        e.preventDefault(); // Prevent modal opening if it somehow bubbles
                                                                                    }
                                                                                }}
                                                                            />
                                                                        )}
                                                                    </td>
                                                                );
                                                            });
                                                        }
                                                    })}
                                                </tr>
                                            );
                                        })}
                                    </React.Fragment>
                                ))}
                            </tbody>
                        </table>
                    </div>
                );
            };

            return (
                <div style={{ display: 'flex', flexDirection: 'column', height: 'calc(100vh - 100px)', gap: '1rem' }}>

                    {/* Toolbar */}
                    <div style={{ display: 'flex', gap: '1rem', borderBottom: '1px solid var(--border)', paddingBottom: '1rem' }}>
                        <button className={`btn ${viewMode === 'call-sheet' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setViewMode('call-sheet')}>
                            Call Sheet
                        </button>
                        <button className={`btn ${viewMode === 'matrix' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setViewMode('matrix')}>
                            Strike 'Em Out
                        </button>
                    </div>

                    {/* View Content */}
                    <div style={{ flex: 1, overflow: 'hidden' }}>
                        {viewMode === 'call-sheet' && renderCallSheet()}
                        {viewMode === 'matrix' && renderMatrix()}
                    </div>


                    {/* Play Selector Modal */}
                    {showPlaySelector && (
                        <div style={{
                            position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh',
                            backgroundColor: 'rgba(0,0,0,0.8)', zIndex: 1000, display: 'flex', justifyContent: 'center', alignItems: 'center'
                        }} onClick={() => setShowPlaySelector(false)}>
                            <div style={{ width: '80%', height: '80%', backgroundColor: 'var(--bg-panel)', borderRadius: '12px', padding: '2rem', display: 'flex', flexDirection: 'column' }} onClick={e => e.stopPropagation()}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '1rem', alignItems: 'center' }}>
                                    <h2>Select Plays</h2>
                                    <button className="btn" onClick={() => setShowPlaySelector(false)}>Close</button>
                                </div>

                                {/* Search Bar */}
                                <div style={{ marginBottom: '1rem' }}>
                                    <input
                                        type="text"
                                        className="form-input"
                                        placeholder="üîç Search plays by name..."
                                        value={playSelectorFilters.search || ''}
                                        onChange={e => setPlaySelectorFilters({ ...playSelectorFilters, search: e.target.value })}
                                        style={{
                                            width: '100%',
                                            fontSize: '1.1rem',
                                            padding: '0.75rem 1rem'
                                        }}
                                    />
                                </div>

                                {/* Filter Dropdowns */}
                                <div style={{ display: 'flex', gap: '1rem', marginBottom: '1rem' }}>
                                    <select className="form-select" value={playSelectorFilters.formation} onChange={e => setPlaySelectorFilters({ ...playSelectorFilters, formation: e.target.value })}>
                                        <option value="">All Formations</option>
                                        {uniqueFormations.map(f => <option key={f} value={f}>{f}</option>)}
                                    </select>
                                    <select className="form-select" value={playSelectorFilters.concept} onChange={e => setPlaySelectorFilters({ ...playSelectorFilters, concept: e.target.value })}>
                                        <option value="">All Concepts</option>
                                        {uniqueConcepts.map(c => <option key={c} value={c}>{c}</option>)}
                                    </select>
                                    <select className="form-select" value={playSelectorFilters.situation} onChange={e => setPlaySelectorFilters({ ...playSelectorFilters, situation: e.target.value })}>
                                        <option value="">All Situations</option>
                                        {situationTags.map(s => <option key={s} value={s}>{s}</option>)}
                                    </select>
                                    <select className="form-select" value={playSelectorFilters.tag} onChange={e => setPlaySelectorFilters({ ...playSelectorFilters, tag: e.target.value })}>
                                        <option value="">All Tags</option>
                                        {allTags.map(t => <option key={t} value={t}>{t}</option>)}
                                    </select>
                                </div>

                                {/* Current Set Plays (Top) */}
                                <div style={{ marginBottom: '1rem', padding: '1rem', border: '1px solid var(--border)', borderRadius: '8px' }}>
                                    <h4 style={{ marginBottom: '0.5rem' }}>Selected Plays:</h4>
                                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                                        {getPlaysForSet(activeCellSetId).map(p => (
                                            <span key={p.id} style={{ padding: '0.25rem 0.5rem', backgroundColor: 'var(--primary)', borderRadius: '4px', fontSize: '0.8rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                {p.name}
                                                <button onClick={() => handleRemovePlayFromSet(activeCellSetId, p.id)} style={{ border: 'none', background: 'none', color: 'white', cursor: 'pointer' }}>√ó</button>
                                            </span>
                                        ))}
                                    </div>
                                </div>

                                <div style={{ flex: 1, overflowY: 'auto', display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: '1rem', alignContent: 'start' }}>
                                    {filteredSelectorPlays.map(play => (
                                        <div key={play.id}
                                            style={{ padding: '0.5rem', border: '1px solid var(--border)', borderRadius: 'var(--radius)', cursor: 'pointer', backgroundColor: 'rgba(255,255,255,0.05)', display: 'flex', flexDirection: 'column' }}
                                            onClick={() => handleAddPlayToSet(activeCellSetId, play.id)}
                                        >
                                            <div style={{ fontWeight: 'bold', marginBottom: '0.25rem' }}>{play.name}</div>
                                            <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', marginBottom: '0.5rem' }}>{play.formation} - {play.concept}</div>
                                            {play.image ? (
                                                <div style={{ height: '100px', backgroundColor: 'white', display: 'flex', justifyContent: 'center', alignItems: 'center', marginBottom: '0.5rem', borderRadius: '4px', overflow: 'hidden' }}>
                                                    <img src={play.image} style={{ maxWidth: '100%', maxHeight: '100%', objectFit: 'contain' }} />
                                                </div>
                                            ) : null}
                                            <button className="btn btn-primary" style={{ width: '100%', fontSize: '0.8rem' }}>Add</button>
                                        </div>
                                    ))}
                                    {filteredSelectorPlays.length === 0 && (
                                        <div style={{ gridColumn: '1 / -1', textAlign: 'center', padding: '2rem', color: 'var(--text-secondary)' }}>
                                            No plays match filters.
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };


        const JerseyLottery = ({ roster, lotteryData, onUpdateLottery }) => {
            const [view, setView] = useState('bidding'); // 'bidding', 'results'
            const [selectedBidderId, setSelectedBidderId] = useState('');
            const [battleNumber, setBattleNumber] = useState(null);
            const [battleLives, setBattleLives] = useState({});

            // Ensure data structure
            const bids = lotteryData?.bids || {};
            const winners = lotteryData?.winners || {};
            const availableNumbers = lotteryData?.available || Array.from({ length: 99 }, (_, i) => i + 1);

            const getRemainingTokens = (pid) => {
                const playerBids = bids[pid] || {};
                const total = Object.values(playerBids).reduce((a, b) => a + b, 0);
                return 7 - total;
            };

            const handleBid = (pid, number, delta) => {
                const currentBids = { ...(bids[pid] || {}) };
                const currentVal = currentBids[number] || 0;
                const remaining = getRemainingTokens(pid);

                if (delta > 0 && remaining <= 0) return;
                if (delta < 0 && currentVal <= 0) return;

                const newVal = currentVal + delta;
                if (newVal === 0) delete currentBids[number];
                else currentBids[number] = newVal;

                const newAllBids = { ...bids, [pid]: currentBids };
                onUpdateLottery({ ...lotteryData, bids: newAllBids });
            };

            const getBidsForNumber = (num) => {
                const bidders = [];
                Object.entries(bids).forEach(([pid, playerBids]) => {
                    if (playerBids[num]) bidders.push({ pid, tokens: playerBids[num] });
                });
                return bidders.sort((a, b) => b.tokens - a.tokens);
            };

            const startBattle = (num) => {
                const bidders = getBidsForNumber(num);
                const lives = {};
                bidders.forEach(b => lives[b.pid] = b.tokens);
                setBattleLives(lives);
                setBattleNumber(num);
            };

            const updateLife = (pid, delta) => {
                setBattleLives(prev => ({
                    ...prev,
                    [pid]: Math.max(0, (prev[pid] || 0) + delta)
                }));
            };

            const declareWinner = (num, pid) => {
                if (!confirm(`Declare ${roster.find(p => p.id === pid)?.name} the winner of #${num}?`)) return;
                onUpdateLottery({ ...lotteryData, winners: { ...winners, [num]: pid } });
                setBattleNumber(null);
            };

            const clearWinner = (num) => {
                if (!confirm(`Reset winner for #${num}?`)) return;
                const newWinners = { ...winners };
                delete newWinners[num];
                onUpdateLottery({ ...lotteryData, winners: newWinners });
            };

            return (
                <div className="card">
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                        <h2>Jersey Number Lottery</h2>
                        <div style={{ display: 'flex', gap: '0.5rem' }}>
                            <button className={`btn ${view === 'bidding' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setView('bidding')}>Place Bids</button>
                            <button className={`btn ${view === 'results' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setView('results')}>Lottery Board</button>
                        </div>
                    </div>

                    {view === 'bidding' && (
                        <div>
                            <div style={{ marginBottom: '1rem' }}>
                                <label className="form-label">Select Player</label>
                                <select className="form-select" value={selectedBidderId} onChange={e => setSelectedBidderId(e.target.value)}>
                                    <option value="">-- Choose Athlete --</option>
                                    {roster.sort((a, b) => a.lastName.localeCompare(b.lastName)).map(p => (
                                        <option key={p.id} value={p.id}>{p.lastName}, {p.firstName} (Tokens: {getRemainingTokens(p.id)})</option>
                                    ))}
                                </select>
                            </div>

                            {selectedBidderId && (
                                <div>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', marginBottom: '1rem', padding: '1rem', background: 'var(--surface)', borderRadius: '8px' }}>
                                        <div style={{ fontSize: '1.2rem', fontWeight: 'bold' }}>Tokens Remaining:</div>
                                        <div style={{ display: 'flex', gap: '4px' }}>
                                            {Array.from({ length: 7 }).map((_, i) => (
                                                <div key={i} style={{
                                                    width: '24px', height: '24px', borderRadius: '50%',
                                                    background: i < getRemainingTokens(selectedBidderId) ? 'var(--accent)' : 'var(--border)',
                                                    border: '1px solid var(--border)'
                                                }}></div>
                                            ))}
                                        </div>
                                    </div>

                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(60px, 1fr))', gap: '0.5rem' }}>
                                        {availableNumbers.map(num => {
                                            const playerBid = (bids[selectedBidderId] || {})[num] || 0;
                                            const isTaken = Object.values(winners).includes(num); // Or check unavailable list
                                            const isWonByMe = winners[num] === selectedBidderId;

                                            // Check if won by someone else
                                            const winnerId = winners[num];
                                            const isWonByOther = winnerId && winnerId !== selectedBidderId;

                                            return (
                                                <button
                                                    key={num}
                                                    onClick={() => !isWonByOther && handleBid(selectedBidderId, num, 1)}
                                                    onContextMenu={(e) => { e.preventDefault(); handleBid(selectedBidderId, num, -1); }}
                                                    disabled={isWonByOther}
                                                    style={{
                                                        height: '60px',
                                                        display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center',
                                                        border: isWonByOther ? '1px solid var(--border)' : playerBid > 0 ? '2px solid var(--accent)' : '1px solid var(--border)',
                                                        background: isWonByMe ? '#dcfce7' : isWonByOther ? '#eee' : playerBid > 0 ? 'var(--surface)' : 'transparent',
                                                        opacity: isWonByOther ? 0.5 : 1,
                                                        cursor: isWonByOther ? 'not-allowed' : 'pointer',
                                                        position: 'relative'
                                                    }}
                                                >
                                                    <span style={{ fontSize: '1.2rem', fontWeight: 'bold' }}>{num}</span>
                                                    {playerBid > 0 && (
                                                        <div style={{
                                                            position: 'absolute', top: '-5px', right: '-5px',
                                                            background: 'var(--accent)', color: 'white',
                                                            borderRadius: '50%', width: '20px', height: '20px',
                                                            fontSize: '0.8rem', display: 'flex', alignItems: 'center', justifyContent: 'center'
                                                        }}>
                                                            {playerBid}
                                                        </div>
                                                    )}
                                                </button>
                                            );
                                        })}
                                    </div>
                                    <div style={{ marginTop: '1rem', color: 'var(--text-secondary)', fontSize: '0.9rem' }}>
                                        * Left Click to Add Token, Right Click to Remove Token.
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {view === 'results' && (
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))', gap: '1rem' }}>
                            {availableNumbers.filter(num => getBidsForNumber(num).length > 0).map(num => {
                                const bidders = getBidsForNumber(num);
                                const winnerId = winners[num];
                                const winner = winnerId ? roster.find(p => p.id === winnerId) : null;
                                const isConflict = bidders.length > 1;

                                return (
                                    <div key={num} className="card" style={{ padding: '1rem', border: winner ? '2px solid #10b981' : isConflict ? '2px solid #f59e0b' : '1px solid var(--border)' }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>
                                            <h3 style={{ margin: 0, fontSize: '2rem' }}>#{num}</h3>
                                            {winner ? (
                                                <span style={{ background: '#dcfce7', color: '#166534', padding: '2px 6px', borderRadius: '4px', fontSize: '0.8rem', fontWeight: 'bold' }}>MATCHED</span>
                                            ) : isConflict ? (
                                                <span style={{ background: '#fef3c7', color: '#b45309', padding: '2px 6px', borderRadius: '4px', fontSize: '0.8rem', fontWeight: 'bold' }}>CONFLICT</span>
                                            ) : (
                                                <span style={{ background: '#e0f2fe', color: '#0369a1', padding: '2px 6px', borderRadius: '4px', fontSize: '0.8rem', fontWeight: 'bold' }}>OPEN</span>
                                            )}
                                        </div>

                                        <div style={{ marginBottom: '1rem' }}>
                                            {winner ? (
                                                <div style={{ fontWeight: 'bold', fontSize: '1.1rem' }}>{winner.name}</div>
                                            ) : (
                                                <ul style={{ listStyle: 'none', padding: 0, margin: 0 }}>
                                                    {bidders.map(b => {
                                                        const p = roster.find(x => x.id === b.pid);
                                                        return (
                                                            <li key={b.pid} style={{ display: 'flex', justifySelf: 'space-between', fontSize: '0.9rem', marginBottom: '0.25rem' }}>
                                                                <span style={{ flex: 1 }}>{p?.lastName}</span>
                                                                <span style={{ fontWeight: 'bold', color: 'var(--accent)' }}>{b.tokens} Lives</span>
                                                            </li>
                                                        );
                                                    })}
                                                </ul>
                                            )}
                                        </div>

                                        <div style={{ display: 'flex', gap: '0.5rem' }}>
                                            {winner ? (
                                                <button className="btn btn-secondary" style={{ width: '100%', fontSize: '0.8rem' }} onClick={() => clearWinner(num)}>Reset</button>
                                            ) : (
                                                <>
                                                    {isConflict ? (
                                                        <button className="btn" style={{ width: '100%', background: '#f59e0b', color: 'white' }} onClick={() => startBattle(num)}>‚öîÔ∏è Battle!</button>
                                                    ) : (
                                                        <button className="btn btn-primary" style={{ width: '100%' }} onClick={() => declareWinner(num, bidders[0].pid)}>Assign</button>
                                                    )}
                                                </>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {/* Battle Modal Overlay */}
                    {battleNumber && (
                        <div style={{
                            position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                            background: 'rgba(0,0,0,0.8)', display: 'flex', alignItems: 'center', justifyContent: 'center',
                            zIndex: 1000
                        }}>
                            <div className="card" style={{ width: '500px', maxWidth: '90vw', border: '2px solid #f59e0b' }}>
                                <div style={{ textAlign: 'center', marginBottom: '2rem' }}>
                                    <h2 style={{ fontSize: '3rem', margin: 0 }}>#{battleNumber}</h2>
                                    <div style={{ color: '#f59e0b', fontWeight: 'bold', letterSpacing: '1px' }}>ROCK PAPER SCISSORS BATTLE</div>
                                </div>

                                <div style={{ display: 'grid', gap: '1rem', marginBottom: '2rem' }}>
                                    {getBidsForNumber(battleNumber).map(b => {
                                        const p = roster.find(x => x.id === b.pid);
                                        const lives = battleLives[b.pid] ?? b.tokens;
                                        const isOut = lives === 0;

                                        return (
                                            <div key={b.pid} style={{
                                                display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                                                padding: '1rem', background: 'var(--bg-body)', borderRadius: '8px',
                                                opacity: isOut ? 0.4 : 1
                                            }}>
                                                <div style={{ fontSize: '1.2rem', fontWeight: 'bold' }}>{p?.name}</div>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                                                    <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: isOut ? 'red' : 'var(--accent)' }}>
                                                        {lives} <span style={{ fontSize: '0.8rem', color: 'var(--text-secondary)' }}>LIVES</span>
                                                    </div>
                                                    <button
                                                        className="btn"
                                                        style={{ background: '#ef4444', color: 'white', padding: '4px 8px' }}
                                                        onClick={() => updateLife(b.pid, -1)}
                                                        disabled={isOut}
                                                    >
                                                        -1
                                                    </button>
                                                    {lives > 0 && Object.values(battleLives).filter(l => l > 0).length === 1 && (
                                                        <button className="btn btn-primary" onClick={() => declareWinner(battleNumber, b.pid)}>Winner üèÜ</button>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>

                                <button className="btn btn-secondary" style={{ width: '100%' }} onClick={() => setBattleNumber(null)}>Cancel Battle</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const EquipmentManager = ({ view, roster, inventory, onUpdateInventory, checkouts, onUpdateCheckouts, issuance, onUpdateIssuance, wishlist, onUpdateWishlist, lotteryData, onUpdateLottery }) => {
            const [newItem, setNewItem] = useState({ name: '', type: '', quantity: 0, condition: 'New' });
            const [selectedPlayerId, setSelectedPlayerId] = useState('');
            const [newWish, setNewWish] = useState({ item: '', priority: 'Medium', cost: 0, link: '' });

            const itemTypes = ['Helmet', 'Shoulder Pads', 'Jersey', 'Pants', 'Cleats', 'Training Gear', 'Other'];
            const conditions = ['New', 'Good', 'Fair', 'Poor', 'Retired'];

            // Simplified standard inventory (Quantity tracking only)
            const addInventoryItem = () => {
                if (!newItem.name) return;
                const id = 'item_' + Date.now();
                onUpdateInventory([...inventory, { ...newItem, id }]);
                setNewItem({ name: '', type: '', quantity: 0, condition: 'New' });
            };

            const deleteInventoryItem = (id) => {
                if (confirm('Delete this item?')) {
                    onUpdateInventory(inventory.filter(i => i.id !== id));
                }
            };

            // Detailed Issuance Logic
            const GEAR_ROWS = [
                { id: 'helmet', label: 'Helmet', fields: ['Style', 'Size', '#'] },
                { id: 'shoulderPads', label: 'Shoulder Pads', fields: ['Size', '#'] },
                { id: 'practiceJersey', label: 'Practice Jersey', fields: ['#', 'Color'] },
                { id: 'practicePants', label: 'Practice Pants', fields: ['Size'] },
                { id: 'gamePantsWhite', label: 'Game Pants (White)', fields: ['Size'] },
                { id: 'gamePantsBlack', label: 'Game Pants (Black)', fields: ['Size'] },
                { id: 'gamePantsGray', label: 'Game Pants (Gray)', fields: ['Size'] },
                { id: 'kneePads', label: 'Knee Pads', type: 'checkbox' },
                { id: 'jerseyBlack', label: 'Black Game Jersey (Var/JV2)', fields: ['#'] },
                { id: 'jerseyWhite', label: 'White Game Jersey (Var/JV2)', fields: ['#'] },
                { id: 'jerseyRed', label: 'Red Game Jersey (Var)', fields: ['#'] },
                { id: 'guardianCap', label: 'Guardian Cap', type: 'checkbox' },
                { id: 'travelJacket', label: 'Black Travel Jacket', type: 'checkbox' },
                { id: 'poloGray', label: 'Gray Polo', type: 'checkbox' },
                { id: 'poloWhite', label: 'White Polo', type: 'checkbox' },
                { id: 'travelPants', label: 'Travel Pants', type: 'checkbox' },
            ];

            const handleIssuanceChange = (rowId, field, value) => {
                if (!selectedPlayerId) return;
                const playerGear = issuance[selectedPlayerId] || {};
                const currentRow = playerGear[rowId] || {};

                const updatedRow = { ...currentRow, [field]: value };
                const updatedGear = { ...playerGear, [rowId]: updatedRow };

                onUpdateIssuance({ ...issuance, [selectedPlayerId]: updatedGear });
            };

            const handleCheckboxChange = (rowId, checked) => {
                if (!selectedPlayerId) return;
                const playerGear = issuance[selectedPlayerId] || {};
                const updatedGear = { ...playerGear, [rowId]: { issued: checked } }; // simple object for checkboxes
                onUpdateIssuance({ ...issuance, [selectedPlayerId]: updatedGear });
            };

            // Wishlist Actions
            const addWish = () => {
                if (!newWish.item) return;
                const id = 'wish_' + Date.now();
                onUpdateWishlist([...wishlist, { ...newWish, id, status: 'Pending' }]);
                setNewWish({ item: '', priority: 'Medium', cost: 0, link: '' });
            };

            const toggleWishStatus = (id) => {
                onUpdateWishlist(wishlist.map(w => w.id === id ? { ...w, status: w.status === 'Pending' ? 'Purchased' : 'Pending' } : w));
            };

            if (view === 'equipment-lottery') {
                return <JerseyLottery roster={roster} lotteryData={lotteryData} onUpdateLottery={onUpdateLottery} />;
            }
            if (view === 'equipment-inventory') {
                return (
                    <div className="card">
                        <h2>Current Inventory</h2>
                        <div style={{ display: 'flex', gap: '1rem', marginBottom: '1rem', alignItems: 'flex-end' }}>
                            <div>
                                <label className="form-label">Item Name</label>
                                <input className="form-input" value={newItem.name} onChange={e => setNewItem({ ...newItem, name: e.target.value })} placeholder="e.g. Riddell Speedflex" />
                            </div>
                            <div>
                                <label className="form-label">Type</label>
                                <select className="form-select" value={newItem.type} onChange={e => setNewItem({ ...newItem, type: e.target.value })}>
                                    <option value="">Select Type</option>
                                    {itemTypes.map(t => <option key={t} value={t}>{t}</option>)}
                                </select>
                            </div>
                            <div style={{ width: '80px' }}>
                                <label className="form-label">Qty</label>
                                <input className="form-input" type="number" value={newItem.quantity} onChange={e => setNewItem({ ...newItem, quantity: parseInt(e.target.value) || 0 })} />
                            </div>
                            <div>
                                <label className="form-label">Condition</label>
                                <select className="form-select" value={newItem.condition} onChange={e => setNewItem({ ...newItem, condition: e.target.value })}>
                                    {conditions.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                            <button className="btn btn-primary" onClick={addInventoryItem}>Add Item</button>
                        </div>

                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead>
                                <tr style={{ borderBottom: '1px solid var(--border)', textAlign: 'left' }}>
                                    <th style={{ padding: '0.5rem' }}>Name</th>
                                    <th style={{ padding: '0.5rem' }}>Type</th>
                                    <th style={{ padding: '0.5rem' }}>Qty</th>
                                    <th style={{ padding: '0.5rem' }}>Condition</th>
                                    <th style={{ padding: '0.5rem' }}>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {inventory.map(item => (
                                    <tr key={item.id} style={{ borderBottom: '1px solid var(--border)' }}>
                                        <td style={{ padding: '0.5rem' }}>{item.name}</td>
                                        <td style={{ padding: '0.5rem' }}>{item.type}</td>
                                        <td style={{ padding: '0.5rem' }}>{item.quantity}</td>
                                        <td style={{ padding: '0.5rem' }}>
                                            <span style={{
                                                padding: '2px 6px', borderRadius: '4px', fontSize: '0.8rem',
                                                background: item.condition === 'New' ? '#dcfce7' : item.condition === 'Poor' ? '#fee2e2' : '#f3f4f6',
                                                color: item.condition === 'New' ? '#166534' : item.condition === 'Poor' ? '#991b1b' : '#374151'
                                            }}>{item.condition}</span>
                                        </td>
                                        <td style={{ padding: '0.5rem' }}>
                                            <button onClick={() => deleteInventoryItem(item.id)} style={{ color: 'red', background: 'none', border: 'none', cursor: 'pointer' }}>Delete</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                );
            }

            if (view === 'equipment-checkout') {
                const playerGear = issuance[selectedPlayerId] || {};

                return (
                    <div className="card">
                        <h2>Equipment Checkout & Issuance</h2>
                        <div style={{ marginBottom: '2rem', padding: '1rem', background: 'var(--surface)', borderRadius: '8px' }}>
                            <label className="form-label">Select Player</label>
                            <select className="form-select" value={selectedPlayerId} onChange={e => setSelectedPlayerId(e.target.value)} style={{ fontSize: '1.2rem', padding: '0.75rem' }}>
                                <option value="">-- Choose Athlete --</option>
                                {roster.sort((a, b) => a.name.localeCompare(b.name)).map(p => (
                                    <option key={p.id} value={p.id}>{p.name} #{p.number}</option>
                                ))}
                            </select>
                        </div>

                        {selectedPlayerId ? (
                            <div style={{ display: 'grid', gap: '1rem' }}>
                                {GEAR_ROWS.map(row => (
                                    <div key={row.id} style={{ display: 'flex', alignItems: 'center', padding: '0.75rem', borderBottom: '1px solid var(--border)', background: row.type === 'checkbox' && playerGear[row.id]?.issued ? '#f0fdf4' : 'transparent' }}>
                                        <div style={{ width: '250px', fontWeight: 'bold' }}>{row.label}</div>
                                        <div style={{ flex: 1, display: 'flex', gap: '1rem' }}>
                                            {row.type === 'checkbox' ? (
                                                <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer' }}>
                                                    <input
                                                        type="checkbox"
                                                        checked={playerGear[row.id]?.issued || false}
                                                        onChange={e => handleCheckboxChange(row.id, e.target.checked)}
                                                        style={{ width: '20px', height: '20px' }}
                                                    />
                                                    Issued
                                                </label>
                                            ) : (
                                                row.fields.map(field => (
                                                    <div key={field} style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                        <span style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>{field}:</span>
                                                        <input
                                                            className="form-input"
                                                            style={{ width: field === '#' ? '60px' : field === 'Size' ? '80px' : '150px', padding: '0.25rem' }}
                                                            value={playerGear[row.id]?.[field] || ''}
                                                            onChange={e => handleIssuanceChange(row.id, field, e.target.value)}
                                                            placeholder={field}
                                                        />
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div style={{ textAlign: 'center', padding: '3rem', color: 'var(--text-secondary)', fontStyle: 'italic' }}>
                                Select a player to view and edit their equipment file.
                            </div>
                        )}
                    </div>
                );
            }

            if (view === 'equipment-wishlist') {
                return (
                    <div className="card">
                        <h2>Wishlist / Needs</h2>
                        <div style={{ display: 'flex', gap: '1rem', marginBottom: '1rem', alignItems: 'flex-end' }}>
                            <div style={{ flex: 2 }}>
                                <label className="form-label">Item Needed</label>
                                <input className="form-input" value={newWish.item} onChange={e => setNewWish({ ...newWish, item: e.target.value })} />
                            </div>
                            <div>
                                <label className="form-label">Priority</label>
                                <select className="form-select" value={newWish.priority} onChange={e => setNewWish({ ...newWish, priority: e.target.value })}>
                                    <option>High</option>
                                    <option>Medium</option>
                                    <option>Low</option>
                                </select>
                            </div>
                            <div>
                                <label className="form-label">Est. Cost</label>
                                <input className="form-input" type="number" value={newWish.cost} onChange={e => setNewWish({ ...newWish, cost: parseFloat(e.target.value) || 0 })} />
                            </div>
                            <button className="btn btn-primary" onClick={addWish}>Add Wish</button>
                        </div>

                        <ul style={{ listStyle: 'none', padding: 0 }}>
                            {wishlist.map(wish => (
                                <li key={wish.id} style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '1rem', borderBottom: '1px solid var(--border)', opacity: wish.status === 'Purchased' ? 0.6 : 1 }}>
                                    <div>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                            <strong style={{ textDecoration: wish.status === 'Purchased' ? 'line-through' : 'none' }}>{wish.item}</strong>
                                            <span style={{
                                                fontSize: '0.7rem', padding: '2px 6px', borderRadius: '4px',
                                                background: wish.priority === 'High' ? '#fee2e2' : '#f3f4f6',
                                                color: wish.priority === 'High' ? '#991b1b' : '#374151'
                                            }}>{wish.priority}</span>
                                        </div>
                                        <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>Est. Cost: ${wish.cost}</div>
                                    </div>
                                    <button
                                        onClick={() => toggleWishStatus(wish.id)}
                                        style={{
                                            padding: '0.5rem 1rem', borderRadius: '20px', border: 'none', cursor: 'pointer',
                                            background: wish.status === 'Purchased' ? '#dcfce7' : '#e5e7eb',
                                            color: wish.status === 'Purchased' ? '#166534' : '#374151'
                                        }}
                                    >
                                        {wish.status === 'Purchased' ? 'Purchased' : 'Mark Purchased'}
                                    </button>
                                </li>
                            ))}
                        </ul>
                    </div>
                );
            }
            return null;
        };


        // --- RBAC CONSTANTS & HELPERS ---
        const ROLES = [
            'Head Coach',
            'Offensive Coordinator',
            'Defensive Coordinator',
            'Special Teams Coordinator',
            'Position Coach',
            'Director of Ops',
            'Recruiting Coordinator',
            'Stats',
            'Trainer'
        ];

        const FEATURES = [
            { id: 'dashboard', label: 'Program Dashboard (Focus/Injuries)' },
            { id: 'playbook', label: 'Playbook' },
            { id: 'callsheet', label: 'Call Sheet & Game Planning' },
            { id: 'install', label: 'Install Schedule' },
            { id: 'scripts', label: 'Practice Scripts' },
            { id: 'depth', label: 'Depth Charts' },
            { id: 'recruiting', label: 'Recruiting Board' },
            { id: 'staff', label: 'Staff Management' },
            { id: 'settings', label: 'Settings & Config' }
        ];

        const DEFAULT_PERMISSIONS = {
            'Head Coach': {
                dashboard: { view: true, edit: true },
                playbook: { view: true, edit: true },
                callsheet: { view: true, edit: true },
                install: { view: true, edit: true },
                scripts: { view: true, edit: true },
                depth: { view: true, edit: true },
                recruiting: { view: true, edit: true },
                staff: { view: true, edit: true },
                settings: { view: true, edit: true }
            },
            'Offensive Coordinator': {
                dashboard: { view: true, edit: true }, // Can update injuries/focus
                playbook: { view: true, edit: true },
                callsheet: { view: true, edit: true },
                install: { view: true, edit: true },
                scripts: { view: true, edit: true },
                depth: { view: true, edit: true }, // Offense depth
                recruiting: { view: true, edit: true }, // Offense recruiting
                staff: { view: true, edit: false },
                settings: { view: false, edit: false }
            },
            'Defensive Coordinator': {
                dashboard: { view: true, edit: true },
                playbook: { view: true, edit: true }, // Assuming shared playbook or separate (future)
                callsheet: { view: true, edit: true },
                install: { view: true, edit: true },
                scripts: { view: true, edit: true },
                depth: { view: true, edit: true },
                recruiting: { view: true, edit: true },
                staff: { view: true, edit: false },
                settings: { view: false, edit: false }
            },
            'Position Coach': {
                dashboard: { view: true, edit: false }, // View only for program focus
                playbook: { view: true, edit: false }, // View only
                callsheet: { view: true, edit: false }, // View only
                install: { view: true, edit: false },
                scripts: { view: true, edit: false },
                depth: { view: true, edit: true }, // Can edit depth (simplified for now)
                recruiting: { view: true, edit: true }, // Can add notes
                staff: { view: false, edit: false },
                settings: { view: false, edit: false }
            },
            'Director of Ops': {
                dashboard: { view: true, edit: true },
                playbook: { view: false, edit: false },
                callsheet: { view: false, edit: false },
                install: { view: true, edit: true }, // Logistics
                scripts: { view: true, edit: true }, // Logistics
                depth: { view: true, edit: false },
                recruiting: { view: true, edit: true },
                staff: { view: true, edit: true },
                settings: { view: true, edit: false }
            },
            'Recruiting Coordinator': {
                dashboard: { view: true, edit: false },
                playbook: { view: false, edit: false },
                callsheet: { view: false, edit: false },
                install: { view: false, edit: false },
                scripts: { view: false, edit: false },
                depth: { view: true, edit: false }, // Needs to see roster
                recruiting: { view: true, edit: true },
                staff: { view: false, edit: false },
                settings: { view: false, edit: false }
            }
        };

        const PermissionsView = ({ permissions, onUpdatePermissions, onResetDefaults }) => {
            const togglePermission = (role, featureId, type) => {
                const newPermissions = JSON.parse(JSON.stringify(permissions));
                if (!newPermissions[role]) newPermissions[role] = {};
                if (!newPermissions[role][featureId]) newPermissions[role][featureId] = { view: false, edit: false };

                newPermissions[role][featureId][type] = !newPermissions[role][featureId][type];

                // Logic: If edit is true, view must be true
                if (type === 'edit' && newPermissions[role][featureId].edit) {
                    newPermissions[role][featureId].view = true;
                }
                // Logic: If view is false, edit must be false
                if (type === 'view' && !newPermissions[role][featureId].view) {
                    newPermissions[role][featureId].edit = false;
                }

                onUpdatePermissions(newPermissions);
            };

            return (
                <div style={{ padding: '2rem', height: '100%', overflowY: 'auto' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
                        <div>
                            <h1 style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>Permissions Management</h1>
                            <div style={{ color: 'var(--text-secondary)' }}>Configure View and Edit access for each staff role.</div>
                        </div>
                        <button className="btn btn-outline" onClick={onResetDefaults}>
                            <Icon name="RotateCcw" size={16} /> Reset to Defaults
                        </button>
                    </div>

                    <div className="card" style={{ overflowX: 'auto' }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse', minWidth: '800px' }}>
                            <thead>
                                <tr style={{ borderBottom: '1px solid var(--border)' }}>
                                    <th style={{ textAlign: 'left', padding: '1rem' }}>Feature</th>
                                    {ROLES.map(role => (
                                        <th key={role} style={{ textAlign: 'center', padding: '1rem', minWidth: '120px' }}>
                                            {role.replace(' Coordinator', ' Coord.')}
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {FEATURES.map(feature => (
                                    <tr key={feature.id} style={{ borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                        <td style={{ padding: '1rem', fontWeight: 'bold' }}>{feature.label}</td>
                                        {ROLES.map(role => {
                                            const rolePerms = permissions[role] || DEFAULT_PERMISSIONS[role] || { view: false, edit: false };
                                            const p = rolePerms[feature.id] || { view: false, edit: false };
                                            const isHC = role === 'Head Coach';

                                            return (
                                                <td key={`${role}-${feature.id}`} style={{ padding: '1rem', textAlign: 'center' }}>
                                                    <div style={{ display: 'flex', justifyContent: 'center', gap: '0.5rem' }}>
                                                        <button
                                                            onClick={() => !isHC && togglePermission(role, feature.id, 'view')}
                                                            title="Toggle View"
                                                            style={{
                                                                background: p.view ? 'rgba(59, 130, 246, 0.2)' : 'rgba(255,255,255,0.05)',
                                                                border: p.view ? '1px solid #3b82f6' : '1px solid transparent',
                                                                color: p.view ? '#3b82f6' : 'var(--text-secondary)',
                                                                padding: '4px 8px', borderRadius: '4px', cursor: isHC ? 'default' : 'pointer',
                                                                opacity: isHC ? 0.5 : 1
                                                            }}
                                                        >
                                                            View
                                                        </button>
                                                        <button
                                                            onClick={() => !isHC && togglePermission(role, feature.id, 'edit')}
                                                            title="Toggle Edit"
                                                            style={{
                                                                background: p.edit ? 'rgba(34, 197, 94, 0.2)' : 'rgba(255,255,255,0.05)',
                                                                border: p.edit ? '1px solid #22c55e' : '1px solid transparent',
                                                                color: p.edit ? '#22c55e' : 'var(--text-secondary)',
                                                                padding: '4px 8px', borderRadius: '4px', cursor: isHC ? 'default' : 'pointer',
                                                                opacity: isHC ? 0.5 : 1
                                                            }}
                                                        >
                                                            Edit
                                                        </button>
                                                    </div>
                                                </td>
                                            );
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // DEFAULT 2025 DATA
        const DEFAULT_ROSTER_2025 = [
            {
                id: 'p1', jersey: '1', firstName: 'Trevor', lastName: 'Britten', name: 'Trevor Britten', year: 'SR', position: 'WR/LB', height: "6'2\"", weight: '185', telephone: '', email: '',
                profile: { favorites: {}, goals: {}, sportsHistory: {} }, metrics: { attendanceStreak: 5, longestStreak: 12, awards: [], warriorDialLogs: [], testHistory: [], weightLog: [] }
            },
            { id: 'p2', jersey: '2', firstName: 'Fiston', lastName: 'Carlson', name: 'Fiston Carlson', year: 'JR', position: 'RB/DL', height: "5'11\"", weight: '180', telephone: '', email: '' },
            { id: 'p3', jersey: '3', firstName: 'Hayden', lastName: 'Janssen', name: 'Hayden Janssen', year: 'SR', position: 'QB/DB', height: "6'3\"", weight: '181', telephone: '', email: '' },
            { id: 'p4', jersey: '4', firstName: 'Cooper', lastName: 'Triggs', name: 'Cooper Triggs', year: 'JR', position: 'RB/DB', height: "5'10\"", weight: '190', telephone: '', email: '' },
            { id: 'p5', jersey: '5', firstName: 'Tucker', lastName: 'Hawkins', name: 'Tucker Hawkins', year: 'JR', position: 'QB/LB', height: "6'3\"", weight: '192', telephone: '', email: '' },
            { id: 'p6', jersey: '6', firstName: 'Logan', lastName: 'Smith', name: 'Logan Smith', year: 'JR', position: 'WR/DB', height: "5'8\"", weight: '155', telephone: '', email: '' },
            { id: 'p7', jersey: '7', firstName: 'Luke', lastName: 'Thoreson', name: 'Luke Thoreson', year: 'JR', position: 'WR/DB', height: "6'3\"", weight: '183', telephone: '', email: '' },
            { id: 'p9', jersey: '9', firstName: 'Noah', lastName: 'Healy', name: 'Noah Healy', year: 'SO', position: 'WR/DB', height: "5'5\"", weight: '127', telephone: '', email: '' },
            { id: 'p11', jersey: '11', firstName: 'Blake', lastName: 'Larson (C)', name: 'Blake Larson (C)', year: 'SR', position: 'WR/DB', height: "5'10\"", weight: '163', telephone: '', email: '', captain: true },
            { id: 'p12', jersey: '12', firstName: 'Jake', lastName: 'Knoll', name: 'Jake Knoll', year: 'JR', position: 'WR/DB', height: "5'10\"", weight: '138', telephone: '', email: '' },
            { id: 'p13', jersey: '13', firstName: 'Colin', lastName: 'Willis', name: 'Colin Willis', year: 'SO', position: 'QB/DB', height: "6'3\"", weight: '165', telephone: '', email: '' },
            { id: 'p16', jersey: '16', firstName: 'Makenna', lastName: 'Springer', name: 'Makenna Springer', year: 'JR', position: 'K', height: "5'4\"", weight: '120', telephone: '', email: '' },
            { id: 'p18', jersey: '18', firstName: 'Wyatt', lastName: 'Ramus', name: 'Wyatt Ramus', year: 'JR', position: 'WR/LB', height: "6'1\"", weight: '181', telephone: '', email: '' },
            { id: 'p21', jersey: '21', firstName: 'Brady', lastName: 'Long', name: 'Brady Long', year: 'SO', position: 'RB/DB', height: "5'7\"", weight: '135', telephone: '', email: '' },
            { id: 'p22', jersey: '22', firstName: 'Cody', lastName: 'Long (C)', name: 'Cody Long (C)', year: 'SR', position: 'WR/DB', height: "5'9\"", weight: '154', telephone: '', email: '', captain: true },
            { id: 'p23', jersey: '23', firstName: 'Myles', lastName: 'McIlrath', name: 'Myles McIlrath', year: 'FR', position: 'K', height: "5'11\"", weight: '140', telephone: '', email: '' },
            { id: 'p24', jersey: '24', firstName: 'Cael', lastName: 'Faber', name: 'Cael Faber', year: 'SR', position: 'K', height: "6'2\"", weight: '180', telephone: '', email: '' },
            { id: 'p25', jersey: '25', firstName: 'Ben', lastName: 'Mazyck', name: 'Ben Mazyck', year: 'JR', position: 'RB/DB', height: "5'9\"", weight: '170', telephone: '', email: '' },
            { id: 'p27', jersey: '27', firstName: 'Brody', lastName: 'Kilstofte', name: 'Brody Kilstofte', year: 'SO', position: 'WR/DB', height: "5'9\"", weight: '140', telephone: '', email: '' },
            { id: 'p28', jersey: '28', firstName: 'Carsyn', lastName: 'Hartmann', name: 'Carsyn Hartmann', year: 'SO', position: 'WR/DB', height: "5'8\"", weight: '140', telephone: '', email: '' },
            { id: 'p30', jersey: '30', firstName: 'Alden', lastName: 'Frey', name: 'Alden Frey', year: 'JR', position: 'WR/DB', height: "5'10\"", weight: '165', telephone: '', email: '' },
            { id: 'p31', jersey: '31', firstName: 'Kale', lastName: 'Kadolph', name: 'Kale Kadolph', year: 'JR', position: 'OL/DL', height: "6'0\"", weight: '165', telephone: '', email: '' },
            { id: 'p34', jersey: '34', firstName: 'Tyler', lastName: 'Lambert', name: 'Tyler Lambert', year: 'JR', position: 'RB/LB', height: "6'0\"", weight: '173', telephone: '', email: '' },
            { id: 'p44', jersey: '44', firstName: 'Cael', lastName: 'Paulson', name: 'Cael Paulson', year: 'SO', position: 'WR/LB', height: "6'0\"", weight: '165', telephone: '', email: '' },
            { id: 'p50', jersey: '50', firstName: 'Jake', lastName: 'Rogers', name: 'Jake Rogers', year: 'SR', position: 'OL/DL', height: "5'9\"", weight: '227', telephone: '', email: '' },
            { id: 'p52', jersey: '52', firstName: 'Cael', lastName: 'Vermeer', name: 'Cael Vermeer', year: 'SR', position: 'OL/LB', height: "6'1\"", weight: '205', telephone: '', email: '' },
            { id: 'p54', jersey: '54', firstName: 'Benjamin', lastName: 'Eshelman', name: 'Benjamin Eshelman', year: 'SO', position: 'OL/LB', height: "5'10\"", weight: '169', telephone: '', email: '' },
            { id: 'p55', jersey: '55', firstName: 'Carter', lastName: 'Barber', name: 'Carter Barber', year: 'JR', position: 'OL/LB', height: "6'2\"", weight: '210', telephone: '', email: '' },
            { id: 'p56', jersey: '56', firstName: 'Jackson', lastName: 'Mohr', name: 'Jackson Mohr', year: 'SR', position: 'OL/DL', height: "6'0\"", weight: '270', telephone: '', email: '' },
            { id: 'p58', jersey: '58', firstName: 'Chance', lastName: 'Georgius', name: 'Chance Georgius', year: 'JR', position: 'OL/DL', height: "5'10\"", weight: '212', telephone: '', email: '' },
            { id: 'p59', jersey: '59', firstName: 'Blake', lastName: 'Nelsen', name: 'Blake Nelsen', year: 'SR', position: 'OL/DL', height: "6'2\"", weight: '230', telephone: '', email: '' },
            { id: 'p62', jersey: '62', firstName: 'Blake', lastName: 'Winecoff', name: 'Blake Winecoff', year: 'FR', position: 'OL/DL', height: "5'11\"", weight: '200', telephone: '', email: '' },
            { id: 'p72', jersey: '72', firstName: 'Kalen', lastName: 'Bauman', name: 'Kalen Bauman', year: 'SO', position: 'OL/DL', height: "6'5\"", weight: '168', telephone: '', email: '' },
            { id: 'p74', jersey: '74', firstName: 'Roman', lastName: 'Stotts', name: 'Roman Stotts', year: 'JR', position: 'OL/DL', height: "6'0\"", weight: '219', telephone: '', email: '' },
            { id: 'p75', jersey: '75', firstName: 'Gavin', lastName: 'Jeter (C)', name: 'Gavin Jeter (C)', year: 'JR', position: 'OL/DL', height: "6'2\"", weight: '210', telephone: '', email: '', captain: true },
            { id: 'p76', jersey: '76', firstName: 'Aiden', lastName: 'Sweeney', name: 'Aiden Sweeney', year: 'SO', position: 'OL/LB', height: "5'11\"", weight: '165', telephone: '', email: '' },
            { id: 'p8533', jersey: '85/33', firstName: 'Nolan', lastName: 'Jonas', name: 'Nolan Jonas', year: 'FR', position: 'WR/DB', height: "6'1\"", weight: '165', telephone: '', email: '' },
            { id: 'p28061', jersey: '28/0/61', firstName: 'Samuel', lastName: 'Scarrow', name: 'Samuel Scarrow', year: 'FR', position: 'RB/LB', height: "6'0\"", weight: '160', telephone: '', email: '' }
        ];

        const DEFAULT_STAFF_2025 = [
            { id: 's1', name: 'Matt Finn', roles: ['Head Coach', 'Offensive Coordinator', 'Director of Ops', 'Recruiting Coordinator'], phone: '', email: '' },
            { id: 's2', name: 'Wyatt Bunn', roles: ['Position Coach'], phone: '', email: '' },
            { id: 's3', name: 'Don Finn', roles: ['Position Coach'], phone: '', email: '' },
            { id: 's4', name: 'Ryan Gelber', roles: ['Position Coach'], phone: '', email: '' },
            { id: 's5', name: 'DJ Hawkins', roles: ['Position Coach'], phone: '', email: '' },
            { id: 's6', name: 'Jeff Janes', roles: ['Position Coach'], phone: '', email: '' },
            { id: 's7', name: 'Hesston Johnson', roles: ['Position Coach'], phone: '', email: '' },
            { id: 's8', name: 'Kirk Knudsen', roles: ['Position Coach'], phone: '', email: '' },
            { id: 's9', name: 'Andy Koester', roles: ['Position Coach'], phone: '', email: '' },
            { id: 's10', name: 'Kale Lande', roles: ['Position Coach'], phone: '', email: '' },
            { id: 's11', name: 'Craig Lyon', roles: ['Position Coach'], phone: '', email: '' },
            { id: 's12', name: 'Alex Macki', roles: ['Position Coach'], phone: '', email: '' },
            { id: 's13', name: 'Rod Ramus', roles: ['Position Coach'], phone: '', email: '' },
            { id: 's14', name: 'Ross Thoreson', roles: ['Position Coach'], phone: '', email: '' }
        ];

        // Default Formation Presets
        const DEFAULT_FORMATIONS = [
            {
                id: 'blue',
                name: 'Blue',
                description: '2x2 Spread - Balanced receivers',
                positions: [
                    { label: 'LT', x: 35, y: 52 },
                    { label: 'LG', x: 42, y: 52 },
                    { label: 'C', x: 50, y: 52 },
                    { label: 'RG', x: 58, y: 52 },
                    { label: 'RT', x: 65, y: 52 },
                    { label: 'QB', x: 50, y: 58 },
                    { label: 'RB', x: 50, y: 65 },
                    { label: 'X', x: 10, y: 52 },
                    { label: 'Z', x: 90, y: 52 },
                    { label: 'A', x: 70, y: 56 },
                    { label: 'Y', x: 30, y: 56 }
                ]
            },
            {
                id: 'red',
                name: 'Red',
                description: '3x1 Spread - Trips right',
                positions: [
                    { label: 'LT', x: 35, y: 52 },
                    { label: 'LG', x: 42, y: 52 },
                    { label: 'C', x: 50, y: 52 },
                    { label: 'RG', x: 58, y: 52 },
                    { label: 'RT', x: 65, y: 52 },
                    { label: 'QB', x: 50, y: 58 },
                    { label: 'RB', x: 50, y: 65 },
                    { label: 'X', x: 10, y: 52 },
                    { label: 'Z', x: 90, y: 52 },
                    { label: 'A', x: 80, y: 52 },
                    { label: 'Y', x: 85, y: 56 }
                ]
            },
            {
                id: 'green',
                name: 'Green',
                description: '2x2 Spread with tight slot',
                positions: [
                    { label: 'LT', x: 35, y: 52 },
                    { label: 'LG', x: 42, y: 52 },
                    { label: 'C', x: 50, y: 52 },
                    { label: 'RG', x: 58, y: 52 },
                    { label: 'RT', x: 65, y: 52 },
                    { label: 'QB', x: 50, y: 58 },
                    { label: 'RB', x: 50, y: 65 },
                    { label: 'X', x: 10, y: 52 },
                    { label: 'Z', x: 90, y: 52 },
                    { label: 'A', x: 68, y: 53 },
                    { label: 'Y', x: 32, y: 53 }
                ]
            },
            {
                id: 'orange',
                name: 'Orange',
                description: 'Empty backfield 3x2',
                positions: [
                    { label: 'LT', x: 35, y: 52 },
                    { label: 'LG', x: 42, y: 52 },
                    { label: 'C', x: 50, y: 52 },
                    { label: 'RG', x: 58, y: 52 },
                    { label: 'RT', x: 65, y: 52 },
                    { label: 'QB', x: 50, y: 58 },
                    { label: 'X', x: 10, y: 52 },
                    { label: 'Z', x: 90, y: 52 },
                    { label: 'A', x: 80, y: 52 },
                    { label: 'Y', x: 30, y: 56 },
                    { label: 'F', x: 70, y: 60 }
                ]
            },
            {
                id: 'diamond_rt',
                name: 'Diamond Rt',
                description: 'Diamond formation right',
                positions: [
                    { label: 'LT', x: 35, y: 52 },
                    { label: 'LG', x: 42, y: 52 },
                    { label: 'C', x: 50, y: 52 },
                    { label: 'RG', x: 58, y: 52 },
                    { label: 'RT', x: 65, y: 52 },
                    { label: 'QB', x: 50, y: 58 },
                    { label: 'WR', x: 55, y: 45 },
                    { label: 'WR', x: 40, y: 58 },
                    { label: 'WR', x: 70, y: 58 },
                    { label: 'WR', x: 55, y: 72 },
                    { label: 'X', x: 10, y: 52 }
                ]
            },
            {
                id: 'diamond_lt',
                name: 'Diamond Lt',
                description: 'Diamond formation left',
                positions: [
                    { label: 'LT', x: 35, y: 52 },
                    { label: 'LG', x: 42, y: 52 },
                    { label: 'C', x: 50, y: 52 },
                    { label: 'RG', x: 58, y: 52 },
                    { label: 'RT', x: 65, y: 52 },
                    { label: 'QB', x: 50, y: 58 },
                    { label: 'WR', x: 45, y: 45 },
                    { label: 'WR', x: 30, y: 58 },
                    { label: 'WR', x: 60, y: 58 },
                    { label: 'WR', x: 45, y: 72 },
                    { label: 'Z', x: 90, y: 52 }
                ]
            },
            {
                id: 'bunch_rt',
                name: 'Bunch Rt',
                description: 'Bunched receivers right',
                positions: [
                    { label: 'LT', x: 35, y: 52 },
                    { label: 'LG', x: 42, y: 52 },
                    { label: 'C', x: 50, y: 52 },
                    { label: 'RG', x: 58, y: 52 },
                    { label: 'RT', x: 65, y: 52 },
                    { label: 'QB', x: 50, y: 58 },
                    { label: 'RB', x: 50, y: 65 },
                    { label: 'X', x: 10, y: 52 },
                    { label: 'WR', x: 78, y: 52 },
                    { label: 'WR', x: 83, y: 52 },
                    { label: 'WR', x: 88, y: 50 }
                ]
            },
            {
                id: 'bunch_lt',
                name: 'Bunch Lt',
                description: 'Bunched receivers left',
                positions: [
                    { label: 'LT', x: 35, y: 52 },
                    { label: 'LG', x: 42, y: 52 },
                    { label: 'C', x: 50, y: 52 },
                    { label: 'RG', x: 58, y: 52 },
                    { label: 'RT', x: 65, y: 52 },
                    { label: 'QB', x: 50, y: 58 },
                    { label: 'RB', x: 50, y: 65 },
                    { label: 'Z', x: 90, y: 52 },
                    { label: 'WR', x: 22, y: 52 },
                    { label: 'WR', x: 17, y: 52 },
                    { label: 'WR', x: 12, y: 50 }
                ]
            },
            {
                id: 'bright',
                name: 'Bright',
                description: 'Tight formation with TE',
                positions: [
                    { label: 'LT', x: 35, y: 52 },
                    { label: 'LG', x: 42, y: 52 },
                    { label: 'C', x: 50, y: 52 },
                    { label: 'RG', x: 58, y: 52 },
                    { label: 'RT', x: 65, y: 52 },
                    { label: 'QB', x: 50, y: 58 },
                    { label: 'RB', x: 50, y: 65 },
                    { label: 'TE', x: 70, y: 52 },
                    { label: 'X', x: 10, y: 52 },
                    { label: 'Z', x: 90, y: 52 },
                    { label: 'A', x: 80, y: 54 }
                ]
            },
            {
                id: 'rip',
                name: 'Rip',
                description: 'Rip formation',
                positions: [
                    { label: 'LT', x: 35, y: 52 },
                    { label: 'LG', x: 42, y: 52 },
                    { label: 'C', x: 50, y: 52 },
                    { label: 'RG', x: 58, y: 52 },
                    { label: 'RT', x: 65, y: 52 },
                    { label: 'QB', x: 50, y: 58 },
                    { label: 'RB', x: 50, y: 65 },
                    { label: 'X', x: 12, y: 52 },
                    { label: 'Z', x: 88, y: 52 },
                    { label: 'A', x: 72, y: 55 },
                    { label: 'Y', x: 28, y: 55 }
                ]
            },
            {
                id: 'gold',
                name: 'Gold',
                description: 'Gold formation',
                positions: [
                    { label: 'LT', x: 35, y: 52 },
                    { label: 'LG', x: 42, y: 52 },
                    { label: 'C', x: 50, y: 52 },
                    { label: 'RG', x: 58, y: 52 },
                    { label: 'RT', x: 65, y: 52 },
                    { label: 'QB', x: 50, y: 58 },
                    { label: 'RB', x: 50, y: 65 },
                    { label: 'X', x: 10, y: 52 },
                    { label: 'Z', x: 90, y: 52 },
                    { label: 'A', x: 75, y: 56 },
                    { label: 'Y', x: 25, y: 56 }
                ]
            }
        ];

        const App = () => {
            const [view, setView] = useState('callsheet'); // Default to landing page
            const [editingPlay, setEditingPlay] = useState(null);
            const [plays, setPlays] = useState(() => {
                const saved = localStorage.getItem('oc-dashboard-plays');
                return saved ? JSON.parse(saved) : INITIAL_PLAYS;
            });

            useEffect(() => {
                localStorage.setItem('oc-dashboard-plays', JSON.stringify(plays));
            }, [plays]);

            // Formation Database
            const [formations, setFormations] = useState(() => {
                const saved = localStorage.getItem('oc-dashboard-formations');
                return saved ? JSON.parse(saved) : DEFAULT_FORMATIONS;
            });

            useEffect(() => {
                localStorage.setItem('oc-dashboard-formations', JSON.stringify(formations));
            }, [formations]);

            // Zone Philosophies
            const [zonePhilosophies, setZonePhilosophies] = useState(() => {
                const saved = localStorage.getItem('oc-dashboard-zone-philosophies');
                return saved ? JSON.parse(saved) : {
                    backed_up: '',
                    coming_out: '',
                    open_field: '',
                    fringe: 'Take one shot, be ready to convert on 4th',
                    high_red: '',
                    low_red: '',
                    goal_line: ''
                };
            });

            useEffect(() => {
                localStorage.setItem('oc-dashboard-zone-philosophies', JSON.stringify(zonePhilosophies));
            }, [zonePhilosophies]);

            const handleUpdateFormations = (newFormations) => {
                setFormations(newFormations);
            };

            const handleAddFormation = (formation) => {
                setFormations([...formations, { ...formation, id: formation.id || Date.now().toString() }]);
            };

            const handleDeleteFormation = (formationId) => {
                setFormations(formations.filter(f => f.id !== formationId));
            };

            const handleUpdateFormation = (formationId, updatedFormation) => {
                setFormations(formations.map(f => f.id === formationId ? updatedFormation : f));
            };

            // Quick add play from game plan (creates incomplete play)
            const handleQuickAddPlay = (playName) => {
                const newPlay = {
                    id: `play_${Date.now()}`,
                    name: playName.trim(),
                    wristbandSlot: '',
                    formation: '',
                    tags: [],
                    incomplete: true // Mark as incomplete
                };
                setPlays(prev => [...prev, newPlay]);
                return newPlay;
            };

            // RBAC State
            // Refactored to be User-Centric
            // We default to the first user (Matt Finn) or finding 's1'
            const [currentUserId, setCurrentUserId] = useState('s1');
            const [permissions, setPermissions] = useLocalStorage('oc-dashboard-permissions', DEFAULT_PERMISSIONS);

            // Ensure permissions structure integrity on load (if new roles added later)
            useEffect(() => {
                const newPerms = { ...permissions };
                let changed = false;
                ROLES.forEach(role => {
                    if (!newPerms[role]) {
                        newPerms[role] = DEFAULT_PERMISSIONS[role];
                        changed = true;
                    }
                });
                if (changed) setPermissions(newPerms);
            }, []);

            // helper to get current staff member
            // We need to access 'staff' state, but it is defined below. 
            // So we will move the staff state definition UP above RBAC or access it inside derived logic.
            // Let's defer currentPermissions calculation until after staff is defined.

            // --- Weeks & Season Management ---

            const [weeks, setWeeks] = useState(() => {
                const saved = localStorage.getItem('oc-dashboard-weeks');
                let existingWeeks = [];
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        existingWeeks = Array.isArray(parsed) ? parsed : [parsed];
                    } catch (e) {
                        console.error("Error parsing saved weeks", e);
                    }
                }

                // Helper to create default plans
                const createDefaultPracticePlans = () => {
                    const defaults = {};
                    ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].forEach(day => {
                        defaults[day] = {
                            id: Date.now().toString() + Math.random().toString(36).substr(2, 9) + day,
                            date: new Date().toISOString().split('T')[0],
                            startTime: '15:40',
                            segments: []
                        };
                    });
                    return defaults;
                };

                // Migrate/Populate from OPS_CALENDAR
                const mergedWeeks = OPS_CALENDAR.map((phase, index) => {
                    const existing = existingWeeks.find(w => w.name === phase || w.id === phase);

                    if (existing) {
                        return existing;
                    }

                    if (phase === "Week 1") {
                        const legacyWeek = existingWeeks.find(w => w.id === 'week-1');
                        if (legacyWeek) return { ...legacyWeek, name: phase };
                    }

                    return {
                        id: `phase-${index}`,
                        name: phase,
                        opponent: '',
                        scoutingReport: '',
                        practicePlans: createDefaultPracticePlans(),
                        gameLog: []
                    };
                });

                const customWeeks = existingWeeks.filter(w => !OPS_CALENDAR.includes(w.name) && w.id !== 'week-1');

                return [...mergedWeeks, ...customWeeks];
            });

            const [currentWeekId, setCurrentWeekId] = useState(() => {
                // Determine current month phase
                const currentMonth = new Date().toLocaleString('default', { month: 'long' });
                const currentMonthIndex = OPS_CALENDAR.indexOf(currentMonth);
                const currentMonthPhaseId = currentMonthIndex !== -1 ? `phase-${currentMonthIndex}` : null;

                // Priority: Saved selection (most recently used) -> Current Month -> Last Week -> Week 1
                const savedWeeks = localStorage.getItem('oc-dashboard-weeks');
                // Note: We are deliberating NOT using 'oc-dashboard-weeks' to persist 'last selected', 
                // but rather if we want to default to "today", we should probably prioritize the current date match on initial load if no specific "last selected week" was saved.
                // However, the existing code looked at the LAST item in the weeks array.

                // Let's check for a specific "last viewed week" pref if we had one (we don't currently save one separately).
                // Or we can just default to the current month if available.

                if (currentMonthPhaseId) {
                    return currentMonthPhaseId;
                }

                if (savedWeeks) {
                    const parsed = JSON.parse(savedWeeks);
                    return parsed[parsed.length - 1].id;
                }
                return 'week-1';
            });

            // Duty Draft State
            const [dutyAssignments, setDutyAssignments] = useState(() => {
                try {
                    const saved = localStorage.getItem('oc-dashboard-duties');
                    return (saved && saved !== "null") ? JSON.parse(saved) : {};
                } catch (e) { return {}; }
            });

            // Save duties to localStorage
            useEffect(() => {
                localStorage.setItem('oc-dashboard-duties', JSON.stringify(dutyAssignments));
            }, [dutyAssignments]);

            // Custom Focus Items State
            const [customFocusItems, setCustomFocusItems] = useState(() => {
                try {
                    const saved = localStorage.getItem('oc-dashboard-custom-focus');
                    return (saved && saved !== "null") ? JSON.parse(saved) : [];
                } catch (e) { return []; }
            });

            // Save custom focus items to localStorage
            useEffect(() => {
                localStorage.setItem('oc-dashboard-custom-focus', JSON.stringify(customFocusItems));
            }, [customFocusItems]);

            // Add custom focus item
            const addCustomFocusItem = (item) => {
                if (item && !customFocusItems.includes(item)) {
                    setCustomFocusItems([...customFocusItems, item]);
                }
            };


            // Helper to get current week data
            const currentWeek = weeks.find(w => w.id === currentWeekId) || weeks[0];

            // Derived state setters for compatibility with existing components
            const setPracticePlans = (newPlans) => {
                setWeeks(weeks.map(w => w.id === currentWeekId ? { ...w, practicePlans: newPlans } : w));
            };

            const setPregamePlan = (newPlan) => {
                setWeeks(weeks.map(w => w.id === currentWeekId ? { ...w, pregamePlan: newPlan } : w));
            };

            const setGameLog = (newLog) => {
                setWeeks(weeks.map(w => w.id === currentWeekId ? { ...w, gameLog: newLog } : w));
            };

            const setGamePlan = (newPlan) => {
                setWeeks(weeks.map(w => w.id === currentWeekId ? { ...w, offensiveGamePlan: newPlan } : w));
            };

            const handleAddWeek = () => {
                const newWeekId = `week-${weeks.length + 1}`;
                const prevWeek = weeks[weeks.length - 1];

                // Carryover Logic
                const newWeek = {
                    id: newWeekId,
                    name: `Week ${weeks.length + 1}`,
                    date: '',
                    opponent: '',
                    scoutingReport: '',
                    // Copy practice plans structure but maybe clear specific details? For now, full copy is safest/easiest base.
                    // Actually, let's keep the structure but maybe reset dates? 
                    // User asked for "saves practice plans... but allows you to edit". Copying is best.
                    practicePlans: JSON.parse(JSON.stringify(prevWeek.practicePlans)),
                    pregamePlan: JSON.parse(JSON.stringify(prevWeek.pregamePlan)),
                    offensiveGamePlan: prevWeek.offensiveGamePlan ? JSON.parse(JSON.stringify(prevWeek.offensiveGamePlan)) : { sets: [] },
                    gameLog: [] // Start fresh for game log
                };

                setWeeks([...weeks, newWeek]);
                setCurrentWeekId(newWeekId);
            };

            const handleUpdateWeek = (id, field, value) => {
                setWeeks(weeks.map(w => w.id === id ? { ...w, [field]: value } : w));
            };

            const handleUpdateGameLog = (newLog) => {
                setWeeks(weeks.map(w => w.id === currentWeekId ? { ...w, gameLog: newLog } : w));
            };

            // Persistence for Weeks
            useEffect(() => {
                localStorage.setItem('oc-dashboard-weeks', JSON.stringify(weeks));
            }, [weeks]);

            // --- End Weeks Management ---

            const [roster, setRoster] = useState(() => {
                try {
                    const saved = localStorage.getItem('oc-dashboard-roster');
                    let loadedRoster = [];

                    if (!saved || saved === "null" || saved === "[]") {
                        loadedRoster = DEFAULT_ROSTER_2025;
                    } else {
                        loadedRoster = JSON.parse(saved);
                    }

                    // Migration / Initialization
                    return loadedRoster.map(p => {
                        let updated = { ...p };

                        // Ensure Position Split
                        if (!updated.offPosition || !updated.defPosition) {
                            const parts = (updated.position || '').split('/');
                            updated.offPosition = updated.offPosition || parts[0] || 'NA';
                            updated.defPosition = updated.defPosition || parts[1] || 'NA';
                        }

                        // Ensure Profile Structure
                        if (!updated.profile) {
                            updated.profile = {
                                favorites: { nfl: '', nba: '', mlb: '', musicians: '', food: '', movie: '', hobbies: '' },
                                family: '',
                                goals: { postHS: '', job: '', colleges: '' }
                            };
                        }

                        // Ensure Metrics Structure
                        if (!updated.metrics) {
                            updated.metrics = {
                                attendanceStreak: 0,
                                longestStreak: 0,
                                awards: [],
                                warriorDialLogs: []
                            };
                        } else if (!updated.metrics.warriorDialLogs) {
                            updated.metrics.warriorDialLogs = [];
                        }

                        return updated;
                    });

                } catch (e) { return DEFAULT_ROSTER_2025; }
            });
            const [depthChart, setDepthChart] = useState(() => {
                try {
                    const saved = localStorage.getItem('oc-dashboard-depthchart');
                    return (saved && saved !== "null") ? JSON.parse(saved) : {};
                } catch (e) { return {}; }
            });
            const [staff, setStaff] = useState(() => {
                try {
                    const saved = localStorage.getItem('oc-dashboard-staff');
                    if (!saved || saved === "null" || saved === "[]") return DEFAULT_STAFF_2025;

                    const loaded = JSON.parse(saved);
                    // Migration: Ensure 'roles' array exists.
                    // If old 'role' string exists, convert to array.
                    return loaded.map(s => {
                        if (s.role && !s.roles) {
                            // Map legacy string roles to new array. 
                            // 'Assistant Coach' -> 'Position Coach' mapping if needed, 
                            // but explicit mapping is safer.
                            let mappedRole = s.role;
                            if (s.role === 'Assistant Coach') mappedRole = 'Position Coach';
                            return { ...s, roles: [mappedRole], role: undefined };
                        }
                        if (!s.roles) {
                            return { ...s, roles: ['Position Coach'] };
                        }
                        return s;
                    });
                } catch (e) { return DEFAULT_STAFF_2025; }
            });

            // Calculate Permissions based on Current User's Roles
            const currentUser = staff.find(s => s.id === currentUserId) || staff[0] || DEFAULT_STAFF_2025[0];

            const currentPermissions = useMemo(() => {
                const userRoles = currentUser.roles || [];
                // Default to first role or generic
                if (userRoles.length === 0) return DEFAULT_PERMISSIONS['Position Coach'];

                // Merge Permissions: If ANY role has 'true', specific permission is true.
                const merged = JSON.parse(JSON.stringify(DEFAULT_PERMISSIONS['Position Coach'])); // Start with base restricted

                userRoles.forEach(role => {
                    const rolePerms = permissions[role] || DEFAULT_PERMISSIONS[role];
                    if (!rolePerms) return;

                    Object.keys(rolePerms).forEach(feature => {
                        if (!merged[feature]) merged[feature] = { view: false, edit: false };
                        if (rolePerms[feature].view) merged[feature].view = true;
                        if (rolePerms[feature].edit) merged[feature].edit = true;
                    });
                });
                return merged;
            }, [currentUser, permissions]);
            const [lotteryData, setLotteryData] = useLocalStorage('oc-dashboard-equipment-lottery', { bids: {}, winners: {}, available: null });

            const [teamLogo, setTeamLogo] = useState(() => {
                return localStorage.getItem('oc-dashboard-logo') || null;
            });
            const [accentColor, setAccentColor] = useState(() => {
                return localStorage.getItem('oc-dashboard-accent') || '#38bdf8';
            });
            const [positionNames, setPositionNames] = useState(() => {
                const saved = localStorage.getItem('oc-dashboard-position-names');
                return saved ? JSON.parse(saved) : {
                    X: 'X', Z: 'Z', A: 'A', Y: 'Y',
                    QB: 'QB', RB: 'RB',
                    LT: 'LT', LG: 'LG', C: 'C', RG: 'RG', RT: 'RT'
                };
            });
            const [depthChartType, setDepthChartType] = useState('OFFENSE');


            // Layout Persistence
            const [formationLayouts, setFormationLayouts] = useLocalStorage('formationLayouts', {});

            const updateFormationLayout = (chartType, posId, x, y) => {
                setFormationLayouts(prev => ({
                    ...prev,
                    [chartType]: {
                        ...(prev[chartType] || {}),
                        [posId]: { x, y }
                    }
                }));
            };

            const resetFormationLayout = (chartType) => {
                setFormationLayouts(prev => {
                    const next = { ...prev };
                    delete next[chartType];
                    return next;
                });
            };

            const [ratings, setRatings] = useLocalStorage('oc-dashboard-ratings', {});
            const [travelRoster, setTravelRoster] = useLocalStorage('oc-dashboard-travel', []);
            const [summerCompData, setSummerCompData] = useLocalStorage('oc-dashboard-summer-comp', null);
            const [valhallaData, setValhallaData] = useLocalStorage('oc-dashboard-valhalla', {
                progress: {},
                xpLog: [],
                careerEvents: {},
                lastCareerUpdate: null,
                programEvents: [],
                participation: {}
            });

            // Game Situation State (Lifted for Smart Call Sheet)
            const [situation, setSituation] = useState({
                down: 1,
                distance: 10,
                yardLine: 25, // Linear 25 = Own 25
                hash: 'M',
                driveNumber: 1
            });

            // Equipment State
            const [inventory, setInventory] = useLocalStorage('oc-dashboard-equipment-inventory', []);
            const [checkouts, setCheckouts] = useLocalStorage('oc-dashboard-equipment-checkouts', []);
            const [issuance, setIssuance] = useLocalStorage('oc-dashboard-equipment-issuance', {}); // { [playerId]: { helmet: { style: '', size: '', num: '' }, ... } }
            const [attendance, setAttendance] = useLocalStorage('oc-dashboard-attendance', []);
            const [wishlist, setWishlist] = useLocalStorage('oc-dashboard-equipment-wishlist', []);
            const [metrics, setMetrics] = useState(() => {
                try {
                    const saved = localStorage.getItem('oc-dashboard-metrics');
                    return (saved && saved !== "null") ? JSON.parse(saved) : {};
                } catch (e) { return {}; }
            });

            // Scouting State
            const [opponentScoutData, setOpponentScoutData] = useLocalStorage('oc-dashboard-scouting', {
                offense: [],
                defense: [],
                specialTeams: []
            });


            /*
                        const [dutyAssignments, setDutyAssignments] = useState(() => {
                            try {
                                const saved = localStorage.getItem('oc-dashboard-duties');
                                return (saved && saved !== "null") ? JSON.parse(saved) : {};
                            } catch (e) { return {}; }
                        });
            
                        // Save duties to localStorage
                        useEffect(() => {
                            localStorage.setItem('oc-dashboard-duties', JSON.stringify(dutyAssignments));
                        }, [dutyAssignments]);
            */

            // Save plays to localStorage whenever they change
            useEffect(() => {
                localStorage.setItem('oc-dashboard-plays', JSON.stringify(plays));
            }, [plays]);

            // Save roster to localStorage whenever it changes
            useEffect(() => {
                localStorage.setItem('oc-dashboard-roster', JSON.stringify(roster));
            }, [roster]);

            // Save depth chart to localStorage whenever it changes
            useEffect(() => {
                localStorage.setItem('oc-dashboard-depthchart', JSON.stringify(depthChart));
            }, [depthChart]);

            // Save staff to localStorage whenever it changes
            useEffect(() => {
                localStorage.setItem('oc-dashboard-staff', JSON.stringify(staff));
            }, [staff]);

            // Save team logo to localStorage whenever it changes
            useEffect(() => {
                if (teamLogo) {
                    localStorage.setItem('oc-dashboard-logo', teamLogo);
                } else {
                    localStorage.removeItem('oc-dashboard-logo');
                }
            }, [teamLogo]);

            // Apply and Save Accent Color
            useEffect(() => {
                if (accentColor) {
                    document.documentElement.style.setProperty('--accent', accentColor);
                    localStorage.setItem('oc-dashboard-accent', accentColor);
                }
            }, [accentColor]);

            // Save position names to localStorage
            useEffect(() => {
                localStorage.setItem('oc-dashboard-position-names', JSON.stringify(positionNames));
            }, [positionNames]);

            // Save ratings to localStorage whenever they change
            useEffect(() => {
                localStorage.setItem('oc-dashboard-ratings', JSON.stringify(ratings));
            }, [ratings]);

            // Save metrics to localStorage whenever they change
            useEffect(() => {
                localStorage.setItem('oc-dashboard-metrics', JSON.stringify(metrics));
            }, [metrics]);

            const toggleTag = (tag) => {
                // ... (logic handled in PlayInput)
            };

            const handleSavePlay = (playData) => {
                if (editingPlay) {
                    setPlays(plays.map(p => p.id === playData.id ? playData : p));
                    setEditingPlay(null);
                } else {
                    setPlays([playData, ...plays]);
                }
                setView('playbook');
            };

            const handleEditPlay = (play) => {
                setEditingPlay(play);
                setView('new-play');
            };

            const handleUpdatePlay = (updatedPlay) => {
                setPlays(plays.map(p => p.id === updatedPlay.id ? updatedPlay : p));
            };

            const handleDeletePlay = (playId) => {
                setPlays(plays.filter(p => p.id !== playId));
                setEditingPlay(null);
                setView('playbook');
            };

            const handleExportData = () => {
                const data = {
                    plays,
                    practicePlans,
                    pregamePlan,
                    roster,
                    depthChart,
                    gameLog,
                    teamLogo,
                    ratings,
                    metrics,
                    exportDate: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `hc-dashboard-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const handleImportData = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.plays) setPlays(data.plays);
                        if (data.practicePlans) setPracticePlans(data.practicePlans);
                        if (data.pregamePlan) setPregamePlan(data.pregamePlan);
                        if (data.roster) setRoster(data.roster);
                        if (data.depthChart) setDepthChart(data.depthChart);
                        if (data.gameLog) setGameLog(data.gameLog);
                        if (data.teamLogo) setTeamLogo(data.teamLogo);
                        if (data.ratings) setRatings(data.ratings);
                        if (data.metrics) setMetrics(data.metrics);
                        alert('Data imported successfully!');
                    } catch (error) {
                        alert('Error importing data: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };

            // Filter Logic for Playbook View
            const [playbookFilters, setPlaybookFilters] = useState({
                formation: '',
                concept: '',
                tag: '',
                situation: ''
            });

            // Batch Delete State
            const [selectedPlays, setSelectedPlays] = useState([]);

            const handleImportDefaultData = () => {
                if (window.confirm('This will OVERWRITE your current roster and staff list with the 2025 default data. Are you sure?')) {
                    setRoster(DEFAULT_ROSTER_2025);
                    setStaff(DEFAULT_STAFF_2025);
                    alert('Loaded 2025 Roster and Staff.');
                }
            };

            const togglePlaySelection = (playId) => {
                setSelectedPlays(prev =>
                    prev.includes(playId)
                        ? prev.filter(id => id !== playId)
                        : [...prev, playId]
                );
            };

            const handleDeleteSelected = (e) => {
                // Prevent event bubbling and default action to avoid conflicts with other handlers
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                // Small timeout to allow the UI to stabilize/event loop to clear before showing the blocking alert
                setTimeout(() => {
                    if (window.confirm(`Are you sure you want to delete ${selectedPlays.length} plays? This cannot be undone.`)) {
                        setPlays(prevPlays => prevPlays.filter(p => !selectedPlays.includes(p.id)));
                        setSelectedPlays([]);
                    }
                }, 50);
            };

            const getFilteredPlaybook = () => {
                return plays.filter(play => {
                    const matchFormation = !playbookFilters.formation || play.formation === playbookFilters.formation;
                    const matchConcept = !playbookFilters.concept || (play.concept && play.concept === playbookFilters.concept);
                    const matchTag = !playbookFilters.tag || play.tags.includes(playbookFilters.tag) || play.tag1 === playbookFilters.tag || play.tag2 === playbookFilters.tag;

                    // Situation filter checks against specific categories
                    const matchSituation = !playbookFilters.situation || play.tags.includes(playbookFilters.situation) ||
                        (TAG_CATEGORIES["Situation"] && TAG_CATEGORIES["Situation"].includes(playbookFilters.situation) && play.tags.includes(playbookFilters.situation)) ||
                        (TAG_CATEGORIES["Field Position"] && TAG_CATEGORIES["Field Position"].includes(playbookFilters.situation) && play.tags.includes(playbookFilters.situation)) ||
                        (TAG_CATEGORIES["Down & Distance"] && TAG_CATEGORIES["Down & Distance"].includes(playbookFilters.situation) && play.tags.includes(playbookFilters.situation));

                    return matchFormation && matchConcept && matchTag && matchSituation;
                });
            };

            const filteredPlaybook = getFilteredPlaybook();

            // Unique values for dropdowns
            const uniqueFormations = [...new Set(plays.map(p => p.formation).filter(Boolean))].sort();
            const uniqueConcepts = [...new Set(plays.map(p => p.concept).filter(Boolean))].sort();
            const allTags = [...new Set(plays.flatMap(p => [...p.tags, p.tag1, p.tag2]).filter(Boolean))].sort();

            // Situation tags (Field Position, D&D, Situation)
            const situationTags = [
                ...(TAG_CATEGORIES["Field Position"] || []),
                ...(TAG_CATEGORIES["Down & Distance"] || []),
                ...(TAG_CATEGORIES["Situation"] || [])
            ].sort();

            return (
                <div className="app-container">
                    <div className="sidebar">
                        <h1 style={{ fontSize: '1.25rem', marginBottom: '2rem', paddingLeft: '0.5rem' }}>
                            <span style={{ color: 'var(--accent)' }}>HC</span> Dashboard
                        </h1>
                        <nav style={{ flex: 1, overflowY: 'auto' }}>
                            {/* SEASON CATEGORY */}
                            {/* Week Selector */}
                            <div style={{ padding: '0 0.5rem 1.5rem 0.5rem', borderBottom: '1px solid rgba(255,255,255,0.1)', marginBottom: '1rem' }}>
                                <label style={{ fontSize: '0.75rem', color: 'var(--text-secondary)', textTransform: 'uppercase', letterSpacing: '0.05em', marginBottom: '0.5rem', display: 'block' }}>
                                    Active Week
                                </label>
                                <select
                                    className="form-select"
                                    value={currentWeekId}
                                    onChange={(e) => {
                                        if (e.target.value === 'NEW_WEEK') {
                                            handleAddWeek();
                                        } else {
                                            setCurrentWeekId(e.target.value);
                                            setView('landing');
                                        }
                                    }}
                                    style={{ width: '100%', padding: '0.5rem', fontSize: '0.9rem', backgroundColor: 'rgba(0,0,0,0.2)', marginBottom: '0.5rem' }}
                                >
                                    {weeks.map(w => (
                                        <option key={w.id} value={w.id}>
                                            {w.name} {w.opponent ? `vs ${w.opponent}` : ''}
                                        </option>
                                    ))}
                                    <option value="NEW_WEEK">+ Create New Week</option>
                                </select>

                                {/* RBAC View As Selector - NOW STAFF CENTRIC */}
                                <select
                                    className="form-select"
                                    value={currentUserId}
                                    onChange={(e) => {
                                        setCurrentUserId(e.target.value);
                                        // Default to landing page on user switch for safety
                                        setView('landing');
                                    }}
                                    style={{
                                        width: '100%',
                                        fontSize: '0.8rem',
                                        padding: '0.4rem',
                                        background: 'rgba(255,255,255,0.05)',
                                        border: '1px solid rgba(255,255,255,0.1)',
                                        color: 'var(--accent)'
                                    }}
                                >
                                    {staff.map(s => (
                                        <option key={s.id} value={s.id}>View as: {s.name}</option>
                                    ))}
                                </select>
                            </div>

                            {currentPermissions.dashboard.view && (
                                <button
                                    className={`nav-item ${view === 'landing' ? 'active' : ''}`}
                                    onClick={() => setView('landing')}
                                    style={{ width: '100%', textAlign: 'left', border: 'none', background: 'none', display: 'flex', alignItems: 'center', gap: '0.75rem', padding: '0.75rem 1rem', marginBottom: '0.5rem' }}
                                >
                                    <Icon name="Checkbox" size={18} color="var(--accent)" />
                                    <span style={{ fontWeight: '600' }}>My Tasks</span>
                                </button>
                            )}

                            {currentPermissions.dashboard.view && (
                                <button
                                    className={`nav-item ${view === 'daily-reports' ? 'active' : ''}`}
                                    onClick={() => setView('daily-reports')}
                                    style={{ width: '100%', textAlign: 'left', border: 'none', background: 'none', display: 'flex', alignItems: 'center', gap: '0.75rem', padding: '0.75rem 1rem', marginBottom: '0.5rem' }}
                                >
                                    <Icon name="Clipboard" size={18} color="#3b82f6" />
                                    <span style={{ fontWeight: '600' }}>Daily Reports</span>
                                </button>
                            )}
                            {/* PERSONNEL CATEGORY */}
                            {currentPermissions.staff.view && (
                                <CollapsibleCategory title="Personnel" icon="Users" defaultOpen={false}>
                                    <button className={`nav-item ${view === 'roster' ? 'active' : ''}`} onClick={() => setView('roster')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                        Manage Roster
                                    </button>
                                    <button className={`nav-item ${view === 'staff-roster' ? 'active' : ''}`} onClick={() => setView('staff-roster')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                        Staff & Roles
                                    </button>
                                    <button className={`nav-item ${view === 'staff-duties' ? 'active' : ''}`} onClick={() => setView('staff-duties')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                        Task Assigner
                                    </button>
                                    <button className={`nav-item ${view === 'player-profiles' ? 'active' : ''}`} onClick={() => setView('player-profiles')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                        Player Profiles
                                    </button>
                                </CollapsibleCategory>
                            )}

                            {/* DEPTH CHARTS CATEGORY (Moved from Players) */}
                            {currentPermissions.depth.view && (
                                <CollapsibleCategory title="Depth Charts" icon="LayoutDashboard" defaultOpen={false}>

                                    {/* VARSITY */}
                                    <CollapsibleCategory title="Varsity" icon="Trophy" defaultOpen={false} nested={true}>
                                        {['OFFENSE', 'DEFENSE', 'KICKOFF', 'KICK_RETURN', 'PUNT', 'PUNT_RETURN', 'HANDS_TEAM', 'ONSIDE_KICK', 'PAT_BLOCK'].map(type => (
                                            <button
                                                key={`V_${type}`}
                                                className={`nav-item ${view === 'depth' && depthChartType === `V_${type}` ? 'active' : ''}`}
                                                onClick={() => { setView('depth'); setDepthChartType(`V_${type}`); }}
                                                style={{ width: '100%', textAlign: 'left', background: 'none', border: 'none', cursor: 'pointer', fontFamily: 'inherit', fontSize: '0.85rem', paddingLeft: '3.5rem', color: 'var(--text-secondary)' }}
                                            >
                                                {type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                            </button>
                                        ))}
                                    </CollapsibleCategory>

                                    {/* JV */}
                                    <CollapsibleCategory title="Junior Varsity" icon="Medal" defaultOpen={false} nested={true}>
                                        {['OFFENSE', 'DEFENSE', 'KICKOFF', 'KICK_RETURN', 'PUNT', 'PUNT_RETURN', 'HANDS_TEAM', 'ONSIDE_KICK', 'PAT_BLOCK'].map(type => (
                                            <button
                                                key={`JV_${type}`}
                                                className={`nav-item ${view === 'depth' && depthChartType === `JV_${type}` ? 'active' : ''}`}
                                                onClick={() => { setView('depth'); setDepthChartType(`JV_${type}`); }}
                                                style={{ width: '100%', textAlign: 'left', background: 'none', border: 'none', cursor: 'pointer', fontFamily: 'inherit', fontSize: '0.85rem', paddingLeft: '3.5rem', color: 'var(--text-secondary)' }}
                                            >
                                                {type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                            </button>
                                        ))}
                                    </CollapsibleCategory>

                                    {/* JV2 */}
                                    <CollapsibleCategory title="JV2" icon="Award" defaultOpen={false} nested={true}>
                                        {['OFFENSE', 'DEFENSE', 'KICKOFF', 'KICK_RETURN', 'PUNT', 'PUNT_RETURN', 'HANDS_TEAM', 'ONSIDE_KICK', 'PAT_BLOCK'].map(type => (
                                            <button
                                                key={`J2_${type}`}
                                                className={`nav-item ${view === 'depth' && depthChartType === `J2_${type}` ? 'active' : ''}`}
                                                onClick={() => { setView('depth'); setDepthChartType(`J2_${type}`); }}
                                                style={{ width: '100%', textAlign: 'left', background: 'none', border: 'none', cursor: 'pointer', fontFamily: 'inherit', fontSize: '0.85rem', paddingLeft: '3.5rem', color: 'var(--text-secondary)' }}
                                            >
                                                {type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                            </button>
                                        ))}
                                    </CollapsibleCategory>

                                </CollapsibleCategory>
                            )}



                            {/* WEEKLY PREP CATEGORY */}
                            {/* WEEKLY PREP CATEGORY */}
                            <CollapsibleCategory title="Offense" icon="Brain" defaultOpen={false}>
                                {currentPermissions.playbook.view && (
                                    <>
                                        <button className={`nav-item ${view === 'playbook' ? 'active' : ''}`} onClick={() => setView('playbook')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                            <Icon name="Book" size={14} style={{ marginRight: '6px' }} /> Playbook
                                        </button>
                                        <button
                                            className={`nav-item ${view === 'new-play' ? 'active' : ''}`}
                                            onClick={() => { setEditingPlay(null); setView('new-play'); }}
                                            style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none', color: 'var(--accent)', fontWeight: '500' }}
                                        >
                                            <Icon name="PlusCircle" size={14} style={{ marginRight: '6px' }} /> Add a New Play
                                        </button>
                                    </>
                                )}
                                <button className={`nav-item ${view === 'formations' ? 'active' : ''}`} onClick={() => setView('formations')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                    <Icon name="Grid" size={14} style={{ marginRight: '6px' }} /> Formations
                                </button>
                                {currentPermissions.callsheet.view && (
                                    <>
                                        <button className={`nav-item ${view === 'game-plan' ? 'active' : ''}`} onClick={() => setView('game-plan')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                            <Icon name="Clipboard" size={14} style={{ marginRight: '6px' }} /> Game Plan
                                        </button>
                                        <button className={`nav-item ${view === 'scouting' ? 'active' : ''}`} onClick={() => setView('scouting')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                            <Icon name="Search" size={14} style={{ marginRight: '6px' }} /> Scouting
                                        </button>
                                        <button className={`nav-item ${view === 'game-plan-2' ? 'active' : ''}`} onClick={() => setView('game-plan-2')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                            <Icon name="Zap" size={14} style={{ marginRight: '6px' }} /> Game Plan 2.0
                                        </button>
                                        <button className={`nav-item ${view === 'scouting' ? 'active' : ''}`} onClick={() => setView('scouting')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                            <Icon name="Swords" size={14} style={{ marginRight: '6px' }} /> Scouting Report
                                        </button>
                                        <button className={`nav-item ${view === 'wristband' ? 'active' : ''}`} onClick={() => setView('wristband')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                            <Icon name="Wristband" size={14} style={{ marginRight: '6px' }} /> Wristband
                                        </button>
                                    </>
                                )}
                            </CollapsibleCategory>

                            {/* PRACTICE CATEGORY */}
                            {/* PRACTICE CATEGORY */}
                            {/* PROGRAM MANAGEMENT CATEGORY */}
                            <CollapsibleCategory title="Program Mgmt" icon="Briefcase" defaultOpen={true}>
                                <button className={`nav-item ${view === 'calendar' ? 'active' : ''}`} onClick={() => setView('calendar')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                    <Icon name="Calendar" size={14} style={{ marginRight: '6px' }} /> Annual Calendar
                                </button>
                            </CollapsibleCategory>

                            {(currentPermissions.scripts.view || currentPermissions.install.view) && (
                                <CollapsibleCategory title="Practice" icon="Calendar" defaultOpen={false}>
                                    {currentPermissions.install.view && (
                                        <button className={`nav-item ${view === 'practice' ? 'active' : ''}`} onClick={() => setView('practice')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                            Plans
                                        </button>
                                    )}
                                    <button className={`nav-item ${view === 'drill-library' ? 'active' : ''}`} onClick={() => setView('drill-library')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                        Drill Library
                                    </button>
                                    {currentPermissions.scripts.view && (
                                        <button className={`nav-item ${view === 'practice-scripts' ? 'active' : ''}`} onClick={() => setView('practice-scripts')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                            Scripts
                                        </button>
                                    )}
                                </CollapsibleCategory>
                            )}



                            {/* PRE-GAME CATEGORY */}
                            <CollapsibleCategory title="Pre-game" icon="ü•ä" defaultOpen={false}>
                                <button className={`nav-item ${view === 'travel' ? 'active' : ''}`} onClick={() => setView('travel')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                    <Icon name="Bus" size={14} style={{ marginRight: '6px' }} /> Travel Roster
                                </button>
                                <button className={`nav-item ${view === 'pregame' ? 'active' : ''}`} onClick={() => setView('pregame')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                    Pre-game Timeline
                                </button>
                            </CollapsibleCategory>

                            {/* MOBILE APPS CATEGORY */}
                            <CollapsibleCategory title="Mobile Apps" icon="Smartphone" defaultOpen={false}>
                                <button
                                    className={`nav-item ${view === 'player-app' ? 'active' : ''}`}
                                    onClick={() => setView('player-app')}
                                    style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}
                                >
                                    <Icon name="User" size={14} style={{ marginRight: '6px' }} /> Player App Preview
                                </button>
                            </CollapsibleCategory>

                            {/* TABLET APP CATEGORY */}
                            {currentPermissions.callsheet.view && (
                                <CollapsibleCategory title="Tablet App" icon="Tablet" defaultOpen={false}>
                                    <button
                                        className={`nav-item ${view === 'callsheet' ? 'active' : ''}`}
                                        onClick={() => setView('callsheet')}
                                        style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}
                                    >
                                        <Icon name="Smartphone" size={14} style={{ marginRight: '6px' }} /> Smart Call Sheet
                                    </button>
                                    <button
                                        className={`nav-item ${view === 'simulator' ? 'active' : ''}`}
                                        onClick={() => setView('simulator')}
                                        style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}
                                    >
                                        <Icon name="Gamepad2" size={14} style={{ marginRight: '6px' }} /> Play-Calling Simulator
                                    </button>
                                </CollapsibleCategory>
                            )}

                            {/* IN-GAME CATEGORY */}
                            {/* IN-GAME CATEGORY */}
                            {currentPermissions.callsheet.view && (
                                <CollapsibleCategory title="In-game" icon="Zap" defaultOpen={false}>
                                    <button className={`nav-item ${view === 'pressbox' ? 'active' : ''}`} onClick={() => setView('pressbox')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                        Pressbox
                                    </button>
                                    <button className={`nav-item ${view === 'special-teams' ? 'active' : ''}`} onClick={() => setView('special-teams')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                        <Icon name="Target" size={14} style={{ marginRight: '6px' }} /> Special Teams
                                    </button>
                                </CollapsibleCategory>
                            )}

                            {/* ATHLETIC DEVELOPMENT CATEGORY */}
                            <CollapsibleCategory title="Player Development" icon="Activity" defaultOpen={false}>
                                <button className={`nav-item ${view === 'testing' ? 'active' : ''}`} onClick={() => setView('testing')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                    <Icon name="Dumbbell" size={14} style={{ marginRight: '6px' }} /> Combine / Testing
                                </button>

                                <button className={`nav-item ${view === 'ironman' ? 'active' : ''}`} onClick={() => setView('ironman')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                    <Icon name="Award" size={14} style={{ marginRight: '6px' }} /> Iron Man
                                </button>
                                <button className={`nav-item ${view === 'ratings' ? 'active' : ''}`} onClick={() => setView('ratings')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                    <Icon name="Gamepad2" size={14} style={{ marginRight: '6px' }} /> Madden Ratings
                                </button>
                                <button className={`nav-item ${view === 'summer-comp' ? 'active' : ''}`} onClick={() => setView('summer-comp')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                    <Icon name="Trophy" size={14} style={{ marginRight: '6px' }} /> Summer Competition
                                </button>
                                <button className={`nav-item ${view === 'valhalla' ? 'active' : ''}`} onClick={() => setView('valhalla')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none', color: '#ffd700', fontWeight: 'bold' }}>
                                    <Icon name="Swords" size={14} style={{ marginRight: '6px' }} /> Quest for Valhalla
                                </button>
                                <button className={`nav-item ${view === 'valhalla-events' ? 'active' : ''}`} onClick={() => setView('valhalla-events')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                    <Icon name="Calendar" size={14} style={{ marginRight: '6px' }} /> Valhalla Events
                                </button>
                                <button className={`nav-item ${view === 'testing-records' ? 'active' : ''}`} onClick={() => setView('testing-records')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                    <Icon name="Award" size={14} style={{ marginRight: '6px' }} /> Program Records
                                </button>
                            </CollapsibleCategory>

                            {/* EQUIPMENT CATEGORY */}
                            <CollapsibleCategory title="Equipment & Inv." icon="Package" defaultOpen={false}>
                                <button className={`nav-item ${view === 'equipment-checkout' ? 'active' : ''}`} onClick={() => setView('equipment-checkout')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                    Checkout Form
                                </button>
                                <button className={`nav-item ${view === 'equipment-lottery' ? 'active' : ''}`} onClick={() => setView('equipment-lottery')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                    <Icon name="Trophy" size={14} style={{ marginRight: '6px' }} /> Jersey Lottery
                                </button>
                                <button className={`nav-item ${view === 'equipment-inventory' ? 'active' : ''}`} onClick={() => setView('equipment-inventory')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                    Current Inventory
                                </button>
                                <button className={`nav-item ${view === 'equipment-wishlist' ? 'active' : ''}`} onClick={() => setView('equipment-wishlist')} style={{ paddingLeft: '2rem', width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                    Wishlist / Needs
                                </button>
                            </CollapsibleCategory>

                            <div style={{ marginTop: 'auto', paddingTop: '1rem', borderTop: '1px solid var(--border)' }}>
                                {currentPermissions.settings.view && (
                                    <button className={`nav-item ${view === 'settings' ? 'active' : ''}`} onClick={() => setView('settings')} style={{ width: '100%', textAlign: 'left', border: 'none', background: 'none' }}>
                                        <Icon name="Settings" /> Settings
                                    </button>
                                )}
                                {currentUser?.roles?.includes('Head Coach') && (
                                    <button className={`nav-item ${view === 'permissions' ? 'active' : ''}`} onClick={() => setView('permissions')} style={{ width: '100%', textAlign: 'left', border: 'none', background: 'none', marginTop: '0.5rem', color: 'var(--text-secondary)' }}>
                                        <Icon name="Lock" /> Permissions
                                    </button>
                                )}
                                <button className={`nav-item ${view === 'help' ? 'active' : ''}`} onClick={() => setView('help')} style={{ width: '100%', textAlign: 'left', border: 'none', background: 'none', marginTop: '0.5rem' }}>
                                    <Icon name="HelpCircle" /> How to Use
                                </button>
                            </div>
                        </nav>
                    </div>

                    <main className="main-content">
                        {view === 'director-ops' && <DirectorOpsView dutyAssignments={dutyAssignments} staff={staff} currentWeek={currentWeek} currentUser={currentUser} />}
                        {view === 'landing' && <ProgramDashboard currentWeek={currentWeek} roster={roster} userRole={(currentUser?.roles && currentUser.roles[0]) || 'Head Coach'} permissions={currentPermissions.dashboard} />}
                        {view === 'daily-reports' && <DailyReportsView roster={roster} attendance={attendance} setAttendance={setAttendance} permissions={currentPermissions.dashboard} />}
                        {view === 'drill-library' && <DrillLibraryView />}
                        {view === 'permissions' && <PermissionsView permissions={permissions} onUpdatePermissions={setPermissions} onResetDefaults={() => setPermissions(DEFAULT_PERMISSIONS)} />}

                        {view === 'scouting' && <ScoutingView data={opponentScoutData} onUpdate={setOpponentScoutData} />}
                        {view === 'dashboard' && <GamedayDashboard plays={plays} />}
                        {view === 'calendar' && <StaffCalendar />}

                        {view === 'valhalla' && <ValhallaDashboard roster={roster} valhallaData={valhallaData || { progress: {}, xpLog: [], programEvents: [], participation: {} }} onUpdateValhalla={setValhallaData} initialTab="player" />}
                        {view === 'valhalla-events' && <ValhallaDashboard roster={roster} valhallaData={valhallaData || { progress: {}, xpLog: [], programEvents: [], participation: {} }} onUpdateValhalla={setValhallaData} initialTab="events" />}

                        {view === 'new-play' && (
                            <PlayInput
                                onSave={handleSavePlay}
                                onCancel={() => { setEditingPlay(null); setView('playbook'); }}
                                onDelete={handleDeletePlay}
                                initialData={editingPlay}
                            />
                        )}

                        {view === 'playbook' && (
                            <div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                                    <h2>Playbook ({filteredPlaybook.length} / {plays.length})</h2>
                                    <div style={{ display: 'flex', gap: '1rem' }}>
                                        {selectedPlays.length > 0 && (
                                            <button className="btn" style={{ backgroundColor: '#ef4444', color: 'white' }} onClick={handleDeleteSelected}>
                                                Delete Selected ({selectedPlays.length})
                                            </button>
                                        )}
                                        <button className="btn btn-primary" onClick={() => { setEditingPlay(null); setView('new-play'); }}>
                                            <Icon name="PlusCircle" /> New Play
                                        </button>
                                    </div>
                                </div>

                                {/* Filter Bar */}
                                <div className="card" style={{ marginBottom: '2rem', padding: '1.5rem' }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                                        <h4 style={{ margin: 0, color: 'var(--text-secondary)' }}>Filters</h4>
                                        <div style={{ display: 'flex', gap: '1rem' }}>
                                            {selectedPlays.length > 0 && (
                                                <button
                                                    className="btn"
                                                    style={{ fontSize: '0.9rem', color: 'var(--text-secondary)' }}
                                                    onClick={() => setSelectedPlays([])}
                                                >
                                                    Clear Selection
                                                </button>
                                            )}
                                            <button
                                                className="btn"
                                                style={{ fontSize: '0.9rem', color: 'var(--accent)' }}
                                                onClick={() => setPlaybookFilters({ formation: '', concept: '', tag: '', situation: '' })}
                                            >
                                                Clear Filters
                                            </button>
                                        </div>
                                    </div>
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem' }}>
                                        {/* Formation Filter */}
                                        <div>
                                            <label className="form-label">Formation</label>
                                            <select
                                                className="form-select"
                                                value={playbookFilters.formation}
                                                onChange={e => setPlaybookFilters({ ...playbookFilters, formation: e.target.value })}
                                            >
                                                <option value="">All Formations</option>
                                                {uniqueFormations.map(f => (
                                                    <option key={f} value={f}>{f}</option>
                                                ))}
                                            </select>
                                        </div>

                                        {/* Concept Filter */}
                                        <div>
                                            <label className="form-label">Concept</label>
                                            <select
                                                className="form-select"
                                                value={playbookFilters.concept}
                                                onChange={e => setPlaybookFilters({ ...playbookFilters, concept: e.target.value })}
                                            >
                                                <option value="">All Concepts</option>
                                                {uniqueConcepts.map(c => (
                                                    <option key={c} value={c}>{c}</option>
                                                ))}
                                            </select>
                                        </div>

                                        {/* Situation Filter */}
                                        <div>
                                            <label className="form-label">Situation</label>
                                            <select
                                                className="form-select"
                                                value={playbookFilters.situation}
                                                onChange={e => setPlaybookFilters({ ...playbookFilters, situation: e.target.value })}
                                            >
                                                <option value="">All Situations</option>
                                                {situationTags.map(s => (
                                                    <option key={s} value={s}>{s}</option>
                                                ))}
                                            </select>
                                        </div>

                                        {/* General Tag Filter */}
                                        <div>
                                            <label className="form-label">Any Tag</label>
                                            <select
                                                className="form-select"
                                                value={playbookFilters.tag}
                                                onChange={e => setPlaybookFilters({ ...playbookFilters, tag: e.target.value })}
                                            >
                                                <option value="">All Tags</option>
                                                {allTags.map(t => (
                                                    <option key={t} value={t}>{t}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))', gap: '1.5rem' }}>
                                    {filteredPlaybook.map(play => (
                                        <PlayCard
                                            key={play.id}
                                            play={play}
                                            onEdit={handleEditPlay}
                                            isSelected={selectedPlays.includes(play.id)}
                                            onToggleSelection={togglePlaySelection}
                                        />
                                    ))}
                                    {filteredPlaybook.length === 0 && (
                                        <div style={{ gridColumn: '1 / -1', textAlign: 'center', padding: '3rem', color: 'var(--text-secondary)' }}>
                                            No plays match your filters.
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'formations' && <FormationManager formations={formations} onAddFormation={handleAddFormation} onUpdateFormation={handleUpdateFormation} onDeleteFormation={handleDeleteFormation} />}

                        {view === 'wristband' && <WristbandBuilder plays={plays} onUpdatePlay={handleUpdatePlay} />}
                        {view === 'game-plan' && <OffensiveGamePlan plays={plays} gamePlan={currentWeek.offensiveGamePlan || { sets: [] }} onUpdateGamePlan={setGamePlan} onQuickAddPlay={handleQuickAddPlay} />}
                        {view === 'game-plan-2' && <GamePlan2 plays={plays} gamePlan={currentWeek.offensiveGamePlan || { sets: [] }} onUpdateGamePlan={setGamePlan} onQuickAddPlay={handleQuickAddPlay} />}
                        {view === 'practice' && <PracticeScriptBuilder mode="plan" plays={plays} plans={currentWeek.practicePlans} onUpdatePlans={setPracticePlans} teamLogo={teamLogo} staff={staff} customFocusItems={customFocusItems} addCustomFocusItem={addCustomFocusItem} />}
                        {view === 'practice-scripts' && <PracticeScriptBuilder mode="script" plays={plays} plans={currentWeek.practicePlans} onUpdatePlans={setPracticePlans} teamLogo={teamLogo} staff={staff} customFocusItems={customFocusItems} addCustomFocusItem={addCustomFocusItem} />}
                        {view === 'pregame' && <PregameTimeline plan={currentWeek.pregamePlan} onUpdatePlan={setPregamePlan} teamLogo={teamLogo} staff={staff} />}
                        {view === 'roster' && <RosterManager roster={roster} onUpdateRoster={setRoster} />}
                        {view === 'player-profiles' && <PlayerProfileGallery roster={roster} onUpdateRoster={setRoster} />}
                        {view === 'depth' && <DepthChart
                            roster={roster}
                            depthChart={currentWeek.depthChart || {}}
                            onUpdateDepthChart={(dc) => updateCurrentWeek('depthChart', dc)}
                            chartType={depthChartType}
                            teamLogo={teamLogo}
                            savedLayout={formationLayouts[depthChartType] || {}}
                            onUpdateLayout={(posId, x, y) => updateFormationLayout(depthChartType, posId, x, y)}
                            positionNames={positionNames}
                            onResetLayout={() => resetFormationLayout(depthChartType)}
                        />}
                        {(view === 'staff-roster' || view === 'staff-duties') && (
                            <StaffManager
                                staff={staff}
                                onUpdateStaff={setStaff}
                                dutyAssignments={dutyAssignments}
                                onUpdateDuties={setDutyAssignments}
                                view={view === 'staff-duties' ? 'duties' : 'roster'}
                            />
                        )}


                        {view === 'testing-records' && <TestingRecords />}

                        {view === 'summer-comp' && <SummerCompetitionManager roster={roster} compData={summerCompData} onUpdateComp={setSummerCompData} />}
                        {view === 'travel' && <TravelManager roster={roster} travelRoster={travelRoster} onUpdateTravel={setTravelRoster} currentWeekName={currentWeek.name} />}
                        {view === 'testing' && <PlayerMetrics roster={roster} metrics={metrics} onUpdateMetrics={setMetrics} viewCategory="combine" />}
                        {view === 'ironman' && <PlayerMetrics roster={roster} metrics={metrics} onUpdateMetrics={setMetrics} viewCategory="ironman" />}
                        {view === 'ratings' && <MaddenRatings roster={roster} ratings={ratings} onUpdateRatings={setRatings} metrics={metrics} />}
                        {view === 'pressbox' && <PressboxTracker plays={plays} gameLog={currentWeek.gameLog} onUpdateGameLog={handleUpdateGameLog} roster={roster} depthChart={currentWeek.depthChart || {}} situation={situation} onUpdateSituation={setSituation} formations={formations} />}
                        {view === 'player-app' && <PlayerApp roster={roster} attendance={attendance} setRoster={setRoster} setAttendance={setAttendance} />}
                        {view === 'callsheet' && <SmartCallSheet gamePlan={currentWeek.offensiveGamePlan || {}} situation={situation} plays={plays} onUpdateSituation={setSituation} zonePhilosophies={zonePhilosophies} onUpdatePhilosophy={setZonePhilosophies} onUpdateGamePlan={setGamePlan} onQuickAddPlay={handleQuickAddPlay} />}
                        {view === 'simulator' && <PlayCallSimulator plays={plays} roster={roster} gamePlan={currentWeek.offensiveGamePlan || {}} onUpdateGamePlan={setGamePlan} />}
                        {view === 'special-teams' && (
                            <SpecialTeamsDashboard
                                roster={roster}
                                depthCharts={currentWeek.depthChart || {}}
                                onUpdateDepthChart={(chartType, updated) => {
                                    const newDepthChart = { ...(currentWeek.depthChart || {}), [chartType]: updated };
                                    updateCurrentWeek('depthChart', newDepthChart);
                                }}
                                savedLayouts={formationLayouts}
                                onUpdateLayout={(chartType, posId, x, y) => updateFormationLayout(chartType, posId, x, y)}
                                onResetLayout={(chartType) => resetFormationLayout(chartType)}
                                opponentData={currentWeek.opponentData || {}}
                                onUpdateOpponentData={(data) => {
                                    const updatedWeeks = weeks.map(w =>
                                        w.id === currentWeek.id ? { ...w, opponentData: data } : w
                                    );
                                    setWeeks(updatedWeeks);
                                }}
                            />
                        )}
                        {view.startsWith('equipment-') && (
                            <EquipmentManager
                                view={view}
                                roster={roster}
                                inventory={inventory}
                                onUpdateInventory={setInventory}
                                checkouts={checkouts} // Legacy checks, mostly unused now but kept for compatibility
                                onUpdateCheckouts={setCheckouts}
                                issuance={issuance}
                                onUpdateIssuance={setIssuance}
                                wishlist={wishlist}
                                onUpdateWishlist={setWishlist}
                                lotteryData={lotteryData}
                                onUpdateLottery={setLotteryData}
                            />
                        )}
                        {view === 'settings' && <Settings teamLogo={teamLogo} onUpdateLogo={setTeamLogo} accentColor={accentColor} onUpdateAccentColor={setAccentColor} positionNames={positionNames} onUpdatePositionNames={setPositionNames} onImportData={handleImportData} onExportData={handleExportData} onImportDefaultData={handleImportDefaultData} />}
                        {view === 'help' && <UserGuide />}
                    </main>
                </div>
            );
        };

        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                this.setState({ error, errorInfo });
                console.error("Uncaught error:", error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div style={{ padding: '2rem', color: '#ef4444', background: '#1e293b', height: '100vh' }}>
                            <h1>Something went wrong.</h1>
                            <details style={{ whiteSpace: 'pre-wrap' }}>
                                {this.state.error && this.state.error.toString()}
                                <br />
                                {this.state.errorInfo && this.state.errorInfo.componentStack}
                            </details>
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>

</html>