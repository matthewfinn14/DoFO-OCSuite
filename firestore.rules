rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    function isMemberOf(schoolId) {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)/memberships/$(schoolId));
    }

    function isSiteAdmin() {
      return request.auth.token.email.lower() in ['admin@digitaldofo.com', 'matthewfinn14@gmail.com'];
    }

    // --- USERS ---
    // Users can access their own profile. Site admins can create/manage any user (for approvals).
    match /users/{userId} {
      // Read: any authenticated user (for admin panel listing)
      allow read: if request.auth != null;
      // Write: own profile or site admin
      allow write: if request.auth != null && (request.auth.uid == userId || isSiteAdmin());

      match /memberships/{schoolId} {
        allow read, write: if request.auth != null && (request.auth.uid == userId || isSiteAdmin());
      }
    }

    // --- SCHOOLS (TEAMS) ---
    // Collaborative data. Access restricted to team members.
    match /schools/{schoolId} {
      // Creation: Any auth user can create a new school.
      allow create: if request.auth != null;

      // Read: Any authenticated user can read (for admin panel listing)
      allow read: if request.auth != null;

      // Update/Delete: Any authenticated user (app-level permissions handle admin checks)
      allow update, delete: if request.auth != null;

      // Subcollections (roster, plays, practice_plans, etc.)
      match /{allChildren=**} {
        allow read: if request.auth != null && (isSiteAdmin() || isMemberOf(schoolId));
        allow write: if request.auth != null && isMemberOf(schoolId);
      }
    }

    // --- ACCESS REQUESTS ---
    // For trial/access request management
    match /access_requests/{requestId} {
      // Anyone can create an access request
      allow create: if request.auth != null;
      // Users can read their own request, site admins can read all
      allow read: if request.auth != null;
      // Site admins can update/delete
      allow update, delete: if request.auth != null && isSiteAdmin();
    }

    // --- GLOBAL RESOURCES ---

    // Global Templates: Readable by all authenticated, writable by admins only
    match /global_templates/{templateId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && isSiteAdmin();
    }

    // Invites: Users can read their own, admins can manage all
    match /invites/{email} {
      allow read: if request.auth != null && (
        request.auth.token.email.lower() == email.lower() || isSiteAdmin()
      );
      allow write: if request.auth != null && isSiteAdmin();
    }

    // Config: App configuration (billing, access control)
    match /config/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && isSiteAdmin();

      match /{allChildren=**} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && isSiteAdmin();
      }
    }

    // Mail: For email triggers (admin only)
    match /mail/{mailId} {
      allow read, write: if request.auth != null && isSiteAdmin();
    }
  }
}
