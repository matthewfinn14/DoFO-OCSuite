rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    function isMemberOf(schoolId) {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)/memberships/$(schoolId));
    }

    function isSiteAdmin() {
      return request.auth.token.email in ['admin@digitaldofo.com', 'matthewfinn14@gmail.com'];
    }

    // --- USERS ---
    // Strictly private. Only the user can access their own profile.
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      match /memberships/{schoolId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // --- SCHOOLS (TEAMS) ---
    // Collaborative data. Access restricted to team members.
    match /schools/{schoolId} {
      // Creation: Any auth user can create a new school.
      allow create: if request.auth != null;

      // Read: Site admins can read all schools, others must be members
      allow read: if request.auth != null && (isSiteAdmin() || isMemberOf(schoolId));

      // Update/Delete: Site admins or members of the school
      allow update, delete: if request.auth != null && (isSiteAdmin() || isMemberOf(schoolId));

      // Subcollections (roster, plays, practice_plans, etc.)
      match /{allChildren=**} {
        allow read: if request.auth != null && (isSiteAdmin() || isMemberOf(schoolId));
        allow write: if request.auth != null && isMemberOf(schoolId);
      }
    }

    // --- GLOBAL RESOURCES ---

    // Global Templates: Readable by all authenticated, writable by admins only
    match /global_templates/{templateId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && isSiteAdmin();
    }

    // Invites: Users can read their own, admins can manage all
    match /invites/{email} {
      allow read: if request.auth != null && (
        request.auth.token.email.lower() == email.lower() || isSiteAdmin()
      );
      allow write: if request.auth != null && isSiteAdmin();
    }

    // Access Requests: For new users requesting access
    match /access_requests/{requestId} {
      // Users can create requests
      allow create: if request.auth != null;

      // Users can read their own request, admins can read all
      allow read: if request.auth != null && (
        resource.data.email == request.auth.token.email.lower() || isSiteAdmin()
      );

      // Only admins can update/delete requests
      allow update, delete: if request.auth != null && isSiteAdmin();
    }

    // Config: App configuration (billing, access control)
    match /config/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && isSiteAdmin();

      match /{allChildren=**} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && isSiteAdmin();
      }
    }

    // Mail: For email triggers (admin only)
    match /mail/{mailId} {
      allow read, write: if request.auth != null && isSiteAdmin();
    }
  }
}
